<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APS - Sistema de Precifica√ß√£o</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .stats {
            display: flex;
            gap: 2rem;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: white;
            min-height: calc(100vh - 100px);
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: #ecf0f1;
            color: #2c3e50;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .tab:hover {
            background: #d5dbdb;
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border-color: #2c3e50;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select {
            padding: 0.75rem;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2c3e50;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(44, 62, 80, 0.4);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-info {
            background: #3498db;
            color: white;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #ecf0f1;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid;
        }

        .alert-warning {
            background: #fef9e7;
            border-color: #f39c12;
            color: #8a6d3b;
        }

        .alert-success {
            background: #d5f4e6;
            border-color: #27ae60;
            color: #155724;
        }

        .alert-info {
            background: #d6eaf8;
            border-color: #3498db;
            color: #0c5460;
        }

        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-success {
            background: #27ae60;
            color: white;
        }

        .badge-warning {
            background: #f39c12;
            color: white;
        }

        .badge-danger {
            background: #e74c3c;
            color: white;
        }

        .badge-info {
            background: #3498db;
            color: white;
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .pricing-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 2px solid #ecf0f1;
        }

        .pricing-card h3 {
            margin-bottom: 1rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .price-display {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 1rem 0;
        }

        .margin-info {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .simulator-section {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem 0;
        }

        .simulator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .simulator-result {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .result-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .result-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .analysis-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid;
        }

        .analysis-card.orange {
            border-left-color: #e67e22;
        }

        .analysis-card.blue {
            border-left-color: #3498db;
        }

        .analysis-card.green {
            border-left-color: #27ae60;
        }

        .analysis-card.purple {
            border-left-color: #8e44ad;
        }

        .import-export-section {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem 0;
        }

        .import-export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: #95a5a6;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-label:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
        }

        .footer {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .ingredient-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .ingredient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
        }

        .ingredient-item:last-child {
            border-bottom: none;
        }

        .quantity-input {
            width: 100px;
            padding: 0.25rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .stats {
                gap: 1rem;
            }

            .container {
                padding: 1rem;
            }

            .tabs {
                flex-direction: column;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span style="font-size: 1.5rem;">üìä</span>
                <div>
                    <h1>APS - Sistema de Precifica√ß√£o</h1>
                    <p style="font-size: 0.9rem; opacity: 0.9;">Sistema Profissional de Gest√£o de Custos</p>
                </div>
            </div>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="totalIngredientes">0</div>
                    <div class="stat-label">Ingredientes</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="totalReceitas">0</div>
                    <div class="stat-label">Receitas</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="totalAlertas">0</div>
                    <div class="stat-label">Alertas</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="custoMedio">R$ 0,00</div>
                    <div class="stat-label">Custo M√©dio</div>
                </div>
                <div class="stat">
                    <div class="stat-value">6</div>
                    <div class="stat-label">Canais</div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('ingredientes')">ü•ò Ingredientes</button>
            <button class="tab" onclick="showTab('receitas')">üìù Receitas</button>
            <button class="tab" onclick="showTab('custos')">üí∞ Custos</button>
            <button class="tab" onclick="showTab('precificacao')">üí≤ Precifica√ß√£o</button>
            <button class="tab" onclick="showTab('simulador')">üßÆ Simulador</button>
            <button class="tab" onclick="showTab('analises')">üìà An√°lises</button>
            <button class="tab" onclick="showTab('importexport')">üì§ Import/Export</button>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="tab-content active">
            <div class="alert alert-warning" id="alertaConfiguracao">
                <strong>‚ö†Ô∏è Sistema Pronto para Configura√ß√£o</strong><br>
                Configure custos operacionais, cadastre ingredientes e use o simulador de cen√°rios para otimizar sua precifica√ß√£o.
            </div>

            <div class="cards-grid">
                <div class="card">
                    <h3>üìä Dashboard Inteligente</h3>
                    <p>Vis√£o geral do sistema com KPIs essenciais, alertas autom√°ticos para configura√ß√µes pendentes e estat√≠sticas em tempo real.</p>
                </div>
                <div class="card">
                    <h3>ü•ò Gest√£o de Ingredientes</h3>
                    <p>CRUD completo com hist√≥rico de pre√ßos, categoriza√ß√£o por tipo e controle de fornecedores e unidades de medida.</p>
                </div>
                <div class="card">
                    <h3>üìù Gest√£o de Receitas</h3>
                    <p>Cria√ß√£o de receitas por tamanho com composi√ß√£o detalhada e c√°lculo autom√°tico de custos por receita.</p>
                </div>
                <div class="card">
                    <h3>üí∞ Custos Operacionais</h3>
                    <p>Controle completo de custos fixos mensais, embalagens, sach√™s e delivery com rateio autom√°tico por volume de vendas.</p>
                </div>
                <div class="card">
                    <h3>üí≤ Precifica√ß√£o Multi-Canal</h3>
                    <p>Sistema inteligente para 6 canais de venda com c√°lculo detalhado, margem real, lucro l√≠quido e compara√ß√£o autom√°tica.</p>
                </div>
                <div class="card">
                    <h3>üßÆ Simulador de Cen√°rios</h3>
                    <p>An√°lise de sensibilidade com diferentes cen√°rios, ponto de equil√≠brio e simula√ß√£o de vendas para otimiza√ß√£o.</p>
                </div>
                <div class="card">
                    <h3>üìà An√°lises Profissionais</h3>
                    <p>Relat√≥rios executivos, hist√≥rico de pre√ßos, an√°lise de rentabilidade e insights para otimiza√ß√£o do neg√≥cio.</p>
                </div>
                <div class="card">
                    <h3>üì§ Import/Export</h3>
                    <p>Sistema completo de backup e restaura√ß√£o de dados em Excel, CSV e JSON para continuidade do trabalho.</p>
                </div>
            </div>
        </div>

        <!-- Ingredientes -->
        <div id="ingredientes" class="tab-content">
            <h2 class="section-title">ü•ò Gest√£o de Ingredientes</h2>
            <p>Cadastre ingredientes com hist√≥rico de pre√ßos e quantidade padr√£o por pizza.</p>

            <div class="form-grid">
                <div class="form-group">
                    <label>Nome do Ingrediente</label>
                    <input type="text" id="nomeIngrediente" placeholder="Ex: Mussarela">
                </div>
                <div class="form-group">
                    <label>Unidade de Medida</label>
                    <select id="unidadeIngrediente">
                        <option value="kg">Quilograma (kg)</option>
                        <option value="g">Gramas (g)</option>
                        <option value="l">Litros (l)</option>
                        <option value="ml">Mililitros (ml)</option>
                        <option value="un">Unidade</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Pre√ßo por Unidade (R$)</label>
                    <input type="number" id="precoIngrediente" step="0.01" placeholder="0,00">
                </div>
                <div class="form-group">
                    <label>Quantidade por Pizza (padr√£o)</label>
                    <input type="number" id="quantidadeIngrediente" step="0.001" placeholder="Ex: 0,15">
                </div>
                <div class="form-group">
                    <label>Fornecedor</label>
                    <input type="text" id="fornecedorIngrediente" placeholder="Ex: Distribuidora ABC">
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="categoriaIngrediente">
                        <option value="queijos">Queijos</option>
                        <option value="carnes">Carnes</option>
                        <option value="vegetais">Vegetais</option>
                        <option value="molhos">Molhos</option>
                        <option value="massas">Massas</option>
                        <option value="temperos">Temperos</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
            </div>

            <div style="margin-bottom: 2rem;">
                <button class="btn btn-primary" onclick="adicionarIngrediente()" id="btnAdicionarIngrediente">‚ûï Adicionar Ingrediente</button>
                <button class="btn btn-warning" onclick="atualizarPrecos()">üìà Atualizar Pre√ßos</button>
                <button class="btn btn-secondary" onclick="cancelarEdicao()" id="btnCancelarEdicao" style="display: none;">‚ùå Cancelar Edi√ß√£o</button>
            </div>

            <table class="table" id="tabelaIngredientes">
                <thead>
                    <tr>
                        <th>Ingrediente</th>
                        <th>Unidade</th>
                        <th>Pre√ßo/Unidade</th>
                        <th>Hist√≥rico</th>
                        <th>Qtd/Pizza</th>
                        <th>Custo/Pizza</th>
                        <th>Fornecedor</th>
                        <th>Categoria</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="9" style="text-align: center; color: #7f8c8d;">
                            Nenhum ingrediente cadastrado. Adicione ingredientes para come√ßar.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Receitas -->
        <div id="receitas" class="tab-content">
            <h2 class="section-title">üìù Gest√£o de Receitas</h2>
            <p>Crie receitas por tamanho com composi√ß√£o detalhada e c√°lculo autom√°tico de custos.</p>

            <div class="form-grid">
                <div class="form-group">
                    <label>Nome da Receita</label>
                    <input type="text" id="nomeReceita" placeholder="Ex: Pizza Margherita">
                </div>
                <div class="form-group">
                    <label>Tamanho</label>
                    <select id="tamanhoReceita">
                        <option value="P">Pequena (P)</option>
                        <option value="M">M√©dia (M)</option>
                        <option value="G">Grande (G)</option>
                        <option value="GG">Gigante (GG)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="categoriaReceita">
                        <option value="tradicional">Tradicional</option>
                        <option value="especial">Especial</option>
                        <option value="premium">Premium</option>
                        <option value="doce">Doce</option>
                    </select>
                </div>
            </div>

            <div style="margin-bottom: 2rem;">
                <button class="btn btn-primary" onclick="criarReceita()">‚ûï Criar Receita</button>
                <button class="btn btn-info" onclick="duplicarReceita()">üìã Duplicar Receita</button>
            </div>

            <div id="listaReceitas">
                <div style="text-align: center; color: #7f8c8d; padding: 2rem;">
                    Nenhuma receita cadastrada. Crie receitas para come√ßar.
                </div>
            </div>
        </div>

        <!-- Modal para Composi√ß√£o de Receita -->
        <div id="modalReceita" class="modal">
            <div class="modal-content">
                <span class="close" onclick="fecharModalReceita()">&times;</span>
                <h2 id="tituloModalReceita">Composi√ß√£o da Receita</h2>
                
                <div class="form-group">
                    <label>Adicionar Ingrediente:</label>
                    <select id="selectIngredienteReceita">
                        <option value="">Selecione um ingrediente</option>
                    </select>
                </div>

                <div id="ingredientesReceita" class="ingredient-list">
                    <p style="text-align: center; color: #7f8c8d;">Nenhum ingrediente adicionado</p>
                </div>

                <div style="margin-top: 1rem;">
                    <strong>Custo Total: R$ <span id="custoTotalReceita">0,00</span></strong>
                </div>

                <div style="margin-top: 2rem;">
                    <button class="btn btn-primary" onclick="salvarReceita()">üíæ Salvar Receita</button>
                    <button class="btn btn-secondary" onclick="fecharModalReceita()">‚ùå Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Custos -->
        <div id="custos" class="tab-content">
            <h2 class="section-title">üí∞ Custos Operacionais Avan√ßados</h2>
            <p>Configure todos os custos operacionais com simula√ß√£o de cen√°rios e metas de lucro.</p>

            <h3>Custos Fixos Mensais</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Sal√°rios e Encargos (R$)</label>
                    <input type="number" id="custoSalarios" step="0.01" placeholder="0,00">
                </div>
                <div class="form-group">
                    <label>Aluguel (R$)</label>
                    <input type="number" id="custoAluguel" step="0.01" placeholder="0,00">
                </div>
                <div class="form-group">
                    <label>Energia El√©trica (R$)</label>
                    <input type="number" id="custoEnergia" step="0.01" placeholder="0,00">
                </div>
                <div class="form-group">
                    <label>G√°s (R$)</label>
                    <input type="number" id="custoGas" step="0.01" placeholder="0,00">
                </div>
                <div class="form-group">
                    <label>Telefone/Internet (R$)</label>
                    <input type="number" id="custoTelefone" step="0.01" placeholder="0,00">
                </div>
                <div class="form-group">
                    <label>Marketing (R$)</label>
                    <input type="number" id="custoMarketing" step="0.01" placeholder="0,00">
                </div>
            </div>

            <h3>Par√¢metros de Neg√≥cio</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Pizzas Vendidas/M√™s</label>
                    <input type="number" id="pizzasVendidasMes" placeholder="Ex: 1000">
                </div>
                <div class="form-group">
                    <label>Impostos (%)</label>
                    <input type="number" id="impostos" step="0.1" placeholder="Ex: 15,5">
                </div>
                <div class="form-group">
                    <label>Meta de Lucro Mensal (R$)</label>
                    <input type="number" id="metaLucro" step="0.01" placeholder="Ex: 15000">
                </div>
                <div class="form-group">
                    <label>Ticket M√©dio Desejado (R$)</label>
                    <input type="number" id="ticketMedio" step="0.01" placeholder="Ex: 35,00">
                </div>
            </div>

            <div style="margin-bottom: 2rem;">
                <button class="btn btn-primary" onclick="salvarCustos()">üíæ Salvar Custos</button>
                <button class="btn btn-success" onclick="calcularCustos()">üßÆ Calcular Custos</button>
            </div>

            <div class="simulator-section">
                <h3>üßÆ Simulador de Cen√°rios</h3>
                <div class="simulator-grid">
                    <div class="simulator-result">
                        <div class="result-value" id="custoOperacionalTotal">R$ 0,00</div>
                        <div class="result-label">Custo Operacional Total</div>
                    </div>
                    <div class="simulator-result">
                        <div class="result-value" id="custoPorPizza">R$ 0,00</div>
                        <div class="result-label">Custo por Pizza</div>
                    </div>
                    <div class="simulator-result">
                        <div class="result-value" id="margemNecessaria">0%</div>
                        <div class="result-label">Margem Necess√°ria</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Precifica√ß√£o -->
        <div id="precificacao" class="tab-content">
            <h2 class="section-title">üí≤ Precifica√ß√£o Multi-Canal Avan√ßada</h2>
            <p>Compare pre√ßos otimizados para cada canal com an√°lise detalhada de rentabilidade.</p>

            <div class="form-grid">
                <div class="form-group">
                    <label>Receita para Precificar</label>
                    <select id="receitaPrecificar">
                        <option value="">Selecione uma receita</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Margem Desejada (%)</label>
                    <input type="number" id="margemDesejada" step="1" placeholder="Ex: 150" value="150">
                </div>
                <div class="form-group">
                    <label>Taxa de Entrega (R$)</label>
                    <input type="number" id="taxaEntrega" step="0.01" placeholder="Ex: 5,00" value="5.00">
                </div>
                <div class="form-group">
                    <label>Custo de Embalagem (R$)</label>
                    <input type="number" id="custoEmbalagem" step="0.01" placeholder="Ex: 2,50" value="2.50">
                </div>
            </div>

            <div style="margin-bottom: 2rem;">
                <button class="btn btn-primary" onclick="calcularPrecos()">üí∞ Calcular Pre√ßos</button>
                <button class="btn btn-info" onclick="exportarTabelaPrecificacao()">üìä Exportar Tabela</button>
            </div>

            <div class="pricing-grid" id="precificacaoResultados">
                <!-- Balc√£o -->
                <div class="pricing-card">
                    <h3>üè™ Balc√£o</h3>
                    <div class="form-group">
                        <label>Taxa (%)</label>
                        <input type="number" value="0" readonly>
                    </div>
                    <div class="form-group">
                        <label>Margem (%)</label>
                        <input type="number" value="150" placeholder="150">
                    </div>
                    <div class="price-display" id="precoBalcao">R$ 0,00</div>
                    <div class="margin-info" id="margemBalcao">Margem Real: 0%</div>
                </div>

                <!-- Delivery Direto -->
                <div class="pricing-card">
                    <h3>üöö Delivery Direto</h3>
                    <div class="form-group">
                        <label>Taxa (%)</label>
                        <input type="number" value="0" readonly>
                    </div>
                    <div class="form-group">
                        <label>Margem (%)</label>
                        <input type="number" value="150" placeholder="150">
                    </div>
                    <div class="price-display" id="precoDelivery">R$ 0,00</div>
                    <div class="margin-info" id="margemDelivery">Margem Real: 0%</div>
                </div>

                <!-- iFood -->
                <div class="pricing-card">
                    <h3>üçï iFood</h3>
                    <div class="form-group">
                        <label>Taxa (%)</label>
                        <input type="number" value="27">
                    </div>
                    <div class="form-group">
                        <label>Margem (%)</label>
                        <input type="number" value="150" placeholder="150">
                    </div>
                    <div class="price-display" id="precoIfood">R$ 0,00</div>
                    <div class="margin-info" id="margemIfood">Margem Real: 0%</div>
                </div>

                <!-- 99Food -->
                <div class="pricing-card">
                    <h3>ü•ò 99Food</h3>
                    <div class="form-group">
                        <label>Taxa (%)</label>
                        <input type="number" value="12">
                    </div>
                    <div class="form-group">
                        <label>Margem (%)</label>
                        <input type="number" value="150" placeholder="150">
                    </div>
                    <div class="price-display" id="preco99Food">R$ 0,00</div>
                    <div class="margin-info" id="margem99Food">Margem Real: 0%</div>
                </div>

                <!-- Rappi -->
                <div class="pricing-card">
                    <h3>üõµ Rappi</h3>
                    <div class="form-group">
                        <label>Taxa (%)</label>
                        <input type="number" value="14">
                    </div>
                    <div class="form-group">
                        <label>Margem (%)</label>
                        <input type="number" value="150" placeholder="150">
                    </div>
                    <div class="price-display" id="precoRappi">R$ 0,00</div>
                    <div class="margin-info" id="margemRappi">Margem Real: 0%</div>
                </div>

                <!-- Uber Eats -->
                <div class="pricing-card">
                    <h3>üöó Uber Eats</h3>
                    <div class="form-group">
                        <label>Taxa (%)</label>
                        <input type="number" value="15">
                    </div>
                    <div class="form-group">
                        <label>Margem (%)</label>
                        <input type="number" value="150" placeholder="150">
                    </div>
                    <div class="price-display" id="precoUber">R$ 0,00</div>
                    <div class="margin-info" id="margemUber">Margem Real: 0%</div>
                </div>
            </div>

            <table class="table" id="tabelaComparacao" style="margin-top: 2rem;">
                <thead>
                    <tr>
                        <th>Canal</th>
                        <th>Custo Total</th>
                        <th>Taxa (%)</th>
                        <th>Margem (%)</th>
                        <th>Pre√ßo Final</th>
                        <th>Lucro L√≠quido</th>
                        <th>Margem Real (%)</th>
                        <th>Ranking</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="8" style="text-align: center; color: #7f8c8d;">
                            Selecione uma receita e calcule os pre√ßos para visualizar a compara√ß√£o.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Simulador -->
        <div id="simulador" class="tab-content">
            <div class="simulator-section">
                <h2 class="section-title">üßÆ Simulador Avan√ßado de Cen√°rios</h2>
                <p>Simule diferentes cen√°rios de vendas e custos para otimizar sua estrat√©gia de precifica√ß√£o.</p>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Vendas Mensais (pizzas)</label>
                        <input type="number" id="vendasMensais" value="1000" placeholder="1000">
                    </div>
                    <div class="form-group">
                        <label>Ticket M√©dio (R$)</label>
                        <input type="number" id="ticketMedioSim" value="35.00" step="0.01" placeholder="35,00">
                    </div>
                    <div class="form-group">
                        <label>Custo M√©dio/Pizza (R$)</label>
                        <input type="number" id="custoMedioPizza" value="15.00" step="0.01" placeholder="15,00">
                    </div>
                    <div class="form-group">
                        <label>Custos Fixos (R$)</label>
                        <input type="number" id="custosFixosSim" value="10000" step="0.01" placeholder="10000">
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <button class="btn btn-primary" onclick="simularCenario()">üéØ Simular Cen√°rio</button>
                    <button class="btn btn-info" onclick="gerarRelatorioSimulacao()">üìä Gerar Relat√≥rio</button>
                </div>

                <div class="simulator-grid">
                    <div class="simulator-result">
                        <div class="result-value" id="receitaMensal">R$ 0,00</div>
                        <div class="result-label">Receita Mensal</div>
                    </div>
                    <div class="simulator-result">
                        <div class="result-value" id="lucroLiquido">R$ 0,00</div>
                        <div class="result-label">Lucro L√≠quido</div>
                    </div>
                    <div class="simulator-result">
                        <div class="result-value" id="margemLucro">0%</div>
                        <div class="result-label">Margem de Lucro</div>
                    </div>
                    <div class="simulator-result">
                        <div class="result-value" id="pontoEquilibrio">0</div>
                        <div class="result-label">Ponto de Equil√≠brio</div>
                    </div>
                </div>
            </div>

            <h3>üìä An√°lise de Sensibilidade</h3>
            <p>Veja como mudan√ßas nos par√¢metros afetam sua rentabilidade.</p>

            <table class="table" id="tabelaSensibilidade">
                <thead>
                    <tr>
                        <th>Cen√°rio</th>
                        <th>Vendas/M√™s</th>
                        <th>Ticket M√©dio</th>
                        <th>Receita</th>
                        <th>Lucro</th>
                        <th>Margem</th>
                        <th>Viabilidade</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Conservador</td>
                        <td>800</td>
                        <td>R$ 30,00</td>
                        <td>R$ 24.000</td>
                        <td>R$ 8.000</td>
                        <td>33%</td>
                        <td><span class="badge badge-success">Vi√°vel</span></td>
                    </tr>
                    <tr>
                        <td>Realista</td>
                        <td>1000</td>
                        <td>R$ 35,00</td>
                        <td>R$ 35.000</td>
                        <td>R$ 15.000</td>
                        <td>43%</td>
                        <td><span class="badge badge-success">Vi√°vel</span></td>
                    </tr>
                    <tr>
                        <td>Otimista</td>
                        <td>1200</td>
                        <td>R$ 40,00</td>
                        <td>R$ 48.000</td>
                        <td>R$ 23.000</td>
                        <td>48%</td>
                        <td><span class="badge badge-success">Vi√°vel</span></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- An√°lises -->
        <div id="analises" class="tab-content">
            <h2 class="section-title">üìà An√°lises Avan√ßadas</h2>
            <p>Relat√≥rios detalhados e insights para otimiza√ß√£o do neg√≥cio.</p>

            <div class="analysis-grid">
                <div class="analysis-card orange">
                    <h3>üìä An√°lise de Rentabilidade</h3>
                    <p>Compare a rentabilidade entre diferentes receitas e canais de venda.</p>
                    <button class="btn btn-primary" onclick="gerarRelatorioRentabilidade()">Gerar Relat√≥rio</button>
                </div>

                <div class="analysis-card blue">
                    <h3>üìà Hist√≥rico de Pre√ßos</h3>
                    <p>Acompanhe a evolu√ß√£o dos pre√ßos dos ingredientes ao longo do tempo.</p>
                    <button class="btn btn-primary" onclick="verHistoricoPrecos()">Ver Hist√≥rico</button>
                </div>

                <div class="analysis-card green">
                    <h3>üéØ An√°lise de Margem</h3>
                    <p>Identifique oportunidades de otimiza√ß√£o de margem por canal.</p>
                    <button class="btn btn-primary" onclick="analisarMargem()">Analisar</button>
                </div>

                <div class="analysis-card purple">
                    <h3>üìã Relat√≥rio Completo</h3>
                    <p>Relat√≥rio executivo com todos os indicadores e recomenda√ß√µes.</p>
                    <button class="btn btn-primary" onclick="exportarPDF()">Exportar PDF</button>
                </div>
            </div>

            <table class="table" style="margin-top: 2rem;" id="tabelaAnalises">
                <thead>
                    <tr>
                        <th>Per√≠odo</th>
                        <th>Receitas</th>
                        <th>Custo M√©dio</th>
                        <th>Margem M√©dia</th>
                        <th>Canal + Rent√°vel</th>
                        <th>Varia√ß√£o Pre√ßos</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="7" style="text-align: center; color: #7f8c8d;">
                            Dados de an√°lise ser√£o gerados conforme o uso do sistema.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Import/Export -->
        <div id="importexport" class="tab-content">
            <h2 class="section-title">üì§ Import/Export de Dados</h2>
            <p>Sistema completo de backup e restaura√ß√£o para continuidade do trabalho em qualquer pizzaria.</p>

            <div class="import-export-section">
                <div class="import-export-grid">
                    <!-- Exporta√ß√£o -->
                    <div class="card">
                        <h3>üì§ Exportar Dados</h3>
                        <p>Fa√ßa backup completo de todos os dados do sistema para continuar o trabalho posteriormente.</p>
                        
                        <div style="margin: 1rem 0;">
                            <h4>Dados a Exportar:</h4>
                            <div style="margin: 0.5rem 0;">
                                <label><input type="checkbox" id="exportIngredientes" checked> Ingredientes e Hist√≥rico</label>
                            </div>
                            <div style="margin: 0.5rem 0;">
                                <label><input type="checkbox" id="exportReceitas" checked> Receitas</label>
                            </div>
                            <div style="margin: 0.5rem 0;">
                                <label><input type="checkbox" id="exportCustos" checked> Custos Operacionais</label>
                            </div>
                            <div style="margin: 0.5rem 0;">
                                <label><input type="checkbox" id="exportConfiguracoes" checked> Configura√ß√µes</label>
                            </div>
                        </div>

                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-success" onclick="exportarExcel()">üìä Excel (.xlsx)</button>
                            <button class="btn btn-info" onclick="exportarCSV()">üìÑ CSV</button>
                            <button class="btn btn-secondary" onclick="exportarJSON()">üîß JSON</button>
                        </div>

                        <div id="statusExport" style="margin-top: 1rem;"></div>
                    </div>

                    <!-- Importa√ß√£o -->
                    <div class="card">
                        <h3>üì• Importar Dados</h3>
                        <p>Restaure dados de backup anterior ou importe dados de outra pizzaria.</p>

                        <div style="margin: 1rem 0;">
                            <label class="file-label" for="arquivoImport">
                                üìÅ Selecionar Arquivo
                            </label>
                            <input type="file" id="arquivoImport" class="file-input" accept=".xlsx,.csv,.json" onchange="processarArquivo(this)">
                        </div>

                        <div id="previewImport" style="display: none; margin: 1rem 0;">
                            <h4>Preview dos Dados:</h4>
                            <div id="dadosPreview"></div>
                        </div>

                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" id="btnImportar" onclick="importarDados()" disabled>üì• Importar Dados</button>
                            <button class="btn btn-warning" onclick="backupAntes()">üíæ Backup Antes</button>
                        </div>

                        <div id="statusImport" style="margin-top: 1rem;"></div>
                    </div>
                </div>

                <!-- Hist√≥rico de Backups -->
                <div class="card" style="margin-top: 2rem;">
                    <h3>üìã Hist√≥rico de Backups</h3>
                    <p>Gerencie seus backups autom√°ticos e manuais.</p>

                    <table class="table">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Tipo</th>
                                <th>Tamanho</th>
                                <th>Ingredientes</th>
                                <th>Receitas</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="historicoBackups">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #7f8c8d;">
                                    Nenhum backup encontrado. Fa√ßa seu primeiro backup.
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <div style="margin-top: 1rem;">
                        <button class="btn btn-info" onclick="backupAutomatico()">üîÑ Backup Autom√°tico</button>
                        <button class="btn btn-danger" onclick="limparBackups()">üóëÔ∏è Limpar Hist√≥rico</button>
                    </div>
                </div>

                <!-- Instru√ß√µes -->
                <div class="alert alert-info" style="margin-top: 2rem;">
                    <strong>üí° Dicas de Uso:</strong><br>
                    ‚Ä¢ <strong>Excel</strong>: Melhor para an√°lise e edi√ß√£o externa<br>
                    ‚Ä¢ <strong>CSV</strong>: Compat√≠vel com qualquer planilha<br>
                    ‚Ä¢ <strong>JSON</strong>: Backup completo com todas as configura√ß√µes<br>
                    ‚Ä¢ Fa√ßa backups regulares para n√£o perder seu trabalho<br>
                    ‚Ä¢ Use a importa√ß√£o para migrar entre dispositivos
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>¬© 2024 APS - Sistema de Precifica√ß√£o v3.0</p>
        <p>Desenvolvido para pizzarias que buscam gest√£o profissional e precifica√ß√£o inteligente</p>
    </footer>

    <script>
        // Dados globais
        let ingredientes = JSON.parse(localStorage.getItem('ingredientes')) || [];
        let receitas = JSON.parse(localStorage.getItem('receitas')) || [];
        let custosOperacionais = JSON.parse(localStorage.getItem('custosOperacionais')) || {};
        let configuracoes = JSON.parse(localStorage.getItem('configuracoes')) || {};
        let historicoBackups = JSON.parse(localStorage.getItem('historicoBackups')) || [];
        let receitaEditando = null;
        let ingredienteEditando = null;

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            atualizarEstatisticas();
            carregarDados();
            verificarAlertas();
        });

        // Navega√ß√£o entre abas
        function showTab(tabName) {
            // Esconder todas as abas
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Remover classe active de todos os bot√µes
            const buttons = document.querySelectorAll('.tab');
            buttons.forEach(btn => btn.classList.remove('active'));

            // Mostrar aba selecionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Gest√£o de Ingredientes
        function adicionarIngrediente() {
            const nome = document.getElementById('nomeIngrediente').value;
            const unidade = document.getElementById('unidadeIngrediente').value;
            const preco = parseFloat(document.getElementById('precoIngrediente').value);
            const quantidade = parseFloat(document.getElementById('quantidadeIngrediente').value);
            const fornecedor = document.getElementById('fornecedorIngrediente').value;
            const categoria = document.getElementById('categoriaIngrediente').value;

            if (!nome || !preco || !quantidade) {
                alert('Preencha todos os campos obrigat√≥rios!');
                return;
            }

            if (ingredienteEditando) {
                // Atualizar ingrediente existente
                const index = ingredientes.findIndex(ing => ing.id === ingredienteEditando);
                if (index !== -1) {
                    // Adicionar ao hist√≥rico se o pre√ßo mudou
                    if (ingredientes[index].preco !== preco) {
                        if (!ingredientes[index].historico) ingredientes[index].historico = [];
                        ingredientes[index].historico.push({
                            data: new Date().toISOString().split('T')[0],
                            preco: preco
                        });
                    }
                    
                    ingredientes[index] = {
                        ...ingredientes[index],
                        nome,
                        unidade,
                        preco,
                        quantidade,
                        fornecedor,
                        categoria
                    };
                }
                ingredienteEditando = null;
                document.getElementById('btnAdicionarIngrediente').textContent = '‚ûï Adicionar Ingrediente';
                document.getElementById('btnCancelarEdicao').style.display = 'none';
            } else {
                // Adicionar novo ingrediente
                const ingrediente = {
                    id: Date.now(),
                    nome,
                    unidade,
                    preco,
                    quantidade,
                    fornecedor,
                    categoria,
                    historico: [{
                        data: new Date().toISOString().split('T')[0],
                        preco: preco
                    }],
                    dataCriacao: new Date().toISOString()
                };
                ingredientes.push(ingrediente);
            }

            salvarDados();
            atualizarTabelaIngredientes();
            limparFormularioIngrediente();
            atualizarEstatisticas();
            atualizarSelectIngredientes();

            // Feedback visual
            const btn = document.getElementById('btnAdicionarIngrediente');
            const textoOriginal = btn.textContent;
            btn.textContent = ingredienteEditando ? 'Atualizado!' : 'Adicionado!';
            btn.style.background = '#27ae60';
            setTimeout(() => {
                btn.textContent = textoOriginal;
                btn.style.background = '';
            }, 2000);
        }

        function editarIngrediente(id) {
            const ingrediente = ingredientes.find(ing => ing.id === id);
            if (!ingrediente) return;

            document.getElementById('nomeIngrediente').value = ingrediente.nome;
            document.getElementById('unidadeIngrediente').value = ingrediente.unidade;
            document.getElementById('precoIngrediente').value = ingrediente.preco;
            document.getElementById('quantidadeIngrediente').value = ingrediente.quantidade;
            document.getElementById('fornecedorIngrediente').value = ingrediente.fornecedor || '';
            document.getElementById('categoriaIngrediente').value = ingrediente.categoria;

            ingredienteEditando = id;
            document.getElementById('btnAdicionarIngrediente').textContent = 'üíæ Salvar Altera√ß√µes';
            document.getElementById('btnCancelarEdicao').style.display = 'inline-flex';
        }

        function cancelarEdicao() {
            ingredienteEditando = null;
            limparFormularioIngrediente();
            document.getElementById('btnAdicionarIngrediente').textContent = '‚ûï Adicionar Ingrediente';
            document.getElementById('btnCancelarEdicao').style.display = 'none';
        }

        function excluirIngrediente(id) {
            if (confirm('Tem certeza que deseja excluir este ingrediente?')) {
                ingredientes = ingredientes.filter(ing => ing.id !== id);
                salvarDados();
                atualizarTabelaIngredientes();
                atualizarEstatisticas();
                atualizarSelectIngredientes();
            }
        }

        function limparFormularioIngrediente() {
            document.getElementById('nomeIngrediente').value = '';
            document.getElementById('precoIngrediente').value = '';
            document.getElementById('quantidadeIngrediente').value = '';
            document.getElementById('fornecedorIngrediente').value = '';
        }

        function atualizarTabelaIngredientes() {
            const tbody = document.querySelector('#tabelaIngredientes tbody');
            
            if (ingredientes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; color: #7f8c8d;">
                            Nenhum ingrediente cadastrado. Adicione ingredientes para come√ßar.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = ingredientes.map(ing => {
                const custoTotal = (ing.preco * ing.quantidade).toFixed(2);
                const historicoCount = ing.historico ? ing.historico.length : 1;
                
                return `
                    <tr>
                        <td>${ing.nome}</td>
                        <td>${ing.unidade}</td>
                        <td>R$ ${ing.preco.toFixed(2)}</td>
                        <td><span class="badge badge-info">${historicoCount} registros</span></td>
                        <td>${ing.quantidade}</td>
                        <td>R$ ${custoTotal}</td>
                        <td>${ing.fornecedor || '-'}</td>
                        <td><span class="badge badge-success">${ing.categoria}</span></td>
                        <td>
                            <button class="btn btn-warning" onclick="editarIngrediente(${ing.id})" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">‚úèÔ∏è</button>
                            <button class="btn btn-danger" onclick="excluirIngrediente(${ing.id})" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function atualizarPrecos() {
            const novoPreco = prompt('Digite o novo pre√ßo para atualiza√ß√£o em massa:');
            if (!novoPreco || isNaN(novoPreco)) return;

            const preco = parseFloat(novoPreco);
            ingredientes.forEach(ing => {
                if (!ing.historico) ing.historico = [];
                ing.historico.push({
                    data: new Date().toISOString().split('T')[0],
                    preco: preco
                });
                ing.preco = preco;
            });

            salvarDados();
            atualizarTabelaIngredientes();
            alert('Pre√ßos atualizados com sucesso!');
        }

        // Gest√£o de Receitas
        function criarReceita() {
            const nome = document.getElementById('nomeReceita').value;
            const tamanho = document.getElementById('tamanhoReceita').value;
            const categoria = document.getElementById('categoriaReceita').value;

            if (!nome) {
                alert('Digite o nome da receita!');
                return;
            }

            receitaEditando = {
                id: Date.now(),
                nome,
                tamanho,
                categoria,
                ingredientes: [],
                custoTotal: 0,
                dataCriacao: new Date().toISOString()
            };

            abrirModalReceita();
            limparFormularioReceita();
        }

        function abrirModalReceita() {
            document.getElementById('modalReceita').style.display = 'block';
            document.getElementById('tituloModalReceita').textContent = 
                `Composi√ß√£o da Receita: ${receitaEditando.nome} (${receitaEditando.tamanho})`;
            atualizarSelectIngredientes();
            atualizarListaIngredientesReceita();
        }

        function fecharModalReceita() {
            document.getElementById('modalReceita').style.display = 'none';
            receitaEditando = null;
        }

        function atualizarSelectIngredientes() {
            const select = document.getElementById('selectIngredienteReceita');
            select.innerHTML = '<option value="">Selecione um ingrediente</option>' +
                ingredientes.map(ing => 
                    `<option value="${ing.id}">${ing.nome} (${ing.unidade}) - R$ ${ing.preco.toFixed(2)}</option>`
                ).join('');

            select.onchange = function() {
                if (this.value) {
                    adicionarIngredienteReceita(parseInt(this.value));
                    this.value = '';
                }
            };
        }

        function adicionarIngredienteReceita(ingredienteId) {
            const ingrediente = ingredientes.find(ing => ing.id === ingredienteId);
            if (!ingrediente) return;

            // Verificar se j√° existe
            const jaExiste = receitaEditando.ingredientes.find(ing => ing.ingredienteId === ingredienteId);
            if (jaExiste) {
                alert('Este ingrediente j√° foi adicionado √† receita!');
                return;
            }

            const quantidade = prompt(`Quantidade de ${ingrediente.nome} (${ingrediente.unidade}):`, ingrediente.quantidade);
            if (!quantidade || isNaN(quantidade)) return;

            receitaEditando.ingredientes.push({
                ingredienteId: ingredienteId,
                nome: ingrediente.nome,
                quantidade: parseFloat(quantidade),
                preco: ingrediente.preco,
                custo: ingrediente.preco * parseFloat(quantidade)
            });

            atualizarListaIngredientesReceita();
        }

        function atualizarListaIngredientesReceita() {
            const container = document.getElementById('ingredientesReceita');
            
            if (receitaEditando.ingredientes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Nenhum ingrediente adicionado</p>';
                document.getElementById('custoTotalReceita').textContent = '0,00';
                return;
            }

            let custoTotal = 0;
            container.innerHTML = receitaEditando.ingredientes.map((ing, index) => {
                custoTotal += ing.custo;
                return `
                    <div class="ingredient-item">
                        <div>
                            <strong>${ing.nome}</strong><br>
                            <small>Qtd: ${ing.quantidade} | Pre√ßo: R$ ${ing.preco.toFixed(2)} | Custo: R$ ${ing.custo.toFixed(2)}</small>
                        </div>
                        <button class="btn btn-danger" onclick="removerIngredienteReceita(${index})" style="padding: 0.25rem 0.5rem;">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');

            receitaEditando.custoTotal = custoTotal;
            document.getElementById('custoTotalReceita').textContent = custoTotal.toFixed(2);
        }

        function removerIngredienteReceita(index) {
            receitaEditando.ingredientes.splice(index, 1);
            atualizarListaIngredientesReceita();
        }

        function salvarReceita() {
            if (receitaEditando.ingredientes.length === 0) {
                alert('Adicione pelo menos um ingrediente √† receita!');
                return;
            }

            receitas.push(receitaEditando);
            salvarDados();
            atualizarListaReceitas();
            atualizarEstatisticas();
            fecharModalReceita();
            alert('Receita salva com sucesso!');
        }

        function limparFormularioReceita() {
            document.getElementById('nomeReceita').value = '';
        }

        function atualizarListaReceitas() {
            const container = document.getElementById('listaReceitas');
            
            if (receitas.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #7f8c8d; padding: 2rem;">
                        Nenhuma receita cadastrada. Crie receitas para come√ßar.
                    </div>
                `;
                return;
            }

            container.innerHTML = receitas.map(receita => `
                <div class="card" style="margin-bottom: 1rem;">
                    <h4>${receita.nome} (${receita.tamanho})</h4>
                    <p><strong>Categoria:</strong> ${receita.categoria}</p>
                    <p><strong>Custo Total:</strong> R$ ${receita.custoTotal.toFixed(2)}</p>
                    <p><strong>Ingredientes:</strong> ${receita.ingredientes.length}</p>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-info" onclick="verDetalhesReceita(${receita.id})">üëÅÔ∏è Ver Detalhes</button>
                        <button class="btn btn-warning" onclick="editarReceita(${receita.id})">‚úèÔ∏è Editar</button>
                        <button class="btn btn-danger" onclick="excluirReceita(${receita.id})">üóëÔ∏è Excluir</button>
                    </div>
                </div>
            `).join('');

            // Atualizar select de receitas na precifica√ß√£o
            atualizarSelectReceitas();
        }

        function verDetalhesReceita(id) {
            const receita = receitas.find(r => r.id === id);
            if (!receita) return;

            let detalhes = `Receita: ${receita.nome} (${receita.tamanho})\n`;
            detalhes += `Categoria: ${receita.categoria}\n\n`;
            detalhes += `Ingredientes:\n`;
            receita.ingredientes.forEach(ing => {
                detalhes += `- ${ing.nome}: ${ing.quantidade} (R$ ${ing.custo.toFixed(2)})\n`;
            });
            detalhes += `\nCusto Total: R$ ${receita.custoTotal.toFixed(2)}`;

            alert(detalhes);
        }

        function editarReceita(id) {
            const receita = receitas.find(r => r.id === id);
            if (!receita) return;

            receitaEditando = { ...receita };
            abrirModalReceita();
        }

        function atualizarSelectReceitas() {
            const select = document.getElementById('receitaPrecificar');
            select.innerHTML = '<option value="">Selecione uma receita</option>' +
                receitas.map(receita => 
                    `<option value="${receita.id}">${receita.nome} (${receita.tamanho}) - R$ ${receita.custoTotal.toFixed(2)}</option>`
                ).join('');
        }

        function excluirReceita(id) {
            if (confirm('Tem certeza que deseja excluir esta receita?')) {
                receitas = receitas.filter(rec => rec.id !== id);
                salvarDados();
                atualizarListaReceitas();
                atualizarEstatisticas();
            }
        }

        function duplicarReceita() {
            if (receitas.length === 0) {
                alert('Nenhuma receita dispon√≠vel para duplicar!');
                return;
            }

            const opcoes = receitas.map((r, i) => `${i + 1}. ${r.nome} (${r.tamanho})`).join('\n');
            const escolha = prompt(`Escolha a receita para duplicar:\n${opcoes}\n\nDigite o n√∫mero:`);
            
            if (!escolha || isNaN(escolha)) return;
            
            const index = parseInt(escolha) - 1;
            if (index < 0 || index >= receitas.length) {
                alert('Op√ß√£o inv√°lida!');
                return;
            }

            const receitaOriginal = receitas[index];
            const novoNome = prompt('Nome da nova receita:', `${receitaOriginal.nome} - C√≥pia`);
            if (!novoNome) return;

            const novaReceita = {
                ...receitaOriginal,
                id: Date.now(),
                nome: novoNome,
                dataCriacao: new Date().toISOString()
            };

            receitas.push(novaReceita);
            salvarDados();
            atualizarListaReceitas();
            atualizarEstatisticas();
            alert('Receita duplicada com sucesso!');
        }

        // Custos Operacionais
        function salvarCustos() {
            custosOperacionais = {
                salarios: parseFloat(document.getElementById('custoSalarios').value) || 0,
                aluguel: parseFloat(document.getElementById('custoAluguel').value) || 0,
                energia: parseFloat(document.getElementById('custoEnergia').value) || 0,
                gas: parseFloat(document.getElementById('custoGas').value) || 0,
                telefone: parseFloat(document.getElementById('custoTelefone').value) || 0,
                marketing: parseFloat(document.getElementById('custoMarketing').value) || 0,
                pizzasVendidasMes: parseInt(document.getElementById('pizzasVendidasMes').value) || 1000,
                impostos: parseFloat(document.getElementById('impostos').value) || 15.5,
                metaLucro: parseFloat(document.getElementById('metaLucro').value) || 15000,
                ticketMedio: parseFloat(document.getElementById('ticketMedio').value) || 35
            };

            salvarDados();
            calcularCustos();
            alert('Custos salvos com sucesso!');
        }

        function calcularCustos() {
            if (!custosOperacionais.pizzasVendidasMes) {
                alert('Configure os par√¢metros de neg√≥cio primeiro!');
                return;
            }

            const custoTotal = custosOperacionais.salarios + custosOperacionais.aluguel + 
                              custosOperacionais.energia + custosOperacionais.gas + 
                              custosOperacionais.telefone + custosOperacionais.marketing;

            const custoPorPizza = custoTotal / custosOperacionais.pizzasVendidasMes;
            const margemNecessaria = ((custosOperacionais.metaLucro / custosOperacionais.pizzasVendidasMes) / custosOperacionais.ticketMedio) * 100;

            document.getElementById('custoOperacionalTotal').textContent = `R$ ${custoTotal.toLocaleString('pt-BR')}`;
            document.getElementById('custoPorPizza').textContent = `R$ ${custoPorPizza.toFixed(2)}`;
            document.getElementById('margemNecessaria').textContent = `${margemNecessaria.toFixed(1)}%`;
        }

        // Precifica√ß√£o
        function calcularPrecos() {
            const receitaId = document.getElementById('receitaPrecificar').value;
            const margem = parseFloat(document.getElementById('margemDesejada').value) || 150;
            const taxaEntrega = parseFloat(document.getElementById('taxaEntrega').value) || 5;
            const custoEmbalagem = parseFloat(document.getElementById('custoEmbalagem').value) || 2.5;

            if (!receitaId) {
                alert('Selecione uma receita!');
                return;
            }

            const receita = receitas.find(r => r.id == receitaId);
            if (!receita) return;

            // Calcular custo base da receita
            let custoBase = receita.custoTotal;

            // Adicionar custo operacional por pizza
            const custoPorPizza = custosOperacionais.pizzasVendidasMes ? 
                (custosOperacionais.salarios + custosOperacionais.aluguel + 
                 custosOperacionais.energia + custosOperacionais.gas + 
                 custosOperacionais.telefone + custosOperacionais.marketing) / 
                 custosOperacionais.pizzasVendidasMes : 0;

            custoBase += custoPorPizza;

            // Calcular pre√ßos por canal
            const canais = [
                { nome: 'Balc√£o', taxa: 0, delivery: false, elemento: 'Balcao' },
                { nome: 'Delivery Direto', taxa: 0, delivery: true, elemento: 'Delivery' },
                { nome: 'iFood', taxa: 27, delivery: true, elemento: 'Ifood' },
                { nome: '99Food', taxa: 12, delivery: true, elemento: '99Food' },
                { nome: 'Rappi', taxa: 14, delivery: true, elemento: 'Rappi' },
                { nome: 'Uber Eats', taxa: 15, delivery: true, elemento: 'Uber' }
            ];

            const resultados = canais.map(canal => {
                let custoTotal = custoBase + custoEmbalagem;
                if (canal.delivery) custoTotal += taxaEntrega;

                const precoFinal = custoTotal * (1 + margem/100) / (1 - canal.taxa/100);
                const lucroLiquido = precoFinal - custoTotal;
                const margemReal = (lucroLiquido / precoFinal) * 100;

                // Atualizar interface
                document.getElementById(`preco${canal.elemento}`).textContent = `R$ ${precoFinal.toFixed(2)}`;
                document.getElementById(`margem${canal.elemento}`).textContent = `Margem Real: ${margemReal.toFixed(1)}%`;

                return {
                    canal: canal.nome,
                    custoTotal,
                    taxa: canal.taxa,
                    margem,
                    precoFinal,
                    lucroLiquido,
                    margemReal
                };
            });

            // Atualizar tabela de compara√ß√£o
            atualizarTabelaComparacao(resultados);
        }

        function atualizarTabelaComparacao(resultados) {
            const tbody = document.querySelector('#tabelaComparacao tbody');
            
            // Ordenar por margem real (melhor primeiro)
            resultados.sort((a, b) => b.margemReal - a.margemReal);

            tbody.innerHTML = resultados.map((resultado, index) => {
                const ranking = index + 1;
                const badgeClass = ranking === 1 ? 'badge-success' : ranking === 2 ? 'badge-info' : 'badge-warning';
                
                return `
                    <tr>
                        <td>${resultado.canal}</td>
                        <td>R$ ${resultado.custoTotal.toFixed(2)}</td>
                        <td>${resultado.taxa}%</td>
                        <td>${resultado.margem}%</td>
                        <td>R$ ${resultado.precoFinal.toFixed(2)}</td>
                        <td>R$ ${resultado.lucroLiquido.toFixed(2)}</td>
                        <td>${resultado.margemReal.toFixed(1)}%</td>
                        <td><span class="badge ${badgeClass}">${ranking}¬∫</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Simulador
        function simularCenario() {
            const vendas = parseInt(document.getElementById('vendasMensais').value) || 1000;
            const ticket = parseFloat(document.getElementById('ticketMedioSim').value) || 35;
            const custo = parseFloat(document.getElementById('custoMedioPizza').value) || 15;
            const fixos = parseFloat(document.getElementById('custosFixosSim').value) || 10000;

            const receita = vendas * ticket;
            const custoTotal = (vendas * custo) + fixos;
            const lucro = receita - custoTotal;
            const margem = (lucro / receita) * 100;
            const pontoEquilibrio = Math.ceil(fixos / (ticket - custo));

            document.getElementById('receitaMensal').textContent = `R$ ${receita.toLocaleString('pt-BR')}`;
            document.getElementById('lucroLiquido').textContent = `R$ ${lucro.toLocaleString('pt-BR')}`;
            document.getElementById('margemLucro').textContent = `${margem.toFixed(1)}%`;
            document.getElementById('pontoEquilibrio').textContent = pontoEquilibrio;

            // Atualizar tabela de sensibilidade com dados reais
            atualizarTabelaSensibilidade(vendas, ticket, custo, fixos);
        }

        function atualizarTabelaSensibilidade(vendasBase, ticketBase, custoBase, fixosBase) {
            const cenarios = [
                { nome: 'Conservador', vendas: Math.round(vendasBase * 0.8), ticket: ticketBase * 0.85 },
                { nome: 'Realista', vendas: vendasBase, ticket: ticketBase },
                { nome: 'Otimista', vendas: Math.round(vendasBase * 1.2), ticket: ticketBase * 1.15 }
            ];

            const tbody = document.querySelector('#tabelaSensibilidade tbody');
            tbody.innerHTML = cenarios.map(cenario => {
                const receita = cenario.vendas * cenario.ticket;
                const custoTotal = (cenario.vendas * custoBase) + fixosBase;
                const lucro = receita - custoTotal;
                const margem = (lucro / receita) * 100;
                const viavel = margem > 20;

                return `
                    <tr>
                        <td>${cenario.nome}</td>
                        <td>${cenario.vendas}</td>
                        <td>R$ ${cenario.ticket.toFixed(2)}</td>
                        <td>R$ ${receita.toLocaleString('pt-BR')}</td>
                        <td>R$ ${lucro.toLocaleString('pt-BR')}</td>
                        <td>${margem.toFixed(1)}%</td>
                        <td><span class="badge ${viavel ? 'badge-success' : 'badge-warning'}">${viavel ? 'Vi√°vel' : 'Aten√ß√£o'}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function gerarRelatorioSimulacao() {
            const vendas = parseInt(document.getElementById('vendasMensais').value) || 1000;
            const ticket = parseFloat(document.getElementById('ticketMedioSim').value) || 35;
            const custo = parseFloat(document.getElementById('custoMedioPizza').value) || 15;
            const fixos = parseFloat(document.getElementById('custosFixosSim').value) || 10000;

            const receita = vendas * ticket;
            const custoTotal = (vendas * custo) + fixos;
            const lucro = receita - custoTotal;
            const margem = (lucro / receita) * 100;

            let relatorio = `RELAT√ìRIO DE SIMULA√á√ÉO DE CEN√ÅRIOS\n`;
            relatorio += `Data: ${new Date().toLocaleDateString('pt-BR')}\n\n`;
            relatorio += `PAR√ÇMETROS:\n`;
            relatorio += `- Vendas mensais: ${vendas} pizzas\n`;
            relatorio += `- Ticket m√©dio: R$ ${ticket.toFixed(2)}\n`;
            relatorio += `- Custo m√©dio/pizza: R$ ${custo.toFixed(2)}\n`;
            relatorio += `- Custos fixos: R$ ${fixos.toLocaleString('pt-BR')}\n\n`;
            relatorio += `RESULTADOS:\n`;
            relatorio += `- Receita mensal: R$ ${receita.toLocaleString('pt-BR')}\n`;
            relatorio += `- Lucro l√≠quido: R$ ${lucro.toLocaleString('pt-BR')}\n`;
            relatorio += `- Margem de lucro: ${margem.toFixed(1)}%\n`;
            relatorio += `- Ponto de equil√≠brio: ${Math.ceil(fixos / (ticket - custo))} pizzas\n`;

            alert(relatorio);
        }

        // An√°lises
        function gerarRelatorioRentabilidade() {
            if (receitas.length === 0) {
                alert('Cadastre receitas primeiro para gerar an√°lises!');
                return;
            }

            let relatorio = `AN√ÅLISE DE RENTABILIDADE\n`;
            relatorio += `Data: ${new Date().toLocaleDateString('pt-BR')}\n\n`;
            
            relatorio += `RECEITAS CADASTRADAS:\n`;
            receitas.forEach(receita => {
                relatorio += `- ${receita.nome} (${receita.tamanho}): R$ ${receita.custoTotal.toFixed(2)}\n`;
            });

            relatorio += `\nINGREDIENTES MAIS CAROS:\n`;
            const ingredientesOrdenados = [...ingredientes].sort((a, b) => (b.preco * b.quantidade) - (a.preco * a.quantidade));
            ingredientesOrdenados.slice(0, 5).forEach(ing => {
                relatorio += `- ${ing.nome}: R$ ${(ing.preco * ing.quantidade).toFixed(2)} por pizza\n`;
            });

            alert(relatorio);
        }

        function verHistoricoPrecos() {
            if (ingredientes.length === 0) {
                alert('Cadastre ingredientes primeiro!');
                return;
            }

            let historico = `HIST√ìRICO DE PRE√áOS\n`;
            historico += `Data: ${new Date().toLocaleDateString('pt-BR')}\n\n`;

            ingredientes.forEach(ing => {
                if (ing.historico && ing.historico.length > 1) {
                    historico += `${ing.nome}:\n`;
                    ing.historico.forEach(h => {
                        historico += `  ${h.data}: R$ ${h.preco.toFixed(2)}\n`;
                    });
                    historico += '\n';
                }
            });

            if (historico.split('\n').length <= 4) {
                historico += 'Nenhuma varia√ß√£o de pre√ßo registrada ainda.';
            }

            alert(historico);
        }

        function analisarMargem() {
            if (receitas.length === 0) {
                alert('Cadastre receitas primeiro!');
                return;
            }

            let analise = `AN√ÅLISE DE MARGEM POR CANAL\n`;
            analise += `Data: ${new Date().toLocaleDateString('pt-BR')}\n\n`;

            const canais = ['Balc√£o', 'Delivery Direto', 'iFood', '99Food', 'Rappi', 'Uber Eats'];
            const taxas = [0, 0, 27, 12, 14, 15];

            analise += `RECOMENDA√á√ïES:\n`;
            analise += `- Balc√£o e Delivery Direto: Sem taxas, maior margem\n`;
            analise += `- 99Food: Taxa baixa (12%), boa op√ß√£o\n`;
            analise += `- Rappi: Taxa m√©dia (14%), aceit√°vel\n`;
            analise += `- Uber Eats: Taxa m√©dia (15%), aceit√°vel\n`;
            analise += `- iFood: Taxa alta (27%), ajustar pre√ßos\n`;

            alert(analise);
        }

        function exportarPDF() {
            alert('Funcionalidade de exporta√ß√£o PDF ser√° implementada em breve!');
        }

        function exportarTabelaPrecificacao() {
            const receitaId = document.getElementById('receitaPrecificar').value;
            if (!receitaId) {
                alert('Calcule os pre√ßos primeiro!');
                return;
            }

            const receita = receitas.find(r => r.id == receitaId);
            const dados = [
                ['Canal', 'Taxa (%)', 'Pre√ßo Final', 'Margem Real (%)'],
                ['Balc√£o', '0', document.getElementById('precoBalcao').textContent, document.getElementById('margemBalcao').textContent.replace('Margem Real: ', '').replace('%', '')],
                ['Delivery Direto', '0', document.getElementById('precoDelivery').textContent, document.getElementById('margemDelivery').textContent.replace('Margem Real: ', '').replace('%', '')],
                ['iFood', '27', document.getElementById('precoIfood').textContent, document.getElementById('margemIfood').textContent.replace('Margem Real: ', '').replace('%', '')],
                ['99Food', '12', document.getElementById('preco99Food').textContent, document.getElementById('margem99Food').textContent.replace('Margem Real: ', '').replace('%', '')],
                ['Rappi', '14', document.getElementById('precoRappi').textContent, document.getElementById('margemRappi').textContent.replace('Margem Real: ', '').replace('%', '')],
                ['Uber Eats', '15', document.getElementById('precoUber').textContent, document.getElementById('margemUber').textContent.replace('Margem Real: ', '').replace('%', '')]
            ];

            const ws = XLSX.utils.aoa_to_sheet(dados);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Precifica√ß√£o");
            XLSX.writeFile(wb, `precificacao_${receita.nome}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Import/Export
        function exportarExcel() {
            const dados = prepararDadosExport();
            
            const wb = XLSX.utils.book_new();
            
            // Aba Ingredientes
            if (document.getElementById('exportIngredientes').checked) {
                const wsIngredientes = XLSX.utils.json_to_sheet(dados.ingredientes);
                XLSX.utils.book_append_sheet(wb, wsIngredientes, "Ingredientes");
            }
            
            // Aba Receitas
            if (document.getElementById('exportReceitas').checked) {
                const wsReceitas = XLSX.utils.json_to_sheet(dados.receitas);
                XLSX.utils.book_append_sheet(wb, wsReceitas, "Receitas");
            }
            
            // Aba Custos
            if (document.getElementById('exportCustos').checked) {
                const wsCustos = XLSX.utils.json_to_sheet([dados.custosOperacionais]);
                XLSX.utils.book_append_sheet(wb, wsCustos, "Custos");
            }
            
            const nomeArquivo = `aps_backup_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, nomeArquivo);
            
            registrarBackup('Excel', nomeArquivo);
            mostrarStatus('statusExport', 'Dados exportados com sucesso!', 'success');
        }

        function exportarCSV() {
            const dados = prepararDadosExport();
            
            let csv = '';
            
            if (document.getElementById('exportIngredientes').checked) {
                csv += 'INGREDIENTES\n';
                csv += 'Nome,Unidade,Pre√ßo,Quantidade,Fornecedor,Categoria\n';
                dados.ingredientes.forEach(ing => {
                    csv += `${ing.nome},${ing.unidade},${ing.preco},${ing.quantidade},${ing.fornecedor || ''},${ing.categoria}\n`;
                });
                csv += '\n';
            }
            
            if (document.getElementById('exportReceitas').checked) {
                csv += 'RECEITAS\n';
                csv += 'Nome,Tamanho,Categoria,Custo Total\n';
                dados.receitas.forEach(rec => {
                    csv += `${rec.nome},${rec.tamanho},${rec.categoria},${rec.custoTotal}\n`;
                });
            }
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const nomeArquivo = `aps_backup_${new Date().toISOString().split('T')[0]}.csv`;
            
            link.href = URL.createObjectURL(blob);
            link.download = nomeArquivo;
            link.click();
            
            registrarBackup('CSV', nomeArquivo);
            mostrarStatus('statusExport', 'Dados exportados em CSV!', 'success');
        }

        function exportarJSON() {
            const dados = prepararDadosExport();
            
            const backup = {
                versao: '3.0',
                dataExport: new Date().toISOString(),
                dados: dados
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            const nomeArquivo = `aps_backup_${new Date().toISOString().split('T')[0]}.json`;
            
            link.href = URL.createObjectURL(blob);
            link.download = nomeArquivo;
            link.click();
            
            registrarBackup('JSON', nomeArquivo);
            mostrarStatus('statusExport', 'Backup completo exportado!', 'success');
        }

        function prepararDadosExport() {
            const dados = {};
            
            if (document.getElementById('exportIngredientes').checked) {
                dados.ingredientes = ingredientes;
            }
            
            if (document.getElementById('exportReceitas').checked) {
                dados.receitas = receitas;
            }
            
            if (document.getElementById('exportCustos').checked) {
                dados.custosOperacionais = custosOperacionais;
            }
            
            if (document.getElementById('exportConfiguracoes').checked) {
                dados.configuracoes = configuracoes;
            }
            
            return dados;
        }

        function processarArquivo(input) {
            const arquivo = input.files[0];
            if (!arquivo) return;
            
            const reader = new FileReader();
            const extensao = arquivo.name.split('.').pop().toLowerCase();
            
            reader.onload = function(e) {
                try {
                    let dados;
                    
                    if (extensao === 'json') {
                        dados = JSON.parse(e.target.result);
                        if (dados.dados) dados = dados.dados; // Extrair dados se estiver em formato de backup
                    } else if (extensao === 'xlsx') {
                        const workbook = XLSX.read(e.target.result, { type: 'binary' });
                        dados = processarExcel(workbook);
                    } else if (extensao === 'csv') {
                        dados = processarCSV(e.target.result);
                    }
                    
                    mostrarPreview(dados);
                    document.getElementById('btnImportar').disabled = false;
                    
                } catch (error) {
                    mostrarStatus('statusImport', 'Erro ao processar arquivo: ' + error.message, 'error');
                }
            };
            
            if (extensao === 'xlsx') {
                reader.readAsBinaryString(arquivo);
            } else {
                reader.readAsText(arquivo);
            }
        }

        function processarExcel(workbook) {
            const dados = {};
            
            if (workbook.SheetNames.includes('Ingredientes')) {
                const ws = workbook.Sheets['Ingredientes'];
                dados.ingredientes = XLSX.utils.sheet_to_json(ws);
            }
            
            if (workbook.SheetNames.includes('Receitas')) {
                const ws = workbook.Sheets['Receitas'];
                dados.receitas = XLSX.utils.sheet_to_json(ws);
            }
            
            if (workbook.SheetNames.includes('Custos')) {
                const ws = workbook.Sheets['Custos'];
                const custos = XLSX.utils.sheet_to_json(ws);
                if (custos.length > 0) dados.custosOperacionais = custos[0];
            }
            
            return dados;
        }

        function processarCSV(texto) {
            // Implementa√ß√£o b√°sica para CSV
            const dados = { ingredientes: [] };
            const linhas = texto.split('\n');
            
            let secaoAtual = '';
            for (let linha of linhas) {
                if (linha.includes('INGREDIENTES')) {
                    secaoAtual = 'ingredientes';
                    continue;
                }
                
                if (secaoAtual === 'ingredientes' && linha.includes(',')) {
                    const campos = linha.split(',');
                    if (campos.length >= 6) {
                        dados.ingredientes.push({
                            nome: campos[0],
                            unidade: campos[1],
                            preco: parseFloat(campos[2]) || 0,
                            quantidade: parseFloat(campos[3]) || 0,
                            fornecedor: campos[4],
                            categoria: campos[5]
                        });
                    }
                }
            }
            
            return dados;
        }

        function mostrarPreview(dados) {
            const preview = document.getElementById('previewImport');
            const container = document.getElementById('dadosPreview');
            
            let html = '';
            
            if (dados.ingredientes) {
                html += `<p><strong>Ingredientes:</strong> ${dados.ingredientes.length} itens</p>`;
            }
            
            if (dados.receitas) {
                html += `<p><strong>Receitas:</strong> ${dados.receitas.length} itens</p>`;
            }
            
            if (dados.custosOperacionais) {
                html += `<p><strong>Custos Operacionais:</strong> Configurado</p>`;
            }
            
            container.innerHTML = html;
            preview.style.display = 'block';
            
            // Armazenar dados para importa√ß√£o
            window.dadosParaImportar = dados;
        }

        function importarDados() {
            if (!window.dadosParaImportar) {
                alert('Nenhum dado para importar!');
                return;
            }
            
            if (!confirm('Isso substituir√° todos os dados atuais. Deseja continuar?')) {
                return;
            }
            
            const dados = window.dadosParaImportar;
            
            if (dados.ingredientes) {
                // Garantir que cada ingrediente tenha um ID √∫nico
                dados.ingredientes.forEach(ing => {
                    if (!ing.id) ing.id = Date.now() + Math.random();
                    if (!ing.historico) ing.historico = [{ data: new Date().toISOString().split('T')[0], preco: ing.preco }];
                });
                ingredientes = dados.ingredientes;
            }
            
            if (dados.receitas) {
                // Garantir que cada receita tenha um ID √∫nico
                dados.receitas.forEach(rec => {
                    if (!rec.id) rec.id = Date.now() + Math.random();
                    if (!rec.ingredientes) rec.ingredientes = [];
                });
                receitas = dados.receitas;
            }
            
            if (dados.custosOperacionais) {
                custosOperacionais = dados.custosOperacionais;
            }
            
            if (dados.configuracoes) {
                configuracoes = dados.configuracoes;
            }
            
            salvarDados();
            carregarDados();
            atualizarEstatisticas();
            
            mostrarStatus('statusImport', 'Dados importados com sucesso!', 'success');
            
            // Limpar preview
            document.getElementById('previewImport').style.display = 'none';
            document.getElementById('btnImportar').disabled = true;
            document.getElementById('arquivoImport').value = '';
        }

        function registrarBackup(tipo, arquivo) {
            const backup = {
                data: new Date().toISOString(),
                tipo: tipo,
                arquivo: arquivo,
                ingredientes: ingredientes.length,
                receitas: receitas.length,
                tamanho: '~' + Math.round(JSON.stringify({ingredientes, receitas, custosOperacionais}).length / 1024) + 'KB'
            };
            
            historicoBackups.unshift(backup);
            if (historicoBackups.length > 10) {
                historicoBackups = historicoBackups.slice(0, 10);
            }
            
            localStorage.setItem('historicoBackups', JSON.stringify(historicoBackups));
            atualizarHistoricoBackups();
        }

        function atualizarHistoricoBackups() {
            const tbody = document.getElementById('historicoBackups');
            
            if (historicoBackups.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #7f8c8d;">
                            Nenhum backup encontrado. Fa√ßa seu primeiro backup.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = historicoBackups.map(backup => `
                <tr>
                    <td>${new Date(backup.data).toLocaleString('pt-BR')}</td>
                    <td><span class="badge badge-info">${backup.tipo}</span></td>
                    <td>${backup.tamanho}</td>
                    <td>${backup.ingredientes}</td>
                    <td>${backup.receitas}</td>
                    <td>
                        <button class="btn btn-danger" onclick="removerBackup('${backup.data}')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function removerBackup(data) {
            if (confirm('Remover este backup?')) {
                historicoBackups = historicoBackups.filter(b => b.data !== data);
                localStorage.setItem('historicoBackups', JSON.stringify(historicoBackups));
                atualizarHistoricoBackups();
            }
        }

        function mostrarStatus(elementId, mensagem, tipo) {
            const elemento = document.getElementById(elementId);
            const classe = tipo === 'success' ? 'alert-success' : tipo === 'error' ? 'alert-danger' : 'alert-info';
            
            elemento.innerHTML = `<div class="alert ${classe}">${mensagem}</div>`;
            
            setTimeout(() => {
                elemento.innerHTML = '';
            }, 5000);
        }

        // Fun√ß√µes auxiliares
        function salvarDados() {
            localStorage.setItem('ingredientes', JSON.stringify(ingredientes));
            localStorage.setItem('receitas', JSON.stringify(receitas));
            localStorage.setItem('custosOperacionais', JSON.stringify(custosOperacionais));
            localStorage.setItem('configuracoes', JSON.stringify(configuracoes));
        }

        function carregarDados() {
            atualizarTabelaIngredientes();
            atualizarListaReceitas();
            atualizarHistoricoBackups();
            
            // Carregar custos nos campos
            if (custosOperacionais.salarios) {
                document.getElementById('custoSalarios').value = custosOperacionais.salarios;
                document.getElementById('custoAluguel').value = custosOperacionais.aluguel;
                document.getElementById('custoEnergia').value = custosOperacionais.energia;
                document.getElementById('custoGas').value = custosOperacionais.gas;
                document.getElementById('custoTelefone').value = custosOperacionais.telefone;
                document.getElementById('custoMarketing').value = custosOperacionais.marketing;
                document.getElementById('pizzasVendidasMes').value = custosOperacionais.pizzasVendidasMes;
                document.getElementById('impostos').value = custosOperacionais.impostos;
                document.getElementById('metaLucro').value = custosOperacionais.metaLucro;
                document.getElementById('ticketMedio').value = custosOperacionais.ticketMedio;
                
                // Calcular automaticamente se h√° dados
                calcularCustos();
            }

            // Atualizar campos do simulador com dados dos custos
            if (custosOperacionais.pizzasVendidasMes) {
                document.getElementById('vendasMensais').value = custosOperacionais.pizzasVendidasMes;
                document.getElementById('ticketMedioSim').value = custosOperacionais.ticketMedio || 35;
                
                // Calcular custo m√©dio baseado nas receitas
                if (receitas.length > 0) {
                    const custoMedio = receitas.reduce((sum, rec) => sum + rec.custoTotal, 0) / receitas.length;
                    document.getElementById('custoMedioPizza').value = custoMedio.toFixed(2);
                }
                
                const custosFixos = custosOperacionais.salarios + custosOperacionais.aluguel + 
                                   custosOperacionais.energia + custosOperacionais.gas + 
                                   custosOperacionais.telefone + custosOperacionais.marketing;
                document.getElementById('custosFixosSim').value = custosFixos;
            }

            // Atualizar an√°lises com dados reais
            atualizarTabelaAnalises();
        }

        function atualizarTabelaAnalises() {
            if (receitas.length === 0 || ingredientes.length === 0) return;

            const tbody = document.querySelector('#tabelaAnalises tbody');
            const hoje = new Date();
            const mesAtual = hoje.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            
            // Calcular estat√≠sticas reais
            const custoMedio = receitas.reduce((sum, rec) => sum + rec.custoTotal, 0) / receitas.length;
            const margemMedia = 145; // Margem padr√£o
            
            // Determinar canal mais rent√°vel (menor taxa)
            const canais = [
                { nome: 'Balc√£o', taxa: 0 },
                { nome: 'Delivery Direto', taxa: 0 },
                { nome: '99Food', taxa: 12 },
                { nome: 'Rappi', taxa: 14 },
                { nome: 'Uber Eats', taxa: 15 },
                { nome: 'iFood', taxa: 27 }
            ];
            const melhorCanal = canais.sort((a, b) => a.taxa - b.taxa)[0].nome;

            // Calcular varia√ß√£o de pre√ßos
            let variacaoPrecos = 0;
            if (ingredientes.length > 0) {
                const ingredientesComHistorico = ingredientes.filter(ing => ing.historico && ing.historico.length > 1);
                if (ingredientesComHistorico.length > 0) {
                    const variacoes = ingredientesComHistorico.map(ing => {
                        const primeiro = ing.historico[0].preco;
                        const ultimo = ing.historico[ing.historico.length - 1].preco;
                        return ((ultimo - primeiro) / primeiro) * 100;
                    });
                    variacaoPrecos = variacoes.reduce((sum, v) => sum + v, 0) / variacoes.length;
                }
            }

            tbody.innerHTML = `
                <tr>
                    <td>${mesAtual}</td>
                    <td>${receitas.length}</td>
                    <td>R$ ${custoMedio.toFixed(2)}</td>
                    <td>${margemMedia}%</td>
                    <td>${melhorCanal}</td>
                    <td>${variacaoPrecos > 0 ? '+' : ''}${variacaoPrecos.toFixed(1)}%</td>
                    <td><span class="badge ${variacaoPrecos < 5 ? 'badge-success' : variacaoPrecos < 10 ? 'badge-warning' : 'badge-danger'}">${variacaoPrecos < 5 ? '√ìtimo' : variacaoPrecos < 10 ? 'Bom' : 'Aten√ß√£o'}</span></td>
                </tr>
            `;
        }

        function atualizarEstatisticas() {
            document.getElementById('totalIngredientes').textContent = ingredientes.length;
            document.getElementById('totalReceitas').textContent = receitas.length;
            
            // Calcular custo m√©dio
            const custoMedio = receitas.length > 0 ? 
                receitas.reduce((sum, rec) => sum + rec.custoTotal, 0) / receitas.length : 
                ingredientes.length > 0 ? 
                ingredientes.reduce((sum, ing) => sum + (ing.preco * ing.quantidade), 0) / ingredientes.length : 0;
            document.getElementById('custoMedio').textContent = `R$ ${custoMedio.toFixed(2)}`;
            
            verificarAlertas();
        }

        function verificarAlertas() {
            let alertas = 0;
            
            if (ingredientes.length === 0) alertas++;
            if (receitas.length === 0) alertas++;
            if (!custosOperacionais.salarios) alertas++;
            
            document.getElementById('totalAlertas').textContent = alertas;
            
            const alertaDiv = document.getElementById('alertaConfiguracao');
            if (alertas === 0) {
                alertaDiv.className = 'alert alert-success';
                alertaDiv.innerHTML = '<strong>‚úÖ Sistema Configurado</strong><br>Todos os m√≥dulos est√£o configurados e prontos para uso.';
            } else {
                alertaDiv.className = 'alert alert-warning';
                let mensagem = '<strong>‚ö†Ô∏è Sistema Pronto para Configura√ß√£o</strong><br>';
                if (ingredientes.length === 0) mensagem += 'Cadastre ingredientes. ';
                if (receitas.length === 0) mensagem += 'Crie receitas. ';
                if (!custosOperacionais.salarios) mensagem += 'Configure custos operacionais. ';
                alertaDiv.innerHTML = mensagem;
            }
        }

        // Fun√ß√µes auxiliares para backup
        function backupAutomatico() {
            exportarJSON();
            alert('Backup autom√°tico realizado!');
        }

        function limparBackups() {
            if (confirm('Tem certeza que deseja limpar o hist√≥rico de backups?')) {
                historicoBackups = [];
                localStorage.removeItem('historicoBackups');
                atualizarHistoricoBackups();
            }
        }

        function backupAntes() {
            exportarJSON();
            alert('Backup de seguran√ßa criado antes da importa√ß√£o!');
        }

        // Inicializar simulador automaticamente se h√° dados
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (custosOperacionais.pizzasVendidasMes && receitas.length > 0) {
                    simularCenario();
                }
            }, 1000);
        });
    </script>
</body>
</html>
