<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Precifica√ß√£o de Pizzas - Pro Estoque</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* SIDEBAR LATERAL */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h1 {
            font-size: 1.4em;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-group {
            margin-bottom: 30px;
        }

        .menu-group-title {
            padding: 10px 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #bdc3c7;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 10px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #ecf0f1;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.1);
            padding-left: 30px;
        }

        .menu-item.active {
            background: linear-gradient(45deg, #3498db, #2980b9);
            border-right: 4px solid #fff;
            font-weight: 600;
        }

        .menu-item-icon {
            margin-right: 12px;
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        /* CONTE√öDO PRINCIPAL */
        .main-content {
            flex: 1;
            margin-left: 280px;
            background: white;
            min-height: 100vh;
        }

        .content-header {
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .content-header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .content-header p {
            opacity: 0.9;
            font-size: 0.95em;
        }

        .content-body {
            padding: 30px;
        }

        /* RESPONSIVIDADE MOBILE */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-menu-toggle {
                display: block;
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 1001;
                background: #2c3e50;
                color: white;
                border: none;
                padding: 10px;
                border-radius: 5px;
                cursor: pointer;
            }
        }

        .mobile-menu-toggle {
            display: none;
        }

        /* OVERLAY MOBILE */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        @media (max-width: 768px) {
            .sidebar-overlay.active {
                display: block;
            }
        }

        /* MANTER ESTILOS EXISTENTES DAS ABAS (OCULTOS) */
        .tabs {
            display: none;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
        }

        .tab.active {
            background: #007bff;
            color: white;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 4px;
            background: #0056b3;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active:hover {
            background: #0056b3;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .help-section {
            background: #e7f3ff;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .help-section h4 {
            color: #004085;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-section p {
            color: #004085;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .help-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 12px;
            cursor: help;
            margin-left: 5px;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.3;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            position: relative;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-card h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .kpi-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .kpi-card .change {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .kpi-card.vendas {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .kpi-card.lucro {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .kpi-card.custo {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .kpi-card.margem {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        }

        .kpi-card.ticket {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .kpi-card.estoque {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .kpi-card.alerta {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .vendas-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .vendas-form {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .produtos-extras-section {
            background: #e7f3ff;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .periodo-filter {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .meta-progress {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .auto-fill {
            background: #e7f3ff !important;
            border-color: #007bff !important;
        }

        .preco-historico {
            display: flex;
            gap: 10px;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .preco-min {
            color: #28a745;
            font-weight: bold;
        }

        .preco-max {
            color: #dc3545;
            font-weight: bold;
        }

        .preco-media {
            color: #007bff;
            font-weight: bold;
        }

        .tendencia {
            display: inline-block;
            margin-left: 10px;
            font-size: 1.2em;
        }

        .tendencia.up {
            color: #dc3545;
        }

        .tendencia.down {
            color: #28a745;
        }

        .tendencia.stable {
            color: #6c757d;
        }

        .btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-vendas {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .btn-vendas:hover {
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-estoque {
            background: linear-gradient(45deg, #17a2b8, #138496);
        }

        .btn-estoque:hover {
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.3);
        }

        .btn-edit {
            background: linear-gradient(45deg, #ffc107, #e0a800);
        }

        .btn-edit:hover {
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }

        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-export {
            background: linear-gradient(45deg, #007bff, #0056b3);
            font-size: 18px;
            padding: 15px 30px;
        }

        .btn-export:hover {
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #5a6268);
        }

        .btn-secondary:hover {
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-calculator {
            background: linear-gradient(45deg, #17a2b8, #138496);
        }

        .btn-calculator:hover {
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.3);
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .editing {
            background: #fff3cd !important;
        }

        .high-cost {
            background: #f8d7da !important;
        }

        .low-margin {
            background: #f8d7da !important;
        }

        .high-margin {
            background: #d4edda !important;
        }

        .stock-low {
            background: #fff3cd !important;
        }

        .stock-critical {
            background: #f8d7da !important;
        }

        .price-up {
            background: #f8d7da !important;
        }

        .price-down {
            background: #d4edda !important;
        }

        .custo-calculado {
            font-weight: bold;
            color: #28a745;
            background: #f8fff9;
            padding: 2px 5px;
            border-radius: 3px;
        }

        .alert {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            background: #e7f3ff;
            color: #004085;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-success {
            border-left-color: #28a745;
            background: #d4edda;
            color: #155724;
        }

        .alert-warning {
            border-left-color: #ffc107;
            background: #fff3cd;
            color: #856404;
        }

        .alert-danger {
            border-left-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .export-section {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 12px;
            margin: 20px 0;
        }

        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            background: #f8f9ff;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: #e7f3ff;
            border-color: #0056b3;
        }

        .upload-area.dragover {
            background: #cce7ff;
            border-color: #0056b3;
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        .calculator-modal, .confirmation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .calculator-content, .confirmation-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .confirmation-content {
            max-width: 600px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .scenario-simulator {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .scenario-result {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .filters-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-item {
            flex: 1;
            min-width: 150px;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .cardapio-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .tamanho-group {
            margin-bottom: 30px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tamanho-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 15px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .pizza-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .pizza-name {
            font-weight: 600;
            color: #333;
        }

        .pizza-ingredients {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .pizza-prices {
            text-align: right;
        }

        .price-direto {
            color: #28a745;
            font-weight: bold;
        }

        .price-ifood {
            color: #007bff;
            font-weight: bold;
        }

        .faixas-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .faixa-item {
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .faixa-alta {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .faixa-media {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: white;
        }

        .faixa-baixa {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .suggestions {
            background: #e7f3ff;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .suggestion-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
        }

        .suggestion-icon.warning {
            background: #fff3cd;
            color: #856404;
        }

        .suggestion-icon.success {
            background: #d4edda;
            color: #155724;
        }

        .suggestion-icon.info {
            background: #e7f3ff;
            color: #004085;
        }

        .estoque-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .entrada-estoque {
            background: #e7f3ff;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .import-status {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #155724;
        }

        .import-detail {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            font-family: monospace;
            font-size: 0.9em;
        }

        .impact-preview {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .impact-item {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .impact-item:last-child {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .pizza-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .pizza-prices {
                text-align: left;
                margin-top: 10px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .filters-container {
                flex-direction: column;
            }

            .faixas-analysis {
                grid-template-columns: 1fr;
            }

            .tooltip .tooltiptext {
                width: 200px;
                margin-left: -100px;
            }

            .periodo-filter {
                flex-direction: column;
                align-items: stretch;
            }
        }
        /* Estilos para alertas inteligentes */
        .alert-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }

        .alert-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .alert:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .alert h4 {
            margin: 0 0 8px 0;
            font-size: 1.1em;
            font-weight: 600;
        }

        .alert p {
            margin: 0 0 8px 0;
            color: #666;
            line-height: 1.4;
        }

        .alert small {
            color: #888;
            font-style: italic;
        }

        .alert-success {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }

        .alert-success h4 {
            color: #155724;
        }

        .alert-warning {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }

        .alert-warning h4 {
            color: #856404;
        }

        .alert-danger {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        }

        .alert-danger h4 {
            color: #721c24;
        }

        .alert-info {
            border-left-color: #17a2b8;
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        }

        .alert-info h4 {
            color: #0c5460;
        }

        /* Melhorias nos toasts */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            min-width: 300px;
            max-width: 400px;
        }

        /* Anima√ß√µes para alertas */
        @keyframes slideInAlert {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert {
            animation: slideInAlert 0.3s ease-out;
        }

        /* Responsividade para alertas */
        @media (max-width: 768px) {
            .alert-section {
                margin: 10px;
                padding: 15px;
            }
            
            .alert {
                padding: 12px;
                margin: 8px 0;
            }
            
            .alert h4 {
                font-size: 1em;
            }
            
            .toast {
                right: 10px;
                left: 10px;
                min-width: auto;
                max-width: none;
            }
        }

        /* Indicadores visuais melhorados */
        .kpi-card.alert-status {
            position: relative;
            overflow: hidden;
        }

        .kpi-card.alert-status::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3);
            animation: alertPulse 2s ease-in-out infinite;
        }

        @keyframes alertPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Bot√£o toggle mobile -->
    <button class="mobile-menu-toggle" onclick="toggleMobileSidebar()">‚ò∞</button>
    
    <!-- Overlay mobile -->
    <div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>
    
    <div class="app-container">
        <!-- SIDEBAR LATERAL -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>üçï Pizza Pro</h1>
                <p>Sistema de Gest√£o Completo</p>
            </div>
            
            <div class="sidebar-menu">
                <!-- DASHBOARD -->
                <div class="menu-group">
                    <div class="menu-group-title">üìä Vis√£o Geral</div>
                    <button class="menu-item active" onclick="showTab('dashboard')" data-tab="dashboard">
                        <span class="menu-item-icon">üìä</span>
                        Dashboard
                    </button>
                </div>
                
                <!-- GEST√ÉO DE PRODUTOS -->
                <div class="menu-group">
                    <div class="menu-group-title">üçï Gest√£o de Produtos</div>
                    <button class="menu-item" onclick="showTab('gestao-ingredientes')" data-tab="gestao-ingredientes">
                        <span class="menu-item-icon">üî•</span>
                        Gest√£o de Ingredientes
                    </button>
                    <button class="menu-item" onclick="showTab('custos-base')" data-tab="custos-base">
                        <span class="menu-item-icon">üí∞</span>
                        Custos Base
                    </button>
                    <button class="menu-item" onclick="showTab('receitas')" data-tab="receitas">
                        <span class="menu-item-icon">üìù</span>
                        Receitas das Pizzas
                    </button>
                    <button class="menu-item" onclick="showTab('cardapio')" data-tab="cardapio">
                        <span class="menu-item-icon">üìã</span>
                        Card√°pio
                    </button>
                </div>
                
                <!-- VENDAS & FINANCEIRO -->
                <div class="menu-group">
                    <div class="menu-group-title">üí∞ Vendas & Financeiro</div>
                    <button class="menu-item" onclick="showTab('vendas')" data-tab="vendas">
                        <span class="menu-item-icon">üí≥</span>
                        Vendas & Contabilidade
                    </button>
                    <button class="menu-item" onclick="showTab('resultados-diarios')" data-tab="resultados-diarios">
                        <span class="menu-item-icon">üìä</span>
                        Resultados Di√°rios
                    </button>
                    <button class="menu-item" onclick="showTab('operacionais')" data-tab="operacionais">
                        <span class="menu-item-icon">‚öôÔ∏è</span>
                        Custos Operacionais
                    </button>
                </div>
                
                <!-- ESTOQUE & COMPRAS -->
                <div class="menu-group">
                    <div class="menu-group-title">üì¶ Estoque & Compras</div>
                    <button class="menu-item" onclick="showTab('estoque')" data-tab="estoque">
                        <span class="menu-item-icon">üì¶</span>
                        Controle de Estoque
                    </button>
                </div>
                
                <!-- CANAIS DE VENDA -->
                <div class="menu-group">
                    <div class="menu-group-title">üöö Canais de Venda</div>
                    <button class="menu-item" onclick="showTab('delivery-direto')" data-tab="delivery-direto">
                        <span class="menu-item-icon">üöó</span>
                        Delivery Direto
                    </button>
                    <button class="menu-item" onclick="showTab('ifood')" data-tab="ifood">
                        <span class="menu-item-icon">üçî</span>
                        iFood
                    </button>
                    <button class="menu-item" onclick="showTab('comparativo')" data-tab="comparativo">
                        <span class="menu-item-icon">üìà</span>
                        Comparativo
                    </button>
                </div>
                
                <!-- RELAT√ìRIOS -->
                <div class="menu-group">
                    <div class="menu-group-title">üìä Relat√≥rios</div>
                    <button class="menu-item" onclick="showTab('analises')" data-tab="analises">
                        <span class="menu-item-icon">üìà</span>
                        An√°lises
                    </button>
                </div>
                
                <!-- CONFIGURA√á√ïES -->
                <div class="menu-group">
                    <div class="menu-group-title">‚öôÔ∏è Configura√ß√µes</div>
                    <button class="menu-item" onclick="showTab('import-export')" data-tab="import-export">
                        <span class="menu-item-icon">üìÅ</span>
                        Import/Export
                    </button>
                </div>
            </div>
        </nav>
        
        <!-- CONTE√öDO PRINCIPAL -->
        <main class="main-content">
            <div class="content-header">
                <h1 id="content-title">üìä Dashboard - Vis√£o Geral</h1>
                <p id="content-subtitle">Monitore os indicadores-chave da sua opera√ß√£o</p>
            </div>
            
            <div class="content-body">
                <!-- MANTER ESTRUTURA ANTIGA DAS ABAS (OCULTA) -->
                <div class="tabs" style="display: none;">
                    <button class="tab active" onclick="showTab('dashboard')">Dashboard</button>
                    <button class="tab" onclick="showTab('gestao-ingredientes')" style="background: linear-gradient(45deg, #28a745, #20c997); color: white; font-weight: bold;">üî• Gest√£o de Ingredientes</button>
                    <button class="tab" onclick="showTab('vendas')">Vendas & Contabilidade</button>
                    <button class="tab" onclick="showTab('resultados-diarios')" style="background: linear-gradient(45deg, #007bff, #0056b3); color: white; font-weight: bold;">üìä Resultados Di√°rios</button>
                    <button class="tab" onclick="showTab('estoque')">Controle de Estoque</button>
                    <button class="tab" onclick="showTab('import-export')">Import/Export</button>
                    <button class="tab" onclick="showTab('custos-base')">Custos Base</button>
                    <button class="tab" onclick="showTab('receitas')">Receitas das Pizzas</button>
                    <button class="tab" onclick="showTab('operacionais')">Custos Operacionais</button>
                    <button class="tab" onclick="showTab('delivery-direto')">Delivery Direto</button>
                    <button class="tab" onclick="showTab('ifood')">iFood</button>
                    <button class="tab" onclick="showTab('comparativo')">Comparativo</button>
                    <button class="tab" onclick="showTab('cardapio')">Card√°pio</button>
                    <button class="tab" onclick="showTab('analises')">An√°lises</button>
                </div>

        <!-- Aba Dashboard -->
        <div id="dashboard" class="tab-content active">
            <h2>üìä Dashboard - Vis√£o Geral</h2>
            
            <div class="help-section">
                <h4>‚ÑπÔ∏è Como interpretar o Dashboard</h4>
                <p><strong>KPIs Principais:</strong> Monitore os indicadores-chave da sua opera√ß√£o. Total de ingredientes e pizzas mostram o tamanho do seu card√°pio. Ingredientes em estoque e alertas indicam a sa√∫de do seu estoque. Custo m√©dio por pizza ajuda no controle de margens. Varia√ß√£o de pre√ßos mostra tend√™ncias dos seus custos.</p>
            </div>
            
            <div class="quick-actions">
                <button class="btn" onclick="showTab('gestao-ingredientes')" style="background: linear-gradient(45deg, #ff6b6b, #ffa500); font-size: 18px; padding: 15px 25px;">üî• Gest√£o de Ingredientes</button>
                <button class="btn btn-calculator" onclick="abrirCalculadora()">üßÆ Calculadora R√°pida</button>
                <button class="btn btn-vendas" onclick="showTab('vendas')">üí∞ Registrar Venda</button>
                <button class="btn" onclick="showTab('resultados-diarios')" style="background: linear-gradient(45deg, #28a745, #20c997); color: white; font-weight: bold;">üìä Resultados Di√°rios</button>
                <button class="btn btn-estoque" onclick="showTab('estoque')">üì¶ Controle de Estoque</button>
                <button class="btn" onclick="calcularTodosProdutos()">‚ö° Recalcular Tudo</button>
                <button class="btn btn-export" onclick="exportarRelatorio()">üìä Relat√≥rio Completo</button>
            </div>

            <div class="dashboard-grid">
                <div class="kpi-card">
                    <h3>
                        Total de Ingredientes
                        <div class="tooltip">
                            <span class="help-icon">?</span>
                            <span class="tooltiptext">Quantidade total de ingredientes cadastrados no sistema. Cada ingrediente deve ter pre√ßo e quantidade padr√£o definidos.</span>
                        </div>
                    </h3>
                    <div class="value" id="kpi-ingredientes">0</div>
                    <div class="change">Cadastrados no sistema</div>
                </div>
                <div class="kpi-card">
                    <h3>
                        Total de Pizzas
                        <div class="tooltip">
                            <span class="help-icon">?</span>
                            <span class="tooltiptext">N√∫mero de receitas de pizzas criadas. Cada pizza deve ter ingredientes e quantidades definidas para c√°lculo correto dos custos.</span>
                        </div>
                    </h3>
                    <div class="value" id="kpi-pizzas">0</div>
                    <div class="change">Receitas criadas</div>
                </div>
                <div class="kpi-card vendas">
                    <h3>
                        Faturamento Hoje
                        <div class="tooltip">
                            <span class="help-icon">?</span>
                            <span class="tooltiptext">Total de vendas registradas hoje. Inclui pizzas, bebidas e produtos extras vendidos.</span>
                        </div>
                    </h3>
                    <div class="value" id="kpi-faturamento-hoje">R$ 0,00</div>
                    <div class="change">Vendas de hoje</div>
                </div>
                <div class="kpi-card lucro">
                    <h3>
                        Lucro Hoje
                        <div class="tooltip">
                            <span class="help-icon">?</span>
                            <span class="tooltiptext">Lucro l√≠quido das vendas de hoje (faturamento - custos dos produtos vendidos).</span>
                        </div>
                    </h3>
                    <div class="value" id="kpi-lucro-hoje">R$ 0,00</div>
                    <div class="change">Lucro l√≠quido</div>
                </div>
                <div class="kpi-card margem">
                    <h3>
                        Margem M√©dia Hoje
                        <div class="tooltip">
                            <span class="help-icon">?</span>
                            <span class="tooltiptext">Percentual m√©dio de margem das vendas de hoje. Indica a rentabilidade das vendas.</span>
                        </div>
                    </h3>
                    <div class="value" id="kpi-margem-hoje">0%</div>
                    <div class="change">Das vendas de hoje</div>
                </div>
                <div class="kpi-card estoque">
                    <h3>
                        Ingredientes em Estoque
                        <div class="tooltip">
                            <span class="help-icon">?</span>
                            <span class="tooltiptext">Ingredientes que possuem saldo dispon√≠vel no estoque. Importante para garantir que voc√™ pode produzir as pizzas do card√°pio.</span>
                        </div>
                    </h3>
                    <div class="value" id="kpi-estoque">0</div>
                    <div class="change">Com saldo dispon√≠vel</div>
                </div>
                <div class="kpi-card alerta">
                    <h3>
                        Alertas de Estoque
                        <div class="tooltip">
                            <span class="help-icon">?</span>
                            <span class="tooltiptext">Ingredientes com estoque abaixo do m√≠nimo ou zerado. Monitore para evitar parar a produ√ß√£o por falta de insumos.</span>
                        </div>
                    </h3>
                    <div class="value" id="kpi-alertas">0</div>
                    <div class="change">Itens com estoque baixo</div>
                </div>
                <div class="kpi-card ticket">
                    <h3>
                        Ticket M√©dio
                        <div class="tooltip">
                            <span class="help-icon">?</span>
                            <span class="tooltiptext">Valor m√©dio por venda registrada. √ötil para an√°lise de performance e metas comerciais.</span>
                        </div>
                    </h3>
                    <div class="value" id="kpi-ticket-medio">R$ 0,00</div>
                    <div class="change">Por venda</div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="vendasChart"></canvas>
            </div>

            <div class="suggestions" id="suggestions-container">
                <h3>üí° Sugest√µes Inteligentes</h3>
                <div id="suggestions-list">
                    <!-- Sugest√µes ser√£o geradas aqui -->
                </div>
            </div>

            <!-- Nova se√ß√£o de alertas inteligentes -->
            <div class="alert-section" id="alertas-inteligentes" style="margin: 20px 0;">
                <h3>üö® Alertas Inteligentes</h3>
                <div id="alertas-list">
                    <!-- Alertas ser√£o gerados automaticamente aqui -->
                </div>
            </div>
        </div>

        <!-- Aba Gest√£o de Ingredientes - NOVA FUNCIONALIDADE INTEGRADA -->
        <div id="gestao-ingredientes" class="tab-content">
            <h2>üî• Gest√£o de Ingredientes - Custos + Estoque Unificado</h2>
            
            <div class="help-section">
                <h4>üöÄ Nova Funcionalidade - Gest√£o Unificada</h4>
                <p><strong>Benef√≠cio:</strong> Gerencie custos e estoque de ingredientes em uma √∫nica tela! Esta nova aba combina as funcionalidades de "Custos Base" e "Controle de Estoque" para maior agilidade operacional. Atualize pre√ßos e estoque simultaneamente, visualize alertas integrados e tenha uma vis√£o completa de cada ingrediente.</p>
                <p><strong>Dica:</strong> As abas originais "Custos Base" e "Controle de Estoque" continuam dispon√≠veis para compatibilidade.</p>
            </div>

            <!-- Filtros e Busca -->
            <div class="filters-container">
                <div class="filter-item">
                    <label>üîç Buscar Ingrediente:</label>
                    <div class="search-container">
                        <input type="text" id="busca-ingrediente-unificado" class="search-input" placeholder="Digite o nome do ingrediente..." onkeyup="filtrarIngredientesUnificado()">
                        <span class="search-icon">üîç</span>
                    </div>
                </div>
                <div class="filter-item">
                    <label>üìÇ Categoria:</label>
                    <select id="filtro-categoria-unificado" onchange="filtrarIngredientesUnificado()">
                        <option value="">Todas as categorias</option>
                        <option value="carnes">Carnes</option>
                        <option value="queijos">Queijos</option>
                        <option value="vegetais">Vegetais</option>
                        <option value="massas">Massas</option>
                        <option value="molhos">Molhos</option>
                        <option value="temperos">Temperos</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>‚ö†Ô∏è Status:</label>
                    <select id="filtro-status-unificado" onchange="filtrarIngredientesUnificado()">
                        <option value="">Todos</option>
                        <option value="ok">‚úÖ OK</option>
                        <option value="estoque-baixo">üü° Estoque Baixo</option>
                        <option value="estoque-critico">üî¥ Estoque Cr√≠tico</option>
                        <option value="sem-estoque">‚ùå Sem Estoque</option>
                        <option value="preco-alto">üìà Pre√ßo em Alta</option>
                    </select>
                </div>
            </div>

            <!-- A√ß√µes R√°pidas -->
            <div class="quick-actions">
                <button class="btn" onclick="adicionarIngredienteUnificado()">‚ûï Novo Ingrediente</button>
                <button class="btn btn-estoque" onclick="abrirEntradaEstoqueMassa()">üì¶ Entrada de Estoque em Massa</button>
                <button class="btn btn-edit" onclick="atualizarPrecosEmMassa()">üí∞ Atualizar Pre√ßos em Massa</button>
                <button class="btn btn-calculator" onclick="calcularCustosIngredientes()">üßÆ Recalcular Custos</button>
                <button class="btn btn-export" onclick="exportarIngredientesUnificado()">üìä Exportar Dados</button>
            </div>

            <!-- Resumo de Status -->
            <div class="dashboard-grid">
                <div class="kpi-card">
                    <h3>Total de Ingredientes</h3>
                    <div class="value" id="total-ingredientes-unificado">0</div>
                    <div class="change">Cadastrados</div>
                </div>
                <div class="kpi-card estoque">
                    <h3>Com Estoque OK</h3>
                    <div class="value" id="ingredientes-ok-unificado">0</div>
                    <div class="change">Dispon√≠veis</div>
                </div>
                <div class="kpi-card alerta">
                    <h3>Alertas de Estoque</h3>
                    <div class="value" id="alertas-estoque-unificado">0</div>
                    <div class="change">Precisam aten√ß√£o</div>
                </div>
                <div class="kpi-card custo">
                    <h3>Custo Total Estoque</h3>
                    <div class="value" id="valor-total-estoque">R$ 0,00</div>
                    <div class="change">Investimento atual</div>
                </div>
            </div>

            <!-- Formul√°rio de Ingrediente -->
            <div class="vendas-section" id="form-ingrediente-unificado" style="display: none;">
                <h3 id="titulo-form-ingrediente">‚ûï Adicionar Novo Ingrediente</h3>
                <div class="vendas-form">
                    <div class="form-row">
                        <div>
                            <label>Nome do Ingrediente:</label>
                            <input type="text" id="ingrediente-nome-unificado" placeholder="Ex: Mussarela">
                        </div>
                        <div>
                            <label>Categoria:</label>
                            <select id="ingrediente-categoria-unificado">
                                <option value="carnes">Carnes</option>
                                <option value="queijos">Queijos</option>
                                <option value="vegetais">Vegetais</option>
                                <option value="massas">Massas</option>
                                <option value="molhos">Molhos</option>
                                <option value="temperos">Temperos</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div>
                            <label>Unidade de Medida:</label>
                            <select id="ingrediente-unidade-unificado">
                                <option value="kg">Quilograma (kg)</option>
                                <option value="g">Grama (g)</option>
                                <option value="l">Litro (l)</option>
                                <option value="ml">Mililitro (ml)</option>
                                <option value="un">Unidade (un)</option>
                                <option value="fatia">Fatia</option>
                                <option value="pitada">Pitada</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label>Pre√ßo por Unidade (R$):</label>
                            <input type="number" id="ingrediente-preco-unificado" step="0.01" placeholder="0.00" onchange="calcularCustoIngredienteUnificado()">
                        </div>
                        <div>
                            <label>Quantidade Padr√£o por Pizza:</label>
                            <input type="number" id="ingrediente-quantidade-unificado" step="0.01" placeholder="0.00" onchange="calcularCustoIngredienteUnificado()">
                        </div>
                        <div>
                            <label>Custo por Pizza (R$):</label>
                            <input type="number" id="ingrediente-custo-pizza-unificado" step="0.01" readonly class="custo-calculado">
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label>Estoque Atual:</label>
                            <input type="number" id="ingrediente-estoque-atual-unificado" step="0.01" placeholder="0.00">
                        </div>
                        <div>
                            <label>Estoque M√≠nimo:</label>
                            <input type="number" id="ingrediente-estoque-minimo-unificado" step="0.01" placeholder="0.00">
                        </div>
                        <div>
                            <label>Fornecedor:</label>
                            <input type="text" id="ingrediente-fornecedor-unificado" placeholder="Nome do fornecedor">
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <button class="btn" onclick="salvarIngredienteUnificado()">üíæ Salvar Ingrediente</button>
                            <button class="btn btn-secondary" onclick="cancelarEdicaoIngredienteUnificado()">‚ùå Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela Unificada de Ingredientes -->
            <div class="table-container">
                <table id="tabela-ingredientes-unificado">
                    <thead>
                        <tr>
                            <th>Ingrediente</th>
                            <th>Categoria</th>
                            <th>Pre√ßo/Un</th>
                            <th>Qtd/Pizza</th>
                            <th>Custo/Pizza</th>
                            <th>Estoque Atual</th>
                            <th>Estoque M√≠n</th>
                            <th>Status</th>
                            <th>Valor Estoque</th>
                            <th>Fornecedor</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Se√ß√£o de Movimenta√ß√£o de Estoque -->
            <div class="entrada-estoque">
                <h3>üì¶ Movimenta√ß√£o de Estoque</h3>
                <div class="vendas-form">
                    <div class="form-row">
                        <div>
                            <label>Ingrediente:</label>
                            <select id="movimentacao-ingrediente-unificado">
                                <option value="">Selecione um ingrediente</option>
                            </select>
                        </div>
                        <div>
                            <label>Tipo de Movimenta√ß√£o:</label>
                            <select id="movimentacao-tipo-unificado">
                                <option value="entrada">‚ûï Entrada (Compra)</option>
                                <option value="saida">‚ûñ Sa√≠da (Uso/Perda)</option>
                                <option value="ajuste">üîß Ajuste de Estoque</option>
                            </select>
                        </div>
                        <div>
                            <label>Quantidade:</label>
                            <input type="number" id="movimentacao-quantidade-unificado" step="0.01" placeholder="0.00">
                        </div>
                        <div>
                            <label>Observa√ß√£o:</label>
                            <input type="text" id="movimentacao-obs-unificado" placeholder="Motivo da movimenta√ß√£o">
                        </div>
                    </div>
                    <button class="btn btn-estoque" onclick="registrarMovimentacaoUnificado()">üìù Registrar Movimenta√ß√£o</button>
                </div>

                <!-- Hist√≥rico de Movimenta√ß√µes -->
                <div class="table-container" style="margin-top: 20px;">
                    <h4>üìã √öltimas Movimenta√ß√µes</h4>
                    <table id="tabela-movimentacoes-unificado">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Ingrediente</th>
                                <th>Tipo</th>
                                <th>Quantidade</th>
                                <th>Estoque Anterior</th>
                                <th>Estoque Atual</th>
                                <th>Observa√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Aba Vendas & Contabilidade -->
        <div id="vendas" class="tab-content">
            <h2>üí∞ Vendas & Contabilidade</h2>
            
            <div class="help-section">
                <h4>‚ÑπÔ∏è Controle de Vendas</h4>
                <p><strong>Funcionalidade:</strong> Registre todas as vendas (pizzas, bebidas, extras) para acompanhar faturamento real, custos e lucros. O sistema calcula automaticamente margens e deduz estoque quando necess√°rio. Use os filtros de per√≠odo para an√°lises espec√≠ficas.</p>
            </div>

            <div class="periodo-filter">
                <div>
                    <label>Per√≠odo:</label>
                    <select id="filtro-periodo" onchange="filtrarVendasPorPeriodo()">
                        <option value="hoje">Hoje</option>
                        <option value="semana">Esta Semana</option>
                        <option value="mes">Este M√™s</option>
                        <option value="personalizado">Per√≠odo Personalizado</option>
                    </select>
                </div>
                <div id="periodo-personalizado" style="display: none;">
                    <label>De:</label>
                    <input type="date" id="data-inicio">
                    <label>At√©:</label>
                    <input type="date" id="data-fim">
                    <button class="btn btn-secondary" onclick="aplicarFiltroPeriodo()">Aplicar</button>
                </div>
            </div>

            <div class="meta-progress">
                <h3>üéØ Meta Mensal de Faturamento</h3>
                <div class="form-row" style="margin-bottom: 15px;">
                    <div>
                        <label>Meta do M√™s (R$):</label>
                        <input type="number" id="meta-mensal" step="0.01" placeholder="Ex: 25000" onchange="atualizarMetaMensal()">
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-meta" style="width: 0%"></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                    <span id="meta-atual">R$ 0,00</span>
                    <span id="meta-objetivo">R$ 0,00</span>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <span id="meta-percentual">0%</span> da meta alcan√ßada
                </div>
            </div>

            <div class="vendas-section">
                <h3>üìù Registrar Nova Venda</h3>
                <div class="vendas-form">
                    <div class="form-row">
                        <div>
                            <label>Tipo de Produto:</label>
                            <select id="tipo-produto" onchange="atualizarProdutoSelect()">
                                <option value="pizza">Pizza</option>
                                <option value="bebida">Bebida/Extra</option>
                            </select>
                        </div>
                        <div id="produto-pizza-container">
                            <label>Pizza:</label>
                            <select id="venda-pizza">
                                <option value="">Selecione uma pizza</option>
                            </select>
                        </div>
                        <div id="produto-extra-container" style="display: none;">
                            <label>Produto:</label>
                            <select id="venda-produto-extra">
                                <option value="">Selecione um produto</option>
                            </select>
                        </div>
                        <div>
                            <label>Quantidade:</label>
                            <input type="number" id="venda-quantidade" min="1" placeholder="1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label>Canal de Venda:</label>
                            <select id="venda-canal">
                                <option value="direto">Delivery Direto</option>
                                <option value="ifood">iFood</option>
                                <option value="balcao">Balc√£o</option>
                            </select>
                        </div>
                        <div>
                            <label>Data/Hora:</label>
                            <input type="datetime-local" id="venda-data">
                        </div>
                        <div>
                            <label>Desconto (R$):</label>
                            <input type="number" id="venda-desconto" step="0.01" value="0" placeholder="0.00">
                        </div>
                        <div>
                            <label>Observa√ß√µes:</label>
                            <input type="text" id="venda-obs" placeholder="Observa√ß√µes da venda">
                        </div>
                    </div>
                    <div id="venda-preview" style="display: none; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <!-- Preview da venda ser√° mostrado aqui -->
                    </div>
                    <button class="btn btn-vendas" onclick="registrarVenda()">üí∞ Registrar Venda</button>
                </div>
            </div>

            <div class="produtos-extras-section">
                <h3>üç∑ Gerenciar Produtos Extras</h3>
                <div class="vendas-form">
                    <div class="form-row">
                        <div>
                            <label>Nome do Produto:</label>
                            <input type="text" id="extra-nome" placeholder="Ex: Coca-Cola 350ml">
                        </div>
                        <div>
                            <label>Categoria:</label>
                            <select id="extra-categoria">
                                <option value="bebida">Bebida</option>
                                <option value="sobremesa">Sobremesa</option>
                                <option value="acompanhamento">Acompanhamento</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div>
                            <label>Pre√ßo de Custo (R$):</label>
                            <input type="number" id="extra-custo" step="0.01" placeholder="0.00">
                        </div>
                        <div>
                            <label>Pre√ßo de Venda (R$):</label>
                            <input type="number" id="extra-preco" step="0.01" placeholder="0.00" onchange="calcularMargemExtra()">
                        </div>
                    </div>
                    <div style="margin: 10px 0;">
                        <strong>Margem: <span id="margem-extra-preview">0%</span></strong>
                    </div>
                    <button class="btn" onclick="adicionarProdutoExtra()">‚ûï Adicionar Produto</button>
                </div>

                <div class="table-container">
                    <table id="tabela-produtos-extras">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Categoria</th>
                                <th>Custo</th>
                                <th>Pre√ßo</th>
                                <th>Margem</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="vendas-section">
                <h3>üìä Resumo de Vendas</h3>
                <div class="dashboard-grid">
                    <div class="kpi-card vendas">
                        <h3>Faturamento</h3>
                        <div class="value" id="resumo-faturamento">R$ 0,00</div>
                        <div class="change">Per√≠odo selecionado</div>
                    </div>
                    <div class="kpi-card lucro">
                        <h3>Lucro</h3>
                        <div class="value" id="resumo-lucro">R$ 0,00</div>
                        <div class="change">Lucro l√≠quido</div>
                    </div>
                    <div class="kpi-card custo">
                        <h3>Custos</h3>
                        <div class="value" id="resumo-custos">R$ 0,00</div>
                        <div class="change">Custos totais</div>
                    </div>
                    <div class="kpi-card margem">
                        <h3>Margem M√©dia</h3>
                        <div class="value" id="resumo-margem">0%</div>
                        <div class="change">Do per√≠odo</div>
                    </div>
                </div>
            </div>

            <div class="search-container">
                <input type="text" class="search-input" id="search-vendas" placeholder="üîç Buscar vendas..." onkeyup="filtrarVendas()">
                <span class="search-icon">üîç</span>
            </div>

            <div class="table-container">
                <table id="tabela-vendas">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Produto</th>
                            <th>Qtd</th>
                            <th>Canal</th>
                            <th>Valor Unit.</th>
                            <th>Desconto</th>
                            <th>Total</th>
                            <th>Custo</th>
                            <th>Lucro</th>
                            <th>Margem</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="chart-container">
                <h3>üìà Gr√°fico de Vendas por Per√≠odo</h3>
                <canvas id="graficoVendasPeriodo"></canvas>
            </div>
        </div>

        <!-- Aba Resultados Di√°rios - NOVA FUNCIONALIDADE -->
        <div id="resultados-diarios" class="tab-content">
            <h2>üìä Resultados Di√°rios - Controle de Faturamento</h2>
            
            <div class="help-section">
                <h4>‚ÑπÔ∏è Resultados Di√°rios</h4>
                <p><strong>Funcionalidade:</strong> Registre o resultado consolidado de cada dia de opera√ß√£o para controle mensal do faturamento. Diferente do registro individual de vendas, aqui voc√™ registra o total do dia com quantidade de pedidos, valor total e canal principal de vendas.</p>
                <p><strong>Benef√≠cios:</strong> Controle mensal, an√°lise de tend√™ncias, comparativo de metas e relat√≥rios autom√°ticos de performance.</p>
            </div>

            <!-- Formul√°rio de Registro -->
            <div class="vendas-section">
                <h3>üìù Registrar Resultado do Dia</h3>
                <div class="vendas-form">
                    <div class="form-row">
                        <div>
                            <label>üìÖ Data:</label>
                            <input type="date" id="resultado-data" required>
                        </div>
                        <div>
                            <label>üî¢ Quantidade de Pedidos:</label>
                            <input type="number" id="resultado-pedidos" placeholder="Ex: 30" min="0" required>
                        </div>
                        <div>
                            <label>üí∞ Valor Total Vendido (R$):</label>
                            <input type="number" id="resultado-valor" placeholder="Ex: 2450.00" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label>üì± Canal Principal de Venda:</label>
                            <select id="resultado-canal" required>
                                <option value="">Selecione o canal</option>
                                <option value="Balc√£o">üè™ Balc√£o</option>
                                <option value="Delivery Pr√≥prio">üöó Delivery Pr√≥prio</option>
                                <option value="iFood">üçî iFood</option>
                                <option value="Uber Eats">üöö Uber Eats</option>
                                <option value="Rappi">üì± Rappi</option>
                                <option value="WhatsApp">üí¨ WhatsApp</option>
                                <option value="Telefone">üìû Telefone</option>
                                <option value="Misto">üîÑ Misto</option>
                            </select>
                        </div>
                        <div>
                            <label>üí≥ Forma de Pagamento Principal:</label>
                            <select id="resultado-pagamento">
                                <option value="">Selecione a forma</option>
                                <option value="PIX">üí≥ PIX</option>
                                <option value="Dinheiro">üíµ Dinheiro</option>
                                <option value="Cart√£o D√©bito">üí≥ Cart√£o D√©bito</option>
                                <option value="Cart√£o Cr√©dito">üí≥ Cart√£o Cr√©dito</option>
                                <option value="Misto">üîÑ Misto</option>
                            </select>
                        </div>
                        <div>
                            <label>üéØ Meta do Dia (R$):</label>
                            <input type="number" id="resultado-meta" placeholder="Ex: 2000.00" step="0.01" min="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div style="flex: 2;">
                            <label>üìù Observa√ß√µes:</label>
                            <input type="text" id="resultado-observacoes" placeholder="Ex: Dia de chuva, promo√ß√£o especial, etc.">
                        </div>
                        <div>
                            <label>üßÆ Ticket M√©dio:</label>
                            <input type="text" id="resultado-ticket-medio" readonly style="background: #f8f9fa; color: #6c757d;">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-vendas" onclick="salvarResultadoDiario()">üíæ Salvar Resultado</button>
                        <button type="button" class="btn" onclick="limparFormularioResultado()">üîÑ Limpar</button>
                        <button type="button" class="btn btn-export" onclick="exportarResultadosDiarios()">üìä Exportar Dados</button>
                    </div>
                </div>
            </div>

            <!-- KPIs do M√™s -->
            <div class="vendas-section">
                <h3>üìà Resumo do M√™s Atual</h3>
                <div class="dashboard-grid">
                    <div class="kpi-card vendas">
                        <h3>Faturamento Mensal</h3>
                        <div class="value" id="kpi-faturamento-mensal">R$ 0,00</div>
                        <div class="change">M√™s atual</div>
                    </div>
                    <div class="kpi-card">
                        <h3>Total de Pedidos</h3>
                        <div class="value" id="kpi-pedidos-mensal">0</div>
                        <div class="change">Pedidos do m√™s</div>
                    </div>
                    <div class="kpi-card lucro">
                        <h3>Ticket M√©dio Mensal</h3>
                        <div class="value" id="kpi-ticket-medio-mensal">R$ 0,00</div>
                        <div class="change">Valor m√©dio por pedido</div>
                    </div>
                    <div class="kpi-card">
                        <h3>Dias Trabalhados</h3>
                        <div class="value" id="kpi-dias-trabalhados">0</div>
                        <div class="change">Dias com vendas</div>
                    </div>
                    <div class="kpi-card margem">
                        <h3>Meta Mensal</h3>
                        <div class="value" id="kpi-meta-mensal">R$ 0,00</div>
                        <div class="change">Meta planejada</div>
                    </div>
                    <div class="kpi-card alerta">
                        <h3>% Meta Atingida</h3>
                        <div class="value" id="kpi-percentual-meta">0%</div>
                        <div class="change">Do m√™s atual</div>
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="vendas-section">
                <h3>üîç Filtros e Busca</h3>
                <div class="form-row">
                    <div>
                        <label>üìÖ M√™s/Ano:</label>
                        <input type="month" id="filtro-mes-resultado" onchange="filtrarResultadosPorMes()">
                    </div>
                    <div>
                        <label>üì± Canal:</label>
                        <select id="filtro-canal-resultado" onchange="filtrarResultadosPorCanal()">
                            <option value="">Todos os canais</option>
                            <option value="Balc√£o">üè™ Balc√£o</option>
                            <option value="Delivery Pr√≥prio">üöó Delivery Pr√≥prio</option>
                            <option value="iFood">üçî iFood</option>
                            <option value="Uber Eats">üöö Uber Eats</option>
                            <option value="Rappi">üì± Rappi</option>
                            <option value="WhatsApp">üí¨ WhatsApp</option>
                            <option value="Telefone">üìû Telefone</option>
                            <option value="Misto">üîÑ Misto</option>
                        </select>
                    </div>
                    <div>
                        <label>üîç Buscar:</label>
                        <input type="text" id="busca-resultado" placeholder="Buscar por observa√ß√µes..." onkeyup="buscarResultados()">
                    </div>
                </div>
            </div>

            <!-- Tabela de Resultados -->
            <div class="table-container">
                <table id="tabela-resultados-diarios">
                    <thead>
                        <tr>
                            <th>üìÖ Data</th>
                            <th>üî¢ Pedidos</th>
                            <th>üí∞ Valor Total</th>
                            <th>üßÆ Ticket M√©dio</th>
                            <th>üì± Canal</th>
                            <th>üí≥ Pagamento</th>
                            <th>üéØ Meta</th>
                            <th>üìä % Meta</th>
                            <th>üìù Observa√ß√µes</th>
                            <th>‚öôÔ∏è A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Gr√°fico de Performance -->
            <div class="chart-container">
                <h3>üìà Gr√°fico de Performance Mensal</h3>
                <canvas id="graficoResultadosDiarios"></canvas>
            </div>
        </div>

        <!-- Aba Controle de Estoque -->
        <div id="estoque" class="tab-content">
            <h2>üì¶ Controle de Estoque</h2>
            
            <div class="help-section">
                <h4>‚ÑπÔ∏è Controle de Estoque</h4>
                <p><strong>Funcionalidade:</strong> Registre entradas de compras para manter hist√≥rico de pre√ßos e controlar saldo. O sistema calcula automaticamente pre√ßos m√©dios e identifica tend√™ncias. Use para tomar decis√µes de compra e reajustes de pre√ßos. O estoque √© automaticamente deduzido quando vendas s√£o registradas.</p>
            </div>
            
            <div class="entrada-estoque">
                <h3>üì• Entrada de Estoque</h3>
                <div class="form-row">
                    <div>
                        <label>
                            Ingrediente:
                            <div class="tooltip">
                                <span class="help-icon">?</span>
                                <span class="tooltiptext">Selecione o ingrediente que voc√™ est√° comprando. Deve estar cadastrado em "Custos Base" primeiro.</span>
                            </div>
                        </label>
                        <select id="estoque-ingrediente">
                            <option value="">Selecione um ingrediente</option>
                        </select>
                    </div>
                    <div>
                        <label>
                            Quantidade Comprada:
                            <div class="tooltip">
                                <span class="help-icon">?</span>
                                <span class="tooltiptext">Quantidade total comprada na unidade de medida do ingrediente (kg, litros, etc.)</span>
                            </div>
                        </label>
                        <input type="number" id="estoque-quantidade" step="0.001" placeholder="Ex: 5.000">
                    </div>
                    <div>
                        <label>
                            Pre√ßo Unit√°rio (R$):
                            <div class="tooltip">
                                <span class="help-icon">?</span>
                                <span class="tooltiptext">Pre√ßo pago por unidade (por kg, litro, etc.). O sistema atualizar√° automaticamente o pre√ßo m√©dio do ingrediente.</span>
                            </div>
                        </label>
                        <input type="number" id="estoque-preco" step="0.01" placeholder="Ex: 28.50">
                    </div>
                    <div>
                        <label>Data da Compra:</label>
                        <input type="date" id="estoque-data">
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label>Fornecedor:</label>
                        <input type="text" id="estoque-fornecedor" placeholder="Ex: Atacad√£o">
                    </div>
                    <div>
                        <label>Observa√ß√µes:</label>
                        <input type="text" id="estoque-obs" placeholder="Observa√ß√µes sobre a compra">
                    </div>
                </div>
                <button class="btn btn-estoque" onclick="registrarEntradaEstoque()">üì• Registrar Entrada</button>
            </div>

            <div class="search-container">
                <input type="text" class="search-input" id="search-estoque" placeholder="üîç Buscar ingredientes no estoque..." onkeyup="filtrarEstoque()">
                <span class="search-icon">üîç</span>
            </div>

            <div class="table-container">
                <table id="tabela-estoque">
                    <thead>
                        <tr>
                            <th>Ingrediente</th>
                            <th>Estoque Atual</th>
                            <th>Pre√ßo Atual</th>
                            <th>Hist√≥rico de Pre√ßos</th>
                            <th>√öltima Entrada</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="chart-container">
                <h3>üìà Evolu√ß√£o de Pre√ßos dos Ingredientes</h3>
                <canvas id="precosChart"></canvas>
            </div>
        </div>

        <!-- Aba Import/Export -->
        <div id="import-export" class="tab-content">
            <h2>üìÇ Importar e Exportar Dados</h2>
            
            <div class="upload-area" onclick="document.getElementById('file-upload').click()">
                <div>
                    <h3>üìÅ Importar Arquivo XLSX</h3>
                    <p>Clique aqui ou arraste um arquivo .xlsx para carregar dados hist√≥ricos</p>
                    <input type="file" id="file-upload" class="file-input" accept=".xlsx,.xls" onchange="importarArquivo(event)">
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processando arquivo...</p>
            </div>

            <div id="import-feedback"></div>

            <div class="export-section">
                <h3>üì§ Exportar Planilha Completa</h3>
                <div class="alert">
                    <strong>Arquivo incluir√°:</strong> TODAS as 13 abas - Custos base, receitas, controle de estoque, 
                    hist√≥rico de compras, custos operacionais, delivery, iFood, comparativo, card√°pio, an√°lises, 
                    vendas registradas, produtos extras, dashboard KPIs e configura√ß√µes completas.
                </div>
                
                <button class="btn btn-export" onclick="exportarPlanilhaCompleta()">üìä Baixar Sistema Completo (.xlsx)</button>
                
                <div style="margin-top: 30px;">
                    <h4>üìã Como importar no Google Sheets:</h4>
                    <ol style="text-align: left; max-width: 600px; margin: 20px auto;">
                        <li>Acesse <strong>sheets.google.com</strong></li>
                        <li>Clique em <strong>"Arquivo" ‚Üí "Importar"</strong></li>
                        <li>Selecione <strong>"Upload"</strong> e escolha o arquivo baixado</li>
                        <li>Escolha <strong>"Substituir planilha"</strong> ou <strong>"Criar nova planilha"</strong></li>
                        <li>Clique em <strong>"Importar dados"</strong></li>
                    </ol>
                </div>
            </div>

            <div class="alert alert-warning">
                <strong>üíæ Auto-backup:</strong> Seus dados s√£o salvos automaticamente no navegador. 
                Para maior seguran√ßa, exporte regularmente seus dados.
            </div>
        </div>

        <!-- Aba Custos Base -->
        <div id="custos-base" class="tab-content">
            <h2>üìã Custos Base dos Ingredientes</h2>
            
            <div class="help-section">
                <h4>‚ÑπÔ∏è Custos Base</h4>
                <p><strong>Campos Importantes:</strong> <strong>Pre√ßo por Unidade:</strong> custo em R$ de cada kg/litro do ingrediente. <strong>Qtd/Pizza:</strong> quantidade padr√£o usada em cada pizza (sugerida automaticamente ao criar receitas). <strong>Custo por Pizza:</strong> resultado da multiplica√ß√£o pre√ßo √ó quantidade (calculado automaticamente). <strong>Estoque:</strong> saldo atual dispon√≠vel.</p>
            </div>
            
            <div class="search-container">
                <input type="text" class="search-input" id="search-ingredientes" placeholder="üîç Buscar ingredientes..." onkeyup="filtrarIngredientes()">
                <span class="search-icon">üîç</span>
            </div>

            <div class="form-group">
                <div class="form-row">
                    <div>
                        <label>
                            Nome do Ingrediente:
                            <div class="tooltip">
                                <span class="help-icon">?</span>
                                <span class="tooltiptext">Nome do ingrediente ou insumo. Ex: Mussarela, Molho de Tomate, Massa, etc.</span>
                            </div>
                        </label>
                        <input type="text" id="ingrediente-nome" placeholder="Ex: Mussarela">
                    </div>
                    <div>
                        <label>
                            Unidade de Medida:
                            <div class="tooltip">
                                <span class="help-icon">?</span>
                                <span class="tooltiptext">Como voc√™ compra este ingrediente: kg para s√≥lidos, litros para l√≠quidos, unidade para itens.</span>
                            </div>
                        </label>
                        <select id="ingrediente-unidade">
                            <option value="kg">Quilograma (kg)</option>
                            <option value="g">Gramas (g)</option>
                            <option value="l">Litros (l)</option>
                            <option value="ml">Mililitros (ml)</option>
                            <option value="unidade">Unidade</option>
                        </select>
                    </div>
                    <div>
                        <label>
                            Pre√ßo por Unidade (R$):
                            <div class="tooltip">
                                <span class="help-icon">?</span>
                                <span class="tooltiptext">Pre√ßo que voc√™ paga por cada kg, litro ou unidade deste ingrediente. Base para todos os c√°lculos de custo.</span>
                            </div>
                        </label>
                        <input type="number" id="ingrediente-preco" step="0.01" placeholder="0.00">
                    </div>
                    <div>
                        <label>
                            Quantidade por Pizza (padr√£o):
                            <div class="tooltip">
                                <span class="help-icon">?</span>
                                <span class="tooltiptext">Quantidade padr√£o deste ingrediente em cada pizza. Ser√° sugerida automaticamente ao criar receitas. Ex: 0.15kg de mussarela por pizza.</span>
                            </div>
                        </label>
                        <input type="number" id="ingrediente-quantidade" step="0.001" placeholder="Ex: 0.15">
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label>
                            Estoque M√≠nimo:
                            <div class="tooltip">
                                <span class="help-icon">?</span>
                                <span class="tooltiptext">Quantidade m√≠nima que deve ter em estoque. O sistema alertar√° quando estiver abaixo deste valor.</span>
                            </div>
                        </label>
                        <input type="number" id="ingrediente-estoque-min" step="0.001" placeholder="Ex: 2.000">
                    </div>
                    <div>
                        <label>
                            Estoque Inicial:
                            <div class="tooltip">
                                <span class="help-icon">?</span>
                                <span class="tooltiptext">Quantidade atual em estoque (opcional). Use para inicializar o controle de estoque.</span>
                            </div>
                        </label>
                        <input type="number" id="ingrediente-estoque-inicial" step="0.001" placeholder="Ex: 10.000">
                    </div>
                </div>
                <button class="btn" onclick="adicionarIngrediente()">‚ûï Adicionar Ingrediente</button>
            </div>
            
            <div class="table-container">
                <table id="tabela-ingredientes">
                    <thead>
                        <tr>
                            <th>Ingrediente</th>
                            <th>Unidade</th>
                            <th>Pre√ßo por Unidade</th>
                            <th>Hist√≥rico</th>
                            <th>Qtd/Pizza</th>
                            <th>Custo por Pizza</th>
                            <th>Estoque</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Aba Receitas -->
        <div id="receitas" class="tab-content">
            <h2>üçï Receitas das Pizzas</h2>
            
            <div class="help-section">
                <h4>‚ÑπÔ∏è Receitas das Pizzas</h4>
                <p><strong>Como criar:</strong> Defina nome e tamanho da pizza, depois adicione ingredientes um por um. O sistema sugere automaticamente as quantidades padr√£o cadastradas. O custo total √© calculado automaticamente somando ingredientes + embalagem + custo operacional por pizza.</p>
            </div>
            
            <div class="search-container">
                <input type="text" class="search-input" id="search-pizzas" placeholder="üîç Buscar pizzas..." onkeyup="filtrarPizzas()">
                <span class="search-icon">üîç</span>
            </div>

            <div class="form-group">
                <div class="form-row">
                    <div>
                        <label>Nome da Pizza:</label>
                        <input type="text" id="pizza-nome" placeholder="Ex: Marguerita">
                    </div>
                    <div>
                        <label>Tamanho:</label>
                        <select id="pizza-tamanho">
                            <option value="Pequena">Pequena</option>
                            <option value="M√©dia">M√©dia</option>
                            <option value="Grande">Grande</option>
                            <option value="Fam√≠lia">Fam√≠lia</option>
                        </select>
                    </div>
                </div>
                
                <div id="ingredientes-pizza">
                    <h3>Ingredientes da Pizza</h3>
                    <div class="form-row">
                        <div>
                            <label>Ingrediente:</label>
                            <select id="select-ingrediente" onchange="preencherQuantidadePadrao()">
                                <option value="">Selecione um ingrediente</option>
                            </select>
                        </div>
                        <div>
                            <label>Quantidade:</label>
                            <input type="number" id="quantidade-ingrediente" step="0.001" placeholder="0.000">
                        </div>
                        <div style="display: flex; align-items: end;">
                            <button class="btn" onclick="adicionarIngredientePizza()">‚ûï Adicionar</button>
                        </div>
                    </div>
                </div>
                
                <div id="lista-ingredientes-pizza"></div>
                
                <button class="btn" onclick="salvarPizza()" id="btn-salvar-pizza">üíæ Salvar Pizza</button>
                <button class="btn btn-secondary" onclick="cancelarEdicaoPizza()" id="btn-cancelar-pizza" style="display:none;">‚ùå Cancelar</button>
            </div>
            
            <div class="table-container">
                <table id="tabela-pizzas">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Tamanho</th>
                            <th>Ingredientes</th>
                            <th>Custo Total</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Aba Custos Operacionais - CORRIGIDA E EXPANDIDA -->
        <div id="operacionais" class="tab-content">
            <h2>üè™ Custos Operacionais Mensais</h2>
            
            <div class="help-section">
                <h4>‚ÑπÔ∏è Custos Operacionais</h4>
                <p><strong>Finalidade:</strong> Estes custos s√£o rateados pelo n√∫mero de pizzas vendidas no m√™s para calcular quanto cada pizza "carrega" de custo fixo. O custo por pizza √© somado automaticamente ao custo dos ingredientes e embalagem. <strong>Pizzas/M√™s:</strong> estimativa de quantas pizzas voc√™ vende mensalmente (usado para dividir os custos).</p>
            </div>
            
            <div class="form-group">
                <h3>üí∞ Custos Fixos Mensais</h3>
                <div class="form-row">
                    <div>
                        <label>Sal√°rios e Encargos (R$):</label>
                        <input type="number" id="custo-salarios" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Aluguel (R$):</label>
                        <input type="number" id="custo-aluguel" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Energia El√©trica (R$):</label>
                        <input type="number" id="custo-energia" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>G√°s (R$):</label>
                        <input type="number" id="custo-gas" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label>√Ågua e Esgoto (R$):</label>
                        <input type="number" id="custo-agua" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Telefone/Internet (R$):</label>
                        <input type="number" id="custo-telefone" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Marketing/Publicidade (R$):</label>
                        <input type="number" id="custo-marketing" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Manuten√ß√£o/Limpeza (R$):</label>
                        <input type="number" id="custo-manutencao" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                </div>

                <div class="form-row">
                    <div>
                        <label>Seguro (R$):</label>
                        <input type="number" id="custo-seguro" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Contador/Contabilidade (R$):</label>
                        <input type="number" id="custo-contador" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Licen√ßas/Taxas (R$):</label>
                        <input type="number" id="custo-licencas" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Deprecia√ß√£o Equipamentos (R$):</label>
                        <input type="number" id="custo-depreciacao" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                </div>

                <div class="form-row">
                    <div>
                        <label>Combust√≠vel Entrega (R$):</label>
                        <input type="number" id="custo-combustivel" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Material de Limpeza (R$):</label>
                        <input type="number" id="custo-limpeza" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Uniformes/EPIs (R$):</label>
                        <input type="number" id="custo-uniformes" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Outros Custos (R$):</label>
                        <input type="number" id="custo-outros" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                </div>

                <div class="form-row">
                    <div>
                        <label>
                            Pizzas Vendidas/M√™s:
                            <div class="tooltip">
                                <span class="help-icon">?</span>
                                <span class="tooltiptext">Estimativa de quantas pizzas voc√™ vende por m√™s. Usado para dividir os custos fixos e calcular quanto cada pizza "carrega" de custo operacional.</span>
                            </div>
                        </label>
                        <input type="number" id="pizzas-mes" placeholder="Ex: 1000" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Impostos sobre Vendas (%):</label>
                        <input type="number" id="impostos" step="0.01" placeholder="Ex: 15.5" onchange="calcularCustosOperacionais()">
                    </div>
                </div>
            </div>
            
            <div class="summary-cards">
                <div class="card">
                    <h3>Custo Operacional Total</h3>
                    <div class="value" id="custo-total-mensal">R$ 0,00</div>
                </div>
                <div class="card">
                    <h3>Custo por Pizza</h3>
                    <div class="value" id="custo-por-pizza">R$ 0,00</div>
                </div>
            </div>

            <div class="scenario-simulator">
                <h3>üéØ Simulador de Cen√°rios</h3>
                <div class="form-row">
                    <div>
                        <label>Meta de Lucro Mensal (R$):</label>
                        <input type="number" id="meta-lucro" step="0.01" placeholder="Ex: 15000">
                    </div>
                    <div>
                        <label>Ticket M√©dio Desejado (R$):</label>
                        <input type="number" id="ticket-medio" step="0.01" placeholder="Ex: 35.00">
                    </div>
                    <div>
                        <label>Margem de Lucro Desejada (%):</label>
                        <input type="number" id="margem-desejada" step="0.1" placeholder="Ex: 40" value="40">
                    </div>
                    <div>
                        <label>Dias de Funcionamento/M√™s:</label>
                        <input type="number" id="dias-mes" placeholder="Ex: 26" value="26">
                    </div>
                </div>
                <button class="btn" onclick="simularCenario()">üìä Simular Cen√°rio</button>
                <div id="resultado-simulacao" class="scenario-result"></div>
            </div>
        </div>

        <!-- Aba Delivery Direto -->
        <div id="delivery-direto" class="tab-content">
            <h2>üõµ Precifica√ß√£o Delivery Direto</h2>
            <div class="form-group">
                <div class="form-row">
                    <div>
                        <label>Margem Desejada (%):</label>
                        <input type="number" id="margem-direto" step="0.01" placeholder="Ex: 150" value="150">
                    </div>
                    <div>
                        <label>Taxa de Entrega (R$):</label>
                        <input type="number" id="taxa-entrega" step="0.01" placeholder="Ex: 5.00" value="5.00">
                    </div>
                </div>
                <button class="btn" onclick="calcularPrecosDirecto()">üí∞ Calcular Pre√ßos</button>
            </div>
            
            <div class="table-container">
                <table id="tabela-direto">
                    <thead>
                        <tr>
                            <th>Pizza</th>
                            <th>Tamanho</th>
                            <th>Custo Total</th>
                            <th>Margem (%)</th>
                            <th>Pre√ßo Base</th>
                            <th>Taxa Entrega</th>
                            <th>Pre√ßo Final</th>
                            <th>Lucro</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Aba iFood -->
        <div id="ifood" class="tab-content">
            <h2>üì± Precifica√ß√£o iFood</h2>
            <div class="form-group">
                <div class="form-row">
                    <div>
                        <label>Taxa iFood (%):</label>
                        <input type="number" id="taxa-ifood" step="0.01" placeholder="Ex: 27" value="27">
                    </div>
                    <div>
                        <label>Margem Desejada (%):</label>
                        <input type="number" id="margem-ifood" step="0.01" placeholder="Ex: 150" value="150">
                    </div>
                </div>
                <button class="btn" onclick="calcularPrecosIfood()">üí∞ Calcular Pre√ßos iFood</button>
            </div>
            
            <div class="table-container">
                <table id="tabela-ifood">
                    <thead>
                        <tr>
                            <th>Pizza</th>
                            <th>Tamanho</th>
                            <th>Custo Total</th>
                            <th>Taxa iFood (%)</th>
                            <th>Margem (%)</th>
                            <th>Pre√ßo iFood</th>
                            <th>Lucro L√≠quido</th>
                            <th>Margem Real (%)</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Aba Comparativo -->
        <div id="comparativo" class="tab-content">
            <h2>üìä Comparativo de Canais</h2>
            
            <div class="filters-container">
                <div class="filter-item">
                    <label>Filtrar por Tamanho:</label>
                    <select id="filtro-tamanho" onchange="filtrarComparativo()">
                        <option value="">Todos os tamanhos</option>
                        <option value="Pequena">Pequena</option>
                        <option value="M√©dia">M√©dia</option>
                        <option value="Grande">Grande</option>
                        <option value="Fam√≠lia">Fam√≠lia</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>Ordenar por:</label>
                    <select id="ordenar-por" onchange="filtrarComparativo()">
                        <option value="nome">Nome</option>
                        <option value="diferenca">Diferen√ßa de Lucro</option>
                        <option value="lucro-direto">Lucro Delivery</option>
                        <option value="lucro-ifood">Lucro iFood</option>
                    </select>
                </div>
            </div>

            <button class="btn" onclick="gerarComparativo()">üîÑ Atualizar Comparativo</button>
            
            <div class="table-container">
                <table id="tabela-comparativo">
                    <thead>
                        <tr>
                            <th>Pizza</th>
                            <th>Tamanho</th>
                            <th>Pre√ßo Direto</th>
                            <th>Pre√ßo iFood</th>
                            <th>Lucro Direto</th>
                            <th>Lucro iFood</th>
                            <th>Diferen√ßa</th>
                            <th>Melhor Canal</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Aba Card√°pio -->
        <div id="cardapio" class="tab-content">
            <h2>üìã Card√°pio de Pizzas</h2>
            <div class="alert">
                <strong>üí° Dica:</strong> Este card√°pio √© gerado automaticamente com base nas suas receitas e pre√ßos calculados. 
                Use este formato para apresentar aos clientes.
            </div>
            
            <button class="btn" onclick="gerarCardapio()">üîÑ Atualizar Card√°pio</button>
            <button class="btn btn-export" onclick="imprimirCardapio()">üñ®Ô∏è Imprimir Card√°pio</button>
            
            <div class="cardapio-section" id="cardapio-display">
                <!-- Card√°pio ser√° gerado aqui -->
            </div>
        </div>

        <!-- Aba An√°lises CORRIGIDA -->
        <div id="analises" class="tab-content">
            <h2>üìà An√°lises por Faixas de Margem</h2>
            
            <div class="help-section">
                <h4>‚ÑπÔ∏è An√°lises por Faixas de Margem</h4>
                <p><strong>An√°lise por Rentabilidade:</strong> <strong>Faixa Alta:</strong> pizzas com margem de lucro acima do percentual configurado - mais lucrativas. <strong>Faixa M√©dia:</strong> pizzas com margem intermedi√°ria - equil√≠brio. <strong>Faixa Baixa:</strong> pizzas com margem menor - podem precisar ajuste de pre√ßo. <strong>Margem:</strong> percentual de lucro sobre o pre√ßo de venda (n√£o valor absoluto).</p>
            </div>
            
            <div class="form-group">
                <h3>‚öôÔ∏è Configurar Faixas por Margem de Lucro (%)</h3>
                <div class="form-row">
                    <div>
                        <label>
                            Faixa Alta - Margem acima de (%):
                            <div class="tooltip">
                                <span class="help-icon">?</span>
                                <span class="tooltiptext">Pizzas com margem de lucro acima deste percentual s√£o consideradas muito lucrativas. Ex: 60% - pizzas premium.</span>
                            </div>
                        </label>
                        <input type="number" id="faixa-margem-alta" step="0.1" value="60" onchange="calcularFaixasPorMargem()">
                    </div>
                    <div>
                        <label>
                            Faixa M√©dia - Margem entre (%):
                            <div class="tooltip">
                                <span class="help-icon">?</span>
                                <span class="tooltiptext">Faixa de margem intermedi√°ria. Pizzas com rentabilidade equilibrada.</span>
                            </div>
                        </label>
                        <input type="number" id="faixa-margem-media-min" step="0.1" value="40" onchange="calcularFaixasPorMargem()">
                        <span style="margin: 0 10px;">e</span>
                        <input type="number" id="faixa-margem-media-max" step="0.1" value="60" onchange="calcularFaixasPorMargem()">
                    </div>
                    <div>
                        <label>
                            Faixa Baixa - Margem abaixo de (%):
                            <div class="tooltip">
                                <span class="help-icon">?</span>
                                <span class="tooltiptext">Pizzas com margem baixa. Podem precisar de reajuste de pre√ßo ou redu√ß√£o de custos.</span>
                            </div>
                        </label>
                        <input type="number" id="faixa-margem-baixa" step="0.1" value="40" onchange="calcularFaixasPorMargem()">
                    </div>
                </div>
                <button class="btn" onclick="calcularFaixasPorMargem()">üìä Atualizar An√°lise</button>
            </div>
            
            <div class="faixas-analysis">
                <div class="faixa-item faixa-alta">
                    <h3>üü¢ Margem Alta</h3>
                    <div id="faixa-margem-alta-info">
                        <div class="value" id="faixa-margem-alta-count">0</div>
                        <p>Pizzas nesta faixa</p>
                        <div id="faixa-margem-alta-media">Margem: 0%</div>
                        <div id="faixa-margem-alta-faturamento">Faturamento: R$ 0</div>
                    </div>
                </div>
                <div class="faixa-item faixa-media">
                    <h3>üü° Margem M√©dia</h3>
                    <div id="faixa-margem-media-info">
                        <div class="value" id="faixa-margem-media-count">0</div>
                        <p>Pizzas nesta faixa</p>
                        <div id="faixa-margem-media-media">Margem: 0%</div>
                        <div id="faixa-margem-media-faturamento">Faturamento: R$ 0</div>
                    </div>
                </div>
                <div class="faixa-item faixa-baixa">
                    <h3>üî¥ Margem Baixa</h3>
                    <div id="faixa-margem-baixa-info">
                        <div class="value" id="faixa-margem-baixa-count">0</div>
                        <p>Pizzas nesta faixa</p>
                        <div id="faixa-margem-baixa-media">Margem: 0%</div>
                        <div id="faixa-margem-baixa-faturamento">Faturamento: R$ 0</div>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <h3>üìä Distribui√ß√£o por Faixas de Margem</h3>
                <canvas id="faixasMargensDistribuicaoChart"></canvas>
            </div>

            <div class="chart-container">
                <h3>üí∞ Comparativo de Rentabilidade por Faixa</h3>
                <canvas id="faixasRentabilidadeChart"></canvas>
            </div>

            <div class="alert alert-info">
                <h4>üìã Detalhamento por Faixa de Margem:</h4>
                <div id="detalhamento-faixas-margem">
                    <!-- Detalhamento ser√° gerado aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Calculadora -->
    <div id="calculator-modal" class="calculator-modal">
        <div class="calculator-content">
            <h3>üßÆ Calculadora R√°pida de Produ√ß√£o</h3>
            <div class="form-group">
                <div class="form-row">
                    <div>
                        <label>Pizza:</label>
                        <select id="calc-pizza">
                            <option value="">Selecione uma pizza</option>
                        </select>
                    </div>
                    <div>
                        <label>Quantidade:</label>
                        <input type="number" id="calc-quantidade" placeholder="Ex: 50" min="1">
                    </div>
                </div>
                <button class="btn" onclick="calcularProducao()">üí∞ Calcular</button>
                <button class="btn btn-secondary" onclick="fecharCalculadora()">‚ùå Fechar</button>
            </div>
            <div id="calc-resultado"></div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div id="confirmation-modal" class="confirmation-modal">
        <div class="confirmation-content">
            <h3>üîÑ Aplicar Altera√ß√£o em Massa</h3>
            <div id="confirmation-message"></div>
            <div id="impact-preview"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="confirmarAlteracaoMassa(true)">‚úÖ Sim, aplicar em todas</button>
                <button class="btn btn-secondary" onclick="confirmarAlteracaoMassa(false)">‚ùå N√£o, manter receitas atuais</button>
            </div>
        </div>
    </div>

    <script>
        // Dados globais expandidos para vendas
        let ingredientes = [];
        let pizzas = [];
        let estoque = {};
        let historicoPrecos = {};
        let entradasEstoque = [];
        let vendas = [];
        let produtosExtras = [];
        let metaMensal = 0;
        let custosOperacionais = {
            salarios: 0,
            aluguel: 0,
            energia: 0,
            gas: 0,
            agua: 0,
            telefone: 0,
            marketing: 0,
            manutencao: 0,
            seguro: 0,
            contador: 0,
            licencas: 0,
            depreciacao: 0,
            combustivel: 0,
            limpeza: 0,
            uniformes: 0,
            outros: 0,
            pizzasMes: 0,
            impostos: 0,
            custoTotal: 0,
            custoPorPizza: 0
        };
        let precosDirecto = [];
        let precosIfood = [];
        let ingredientesPizzaAtual = [];
        let editandoPizza = null;
        let historico = [];
        let chartFaixas = null;
        let chartPrecos = null;
        let chartVendas = null;
        let chartVendasPeriodo = null;
        let chartFaixasMargensDistribuicao = null;
        let chartFaixasRentabilidade = null;
        let pendingQuantityChange = null;

        // Configura√ß√£o inicial
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.querySelector('.upload-area');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    importarArquivo({ target: { files: files } });
                }
            });

            // Atalhos de teclado
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    salvarLocal();
                    mostrarToast('Dados salvos!', 'success');
                }
                if (e.key === 'Escape') {
                    fecharCalculadora();
                    fecharModalConfirmacao();
                    cancelarEdicaoPizza();
                }
            });

            // Definir data/hora atual
            document.getElementById('estoque-data').value = new Date().toISOString().split('T')[0];
            document.getElementById('venda-data').value = new Date().toISOString().slice(0, 16);

            // Auto-save
            setInterval(salvarLocal, 30000);
            carregarLocal();
            validarConsistenciaDados();
            atualizarDashboard();
            atualizarSelectVendas();
        });

        // SIMULADOR DE CEN√ÅRIOS - TOTALMENTE FUNCIONAL
        function simularCenario() {
            const metaLucro = parseFloat(document.getElementById('meta-lucro').value) || 0;
            const ticketMedio = parseFloat(document.getElementById('ticket-medio').value) || 0;
            const margemDesejada = parseFloat(document.getElementById('margem-desejada').value) || 40;
            const diasMes = parseInt(document.getElementById('dias-mes').value) || 26;

            if (metaLucro <= 0 && ticketMedio <= 0) {
                mostrarToast('Preencha pelo menos um dos campos para simular!', 'warning');
                return;
            }

            const resultadoDiv = document.getElementById('resultado-simulacao');
            let resultadoHTML = '<h4>üìä Resultado da Simula√ß√£o</h4>';

            // C√°lculos baseados na meta de lucro
            if (metaLucro > 0) {
                const lucroNecessarioDia = metaLucro / diasMes;
                const custosFixosDia = custosOperacionais.custoTotal / diasMes;
                const faturamentoNecessario = metaLucro + custosOperacionais.custoTotal;
                const faturamentoDia = faturamentoNecessario / diasMes;

                if (ticketMedio > 0) {
                    const vendasNecessariasDia = Math.ceil(faturamentoDia / ticketMedio);
                    const vendasNecessariasMes = vendasNecessariasDia * diasMes;

                    resultadoHTML += `
                        <div class="alert alert-success">
                            <h5>üéØ Para atingir R$ ${metaLucro.toFixed(2)} de lucro/m√™s:</h5>
                            <p><strong>Faturamento necess√°rio:</strong> R$ ${faturamentoNecessario.toFixed(2)}/m√™s (R$ ${faturamentoDia.toFixed(2)}/dia)</p>
                            <p><strong>Vendas necess√°rias:</strong> ${vendasNecessariasMes} unidades/m√™s (${vendasNecessariasDia} unidades/dia)</p>
                            <p><strong>Margem de lucro:</strong> ${(metaLucro / faturamentoNecessario * 100).toFixed(1)}%</p>
                        </div>
                    `;
                } else {
                    resultadoHTML += `
                        <div class="alert alert-success">
                            <h5>üéØ Para atingir R$ ${metaLucro.toFixed(2)} de lucro/m√™s:</h5>
                            <p><strong>Faturamento necess√°rio:</strong> R$ ${faturamentoNecessario.toFixed(2)}/m√™s</p>
                            <p><strong>Faturamento/dia:</strong> R$ ${faturamentoDia.toFixed(2)}</p>
                        </div>
                    `;
                }
            }

            // C√°lculos baseados no ticket m√©dio
            if (ticketMedio > 0) {
                const custoMedioPizza = pizzas.length > 0 ? pizzas.reduce((acc, p) => acc + p.custoTotal, 0) / pizzas.length : 10;
                const margemAtual = ((ticketMedio - custoMedioPizza) / ticketMedio) * 100;
                const lucroUnitario = ticketMedio - custoMedioPizza;

                const pizzasNecessariasMeta = metaLucro > 0 ? Math.ceil(metaLucro / lucroUnitario) : 0;
                const diasParaMeta = pizzasNecessariasMeta > 0 ? Math.ceil(pizzasNecessariasMeta / diasMes) : 0;

                resultadoHTML += `
                    <div class="alert alert-info">
                        <h5>üçï An√°lise do Ticket M√©dio de R$ ${ticketMedio.toFixed(2)}:</h5>
                        <p><strong>Custo m√©dio por pizza:</strong> R$ ${custoMedioPizza.toFixed(2)}</p>
                        <p><strong>Lucro por pizza:</strong> R$ ${lucroUnitario.toFixed(2)}</p>
                        <p><strong>Margem atual:</strong> ${margemAtual.toFixed(1)}%</p>
                        ${pizzasNecessariasMeta > 0 ? `
                            <p><strong>Para atingir a meta:</strong> ${pizzasNecessariasMeta} pizzas/m√™s (${diasParaMeta} pizzas/dia)</p>
                        ` : ''}
                    </div>
                `;
            }

            // Recomenda√ß√µes
            resultadoHTML += `
                <div class="alert alert-warning">
                    <h5>üí° Recomenda√ß√µes:</h5>
                    <ul>
                        <li>Mantenha os custos operacionais controlados: R$ ${custosOperacionais.custoPorPizza.toFixed(2)} por pizza</li>
                        <li>Monitore a margem de lucro: mantenha acima de ${margemDesejada}%</li>
                        <li>Controle o ticket m√©dio para maximizar a rentabilidade</li>
                        ${custosOperacionais.custoTotal > metaLucro && metaLucro > 0 ? '<li style="color: #dc3545;"><strong>ATEN√á√ÉO:</strong> Seus custos fixos s√£o maiores que sua meta de lucro!</li>' : ''}
                    </ul>
                </div>
            `;

            resultadoDiv.innerHTML = resultadoHTML;
            resultadoDiv.style.display = 'block';

            mostrarToast('Simula√ß√£o realizada com sucesso!', 'success');
            
            // Adicionar ao hist√≥rico
            historico.push({
                acao: 'simulacao_cenario',
                timestamp: new Date().toISOString(),
                detalhes: `Simula√ß√£o: Meta R$ ${metaLucro}, Ticket R$ ${ticketMedio}, ${diasMes} dias`
            });
        }

        // Fun√ß√µes de toast
        function mostrarToast(mensagem, tipo = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            toast.textContent = mensagem;
            
            // Cores por tipo
            if (tipo === 'success') toast.style.background = '#28a745';
            if (tipo === 'warning') toast.style.background = '#ffc107';
            if (tipo === 'danger') toast.style.background = '#dc3545';
            if (tipo === 'info') toast.style.background = '#17a2b8';
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Fun√ß√£o de valida√ß√£o de consist√™ncia
        function validarConsistenciaDados() {
            let inconsistencias = [];

            // Verificar IDs √∫nicos
            const idsIngredientes = ingredientes.map(ing => ing.id);
            const idsUnicos = [...new Set(idsIngredientes)];
            if (idsIngredientes.length !== idsUnicos.length) {
                inconsistencias.push('IDs duplicados encontrados em ingredientes');
            }

            // Verificar relacionamentos pizza -> ingrediente
            pizzas.forEach(pizza => {
                if (pizza.ingredientes) {
                    pizza.ingredientes.forEach(ing => {
                        const ingredienteExiste = ingredientes.find(i => i.id === ing.ingredienteId);
                        if (!ingredienteExiste) {
                            inconsistencias.push(`Pizza "${pizza.nome}" referencia ingrediente inexistente (ID: ${ing.ingredienteId})`);
                        }
                    });
                }
            });

            // Verificar se custos por pizza est√£o corretos
            ingredientes.forEach(ing => {
                const custoCalculado = ing.preco * ing.quantidadePadrao;
                if (Math.abs((ing.custoPorPizza || 0) - custoCalculado) > 0.01) {
                    ing.custoPorPizza = custoCalculado;
                }
            });

            // Sincronizar estoques √≥rf√£os
            Object.keys(estoque).forEach(id => {
                const ingredienteExiste = ingredientes.find(ing => ing.id == id);
                if (!ingredienteExiste) {
                    delete estoque[id];
                }
            });

            if (inconsistencias.length > 0) {
                console.warn('Inconsist√™ncias encontradas e corrigidas:', inconsistencias);
                salvarLocal();
            }
        }

        // Fun√ß√µes de navega√ß√£o
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'dashboard') {
                atualizarDashboard();
            }
            if (tabName === 'vendas') {
                atualizarSelectVendas();
                atualizarTabelaVendas();
                atualizarResumoVendas();
                filtrarVendasPorPeriodo();
            }
            if (tabName === 'estoque') {
                atualizarTabelaEstoque();
                atualizarSelectEstoque();
                gerarGraficoPrecos();
            }
            if (tabName === 'operacionais') {
                preencherCustosOperacionais();
            }
            if (tabName === 'delivery-direto') {
                if (precosDirecto.length > 0) {
                    atualizarTabelaDirecto();
                }
            }
            if (tabName === 'ifood') {
                if (precosIfood.length > 0) {
                    atualizarTabelaIfood();
                }
            }
            if (tabName === 'comparativo') {
                gerarComparativo();
            }
            if (tabName === 'cardapio') {
                gerarCardapio();
            }
            if (tabName === 'analises') {
                setTimeout(calcularFaixasPorMargem, 100);
            }
        }

        // VENDAS FUNCIONAIS COMPLETAS
        function atualizarSelectVendas() {
            const selectPizza = document.getElementById('venda-pizza');
            selectPizza.innerHTML = '<option value="">Selecione uma pizza</option>';
            
            pizzas.forEach(pizza => {
                const option = document.createElement('option');
                option.value = pizza.id;
                option.textContent = `${pizza.nome} - ${pizza.tamanho}`;
                selectPizza.appendChild(option);
            });

            const selectExtra = document.getElementById('venda-produto-extra');
            selectExtra.innerHTML = '<option value="">Selecione um produto</option>';
            
            produtosExtras.forEach(produto => {
                const option = document.createElement('option');
                option.value = produto.id;
                option.textContent = `${produto.nome} - R$ ${produto.preco.toFixed(2)}`;
                selectExtra.appendChild(option);
            });
        }

        function atualizarProdutoSelect() {
            const tipo = document.getElementById('tipo-produto').value;
            const pizzaContainer = document.getElementById('produto-pizza-container');
            const extraContainer = document.getElementById('produto-extra-container');
            
            if (tipo === 'pizza') {
                pizzaContainer.style.display = 'block';
                extraContainer.style.display = 'none';
            } else {
                pizzaContainer.style.display = 'none';
                extraContainer.style.display = 'block';
            }
        }

        function registrarVenda() {
            const tipo = document.getElementById('tipo-produto').value;
            const quantidade = parseInt(document.getElementById('venda-quantidade').value) || 1;
            const canal = document.getElementById('venda-canal').value;
            const data = document.getElementById('venda-data').value || new Date().toISOString();
            const desconto = parseFloat(document.getElementById('venda-desconto').value) || 0;
            const observacoes = document.getElementById('venda-obs').value;

            let produto, precoUnitario, custoUnitario;

            if (tipo === 'pizza') {
                const pizzaId = parseInt(document.getElementById('venda-pizza').value);
                if (!pizzaId) {
                    mostrarToast('Selecione uma pizza!', 'warning');
                    return;
                }

                const pizza = pizzas.find(p => p.id === pizzaId);
                if (!pizza) return;

                produto = `${pizza.nome} (${pizza.tamanho})`;
                custoUnitario = pizza.custoTotal;

                // Determinar pre√ßo baseado no canal
                if (canal === 'direto') {
                    const precoDirecto = precosDirecto.find(p => p.id === pizzaId);
                    precoUnitario = precoDirecto ? precoDirecto.precoFinal : pizza.custoTotal * 2.5;
                } else if (canal === 'ifood') {
                    const precoIfood = precosIfood.find(p => p.id === pizzaId);
                    precoUnitario = precoIfood ? precoIfood.precoIfood : pizza.custoTotal * 3;
                } else {
                    precoUnitario = pizza.custoTotal * 2.2; // Balc√£o
                }

                // Deduzir estoque
                pizza.ingredientes.forEach(ing => {
                    if (estoque[ing.ingredienteId]) {
                        estoque[ing.ingredienteId].quantidade -= ing.quantidade * quantidade;
                        if (estoque[ing.ingredienteId].quantidade < 0) {
                            estoque[ing.ingredienteId].quantidade = 0;
                        }
                    }
                });

            } else {
                const extraId = parseInt(document.getElementById('venda-produto-extra').value);
                if (!extraId) {
                    mostrarToast('Selecione um produto!', 'warning');
                    return;
                }

                const extra = produtosExtras.find(p => p.id === extraId);
                if (!extra) return;

                produto = extra.nome;
                precoUnitario = extra.preco;
                custoUnitario = extra.custo;
            }

            const valorTotal = (precoUnitario * quantidade) - desconto;
            const custoTotal = custoUnitario * quantidade;
            const lucro = valorTotal - custoTotal;
            const margem = valorTotal > 0 ? (lucro / valorTotal) * 100 : 0;

            const venda = {
                id: Date.now(),
                data,
                produto,
                tipo,
                quantidade,
                canal,
                precoUnitario,
                desconto,
                valorTotal,
                custoTotal,
                lucro,
                margem,
                observacoes
            };

            vendas.push(venda);
            atualizarTabelaVendas();
            atualizarResumoVendas();
            atualizarDashboard();
            atualizarTabelaEstoque();
            limparFormularioVenda();
            salvarLocal();
            mostrarToast('Venda registrada com sucesso!', 'success');

            // Adicionar ao hist√≥rico
            historico.push({
                acao: 'venda_registrada',
                timestamp: new Date().toISOString(),
                detalhes: `Venda: ${produto} x${quantidade} - R$ ${valorTotal.toFixed(2)}`
            });
        }

        function atualizarTabelaVendas() {
            const tbody = document.querySelector('#tabela-vendas tbody');
            tbody.innerHTML = '';

            // Ordenar vendas por data (mais recentes primeiro)
            const vendasOrdenadas = [...vendas].sort((a, b) => new Date(b.data) - new Date(a.data));

            vendasOrdenadas.forEach(venda => {
                const row = tbody.insertRow();
                const dataFormatada = new Date(venda.data).toLocaleString('pt-BR');
                
                row.innerHTML = `
                    <td>${dataFormatada}</td>
                    <td>${venda.produto}</td>
                    <td>${venda.quantidade}</td>
                    <td>${venda.canal}</td>
                    <td>R$ ${venda.precoUnitario.toFixed(2)}</td>
                    <td>R$ ${venda.desconto.toFixed(2)}</td>
                    <td>R$ ${venda.valorTotal.toFixed(2)}</td>
                    <td>R$ ${venda.custoTotal.toFixed(2)}</td>
                    <td>R$ ${venda.lucro.toFixed(2)}</td>
                    <td>${venda.margem.toFixed(1)}%</td>
                    <td>
                        <button class="btn btn-danger" onclick="removerVenda(${venda.id})" style="padding: 5px 10px; font-size: 12px;">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        function limparFormularioVenda() {
            document.getElementById('venda-pizza').value = '';
            document.getElementById('venda-produto-extra').value = '';
            document.getElementById('venda-quantidade').value = '1';
            document.getElementById('venda-desconto').value = '0';
            document.getElementById('venda-obs').value = '';
            document.getElementById('venda-data').value = new Date().toISOString().slice(0, 16);
        }

        function removerVenda(id) {
            if (confirm('Tem certeza que deseja remover esta venda?')) {
                vendas = vendas.filter(venda => venda.id !== id);
                atualizarTabelaVendas();
                atualizarResumoVendas();
                atualizarDashboard();
                salvarLocal();
                mostrarToast('Venda removida!', 'success');
            }
        }

        function atualizarResumoVendas() {
            const periodoSelecionado = document.getElementById('filtro-periodo').value;
            let vendasFiltradas = vendas;

            // Aplicar filtro de per√≠odo
            if (periodoSelecionado === 'hoje') {
                const hoje = new Date().toDateString();
                vendasFiltradas = vendas.filter(venda => new Date(venda.data).toDateString() === hoje);
            } else if (periodoSelecionado === 'semana') {
                const hoje = new Date();
                const inicioSemana = new Date(hoje.setDate(hoje.getDate() - hoje.getDay()));
                vendasFiltradas = vendas.filter(venda => new Date(venda.data) >= inicioSemana);
            } else if (periodoSelecionado === 'mes') {
                const hoje = new Date();
                const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                vendasFiltradas = vendas.filter(venda => new Date(venda.data) >= inicioMes);
            }

            const faturamento = vendasFiltradas.reduce((acc, v) => acc + v.valorTotal, 0);
            const custos = vendasFiltradas.reduce((acc, v) => acc + v.custoTotal, 0);
            const lucro = faturamento - custos;
            const margem = faturamento > 0 ? (lucro / faturamento) * 100 : 0;

            document.getElementById('resumo-faturamento').textContent = `R$ ${faturamento.toFixed(2)}`;
            document.getElementById('resumo-lucro').textContent = `R$ ${lucro.toFixed(2)}`;
            document.getElementById('resumo-custos').textContent = `R$ ${custos.toFixed(2)}`;
            document.getElementById('resumo-margem').textContent = `${margem.toFixed(1)}%`;
        }

        function filtrarVendasPorPeriodo() {
            atualizarResumoVendas();
            const periodo = document.getElementById('filtro-periodo').value;
            
            if (periodo === 'personalizado') {
                document.getElementById('periodo-personalizado').style.display = 'flex';
            } else {
                document.getElementById('periodo-personalizado').style.display = 'none';
            }
        }

        function aplicarFiltroPeriodo() {
            const dataInicio = document.getElementById('data-inicio').value;
            const dataFim = document.getElementById('data-fim').value;
            
            if (!dataInicio || !dataFim) {
                mostrarToast('Selecione as datas de in√≠cio e fim!', 'warning');
                return;
            }
            
            atualizarResumoVendas();
        }

        function atualizarMetaMensal() {
            metaMensal = parseFloat(document.getElementById('meta-mensal').value) || 0;
            
            // Calcular vendas do m√™s atual
            const hoje = new Date();
            const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            const vendasMes = vendas.filter(venda => new Date(venda.data) >= inicioMes);
            const faturamentoMes = vendasMes.reduce((acc, v) => acc + v.valorTotal, 0);
            
            const percentual = metaMensal > 0 ? (faturamentoMes / metaMensal) * 100 : 0;
            
            document.getElementById('meta-atual').textContent = `R$ ${faturamentoMes.toFixed(2)}`;
            document.getElementById('meta-objetivo').textContent = `R$ ${metaMensal.toFixed(2)}`;
            document.getElementById('meta-percentual').textContent = `${Math.min(percentual, 100).toFixed(1)}%`;
            document.getElementById('progress-meta').style.width = `${Math.min(percentual, 100)}%`;
            
            salvarLocal();
        }

        function adicionarProdutoExtra() {
            const nome = document.getElementById('extra-nome').value;
            const categoria = document.getElementById('extra-categoria').value;
            const custo = parseFloat(document.getElementById('extra-custo').value) || 0;
            const preco = parseFloat(document.getElementById('extra-preco').value) || 0;

            if (!nome || preco <= 0) {
                mostrarToast('Preencha o nome e pre√ßo do produto!', 'warning');
                return;
            }

            const margem = preco > 0 ? ((preco - custo) / preco) * 100 : 0;

            const produto = {
                id: Date.now(),
                nome,
                categoria,
                custo,
                preco,
                margem
            };

            produtosExtras.push(produto);
            atualizarTabelaProdutosExtras();
            atualizarSelectVendas();
            limparFormularioProdutoExtra();
            salvarLocal();
            mostrarToast('Produto extra adicionado!', 'success');
        }

        function atualizarTabelaProdutosExtras() {
            const tbody = document.querySelector('#tabela-produtos-extras tbody');
            tbody.innerHTML = '';

            produtosExtras.forEach(produto => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${produto.nome}</td>
                    <td>${produto.categoria}</td>
                    <td>R$ ${produto.custo.toFixed(2)}</td>
                    <td>R$ ${produto.preco.toFixed(2)}</td>
                    <td>${produto.margem.toFixed(1)}%</td>
                    <td>
                        <button class="btn btn-danger" onclick="removerProdutoExtra(${produto.id})" style="padding: 5px 10px; font-size: 12px;">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        function limparFormularioProdutoExtra() {
            document.getElementById('extra-nome').value = '';
            document.getElementById('extra-custo').value = '';
            document.getElementById('extra-preco').value = '';
            document.getElementById('margem-extra-preview').textContent = '0%';
        }

        function calcularMargemExtra() {
            const custo = parseFloat(document.getElementById('extra-custo').value) || 0;
            const preco = parseFloat(document.getElementById('extra-preco').value) || 0;
            const margem = preco > 0 ? ((preco - custo) / preco) * 100 : 0;
            
            document.getElementById('margem-extra-preview').textContent = `${margem.toFixed(1)}%`;
        }

        function removerProdutoExtra(id) {
            if (confirm('Tem certeza que deseja remover este produto?')) {
                produtosExtras = produtosExtras.filter(produto => produto.id !== id);
                atualizarTabelaProdutosExtras();
                atualizarSelectVendas();
                salvarLocal();
                mostrarToast('Produto extra removido!', 'success');
            }
        }

        function filtrarVendas() {
            const busca = document.getElementById('search-vendas').value.toLowerCase();
            const tbody = document.querySelector('#tabela-vendas tbody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const texto = row.textContent.toLowerCase();
                row.style.display = texto.includes(busca) ? '' : 'none';
            });
        }

        // INGREDIENTES - SINCRONIZADOS COM ESTOQUE
        function adicionarIngrediente() {
            const nome = document.getElementById('ingrediente-nome').value;
            const unidade = document.getElementById('ingrediente-unidade').value;
            const preco = parseFloat(document.getElementById('ingrediente-preco').value);
            const quantidadePadrao = parseFloat(document.getElementById('ingrediente-quantidade').value);
            const estoqueMinimo = parseFloat(document.getElementById('ingrediente-estoque-min').value) || 0;
            const estoqueInicial = parseFloat(document.getElementById('ingrediente-estoque-inicial').value) || 0;

            if (!nome || !preco || !quantidadePadrao) {
                mostrarToast('Preencha todos os campos obrigat√≥rios!', 'warning');
                return;
            }

            const custoPorPizza = preco * quantidadePadrao;
            const id = Date.now();
            
            const ingrediente = {
                id,
                nome,
                unidade,
                preco,
                quantidadePadrao,
                estoqueMinimo,
                custoPorPizza
            };

            ingredientes.push(ingrediente);

            // SINCRONIZAR COM ESTOQUE
            if (estoqueInicial > 0) {
                estoque[id] = {
                    quantidade: estoqueInicial,
                    ultimaEntrada: new Date().toISOString().split('T')[0],
                    estoqueMinimo: estoqueMinimo
                };

                historicoPrecos[id] = [{
                    data: new Date().toISOString().split('T')[0],
                    preco: preco,
                    quantidade: estoqueInicial
                }];
            } else {
                // Criar entrada de estoque zerada para manter consist√™ncia
                estoque[id] = {
                    quantidade: 0,
                    ultimaEntrada: null,
                    estoqueMinimo: estoqueMinimo
                };
            }

            atualizarTabelaIngredientes();
            atualizarSelectIngredientes();
            atualizarSelectEstoque();
            atualizarTabelaEstoque(); // Importante: atualizar estoque tamb√©m
            limparFormularioIngrediente();
            atualizarDashboard();
            salvarLocal();
            mostrarToast('Ingrediente adicionado!', 'success');

            historico.push({
                acao: 'ingrediente_adicionado',
                timestamp: new Date().toISOString(),
                detalhes: `${nome}: R$ ${preco.toFixed(2)}/${unidade}, ${quantidadePadrao.toFixed(3)}/${unidade} por pizza`
            });
        }

        function atualizarTabelaIngredientes() {
            const tbody = document.querySelector('#tabela-ingredientes tbody');
            tbody.innerHTML = '';

            ingredientes.forEach(ing => {
                const row = tbody.insertRow();
                row.setAttribute('data-id', ing.id);
                
                const estoqueAtual = estoque[ing.id]?.quantidade || 0;
                if (ing.custoPorPizza > 5.0) {
                    row.classList.add('high-cost');
                } else if (estoqueAtual <= 0) {
                    row.classList.add('stock-critical');
                } else if (estoqueAtual <= (estoque[ing.id]?.estoqueMinimo || 0)) {
                    row.classList.add('stock-low');
                }

                const historico = historicoPrecos[ing.id] || [];
                let precoMin = ing.preco;
                let precoMax = ing.preco;
                
                if (historico.length > 0) {
                    precoMin = Math.min(...historico.map(h => h.preco));
                    precoMax = Math.max(...historico.map(h => h.preco));
                }

                let tendencia = 'stable';
                if (historico.length >= 2) {
                    const ultimoPreco = historico[historico.length - 1].preco;
                    const penultimoPreco = historico[historico.length - 2].preco;
                    if (ultimoPreco > penultimoPreco) tendencia = 'up';
                    else if (ultimoPreco < penultimoPreco) tendencia = 'down';
                }
                
                row.innerHTML = `
                    <td>${ing.nome}</td>
                    <td>${ing.unidade}</td>
                    <td>R$ ${ing.preco.toFixed(2)}
                        <span class="tendencia ${tendencia}">
                            ${tendencia === 'up' ? 'üìà' : tendencia === 'down' ? 'üìâ' : '‚û°Ô∏è'}
                        </span>
                    </td>
                    <td>
                        <div class="preco-historico">
                            <span class="preco-min">Min: R$ ${precoMin.toFixed(2)}</span>
                            <span class="preco-max">Max: R$ ${precoMax.toFixed(2)}</span>
                        </div>
                    </td>
                    <td>${ing.quantidadePadrao.toFixed(3)} ${ing.unidade}</td>
                    <td><span class="custo-calculado">R$ ${ing.custoPorPizza.toFixed(3)}</span></td>
                    <td>${estoqueAtual.toFixed(3)} ${ing.unidade}</td>
                    <td>
                        <button class="btn btn-edit" onclick="editarIngrediente(${ing.id})" title="Editar">‚úèÔ∏è</button>
                        <button class="btn btn-danger" onclick="removerIngrediente(${ing.id})" title="Remover">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        function atualizarSelectIngredientes() {
            const select = document.getElementById('select-ingrediente');
            select.innerHTML = '<option value="">Selecione um ingrediente</option>';
            
            ingredientes.forEach(ing => {
                const estoqueAtual = estoque[ing.id]?.quantidade || 0;
                const option = document.createElement('option');
                option.value = ing.id;
                option.textContent = `${ing.nome} (${ing.unidade}) ${estoqueAtual <= 0 ? '‚ö†Ô∏è SEM ESTOQUE' : ''}`;
                if (estoqueAtual <= 0) {
                    option.style.color = '#dc3545';
                }
                select.appendChild(option);
            });
        }

        function atualizarSelectEstoque() {
            const select = document.getElementById('estoque-ingrediente');
            select.innerHTML = '<option value="">Selecione um ingrediente</option>';
            
            ingredientes.forEach(ing => {
                const option = document.createElement('option');
                option.value = ing.id;
                option.textContent = `${ing.nome} (${ing.unidade})`;
                select.appendChild(option);
            });
        }

        function limparFormularioIngrediente() {
            document.getElementById('ingrediente-nome').value = '';
            document.getElementById('ingrediente-preco').value = '';
            document.getElementById('ingrediente-quantidade').value = '';
            document.getElementById('ingrediente-estoque-min').value = '';
            document.getElementById('ingrediente-estoque-inicial').value = '';
        }

        function editarIngrediente(id) {
            const ingrediente = ingredientes.find(ing => ing.id === id);
            if (!ingrediente) return;

            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (!row) return;

            row.classList.add('editing');
            
            row.innerHTML = `
                <td><input type="text" value="${ingrediente.nome}" id="edit-nome-${id}"></td>
                <td>
                    <select id="edit-unidade-${id}">
                        <option value="kg" ${ingrediente.unidade === 'kg' ? 'selected' : ''}>kg</option>
                        <option value="g" ${ingrediente.unidade === 'g' ? 'selected' : ''}>g</option>
                        <option value="l" ${ingrediente.unidade === 'l' ? 'selected' : ''}>l</option>
                        <option value="ml" ${ingrediente.unidade === 'ml' ? 'selected' : ''}>ml</option>
                        <option value="unidade" ${ingrediente.unidade === 'unidade' ? 'selected' : ''}>unidade</option>
                    </select>
                </td>
                <td><input type="number" value="${ingrediente.preco}" step="0.01" id="edit-preco-${id}"></td>
                <td>-</td>
                <td><input type="number" value="${ingrediente.quantidadePadrao}" step="0.001" id="edit-quantidade-${id}"></td>
                <td>-</td>
                <td>-</td>
                <td>
                    <button class="btn" onclick="salvarEdicaoIngrediente(${id})">üíæ</button>
                    <button class="btn btn-secondary" onclick="cancelarEdicaoIngrediente(${id})">‚ùå</button>
                </td>
            `;
        }

        function salvarEdicaoIngrediente(id) {
            const nome = document.getElementById(`edit-nome-${id}`).value;
            const unidade = document.getElementById(`edit-unidade-${id}`).value;
            const preco = parseFloat(document.getElementById(`edit-preco-${id}`).value);
            const quantidadePadrao = parseFloat(document.getElementById(`edit-quantidade-${id}`).value);

            if (!nome || !preco || !quantidadePadrao) {
                mostrarToast('Preencha todos os campos!', 'warning');
                return;
            }

            const ingrediente = ingredientes.find(ing => ing.id === id);
            if (ingrediente) {
                const quantidadeAnterior = ingrediente.quantidadePadrao;
                const mudancaQuantidade = Math.abs(quantidadePadrao - quantidadeAnterior) > 0.001;

                const precoAnterior = ingrediente.preco;
                const variacao = ((preco - precoAnterior) / precoAnterior) * 100;

                ingrediente.nome = nome;
                ingrediente.unidade = unidade;
                ingrediente.preco = preco;
                ingrediente.quantidadePadrao = quantidadePadrao;
                ingrediente.custoPorPizza = preco * quantidadePadrao;
                if (Math.abs(variacao) > 1) {
                    if (!historicoPrecos[id]) {
                        historicoPrecos[id] = [];
                    }
                    historicoPrecos[id].push({
                        data: new Date().toISOString().split('T')[0],
                        preco: preco,
                        quantidade: estoque[id]?.quantidade || 0
                    });

                    mostrarToast(`Pre√ßo do ${nome} ${variacao > 0 ? 'aumentou' : 'diminuiu'} ${Math.abs(variacao).toFixed(1)}%`, 'info');
                }

                if (mudancaQuantidade) {
                    atualizarTabelaIngredientes();
                    atualizarSelectIngredientes();
                    atualizarSelectEstoque();
                    mostrarModalConfirmacao(id, quantidadePadrao);
                } else {
                    atualizarTabelaIngredientes();
                    atualizarSelectIngredientes();
                    atualizarSelectEstoque();
                    recalcularCustosPizzas();
                    atualizarTabelaPizzas();
                    salvarLocal();
                    mostrarToast('Ingrediente atualizado!', 'success');
                }
            }
        }

        function cancelarEdicaoIngrediente(id) {
            atualizarTabelaIngredientes();
        }

        function removerIngrediente(id) {
            if (confirm('Tem certeza que deseja remover este ingrediente?')) {
                ingredientes = ingredientes.filter(ing => ing.id !== id);
                delete estoque[id];
                delete historicoPrecos[id];
                atualizarTabelaIngredientes();
                atualizarSelectIngredientes();
                atualizarSelectEstoque();
                atualizarTabelaEstoque();
                atualizarDashboard();
                salvarLocal();
                mostrarToast('Ingrediente removido!', 'success');
            }
        }

        // ESTOQUE TOTALMENTE SINCRONIZADO
        function atualizarTabelaEstoque() {
            const tbody = document.querySelector('#tabela-estoque tbody');
            tbody.innerHTML = '';

            ingredientes.forEach(ing => {
                const estoqueAtual = estoque[ing.id] || { quantidade: 0, ultimaEntrada: null, estoqueMinimo: ing.estoqueMinimo || 0 };
                
                let status = 'Normal';
                let statusClass = 'color: #28a745;';
                
                if (estoqueAtual.quantidade <= 0) {
                    status = 'Sem Estoque';
                    statusClass = 'color: #dc3545; font-weight: bold;';
                } else if (estoqueAtual.quantidade <= estoqueAtual.estoqueMinimo) {
                    status = 'Estoque Baixo';
                    statusClass = 'color: #ffc107; font-weight: bold;';
                }

                const historico = historicoPrecos[ing.id] || [];
                let precoMin = ing.preco;
                let precoMax = ing.preco;
                let precoMedia = ing.preco;
                
                if (historico.length > 0) {
                    precoMin = Math.min(...historico.map(h => h.preco));
                    precoMax = Math.max(...historico.map(h => h.preco));
                    precoMedia = historico.reduce((acc, h) => acc + h.preco, 0) / historico.length;
                }

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${ing.nome}</td>
                    <td>${estoqueAtual.quantidade.toFixed(3)} ${ing.unidade}</td>
                    <td>R$ ${ing.preco.toFixed(2)}</td>
                    <td>
                        <div class="preco-historico">
                            <span class="preco-min">Min: R$ ${precoMin.toFixed(2)}</span>
                            <span class="preco-media">M√©dia: R$ ${precoMedia.toFixed(2)}</span>
                            <span class="preco-max">Max: R$ ${precoMax.toFixed(2)}</span>
                        </div>
                    </td>
                    <td>${estoqueAtual.ultimaEntrada || '-'}</td>
                    <td style="${statusClass}">${status}</td>
                    <td>
                        <button class="btn btn-estoque" onclick="ajustarEstoque(${ing.id})" style="padding: 5px 10px; font-size: 12px;">‚öñÔ∏è Ajustar</button>
                    </td>
                `;
            });
        }

        function registrarEntradaEstoque() {
            const ingredienteId = parseInt(document.getElementById('estoque-ingrediente').value);
            const quantidade = parseFloat(document.getElementById('estoque-quantidade').value);
            const preco = parseFloat(document.getElementById('estoque-preco').value);
            const data = document.getElementById('estoque-data').value;
            const fornecedor = document.getElementById('estoque-fornecedor').value;
            const observacoes = document.getElementById('estoque-obs').value;

            if (!ingredienteId || !quantidade || !preco || !data) {
                mostrarToast('Preencha todos os campos obrigat√≥rios!', 'warning');
                return;
            }

            const ingrediente = ingredientes.find(ing => ing.id === ingredienteId);
            if (!ingrediente) return;

            const entrada = {
                id: Date.now(),
                ingredienteId,
                quantidade,
                preco,
                data,
                fornecedor,
                observacoes,
                custoTotal: quantidade * preco
            };

            entradasEstoque.push(entrada);

            // Atualizar estoque
            if (!estoque[ingredienteId]) {
                estoque[ingredienteId] = { quantidade: 0, ultimaEntrada: null, estoqueMinimo: 0 };
            }
            estoque[ingredienteId].quantidade += quantidade;
            estoque[ingredienteId].ultimaEntrada = data;

            // Atualizar hist√≥rico de pre√ßos
            if (!historicoPrecos[ingredienteId]) {
                historicoPrecos[ingredienteId] = [];
            }
            historicoPrecos[ingredienteId].push({
                data,
                preco,
                quantidade
            });

            // Atualizar pre√ßo do ingrediente com m√©dia ponderada se a varia√ß√£o for significativa
            const variacaoPreco = Math.abs(preco - ingrediente.preco) / ingrediente.preco * 100;
            if (variacaoPreco > 5) { // Se varia√ß√£o > 5%
                ingrediente.preco = preco; // Atualizar para o pre√ßo mais recente
                ingrediente.custoPorPizza = preco * ingrediente.quantidadePadrao;
                recalcularCustosPizzas();
                atualizarTabelaPizzas();
            }

            // Limpar formul√°rio
            document.getElementById('estoque-ingrediente').value = '';
            document.getElementById('estoque-quantidade').value = '';
            document.getElementById('estoque-preco').value = '';
            document.getElementById('estoque-fornecedor').value = '';
            document.getElementById('estoque-obs').value = '';

            atualizarTabelaEstoque();
            atualizarTabelaIngredientes();
            atualizarDashboard();
            salvarLocal();
            mostrarToast('Entrada de estoque registrada!', 'success');

            historico.push({
                acao: 'entrada_estoque',
                timestamp: new Date().toISOString(),
                detalhes: `${ingrediente.nome}: +${quantidade} ${ingrediente.unidade} - R$ ${preco.toFixed(2)}`
            });
        }

        function ajustarEstoque(id) {
            const ingrediente = ingredientes.find(ing => ing.id === id);
            const estoqueAtual = estoque[id]?.quantidade || 0;
            
            const novaQuantidade = prompt(`Ajustar estoque de ${ingrediente.nome}\n\nEstoque atual: ${estoqueAtual.toFixed(3)} ${ingrediente.unidade}\n\nDigite a nova quantidade:`);
            
            if (novaQuantidade !== null) {
                const quantidade = parseFloat(novaQuantidade);
                if (!isNaN(quantidade) && quantidade >= 0) {
                    if (!estoque[id]) {
                        estoque[id] = { quantidade: 0, ultimaEntrada: null, estoqueMinimo: 0 };
                    }
                    estoque[id].quantidade = quantidade;
                    atualizarTabelaEstoque();
                    atualizarTabelaIngredientes();
                    atualizarDashboard();
                    salvarLocal();
                    mostrarToast('Estoque ajustado!', 'success');

                    historico.push({
                        acao: 'ajuste_estoque',
                        timestamp: new Date().toISOString(),
                        detalhes: `${ingrediente.nome}: ${estoqueAtual.toFixed(3)} ‚Üí ${quantidade.toFixed(3)} ${ingrediente.unidade}`
                    });
                }
            }
        }

        function filtrarEstoque() {
            const busca = document.getElementById('search-estoque').value.toLowerCase();
            const tbody = document.querySelector('#tabela-estoque tbody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const texto = row.textContent.toLowerCase();
                row.style.display = texto.includes(busca) ? '' : 'none';
            });
        }

        function gerarGraficoPrecos() {
            if (chartPrecos) {
                chartPrecos.destroy();
            }
            
            const ctx = document.getElementById('precosChart');
            if (!ctx || Object.keys(historicoPrecos).length === 0) return;
            
            // Pegar os ingredientes com mais entradas
            const ingredientesComHistorico = Object.keys(historicoPrecos)
                .filter(id => historicoPrecos[id].length > 1)
                .slice(0, 5); // Top 5
            
            if (ingredientesComHistorico.length === 0) return;
            
            const datasets = ingredientesComHistorico.map((id, index) => {
                const ingrediente = ingredientes.find(ing => ing.id == id);
                const historico = historicoPrecos[id];
                const cores = ['#ff6384', '#36a2eb', '#cc65fe', '#ffce56', '#4bc0c0'];
                
                return {
                    label: ingrediente ? ingrediente.nome : `Ingrediente ${id}`,
                    data: historico.map(h => ({ x: h.data, y: h.preco })),
                    borderColor: cores[index % cores.length],
                    backgroundColor: cores[index % cores.length] + '20',
                    tension: 0.1
                };
            });
            
            chartPrecos = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evolu√ß√£o de Pre√ßos dos Ingredientes'
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                parser: 'YYYY-MM-DD',
                                displayFormats: {
                                    day: 'DD/MM'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Data'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Pre√ßo (R$)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        // RECEITAS DE PIZZAS
        function preencherQuantidadePadrao() {
            const selectIngrediente = document.getElementById('select-ingrediente');
            const inputQuantidade = document.getElementById('quantidade-ingrediente');
            
            if (selectIngrediente.value) {
                const ingredienteId = parseInt(selectIngrediente.value);
                const ingrediente = ingredientes.find(ing => ing.id === ingredienteId);
                
                if (ingrediente && ingrediente.quantidadePadrao) {
                    inputQuantidade.value = ingrediente.quantidadePadrao.toFixed(3);
                    inputQuantidade.classList.add('auto-fill');
                    
                    const estoqueAtual = estoque[ingredienteId]?.quantidade || 0;
                    if (estoqueAtual <= 0) {
                        mostrarToast(`Aten√ß√£o: ${ingrediente.nome} sem estoque!`, 'warning');
                    }
                    
                    setTimeout(() => {
                        inputQuantidade.classList.remove('auto-fill');
                    }, 2000);
                }
            }
        }

        function adicionarIngredientePizza() {
            const ingredienteId = parseInt(document.getElementById('select-ingrediente').value);
            const quantidade = parseFloat(document.getElementById('quantidade-ingrediente').value);

            if (!ingredienteId || !quantidade) {
                mostrarToast('Selecione um ingrediente e informe a quantidade!', 'warning');
                return;
            }

            const ingrediente = ingredientes.find(ing => ing.id === ingredienteId);
            if (!ingrediente) return;

            const estoqueAtual = estoque[ingredienteId]?.quantidade || 0;
            if (estoqueAtual <= 0) {
                const confirmar = confirm(`${ingrediente.nome} est√° sem estoque! Deseja continuar mesmo assim?`);
                if (!confirmar) return;
            }

            const ingredientePizza = {
                ingredienteId,
                nome: ingrediente.nome,
                quantidade,
                custoUnitario: ingrediente.preco,
                custoTotal: ingrediente.preco * quantidade
            };

            ingredientesPizzaAtual.push(ingredientePizza);
            atualizarListaIngredientesPizza();
            
            document.getElementById('select-ingrediente').value = '';
            document.getElementById('quantidade-ingrediente').value = '';
            document.getElementById('quantidade-ingrediente').classList.remove('auto-fill');
        }

        function atualizarListaIngredientesPizza() {
            const lista = document.getElementById('lista-ingredientes-pizza');
            lista.innerHTML = '<h4>Ingredientes Adicionados:</h4>';

            let custoTotal = 0;
            let semEstoque = [];

            ingredientesPizzaAtual.forEach((ing, index) => {
                custoTotal += ing.custoTotal;
                const estoqueAtual = estoque[ing.ingredienteId]?.quantidade || 0;
                
                if (estoqueAtual <= 0) {
                    semEstoque.push(ing.nome);
                }

                const div = document.createElement('div');
                div.style.cssText = `display: flex; justify-content: space-between; align-items: center; padding: 10px; 
                    background: ${estoqueAtual <= 0 ? '#f8d7da' : '#f8f9fa'}; margin: 5px 0; border-radius: 5px;`;
                div.innerHTML = `
                    <span>${ing.nome}: ${ing.quantidade.toFixed(3)} - R$ ${ing.custoTotal.toFixed(3)} 
                        ${estoqueAtual <= 0 ? '‚ö†Ô∏è SEM ESTOQUE' : ''}
                    </span>
                    <button class="btn btn-danger" onclick="removerIngredientePizza(${index})" style="padding: 5px 10px; font-size: 12px;">üóëÔ∏è</button>
                `;
                lista.appendChild(div);
            });

            const totalDiv = document.createElement('div');
            totalDiv.style.cssText = 'font-weight: bold; font-size: 1.2em; color: #28a745; margin-top: 10px;';
            totalDiv.innerHTML = `<strong>Custo Total: R$ ${custoTotal.toFixed(3)}</strong>`;
            lista.appendChild(totalDiv);

            if (semEstoque.length > 0) {
                const alertDiv = document.createElement('div');
                alertDiv.style.cssText = 'color: #dc3545; font-weight: bold; margin-top: 10px;';
                alertDiv.innerHTML = `‚ö†Ô∏è Ingredientes sem estoque: ${semEstoque.join(', ')}`;
                lista.appendChild(alertDiv);
            }
        }

        function removerIngredientePizza(index) {
            ingredientesPizzaAtual.splice(index, 1);
            atualizarListaIngredientesPizza();
        }

        function salvarPizza() {
            const nome = document.getElementById('pizza-nome').value;
            const tamanho = document.getElementById('pizza-tamanho').value;

            if (!nome || ingredientesPizzaAtual.length === 0) {
                mostrarToast('Preencha o nome da pizza e adicione pelo menos um ingrediente!', 'warning');
                return;
            }

            const custoIngredientes = ingredientesPizzaAtual.reduce((total, ing) => total + ing.custoTotal, 0);
            const custoEmbalagem = 0.50;
            const custoTotal = custoIngredientes + custoEmbalagem + custosOperacionais.custoPorPizza;

            if (editandoPizza) {
                const pizza = pizzas.find(p => p.id === editandoPizza);
                if (pizza) {
                    pizza.nome = nome;
                    pizza.tamanho = tamanho;
                    pizza.ingredientes = [...ingredientesPizzaAtual];
                    pizza.custoIngredientes = custoIngredientes;
                    pizza.custoEmbalagem = custoEmbalagem;
                    pizza.custoOperacional = custosOperacionais.custoPorPizza;
                    pizza.custoTotal = custoTotal;
                }
                cancelarEdicaoPizza();
                mostrarToast('Pizza atualizada!', 'success');
            } else {
                const pizza = {
                    id: Date.now(),
                    nome,
                    tamanho,
                    ingredientes: [...ingredientesPizzaAtual],
                    custoIngredientes,
                    custoEmbalagem,
                    custoOperacional: custosOperacionais.custoPorPizza,
                    custoTotal
                };
                pizzas.push(pizza);
                limparFormularioPizza();
                mostrarToast('Pizza criada!', 'success');
            }

            atualizarTabelaPizzas();
            atualizarSelectCalculadora();
            atualizarSelectVendas();
            atualizarDashboard();
            salvarLocal();

            historico.push({
                acao: editandoPizza ? 'pizza_editada' : 'pizza_criada',
                timestamp: new Date().toISOString(),
                detalhes: `${nome} (${tamanho}): R$ ${custoTotal.toFixed(2)}`
            });
        }

        function atualizarTabelaPizzas() {
            const tbody = document.querySelector('#tabela-pizzas tbody');
            tbody.innerHTML = '';

            pizzas.forEach(pizza => {
                const row = tbody.insertRow();
                const ingredientesStr = pizza.ingredientes.map(ing => `${ing.nome} (${ing.quantidade.toFixed(3)})`).join(', ');
                
                const ingredientesSemEstoque = pizza.ingredientes.filter(ing => {
                    const estoqueAtual = estoque[ing.ingredienteId]?.quantidade || 0;
                    return estoqueAtual <= 0;
                });

                if (pizza.custoTotal > 15.0) {
                    row.classList.add('high-cost');
                } else if (ingredientesSemEstoque.length > 0) {
                    row.classList.add('stock-critical');
                }
                
                row.innerHTML = `
                    <td>${pizza.nome} ${ingredientesSemEstoque.length > 0 ? '‚ö†Ô∏è' : ''}</td>
                    <td>${pizza.tamanho}</td>
                    <td title="${ingredientesStr}">${ingredientesStr.length > 50 ? ingredientesStr.substring(0, 50) + '...' : ingredientesStr}</td>
                    <td>R$ ${pizza.custoTotal.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-edit" onclick="editarPizza(${pizza.id})" title="Editar">‚úèÔ∏è</button>
                        <button class="btn btn-danger" onclick="removerPizza(${pizza.id})" title="Remover">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        function cancelarEdicaoPizza() {
            editandoPizza = null;
            limparFormularioPizza();
            document.getElementById('btn-salvar-pizza').textContent = 'üíæ Salvar Pizza';
            document.getElementById('btn-cancelar-pizza').style.display = 'none';
        }

        function limparFormularioPizza() {
            document.getElementById('pizza-nome').value = '';
            ingredientesPizzaAtual = [];
            atualizarListaIngredientesPizza();
        }

        function editarPizza(id) {
            const pizza = pizzas.find(p => p.id === id);
            if (!pizza) return;

            editandoPizza = id;
            
            document.getElementById('pizza-nome').value = pizza.nome;
            document.getElementById('pizza-tamanho').value = pizza.tamanho;
            ingredientesPizzaAtual = [...pizza.ingredientes];
            
            atualizarListaIngredientesPizza();
            
            document.getElementById('btn-salvar-pizza').textContent = 'üíæ Atualizar Pizza';
            document.getElementById('btn-cancelar-pizza').style.display = 'inline-block';
            
            document.getElementById('receitas').scrollIntoView({ behavior: 'smooth' });
        }

        function removerPizza(id) {
            if (confirm('Tem certeza que deseja remover esta pizza?')) {
                pizzas = pizzas.filter(pizza => pizza.id !== id);
                atualizarTabelaPizzas();
                atualizarSelectCalculadora();
                atualizarSelectVendas();
                atualizarDashboard();
                salvarLocal();
                mostrarToast('Pizza removida!', 'success');
            }
        }

        function filtrarIngredientes() {
            const busca = document.getElementById('search-ingredientes').value.toLowerCase();
            const tbody = document.querySelector('#tabela-ingredientes tbody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const texto = row.textContent.toLowerCase();
                row.style.display = texto.includes(busca) ? '' : 'none';
            });
        }

        function filtrarPizzas() {
            const busca = document.getElementById('search-pizzas').value.toLowerCase();
            const tbody = document.querySelector('#tabela-pizzas tbody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const texto = row.textContent.toLowerCase();
                row.style.display = texto.includes(busca) ? '' : 'none';
            });
        }

        // CUSTOS OPERACIONAIS EXPANDIDOS E FUNCIONAIS
        function calcularCustosOperacionais() {
            custosOperacionais.salarios = parseFloat(document.getElementById('custo-salarios').value) || 0;
            custosOperacionais.aluguel = parseFloat(document.getElementById('custo-aluguel').value) || 0;
            custosOperacionais.energia = parseFloat(document.getElementById('custo-energia').value) || 0;
            custosOperacionais.gas = parseFloat(document.getElementById('custo-gas').value) || 0;
            custosOperacionais.agua = parseFloat(document.getElementById('custo-agua').value) || 0;
            custosOperacionais.telefone = parseFloat(document.getElementById('custo-telefone').value) || 0;
            custosOperacionais.marketing = parseFloat(document.getElementById('custo-marketing').value) || 0;
            custosOperacionais.manutencao = parseFloat(document.getElementById('custo-manutencao').value) || 0;
            custosOperacionais.seguro = parseFloat(document.getElementById('custo-seguro').value) || 0;
            custosOperacionais.contador = parseFloat(document.getElementById('custo-contador').value) || 0;
            custosOperacionais.licencas = parseFloat(document.getElementById('custo-licencas').value) || 0;
            custosOperacionais.depreciacao = parseFloat(document.getElementById('custo-depreciacao').value) || 0;
            custosOperacionais.combustivel = parseFloat(document.getElementById('custo-combustivel').value) || 0;
            custosOperacionais.limpeza = parseFloat(document.getElementById('custo-limpeza').value) || 0;
            custosOperacionais.uniformes = parseFloat(document.getElementById('custo-uniformes').value) || 0;
            custosOperacionais.outros = parseFloat(document.getElementById('custo-outros').value) || 0;
            custosOperacionais.pizzasMes = parseInt(document.getElementById('pizzas-mes').value) || 1;
            custosOperacionais.impostos = parseFloat(document.getElementById('impostos').value) || 0;

            custosOperacionais.custoTotal = custosOperacionais.salarios + custosOperacionais.aluguel + 
                custosOperacionais.energia + custosOperacionais.gas + custosOperacionais.agua + 
                custosOperacionais.telefone + custosOperacionais.marketing + custosOperacionais.manutencao + 
                custosOperacionais.seguro + custosOperacionais.contador + custosOperacionais.licencas + 
                custosOperacionais.depreciacao + custosOperacionais.combustivel + custosOperacionais.limpeza + 
                custosOperacionais.uniformes + custosOperacionais.outros;

            custosOperacionais.custoPorPizza = custosOperacionais.custoTotal / custosOperacionais.pizzasMes;

            document.getElementById('custo-total-mensal').textContent = `R$ ${custosOperacionais.custoTotal.toFixed(2)}`;
            document.getElementById('custo-por-pizza').textContent = `R$ ${custosOperacionais.custoPorPizza.toFixed(2)}`;

            // Atualizar custos das pizzas
            pizzas.forEach(pizza => {
                pizza.custoOperacional = custosOperacionais.custoPorPizza;
                pizza.custoTotal = pizza.custoIngredientes + pizza.custoEmbalagem + pizza.custoOperacional;
            });
            
            atualizarTabelaPizzas();
            salvarLocal();
        }

        function preencherCustosOperacionais() {
            document.getElementById('custo-salarios').value = custosOperacionais.salarios || 0;
            document.getElementById('custo-aluguel').value = custosOperacionais.aluguel || 0;
            document.getElementById('custo-energia').value = custosOperacionais.energia || 0;
            document.getElementById('custo-gas').value = custosOperacionais.gas || 0;
            document.getElementById('custo-agua').value = custosOperacionais.agua || 0;
            document.getElementById('custo-telefone').value = custosOperacionais.telefone || 0;
            document.getElementById('custo-marketing').value = custosOperacionais.marketing || 0;
            document.getElementById('custo-manutencao').value = custosOperacionais.manutencao || 0;
            document.getElementById('custo-seguro').value = custosOperacionais.seguro || 0;
            document.getElementById('custo-contador').value = custosOperacionais.contador || 0;
            document.getElementById('custo-licencas').value = custosOperacionais.licencas || 0;
            document.getElementById('custo-depreciacao').value = custosOperacionais.depreciacao || 0;
            document.getElementById('custo-combustivel').value = custosOperacionais.combustivel || 0;
            document.getElementById('custo-limpeza').value = custosOperacionais.limpeza || 0;
            document.getElementById('custo-uniformes').value = custosOperacionais.uniformes || 0;
            document.getElementById('custo-outros').value = custosOperacionais.outros || 0;
            document.getElementById('pizzas-mes').value = custosOperacionais.pizzasMes || 0;
            document.getElementById('impostos').value = custosOperacionais.impostos || 0;
            
            document.getElementById('custo-total-mensal').textContent = `R$ ${custosOperacionais.custoTotal.toFixed(2)}`;
            document.getElementById('custo-por-pizza').textContent = `R$ ${custosOperacionais.custoPorPizza.toFixed(2)}`;
        }

        // PRECIFICA√á√ÉO
        function calcularPrecosDirecto() {
            if (pizzas.length === 0) {
                mostrarToast('Adicione algumas pizzas primeiro!', 'warning');
                return;
            }

            const margem = parseFloat(document.getElementById('margem-direto').value) || 150;
            const taxaEntrega = parseFloat(document.getElementById('taxa-entrega').value) || 5.00;

            precosDirecto = pizzas.map(pizza => {
                const margemDecimal = margem / 100;
                const precoBase = pizza.custoTotal * (1 + margemDecimal);
                const precoFinal = precoBase + taxaEntrega;
                const lucro = precoFinal - pizza.custoTotal;

                return {
                    id: pizza.id,
                    pizza: pizza.nome,
                    tamanho: pizza.tamanho,
                    custoTotal: pizza.custoTotal,
                    margem: margem,
                    precoBase: precoBase,
                    taxaEntrega: taxaEntrega,
                    precoFinal: precoFinal,
                    lucro: lucro
                };
            });

            atualizarTabelaDirecto();
            salvarLocal();
            mostrarToast('Pre√ßos delivery calculados!', 'success');
        }

        function atualizarTabelaDirecto() {
            const tbody = document.querySelector('#tabela-direto tbody');
            tbody.innerHTML = '';

            precosDirecto.forEach(item => {
                const row = tbody.insertRow();
                row.setAttribute('data-id', item.id);
                
                const margemPorcentual = (item.lucro / item.precoFinal) * 100;
                if (margemPorcentual < 30) {
                    row.classList.add('low-margin');
                } else if (margemPorcentual > 60) {
                    row.classList.add('high-margin');
                }
                
                row.innerHTML = `
                    <td>${item.pizza}</td>
                    <td>${item.tamanho}</td>
                    <td>R$ ${item.custoTotal.toFixed(2)}</td>
                    <td>${item.margem.toFixed(1)}%</td>
                    <td>R$ ${item.precoBase.toFixed(2)}</td>
                    <td>R$ ${item.taxaEntrega.toFixed(2)}</td>
                    <td>R$ ${item.precoFinal.toFixed(2)}</td>
                    <td>R$ ${item.lucro.toFixed(2)} (${margemPorcentual.toFixed(1)}%)</td>
                    <td>
                        <button class="btn btn-edit" onclick="editarPrecoDirecto(${item.id})" title="Editar">‚úèÔ∏è</button>
                    </td>
                `;
            });
        }

        function calcularPrecosIfood() {
            if (pizzas.length === 0) {
                mostrarToast('Adicione algumas pizzas primeiro!', 'warning');
                return;
            }

            const taxaIfood = parseFloat(document.getElementById('taxa-ifood').value) || 27;
            const margem = parseFloat(document.getElementById('margem-ifood').value) || 150;

            precosIfood = pizzas.map(pizza => {
                const taxaDecimal = taxaIfood / 100;
                const margemDecimal = margem / 100;
                
                const precoIfood = (pizza.custoTotal / (1 - taxaDecimal)) * (1 + margemDecimal);
                const lucroLiquido = precoIfood - pizza.custoTotal - (precoIfood * taxaDecimal);
                const margemReal = (lucroLiquido / precoIfood) * 100;

                return {
                    id: pizza.id,
                    pizza: pizza.nome,
                    tamanho: pizza.tamanho,
                    custoTotal: pizza.custoTotal,
                    taxaIfood: taxaIfood,
                    margem: margem,
                    precoIfood: precoIfood,
                    lucroLiquido: lucroLiquido,
                    margemReal: margemReal
                };
            });

            atualizarTabelaIfood();
            salvarLocal();
            mostrarToast('Pre√ßos iFood calculados!', 'success');
        }

        function atualizarTabelaIfood() {
            const tbody = document.querySelector('#tabela-ifood tbody');
            tbody.innerHTML = '';

            precosIfood.forEach(item => {
                const row = tbody.insertRow();
                row.setAttribute('data-id', item.id);
                
                if (item.margemReal < 20) {
                    row.classList.add('low-margin');
                } else if (item.margemReal > 40) {
                    row.classList.add('high-margin');
                }
                
                row.innerHTML = `
                    <td>${item.pizza}</td>
                    <td>${item.tamanho}</td>
                    <td>R$ ${item.custoTotal.toFixed(2)}</td>
                    <td>${item.taxaIfood.toFixed(1)}%</td>
                    <td>${item.margem.toFixed(1)}%</td>
                    <td>R$ ${item.precoIfood.toFixed(2)}</td>
                    <td>R$ ${item.lucroLiquido.toFixed(2)}</td>
                    <td>${item.margemReal.toFixed(1)}%</td>
                    <td>
                        <button class="btn btn-edit" onclick="editarPrecoIfood(${item.id})" title="Editar">‚úèÔ∏è</button>
                    </td>
                `;
            });
        }

        function editarPrecoDirecto(id) {
            mostrarToast('Funcionalidade de edi√ß√£o em desenvolvimento!', 'info');
        }

        function editarPrecoIfood(id) {
            mostrarToast('Funcionalidade de edi√ß√£o em desenvolvimento!', 'info');
        }

        // COMPARATIVO
        function gerarComparativo(filtroTamanho = '', ordenacao = 'nome') {
            if (precosDirecto.length === 0 || precosIfood.length === 0) {
                mostrarToast('Calcule os pre√ßos primeiro!', 'warning');
                return;
            }

            const tbody = document.querySelector('#tabela-comparativo tbody');
            tbody.innerHTML = '';

            let dadosComparativo = [];

            pizzas.forEach(pizza => {
                const precoDirectoItem = precosDirecto.find(p => p.pizza === pizza.nome && p.tamanho === pizza.tamanho);
                const precoIfoodItem = precosIfood.find(p => p.pizza === pizza.nome && p.tamanho === pizza.tamanho);

                if (precoDirectoItem && precoIfoodItem) {
                    const diferenca = precoDirectoItem.lucro - precoIfoodItem.lucroLiquido;
                    const melhorCanal = diferenca > 0 ? 'Delivery Direto' : 'iFood';

                    dadosComparativo.push({
                        pizza: pizza.nome,
                        tamanho: pizza.tamanho,
                        precoDirecto: precoDirectoItem.precoFinal,
                        precoIfood: precoIfoodItem.precoIfood,
                        lucroDirecto: precoDirectoItem.lucro,
                        lucroIfood: precoIfoodItem.lucroLiquido,
                        diferenca: diferenca,
                        melhorCanal: melhorCanal
                    });
                }
            });

            if (filtroTamanho) {
                dadosComparativo = dadosComparativo.filter(item => item.tamanho === filtroTamanho);
            }

            dadosComparativo.sort((a, b) => {
                switch (ordenacao) {
                    case 'diferenca':
                        return Math.abs(b.diferenca) - Math.abs(a.diferenca);
                    case 'lucro-direto':
                        return b.lucroDirecto - a.lucroDirecto;
                    case 'lucro-ifood':
                        return b.lucroIfood - a.lucroIfood;
                    default:
                        return a.pizza.localeCompare(b.pizza);
                }
            });

            dadosComparativo.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.pizza}</td>
                    <td>${item.tamanho}</td>
                    <td>R$ ${item.precoDirecto.toFixed(2)}</td>
                    <td>R$ ${item.precoIfood.toFixed(2)}</td>
                    <td>R$ ${item.lucroDirecto.toFixed(2)}</td>
                    <td>R$ ${item.lucroIfood.toFixed(2)}</td>
                    <td style="color: ${item.diferenca > 0 ? 'green' : 'red'}">R$ ${Math.abs(item.diferenca).toFixed(2)}</td>
                    <td style="font-weight: bold; color: ${item.diferenca > 0 ? 'green' : 'blue'}">${item.melhorCanal}</td>
                `;
            });

            mostrarToast('Comparativo atualizado!', 'success');
        }

        function filtrarComparativo() {
            const filtroTamanho = document.getElementById('filtro-tamanho').value;
            const ordenacao = document.getElementById('ordenar-por').value;
            gerarComparativo(filtroTamanho, ordenacao);
        }

        // CARD√ÅPIO
        function gerarCardapio() {
            const cardapioDisplay = document.getElementById('cardapio-display');
            
            if (pizzas.length === 0) {
                cardapioDisplay.innerHTML = '<div class="alert alert-warning">Nenhuma pizza cadastrada ainda.</div>';
                return;
            }

            const tamanhos = ['Pequena', 'M√©dia', 'Grande', 'Fam√≠lia'];
            let cardapioHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h1>üçï CARD√ÅPIO DE PIZZAS</h1>
                    <p style="color: #666; margin-top: 10px;">Atualizado em ${new Date().toLocaleDateString('pt-BR')}</p>
                </div>
            `;

            tamanhos.forEach(tamanho => {
                const pizzasDoTamanho = pizzas.filter(pizza => pizza.tamanho === tamanho);
                
                if (pizzasDoTamanho.length > 0) {
                    cardapioHTML += `<div class="tamanho-group">`;
                    cardapioHTML += `<div class="tamanho-title">PIZZA ${tamanho.toUpperCase()}</div>`;
                    
                    pizzasDoTamanho.forEach(pizza => {
                        const precoDirecto = precosDirecto.find(p => p.pizza === pizza.nome && p.tamanho === pizza.tamanho);
                        const precoIfood = precosIfood.find(p => p.pizza === pizza.nome && p.tamanho === pizza.tamanho);
                        
                        const ingredientesStr = pizza.ingredientes.map(ing => ing.nome).join(', ');
                        
                        // Verificar se h√° ingredientes sem estoque
                        const semEstoque = pizza.ingredientes.some(ing => {
                            const estoqueAtual = estoque[ing.ingredienteId]?.quantidade || 0;
                            return estoqueAtual <= 0;
                        });
                        
                        cardapioHTML += `
                            <div class="pizza-item" style="${semEstoque ? 'opacity: 0.6;' : ''}">
                                <div>
                                    <div class="pizza-name">${pizza.nome} ${semEstoque ? '(Indispon√≠vel)' : ''}</div>
                                    <div class="pizza-ingredients">${ingredientesStr}</div>
                                </div>
                                <div class="pizza-prices">
                                    ${precoDirecto && !semEstoque ? `<div class="price-direto">Delivery: R$ ${precoDirecto.precoFinal.toFixed(2)}</div>` : ''}
                                    ${precoIfood && !semEstoque ? `<div class="price-ifood">iFood: R$ ${precoIfood.precoIfood.toFixed(2)}</div>` : ''}
                                    ${semEstoque ? '<div style="color: #dc3545; font-weight: bold;">Sem Estoque</div>' : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    cardapioHTML += `</div>`;
                }
            });

            cardapioDisplay.innerHTML = cardapioHTML;
            mostrarToast('Card√°pio atualizado!', 'success');
        }

        function imprimirCardapio() {
            const cardapioContent = document.getElementById('cardapio-display').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Card√°pio de Pizzas</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .tamanho-group { margin-bottom: 30px; page-break-inside: avoid; }
                        .tamanho-title { font-size: 1.5em; font-weight: bold; color: #007bff; margin-bottom: 15px; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
                        .pizza-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
                        .pizza-name { font-weight: 600; color: #333; }
                        .pizza-ingredients { font-size: 0.9em; color: #666; margin-top: 5px; }
                        .pizza-prices { text-align: right; }
                        .price-direto { color: #28a745; font-weight: bold; }
                        .price-ifood { color: #007bff; font-weight: bold; }
                    </style>
                </head>
                <body>${cardapioContent}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // AN√ÅLISES POR MARGEM
        function calcularFaixasPorMargem() {
            if (precosDirecto.length === 0) {
                mostrarToast('Calcule os pre√ßos primeiro!', 'warning');
                return;
            }

            const faixaAltaMin = parseFloat(document.getElementById('faixa-margem-alta').value);
            const faixaMediaMax = parseFloat(document.getElementById('faixa-margem-media-max').value);
            const faixaMediaMin = parseFloat(document.getElementById('faixa-margem-media-min').value);

            const faixas = {
                alta: [],
                media: [],
                baixa: []
            };

            precosDirecto.forEach(p => {
                const margem = (p.lucro / p.precoFinal) * 100;
                
                if (margem > faixaAltaMin) {
                    faixas.alta.push({...p, margem});
                } else if (margem >= faixaMediaMin && margem <= faixaMediaMax) {
                    faixas.media.push({...p, margem});
                } else {
                    faixas.baixa.push({...p, margem});
                }
            });

            ['alta', 'media', 'baixa'].forEach(faixa => {
                const pizzas = faixas[faixa];
                const count = pizzas.length;
                const margemMedia = count > 0 ? pizzas.reduce((acc, p) => acc + p.margem, 0) / count : 0;
                const faturamentoEstimado = pizzas.reduce((acc, p) => acc + p.precoFinal, 0) * 30;

                document.getElementById(`faixa-margem-${faixa}-count`).textContent = count;
                document.getElementById(`faixa-margem-${faixa}-media`).textContent = `Margem: ${margemMedia.toFixed(1)}%`;
                document.getElementById(`faixa-margem-${faixa}-faturamento`).textContent = `Faturamento: R$ ${faturamentoEstimado.toFixed(0)}`;
            });

            gerarGraficosFaixasMargem(faixas);
            gerarDetalhamentoFaixasMargem(faixas);
            mostrarToast('An√°lise por margem atualizada!', 'success');
        }

        function gerarGraficosFaixasMargem(faixas) {
            if (chartFaixasMargensDistribuicao) {
                chartFaixasMargensDistribuicao.destroy();
            }
            
            const ctxDist = document.getElementById('faixasMargensDistribuicaoChart');
            if (ctxDist) {
                chartFaixasMargensDistribuicao = new Chart(ctxDist, {
                    type: 'doughnut',
                    data: {
                        labels: ['Alta Margem', 'Margem M√©dia', 'Baixa Margem'],
                        datasets: [{
                            data: [faixas.alta.length, faixas.media.length, faixas.baixa.length],
                            backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                            borderColor: ['#1e7e34', '#e0a800', '#c82333'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Distribui√ß√£o de Pizzas por Faixa de Margem'
                            }
                        }
                    }
                });
            }

            if (chartFaixasRentabilidade) {
                chartFaixasRentabilidade.destroy();
            }
            
            const ctxRent = document.getElementById('faixasRentabilidadeChart');
            if (ctxRent) {
                const rentabilidadeData = [
                    faixas.alta.length > 0 ? faixas.alta.reduce((acc, p) => acc + p.margem, 0) / faixas.alta.length : 0,
                    faixas.media.length > 0 ? faixas.media.reduce((acc, p) => acc + p.margem, 0) / faixas.media.length : 0,
                    faixas.baixa.length > 0 ? faixas.baixa.reduce((acc, p) => acc + p.margem, 0) / faixas.baixa.length : 0
                ];

                chartFaixasRentabilidade = new Chart(ctxRent, {
                    type: 'bar',
                    data: {
                        labels: ['Alta Margem', 'Margem M√©dia', 'Baixa Margem'],
                        datasets: [{
                            label: 'Margem M√©dia (%)',
                            data: rentabilidadeData,
                            backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                            borderColor: ['#1e7e34', '#e0a800', '#c82333'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Rentabilidade M√©dia por Faixa de Margem'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toFixed(1) + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function gerarDetalhamentoFaixasMargem(faixas) {
            const container = document.getElementById('detalhamento-faixas-margem');
            let html = '';

            ['alta', 'media', 'baixa'].forEach(faixa => {
                const pizzas = faixas[faixa];
                const cor = faixa === 'alta' ? '#28a745' : faixa === 'media' ? '#ffc107' : '#dc3545';
                const nome = faixa === 'alta' ? 'Alta' : faixa === 'media' ? 'M√©dia' : 'Baixa';

                html += `
                    <div style="margin: 20px 0; padding: 15px; border-left: 4px solid ${cor}; background: #f8f9fa;">
                        <h5 style="color: ${cor};">Margem ${nome} (${pizzas.length} pizzas):</h5>
                        ${pizzas.map(p => `
                            <span style="display: inline-block; margin: 2px 5px; padding: 3px 8px; background: ${cor}20; border-radius: 12px; font-size: 0.9em;">
                                ${p.pizza} (${p.tamanho}) - ${p.margem.toFixed(1)}%
                            </span>
                        `).join('')}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // DASHBOARD
        function atualizarDashboard() {
            document.getElementById('kpi-ingredientes').textContent = ingredientes.length;
            document.getElementById('kpi-pizzas').textContent = pizzas.length;
            
            // KPIs de vendas de hoje
            const hoje = new Date();
            const inicioHoje = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
            const vendasHoje = vendas.filter(venda => {
                const dataVenda = new Date(venda.data);
                return dataVenda >= inicioHoje;
            });
            
            const faturamentoHoje = vendasHoje.reduce((acc, v) => acc + v.valorTotal, 0);
            const lucroHoje = vendasHoje.reduce((acc, v) => acc + v.lucro, 0);
            const margemHoje = faturamentoHoje > 0 ? (lucroHoje / faturamentoHoje) * 100 : 0;
            const ticketMedio = vendasHoje.length > 0 ? faturamentoHoje / vendasHoje.length : 0;
            
            document.getElementById('kpi-faturamento-hoje').textContent = `R$ ${faturamentoHoje.toFixed(2)}`;
            document.getElementById('kpi-lucro-hoje').textContent = `R$ ${lucroHoje.toFixed(2)}`;
            document.getElementById('kpi-margem-hoje').textContent = `${margemHoje.toFixed(1)}%`;
            document.getElementById('kpi-ticket-medio').textContent = `R$ ${ticketMedio.toFixed(2)}`;
            
            // KPIs de estoque
            const ingredientesComEstoque = Object.keys(estoque).filter(id => estoque[id].quantidade > 0).length;
            document.getElementById('kpi-estoque').textContent = ingredientesComEstoque;
            
            const alertasEstoque = Object.keys(estoque).filter(id => {
                const est = estoque[id];
                return est.quantidade <= est.estoqueMinimo || est.quantidade <= 0;
            }).length;
            document.getElementById('kpi-alertas').textContent = alertasEstoque;
            
            // Atualizar meta mensal
            atualizarMetaMensal();
            
            gerarGraficoVendas();
            gerarSugestoes();
        }

        function gerarGraficoVendas() {
            if (chartVendas) {
                chartVendas.destroy();
            }
            
            const ctx = document.getElementById('vendasChart');
            if (!ctx || vendas.length === 0) return;
            
            // Vendas dos √∫ltimos 7 dias
            const dados = [];
            const labels = [];
            
            for (let i = 6; i >= 0; i--) {
                const data = new Date();
                data.setDate(data.getDate() - i);
                const dataStr = data.toISOString().split('T')[0];
                labels.push(data.toLocaleDateString('pt-BR', { weekday: 'short', day: 'numeric' }));
                
                const vendasDia = vendas.filter(venda => {
                    return venda.data.startsWith(dataStr);
                });
                
                const faturamentoDia = vendasDia.reduce((acc, v) => acc + v.valorTotal, 0);
                dados.push(faturamentoDia);
            }
            
            chartVendas = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Faturamento (R$)',
                        data: dados,
                        borderColor: '#28a745',
                        backgroundColor: '#28a74520',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Faturamento dos √öltimos 7 Dias'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }

        function gerarSugestoes() {
            const container = document.getElementById('suggestions-list');
            container.innerHTML = '';
            
            const estoqueBaixo = Object.keys(estoque).filter(id => {
                const est = estoque[id];
                return est.quantidade <= est.estoqueMinimo && est.quantidade > 0;
            });
            
            if (estoqueBaixo.length > 0) {
                const nomes = estoqueBaixo.map(id => ingredientes.find(ing => ing.id == id)?.nome).filter(Boolean);
                container.innerHTML += `
                    <div class="suggestion-item">
                        <div class="suggestion-icon warning">‚ö†Ô∏è</div>
                        <div>
                            <strong>Estoque baixo:</strong> 
                            ${nomes.join(', ')} est√£o com estoque abaixo do m√≠nimo recomendado.
                        </div>
                    </div>
                `;
            }
            
            const semEstoque = Object.keys(estoque).filter(id => estoque[id].quantidade <= 0);
            if (semEstoque.length > 0) {
                const nomes = semEstoque.map(id => ingredientes.find(ing => ing.id == id)?.nome).filter(Boolean);
                container.innerHTML += `
                    <div class="suggestion-item">
                        <div class="suggestion-icon warning">üö®</div>
                        <div>
                            <strong>Sem estoque:</strong> 
                            ${nomes.join(', ')} est√£o sem estoque! Urgente reposi√ß√£o.
                        </div>
                    </div>
                `;
            }

            if (vendas.length > 0) {
                const hoje = new Date();
                const ontem = new Date(hoje.getTime() - 24 * 60 * 60 * 1000);
                const vendasOntem = vendas.filter(v => new Date(v.data) >= ontem && new Date(v.data) < hoje);
                const vendasHoje = vendas.filter(v => new Date(v.data) >= hoje);
                
                if (vendasOntem.length > 0 && vendasHoje.length === 0) {
                    container.innerHTML += `
                        <div class="suggestion-item">
                            <div class="suggestion-icon info">üìä</div>
                            <div>
                                <strong>Nenhuma venda hoje:</strong> 
                                Considere verificar a opera√ß√£o ou registrar vendas pendentes.
                            </div>
                        </div>
                    `;
                }
            }
        }

        // CALCULADORA R√ÅPIDA
        function abrirCalculadora() {
            if (pizzas.length === 0) {
                mostrarToast('Cadastre algumas pizzas primeiro!', 'warning');
                return;
            }
            atualizarSelectCalculadora();
            document.getElementById('calculator-modal').style.display = 'block';
        }

        function fecharCalculadora() {
            document.getElementById('calculator-modal').style.display = 'none';
            document.getElementById('calc-resultado').innerHTML = '';
        }

        function atualizarSelectCalculadora() {
            const select = document.getElementById('calc-pizza');
            select.innerHTML = '<option value="">Selecione uma pizza</option>';
            
            pizzas.forEach(pizza => {
                const option = document.createElement('option');
                option.value = pizza.id;
                option.textContent = `${pizza.nome} - ${pizza.tamanho}`;
                select.appendChild(option);
            });
        }

        function calcularProducao() {
            const pizzaId = parseInt(document.getElementById('calc-pizza').value);
            const quantidade = parseInt(document.getElementById('calc-quantidade').value);
            
            if (!pizzaId || !quantidade) {
                mostrarToast('Selecione uma pizza e informe a quantidade!', 'warning');
                return;
            }
            
            const pizza = pizzas.find(p => p.id === pizzaId);
            const precoDirecto = precosDirecto.find(p => p.id === pizzaId);
            const precoIfood = precosIfood.find(p => p.id === pizzaId);
            
            if (!pizza) return;
            
            const custoTotal = pizza.custoTotal * quantidade;
            const receitaDirecto = precoDirecto ? precoDirecto.precoFinal * quantidade : 0;
            const receitaIfood = precoIfood ? precoIfood.precoIfood * quantidade : 0;
            const lucroDirecto = receitaDirecto - custoTotal;
            const lucroIfood = receitaIfood - custoTotal - (receitaIfood * 0.27);
            
            let alertaEstoque = '';
            let podeProducir = true;
            
            pizza.ingredientes.forEach(ing => {
                const necessario = ing.quantidade * quantidade;
                const disponivel = estoque[ing.ingredienteId]?.quantidade || 0;
                
                if (disponivel < necessario) {
                    podeProducir = false;
                    alertaEstoque += `<p style="color: #dc3545;"><strong>${ing.nome}:</strong> Necess√°rio ${necessario.toFixed(3)}, dispon√≠vel ${disponivel.toFixed(3)} ${ingredientes.find(i => i.id === ing.ingredienteId)?.unidade}</p>`;
                }
            });
            
            document.getElementById('calc-resultado').innerHTML = `
                <div class="alert ${podeProducir ? 'alert-success' : 'alert-warning'}">
                    <h4>üìä Resultado para ${quantidade}x ${pizza.nome} (${pizza.tamanho})</h4>
                    <p><strong>Custo Total:</strong> R$ ${custoTotal.toFixed(2)}</p>
                    ${precoDirecto ? `
                        <p><strong>Receita Delivery:</strong> R$ ${receitaDirecto.toFixed(2)}</p>
                        <p><strong>Lucro Delivery:</strong> R$ ${lucroDirecto.toFixed(2)}</p>
                    ` : ''}
                    ${precoIfood ? `
                        <p><strong>Receita iFood:</strong> R$ ${receitaIfood.toFixed(2)}</p>
                        <p><strong>Lucro iFood:</strong> R$ ${lucroIfood.toFixed(2)}</p>
                    ` : ''}
                    <hr>
                    <h5>üì¶ An√°lise de Estoque:</h5>
                    ${podeProducir ? '<p style="color: #28a745;"><strong>‚úÖ Estoque suficiente para produ√ß√£o!</strong></p>' : '<p style="color: #dc3545;"><strong>‚ùå Estoque insuficiente!</strong></p>'}
                    ${alertaEstoque}
                    <hr>
                    <h5>üìã Ingredientes Necess√°rios:</h5>
                    ${pizza.ingredientes.map(ing => {
                        const necessario = ing.quantidade * quantidade;
                        const disponivel = estoque[ing.ingredienteId]?.quantidade || 0;
                        const unidade = ingredientes.find(i => i.id === ing.ingredienteId)?.unidade || '';
                        return `<p>${ing.nome}: ${necessario.toFixed(3)} ${unidade} ${disponivel < necessario ? '‚ö†Ô∏è' : '‚úÖ'}</p>`;
                    }).join('')}
                </div>
            `;
        }

        // FUN√á√ïES AUXILIARES
        function recalcularCustosPizzas() {
            pizzas.forEach(pizza => {
                pizza.custoIngredientes = pizza.ingredientes.reduce((total, ing) => {
                    const ingrediente = ingredientes.find(i => i.id === ing.ingredienteId);
                    if (ingrediente) {
                        ing.custoUnitario = ingrediente.preco;
                        ing.custoTotal = ingrediente.preco * ing.quantidade;
                    }
                    return total + ing.custoTotal;
                }, 0);
                
                pizza.custoTotal = pizza.custoIngredientes + pizza.custoEmbalagem + pizza.custoOperacional;
            });
        }

        function calcularTodosProdutos() {
            calcularCustosOperacionais();
            recalcularCustosPizzas();
            atualizarTabelaPizzas();
            
            if (pizzas.length > 0) {
                calcularPrecosDirecto();
                calcularPrecosIfood();
                gerarComparativo();
                gerarCardapio();
                calcularFaixasPorMargem();
            }
            
            atualizarDashboard();
            mostrarToast('Todos os c√°lculos atualizados!', 'success');
        }

        function exportarRelatorio() {
            exportarPlanilhaCompleta();
        }

        // IMPORTA√á√ÉO
        function importarArquivo(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.match(/\.(xlsx|xls)$/)) {
                mostrarFeedback('Por favor, selecione um arquivo Excel (.xlsx ou .xls)', 'danger');
                return;
            }

            mostrarLoading(true);
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'binary' });
                    processarArquivoImportadoCompleto(workbook);
                } catch (error) {
                    mostrarFeedback('Erro ao processar arquivo: ' + error.message, 'danger');
                    mostrarLoading(false);
                }
            };
            
            reader.readAsBinaryString(file);
        }

        function processarArquivoImportadoCompleto(workbook) {
        let feedback = '<div class="import-status"><h4>‚úÖ Importa√ß√£o Completa Realizada!</h4>';
        let totalItensImportados = 0;
        
        try {
            // 1. CUSTOS BASE
            if (workbook.SheetNames.includes('Custos Base')) {
                const sheet = workbook.Sheets['Custos Base'];
                const data = XLSX.utils.sheet_to_json(sheet);
                
                ingredientes = data.map((row, index) => ({
                    id: Date.now() + index,
                    nome: row['Ingrediente'] || '',
                    unidade: row['Unidade'] || 'kg',
                    preco: parseFloat(row['Pre√ßo por Unidade'] || 0),
                    quantidadePadrao: parseFloat(row['Qtd/Pizza Padr√£o'] || 0),
                    estoqueMinimo: parseFloat(row['Estoque M√≠nimo'] || 0),
                    custoPorPizza: parseFloat(row['Custo por Pizza'] || 0)
                })).filter(ing => ing.nome);
                
                // Inicializar estoque para todos os ingredientes
                ingredientes.forEach(ing => {
                    if (!estoque[ing.id]) {
                        estoque[ing.id] = {
                            quantidade: 0,
                            estoqueMinimo: ing.estoqueMinimo || 0,
                            ultimaEntrada: ''
                        };
                    }
                });
                
                totalItensImportados += ingredientes.length;
                feedback += `<div class="import-detail">üì¶ ${ingredientes.length} ingredientes importados</div>`;
            }

            // 2. RECEITAS DAS PIZZAS
            if (workbook.SheetNames.includes('Receitas das Pizzas')) {
                const sheet = workbook.Sheets['Receitas das Pizzas'];
                const data = XLSX.utils.sheet_to_json(sheet);
                
                pizzas = data.map((row, index) => {
                    // Parser melhorado para ingredientes
                    const ingredientesStr = row['Ingredientes'] || '';
                    const ingredientesPizza = [];
                    
                    if (ingredientesStr) {
                        const regex = /([^,()]+)\s*\(([0-9.]+)\)/g;
                        let match;
                        
                        while ((match = regex.exec(ingredientesStr)) !== null) {
                            const nomeIng = match[1].trim();
                            const quantidade = parseFloat(match[2]);
                            
                            const ingrediente = ingredientes.find(ing => ing.nome === nomeIng);
                            if (ingrediente) {
                                ingredientesPizza.push({
                                    ingredienteId: ingrediente.id,
                                    nome: nomeIng,
                                    quantidade: quantidade,
                                    custoUnitario: ingrediente.preco,
                                    custoTotal: ingrediente.preco * quantidade
                                });
                            }
                        }
                    }

                    return {
                        id: Date.now() + index + 1000,
                        nome: row['Nome'] || '',
                        tamanho: row['Tamanho'] || 'Grande',
                        ingredientes: ingredientesPizza,
                        custoIngredientes: parseFloat(row['Custo Ingredientes'] || 0),
                        custoEmbalagem: parseFloat(row['Custo Embalagem'] || 0.5),
                        custoOperacional: parseFloat(row['Custo Operacional'] || 0),
                        custoTotal: parseFloat(row['Custo Total'] || 0)
                    };
                }).filter(pizza => pizza.nome);
                
                totalItensImportados += pizzas.length;
                feedback += `<div class="import-detail">üçï ${pizzas.length} pizzas importadas com receitas</div>`;
            }

            // 3. CONTROLE DE ESTOQUE
            if (workbook.SheetNames.includes('Controle de Estoque')) {
                const sheet = workbook.Sheets['Controle de Estoque'];
                const data = XLSX.utils.sheet_to_json(sheet);
                
                data.forEach(row => {
                    const ingrediente = ingredientes.find(ing => ing.nome === row['Ingrediente']);
                    if (ingrediente) {
                        estoque[ingrediente.id] = {
                            quantidade: parseFloat(row['Estoque Atual'] || 0),
                            estoqueMinimo: parseFloat(row['Estoque M√≠nimo'] || 0),
                            ultimaEntrada: row['√öltima Entrada'] || ''
                        };
                    }
                });
                
                feedback += `<div class="import-detail">üì¶ ${Object.keys(estoque).length} estoques sincronizados</div>`;
            }

            // 4. HIST√ìRICO DE COMPRAS
            if (workbook.SheetNames.includes('Hist√≥rico de Compras')) {
                const sheet = workbook.Sheets['Hist√≥rico de Compras'];
                const data = XLSX.utils.sheet_to_json(sheet);
                
                entradasEstoque = data.map((row, index) => {
                    const ingrediente = ingredientes.find(ing => ing.nome === row['Ingrediente']);
                    return {
                        id: Date.now() + index + 2000,
                        ingredienteId: ingrediente ? ingrediente.id : null,
                        quantidade: parseFloat(row['Quantidade'] || 0),
                        preco: parseFloat(row['Pre√ßo Unit√°rio'] || 0),
                        data: row['Data'] || '',
                        fornecedor: row['Fornecedor'] || '',
                        observacoes: row['Observa√ß√µes'] || '',
                        custoTotal: parseFloat(row['Custo Total'] || 0)
                    };
                }).filter(entrada => entrada.ingredienteId);
                
                feedback += `<div class="import-detail">üìã ${entradasEstoque.length} entradas de compras importadas</div>`;
            }

            // 5. CUSTOS OPERACIONAIS
            if (workbook.SheetNames.includes('Custos Operacionais')) {
                const sheet = workbook.Sheets['Custos Operacionais'];
                const data = XLSX.utils.sheet_to_json(sheet);
                
                data.forEach(row => {
                    const item = row['Item'];
                    const valor = parseFloat(row['Valor'] || 0);
                    
                    switch (item) {
                        case 'Sal√°rios e Encargos': custosOperacionais.salarios = valor; break;
                        case 'Aluguel': custosOperacionais.aluguel = valor; break;
                        case 'Energia El√©trica': custosOperacionais.energia = valor; break;
                        case 'G√°s': custosOperacionais.gas = valor; break;
                        case '√Ågua e Esgoto': custosOperacionais.agua = valor; break;
                        case 'Telefone/Internet': custosOperacionais.telefone = valor; break;
                        case 'Marketing/Publicidade': custosOperacionais.marketing = valor; break;
                        case 'Manuten√ß√£o/Limpeza': custosOperacionais.manutencao = valor; break;
                        case 'Seguro': custosOperacionais.seguro = valor; break;
                        case 'Contador/Contabilidade': custosOperacionais.contador = valor; break;
                        case 'Licen√ßas/Taxas': custosOperacionais.licencas = valor; break;
                        case 'Deprecia√ß√£o Equipamentos': custosOperacionais.depreciacao = valor; break;
                        case 'Combust√≠vel Entrega': custosOperacionais.combustivel = valor; break;
                        case 'Material de Limpeza': custosOperacionais.limpeza = valor; break;
                        case 'Uniformes/EPIs': custosOperacionais.uniformes = valor; break;
                        case 'Outros': custosOperacionais.outros = valor; break;
                        case 'Pizzas por M√™s': custosOperacionais.pizzasMes = valor; break;
                        case 'Impostos (%)': custosOperacionais.impostos = valor; break;
                        case 'Total Mensal': custosOperacionais.custoTotal = valor; break;
                        case 'Custo por Pizza': custosOperacionais.custoPorPizza = valor; break;
                    }
                });
                
                feedback += `<div class="import-detail">üè™ Custos operacionais importados (15 categorias)</div>`;
            }

            // 6. DELIVERY DIRETO
            if (workbook.SheetNames.includes('Delivery Direto')) {
                const sheet = workbook.Sheets['Delivery Direto'];
                const data = XLSX.utils.sheet_to_json(sheet);
                
                precosDirecto = data.map((row, index) => {
                    const pizza = pizzas.find(p => p.nome === row['Pizza'] && p.tamanho === row['Tamanho']);
                    return {
                        id: pizza ? pizza.id : Date.now() + index + 3000,
                        pizza: row['Pizza'] || '',
                        tamanho: row['Tamanho'] || '',
                        custoTotal: parseFloat(row['Custo Total'] || 0),
                        margem: parseFloat(row['Margem (%)'] || 0),
                        precoBase: parseFloat(row['Pre√ßo Base'] || 0),
                        taxaEntrega: parseFloat(row['Taxa Entrega'] || 0),
                        precoFinal: parseFloat(row['Pre√ßo Final'] || 0),
                        lucro: parseFloat(row['Lucro'] || 0)
                    };
                }).filter(item => item.pizza);
                
                feedback += `<div class="import-detail">üõµ ${precosDirecto.length} pre√ßos delivery importados</div>`;
            }

            // 7. IFOOD
            if (workbook.SheetNames.includes('iFood')) {
                const sheet = workbook.Sheets['iFood'];
                const data = XLSX.utils.sheet_to_json(sheet);
                
                precosIfood = data.map((row, index) => {
                    const pizza = pizzas.find(p => p.nome === row['Pizza'] && p.tamanho === row['Tamanho']);
                    return {
                        id: pizza ? pizza.id : Date.now() + index + 4000,
                        pizza: row['Pizza'] || '',
                        tamanho: row['Tamanho'] || '',
                        custoTotal: parseFloat(row['Custo Total'] || 0),
                        taxaIfood: parseFloat(row['Taxa iFood (%)'] || 0),
                        margem: parseFloat(row['Margem (%)'] || 0),
                        precoIfood: parseFloat(row['Pre√ßo iFood'] || 0),
                        lucroLiquido: parseFloat(row['Lucro L√≠quido'] || 0),
                        margemReal: parseFloat(row['Margem Real (%)'] || 0)
                    };
                }).filter(item => item.pizza);
                
                feedback += `<div class="import-detail">üì± ${precosIfood.length} pre√ßos iFood importados</div>`;
            }

            // 8. VENDAS REGISTRADAS
            if (workbook.SheetNames.includes('Vendas Registradas')) {
                const sheet = workbook.Sheets['Vendas Registradas'];
                const data = XLSX.utils.sheet_to_json(sheet);
                
                vendas = data.map((row, index) => ({
                    id: Date.now() + index + 5000,
                    data: row['Data/Hora'] || '',
                    produto: row['Produto'] || '',
                    tipo: row['Tipo'] || '',
                    quantidade: parseInt(row['Quantidade'] || 0),
                    canal: row['Canal'] || '',
                    precoUnitario: parseFloat(row['Pre√ßo Unit√°rio'] || 0),
                    desconto: parseFloat(row['Desconto'] || 0),
                    valorTotal: parseFloat(row['Valor Total'] || 0),
                    custoTotal: parseFloat(row['Custo Total'] || 0),
                    lucro: parseFloat(row['Lucro'] || 0),
                    margem: parseFloat(row['Margem (%)'] || 0),
                    observacoes: row['Observa√ß√µes'] || ''
                })).filter(venda => venda.produto);
                
                feedback += `<div class="import-detail">üí∞ ${vendas.length} vendas importadas</div>`;
            }

            // 9. PRODUTOS EXTRAS
            if (workbook.SheetNames.includes('Produtos Extras')) {
                const sheet = workbook.Sheets['Produtos Extras'];
                const data = XLSX.utils.sheet_to_json(sheet);
                
                produtosExtras = data.map((row, index) => ({
                    id: Date.now() + index + 6000,
                    nome: row['Produto'] || '',
                    categoria: row['Categoria'] || '',
                    custo: parseFloat(row['Pre√ßo de Custo'] || 0),
                    preco: parseFloat(row['Pre√ßo de Venda'] || 0),
                    margem: parseFloat(row['Margem (%)'] || 0)
                })).filter(produto => produto.nome);
                
                feedback += `<div class="import-detail">üç∑ ${produtosExtras.length} produtos extras importados</div>`;
            }

            // 10. DASHBOARD KPIS
            if (workbook.SheetNames.includes('Dashboard KPIs')) {
                const sheet = workbook.Sheets['Dashboard KPIs'];
                const data = XLSX.utils.sheet_to_json(sheet);
                
                const metaItem = data.find(row => row['KPI'] === 'Meta Mensal');
                if (metaItem) {
                    metaMensal = parseFloat(metaItem['Valor'] || 0);
                }
                
                feedback += `<div class="import-detail">üìä KPIs do dashboard importados</div>`;
            }

            // 11. CONFIGURA√á√ïES
            if (workbook.SheetNames.includes('Configura√ß√µes')) {
                const sheet = workbook.Sheets['Configura√ß√µes'];
                const data = XLSX.utils.sheet_to_json(sheet);
                
                data.forEach(row => {
                    const config = row['Configura√ß√£o'];
                    const valor = row['Valor'];
                    
                    switch (config) {
                        case 'Margem Delivery Direto (%)':
                            if (document.getElementById('margem-direto')) {
                                document.getElementById('margem-direto').value = valor || 150;
                            }
                            break;
                        case 'Taxa de Entrega (R$)':
                            if (document.getElementById('taxa-entrega')) {
                                document.getElementById('taxa-entrega').value = valor || 5;
                            }
                            break;
                        case 'Taxa iFood (%)':
                            if (document.getElementById('taxa-ifood')) {
                                document.getElementById('taxa-ifood').value = valor || 27;
                            }
                            break;
                        case 'Margem iFood (%)':
                            if (document.getElementById('margem-ifood')) {
                                document.getElementById('margem-ifood').value = valor || 150;
                            }
                            break;
                        case 'Meta Mensal (R$)':
                            metaMensal = parseFloat(valor || 0);
                            break;
                    }
                });
                
                feedback += `<div class="import-detail">‚öôÔ∏è Configura√ß√µes restauradas</div>`;
            }

            // VALIDAR E CORRIGIR INCONSIST√äNCIAS
            validarConsistenciaDados();

            // ATUALIZAR TODAS AS INTERFACES
            atualizarTodasTabelas();
            preencherCustosOperacionais();
            
            if (precosDirecto.length > 0) atualizarTabelaDirecto();
            if (precosIfood.length > 0) atualizarTabelaIfood();
            if (metaMensal > 0) {
                if (document.getElementById('meta-mensal')) {
                    document.getElementById('meta-mensal').value = metaMensal;
                }
                atualizarMetaMensal();
            }
            
            // Atualizar comparativo e card√°pio
            if (precosDirecto.length > 0 && precosIfood.length > 0) {
                gerarComparativo();
            }
            gerarCardapio();
            calcularFaixasPorMargem();
            
            salvarLocal();
            atualizarDashboard();
            
            feedback += `<div class="import-detail" style="margin-top: 15px; font-weight: bold; color: #28a745;">
                ‚úÖ IMPORTA√á√ÉO 100% COMPLETA!<br>
                ‚Ä¢ ${ingredientes.length} ingredientes com estoque sincronizado<br>
                ‚Ä¢ ${pizzas.length} pizzas com receitas completas<br>
                ‚Ä¢ Custos operacionais (15 categorias)<br>
                ‚Ä¢ ${precosDirecto.length} pre√ßos delivery<br>
                ‚Ä¢ ${precosIfood.length} pre√ßos iFood<br>
                ‚Ä¢ ${vendas.length} vendas registradas<br>
                ‚Ä¢ ${produtosExtras.length} produtos extras<br>
                ‚Ä¢ Comparativo e an√°lises geradas<br>
                ‚Ä¢ Sistema totalmente funcional!
            </div>`;
            feedback += '</div>';
            
            mostrarFeedback(feedback, 'success');
            mostrarToast('TODAS as abas importadas com sucesso!', 'success');
            
            // Adicionar ao hist√≥rico
            historico.push({
                acao: 'import_completo_corrigido',
                timestamp: new Date().toISOString(),
                detalhes: `Importa√ß√£o completa: ${ingredientes.length} ingredientes, ${pizzas.length} pizzas, ${precosDirecto.length} pre√ßos delivery, ${precosIfood.length} pre√ßos iFood, ${vendas.length} vendas`
            });

            // Recalcular tudo ap√≥s importa√ß√£o
            setTimeout(() => {
                calcularTodosProdutos();
            }, 1000);
            
        } catch (error) {
            mostrarFeedback('Erro ao importar dados: ' + error.message, 'danger');
            console.error('Erro detalhado:', error);
        } finally {
            mostrarLoading(false);
        }
    }

        function atualizarTodasTabelas() {
            atualizarTabelaIngredientes();
            atualizarSelectIngredientes();
            atualizarSelectEstoque();
            atualizarSelectVendas();
            atualizarTabelaPizzas();
            atualizarSelectCalculadora();
            atualizarTabelaEstoque();
            atualizarTabelaVendas();
            atualizarTabelaProdutosExtras();
        }

        function mostrarLoading(show) {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.style.display = show ? 'block' : 'none';
            }
        }

        function mostrarFeedback(mensagem, tipo = 'info') {
            const feedback = document.getElementById('import-feedback');
            if (feedback) {
                feedback.innerHTML = `<div class="alert alert-${tipo}">${mensagem}</div>`;
                setTimeout(() => {
                    if (tipo !== 'success') {
                        feedback.innerHTML = '';
                    }
                }, tipo === 'success' ? 10000 : 5000);
            }
        }

        // MODAL DE CONFIRMA√á√ÉO
        function mostrarModalConfirmacao(ingredienteId, novaQuantidade) {
            const ingrediente = ingredientes.find(ing => ing.id === ingredienteId);
            const pizzasAfetadas = pizzas.filter(pizza => 
                pizza.ingredientes && pizza.ingredientes.some(ing => ing.ingredienteId === ingredienteId)
            );

            document.getElementById('confirmation-message').innerHTML = `
                <p><strong>Voc√™ alterou a quantidade padr√£o de "${ingrediente.nome}" para ${novaQuantidade.toFixed(3)} ${ingrediente.unidade}.</strong></p>
                <p>Deseja aplicar esta nova quantidade em todas as pizzas que j√° usam este ingrediente?</p>
                <p><strong>Pizzas afetadas:</strong> ${pizzasAfetadas.length}</p>
            `;

            if (pizzasAfetadas.length > 0) {
                let previewHtml = '<div class="impact-preview"><h4>Impacto nas pizzas:</h4>';
                pizzasAfetadas.forEach(pizza => {
                    const ingredientePizza = pizza.ingredientes.find(ing => ing.ingredienteId === ingredienteId);
                    if (ingredientePizza) {
                        const quantidadeAtual = ingredientePizza.quantidade;
                        const diferenca = novaQuantidade - quantidadeAtual;
                        const custoImpacto = diferenca * ingrediente.preco;
                        
                        previewHtml += `
                            <div class="impact-item">
                                <strong>${pizza.nome} (${pizza.tamanho}):</strong> 
                                ${quantidadeAtual.toFixed(3)} ‚Üí ${novaQuantidade.toFixed(3)} ${ingrediente.unidade}
                                (${diferenca > 0 ? '+' : ''}${custoImpacto.toFixed(2)} R$)
                            </div>
                        `;
                    }
                });
                previewHtml += '</div>';
                document.getElementById('impact-preview').innerHTML = previewHtml;
            } else {
                document.getElementById('impact-preview').innerHTML = '';
            }

            pendingQuantityChange = { ingredienteId, novaQuantidade, pizzasAfetadas };
            document.getElementById('confirmation-modal').style.display = 'block';
        }

        function fecharModalConfirmacao() {
            document.getElementById('confirmation-modal').style.display = 'none';
            pendingQuantityChange = null;
        }

        function confirmarAlteracaoMassa(aplicarEmTodas) {
            if (!pendingQuantityChange) return;

            const { ingredienteId, novaQuantidade, pizzasAfetadas } = pendingQuantityChange;
            const ingrediente = ingredientes.find(ing => ing.id === ingredienteId);

            if (aplicarEmTodas && pizzasAfetadas.length > 0) {
                pizzasAfetadas.forEach(pizza => {
                    const ingredientePizza = pizza.ingredientes.find(ing => ing.ingredienteId === ingredienteId);
                    if (ingredientePizza) {
                        ingredientePizza.quantidade = novaQuantidade;
                        ingredientePizza.custoTotal = ingrediente.preco * novaQuantidade;
                    }
                });

                recalcularCustosPizzas();
                atualizarTabelaPizzas();
                
                mostrarToast(`Quantidade aplicada em ${pizzasAfetadas.length} pizzas!`, 'success');

                historico.push({
                    acao: 'alteracao_massa_quantidade',
                    timestamp: new Date().toISOString(),
                    detalhes: `${ingrediente.nome}: nova quantidade ${novaQuantidade.toFixed(3)} aplicada em ${pizzasAfetadas.length} pizzas`
                });
            } else {
                mostrarToast('Altera√ß√£o aplicada apenas ao ingrediente base', 'info');
            }

            fecharModalConfirmacao();
            salvarLocal();
        }

        // EXPORTA√á√ÉO COMPLETAMENTE FUNCIONAL
        function exportarPlanilhaCompleta() {
            if (typeof XLSX === 'undefined') {
                mostrarToast('Erro: Biblioteca XLSX n√£o carregada!', 'danger');
                return;
            }

            mostrarLoading(true);
            
            try {
                console.log('Iniciando exporta√ß√£o...');
                const wb = XLSX.utils.book_new();

                // 1. ABA CUSTOS BASE
                const dadosIngredientes = ingredientes.length > 0 ? ingredientes.map(ing => ({
                    'Ingrediente': ing.nome || '',
                    'Unidade': ing.unidade || 'kg',
                    'Pre√ßo por Unidade': ing.preco || 0,
                    'Qtd/Pizza Padr√£o': ing.quantidadePadrao || 0,
                    'Custo por Pizza': ing.custoPorPizza || 0,
                    'Estoque M√≠nimo': ing.estoqueMinimo || 0
                })) : [{ 'Ingrediente': 'Exemplo', 'Unidade': 'kg', 'Pre√ßo por Unidade': 0, 'Qtd/Pizza Padr√£o': 0, 'Custo por Pizza': 0, 'Estoque M√≠nimo': 0 }];
                
                const wsIngredientes = XLSX.utils.json_to_sheet(dadosIngredientes);
                XLSX.utils.book_append_sheet(wb, wsIngredientes, 'Custos Base');

                // 2. ABA RECEITAS DAS PIZZAS
                const dadosPizzas = pizzas.length > 0 ? pizzas.map(pizza => ({
                    'Nome': pizza.nome || '',
                    'Tamanho': pizza.tamanho || 'Grande',
                    'Ingredientes': pizza.ingredientes ? pizza.ingredientes.map(ing => `${ing.nome} (${(ing.quantidade || 0).toFixed(3)})`).join(', ') : '',
                    'Custo Ingredientes': pizza.custoIngredientes || 0,
                    'Custo Embalagem': pizza.custoEmbalagem || 0.5,
                    'Custo Operacional': pizza.custoOperacional || 0,
                    'Custo Total': pizza.custoTotal || 0
                })) : [{ 'Nome': 'Exemplo', 'Tamanho': 'Grande', 'Ingredientes': '', 'Custo Ingredientes': 0, 'Custo Embalagem': 0.5, 'Custo Operacional': 0, 'Custo Total': 0 }];
                
                const wsPizzas = XLSX.utils.json_to_sheet(dadosPizzas);
                XLSX.utils.book_append_sheet(wb, wsPizzas, 'Receitas das Pizzas');

                // 3. ABA CONTROLE DE ESTOQUE
                const dadosEstoque = ingredientes.length > 0 ? ingredientes.map(ing => {
                    const est = estoque[ing.id] || { quantidade: 0, ultimaEntrada: '', estoqueMinimo: 0 };
                    return {
                        'Ingrediente': ing.nome || '',
                        'Unidade': ing.unidade || 'kg',
                        'Estoque Atual': est.quantidade || 0,
                        'Estoque M√≠nimo': est.estoqueMinimo || ing.estoqueMinimo || 0,
                        'Pre√ßo Atual': ing.preco || 0,
                        '√öltima Entrada': est.ultimaEntrada || '',
                        'Status': (est.quantidade || 0) <= 0 ? 'Sem Estoque' : (est.quantidade || 0) <= (est.estoqueMinimo || 0) ? 'Estoque Baixo' : 'Normal'
                    };
                }) : [{ 'Ingrediente': 'Exemplo', 'Unidade': 'kg', 'Estoque Atual': 0, 'Estoque M√≠nimo': 0, 'Pre√ßo Atual': 0, '√öltima Entrada': '', 'Status': 'Sem Estoque' }];
                
                const wsEstoque = XLSX.utils.json_to_sheet(dadosEstoque);
                XLSX.utils.book_append_sheet(wb, wsEstoque, 'Controle de Estoque');

                // 4. ABA HIST√ìRICO DE COMPRAS
                const dadosCompras = entradasEstoque && entradasEstoque.length > 0 ? entradasEstoque.map(entrada => {
                    const ingrediente = ingredientes.find(ing => ing.id === entrada.ingredienteId);
                    return {
                        'Data': entrada.data || '',
                        'Ingrediente': ingrediente ? ingrediente.nome : 'N/A',
                        'Quantidade': entrada.quantidade || 0,
                        'Pre√ßo Unit√°rio': entrada.preco || 0,
                        'Custo Total': entrada.custoTotal || (entrada.quantidade || 0) * (entrada.preco || 0),
                        'Fornecedor': entrada.fornecedor || '',
                        'Observa√ß√µes': entrada.observacoes || ''
                    };
                }) : [{ 'Data': '', 'Ingrediente': '', 'Quantidade': 0, 'Pre√ßo Unit√°rio': 0, 'Custo Total': 0, 'Fornecedor': '', 'Observa√ß√µes': '' }];
                
                const wsCompras = XLSX.utils.json_to_sheet(dadosCompras);
                XLSX.utils.book_append_sheet(wb, wsCompras, 'Hist√≥rico de Compras');

                // 5. ABA CUSTOS OPERACIONAIS EXPANDIDA
                const dadosCustosOp = [
                    { 'Item': 'Sal√°rios e Encargos', 'Valor': custosOperacionais.salarios || 0 },
                    { 'Item': 'Aluguel', 'Valor': custosOperacionais.aluguel || 0 },
                    { 'Item': 'Energia El√©trica', 'Valor': custosOperacionais.energia || 0 },
                    { 'Item': 'G√°s', 'Valor': custosOperacionais.gas || 0 },
                    { 'Item': '√Ågua e Esgoto', 'Valor': custosOperacionais.agua || 0 },
                    { 'Item': 'Telefone/Internet', 'Valor': custosOperacionais.telefone || 0 },
                    { 'Item': 'Marketing/Publicidade', 'Valor': custosOperacionais.marketing || 0 },
                    { 'Item': 'Manuten√ß√£o/Limpeza', 'Valor': custosOperacionais.manutencao || 0 },
                    { 'Item': 'Seguro', 'Valor': custosOperacionais.seguro || 0 },
                    { 'Item': 'Contador/Contabilidade', 'Valor': custosOperacionais.contador || 0 },
                    { 'Item': 'Licen√ßas/Taxas', 'Valor': custosOperacionais.licencas || 0 },
                    { 'Item': 'Deprecia√ß√£o Equipamentos', 'Valor': custosOperacionais.depreciacao || 0 },
                    { 'Item': 'Combust√≠vel Entrega', 'Valor': custosOperacionais.combustivel || 0 },
                    { 'Item': 'Material de Limpeza', 'Valor': custosOperacionais.limpeza || 0 },
                    { 'Item': 'Uniformes/EPIs', 'Valor': custosOperacionais.uniformes || 0 },
                    { 'Item': 'Outros', 'Valor': custosOperacionais.outros || 0 },
                    { 'Item': 'Total Mensal', 'Valor': custosOperacionais.custoTotal || 0 },
                    { 'Item': 'Pizzas por M√™s', 'Valor': custosOperacionais.pizzasMes || 0 },
                    { 'Item': 'Custo por Pizza', 'Valor': custosOperacionais.custoPorPizza || 0 },
                    { 'Item': 'Impostos (%)', 'Valor': custosOperacionais.impostos || 0 }
                ];
                
                const wsCustosOp = XLSX.utils.json_to_sheet(dadosCustosOp);
                XLSX.utils.book_append_sheet(wb, wsCustosOp, 'Custos Operacionais');

                // 6. ABA DELIVERY DIRETO
                const dadosDelivery = precosDirecto && precosDirecto.length > 0 ? precosDirecto.map(item => ({
                    'Pizza': item.pizza || '',
                    'Tamanho': item.tamanho || '',
                    'Custo Total': item.custoTotal || 0,
                    'Margem (%)': item.margem || 0,
                    'Pre√ßo Base': item.precoBase || 0,
                    'Taxa Entrega': item.taxaEntrega || 0,
                    'Pre√ßo Final': item.precoFinal || 0,
                    'Lucro': item.lucro || 0,
                    'Margem Real (%)': item.precoFinal > 0 ? ((item.lucro || 0) / (item.precoFinal || 1) * 100).toFixed(1) : 0
                })) : [{ 'Pizza': '', 'Tamanho': '', 'Custo Total': 0, 'Margem (%)': 0, 'Pre√ßo Base': 0, 'Taxa Entrega': 0, 'Pre√ßo Final': 0, 'Lucro': 0, 'Margem Real (%)': 0 }];
                
                const wsDelivery = XLSX.utils.json_to_sheet(dadosDelivery);
                XLSX.utils.book_append_sheet(wb, wsDelivery, 'Delivery Direto');

                // 7. ABA IFOOD
                const dadosIfood = precosIfood && precosIfood.length > 0 ? precosIfood.map(item => ({
                    'Pizza': item.pizza || '',
                    'Tamanho': item.tamanho || '',
                    'Custo Total': item.custoTotal || 0,
                    'Taxa iFood (%)': item.taxaIfood || 0,
                    'Margem (%)': item.margem || 0,
                    'Pre√ßo iFood': item.precoIfood || 0,
                    'Lucro L√≠quido': item.lucroLiquido || 0,
                    'Margem Real (%)': item.margemReal || 0
                })) : [{ 'Pizza': '', 'Tamanho': '', 'Custo Total': 0, 'Taxa iFood (%)': 0, 'Margem (%)': 0, 'Pre√ßo iFood': 0, 'Lucro L√≠quido': 0, 'Margem Real (%)': 0 }];
                
                const wsIfood = XLSX.utils.json_to_sheet(dadosIfood);
                XLSX.utils.book_append_sheet(wb, wsIfood, 'iFood');

                // 8. ABA COMPARATIVO
                let dadosComparativo = [];
                if (pizzas.length > 0 && precosDirecto.length > 0 && precosIfood.length > 0) {
                    dadosComparativo = pizzas.map(pizza => {
                        const precoDirecto = precosDirecto.find(p => p.pizza === pizza.nome && p.tamanho === pizza.tamanho);
                        const precoIfood = precosIfood.find(p => p.pizza === pizza.nome && p.tamanho === pizza.tamanho);
                        
                        if (precoDirecto && precoIfood) {
                            const diferenca = (precoDirecto.lucro || 0) - (precoIfood.lucroLiquido || 0);
                            return {
                                'Pizza': pizza.nome || '',
                                'Tamanho': pizza.tamanho || '',
                                'Pre√ßo Direto': precoDirecto.precoFinal || 0,
                                'Pre√ßo iFood': precoIfood.precoIfood || 0,
                                'Lucro Direto': precoDirecto.lucro || 0,
                                'Lucro iFood': precoIfood.lucroLiquido || 0,
                                'Diferen√ßa': diferenca,
                                'Melhor Canal': diferenca > 0 ? 'Delivery Direto' : 'iFood'
                            };
                        }
                        return null;
                    }).filter(Boolean);
                }
                
                if (dadosComparativo.length === 0) {
                    dadosComparativo = [{ 'Pizza': '', 'Tamanho': '', 'Pre√ßo Direto': 0, 'Pre√ßo iFood': 0, 'Lucro Direto': 0, 'Lucro iFood': 0, 'Diferen√ßa': 0, 'Melhor Canal': '' }];
                }
                
                const wsComparativo = XLSX.utils.json_to_sheet(dadosComparativo);
                XLSX.utils.book_append_sheet(wb, wsComparativo, 'Comparativo');

                // 9. ABA VENDAS REGISTRADAS
                const dadosVendas = vendas && vendas.length > 0 ? vendas.map(venda => ({
                    'Data/Hora': venda.data || '',
                    'Produto': venda.produto || '',
                    'Tipo': venda.tipo || '',
                    'Quantidade': venda.quantidade || 0,
                    'Canal': venda.canal || '',
                    'Pre√ßo Unit√°rio': venda.precoUnitario || 0,
                    'Desconto': venda.desconto || 0,
                    'Valor Total': venda.valorTotal || 0,
                    'Custo Total': venda.custoTotal || 0,
                    'Lucro': venda.lucro || 0,
                    'Margem (%)': venda.margem || 0,
                    'Observa√ß√µes': venda.observacoes || ''
                })) : [{ 'Data/Hora': '', 'Produto': '', 'Tipo': '', 'Quantidade': 0, 'Canal': '', 'Pre√ßo Unit√°rio': 0, 'Desconto': 0, 'Valor Total': 0, 'Custo Total': 0, 'Lucro': 0, 'Margem (%)': 0, 'Observa√ß√µes': '' }];
                
                const wsVendas = XLSX.utils.json_to_sheet(dadosVendas);
                XLSX.utils.book_append_sheet(wb, wsVendas, 'Vendas Registradas');

                // 10. ABA PRODUTOS EXTRAS
                const dadosExtras = produtosExtras && produtosExtras.length > 0 ? produtosExtras.map(produto => ({
                    'Produto': produto.nome || '',
                    'Categoria': produto.categoria || '',
                    'Pre√ßo de Custo': produto.custo || 0,
                    'Pre√ßo de Venda': produto.preco || 0,
                    'Margem (%)': produto.margem || 0
                })) : [{ 'Produto': '', 'Categoria': '', 'Pre√ßo de Custo': 0, 'Pre√ßo de Venda': 0, 'Margem (%)': 0 }];
                
                const wsExtras = XLSX.utils.json_to_sheet(dadosExtras);
                XLSX.utils.book_append_sheet(wb, wsExtras, 'Produtos Extras');

                // 11. ABA DASHBOARD KPIS
                const hoje = new Date();
                const inicioHoje = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                const vendasHoje = vendas ? vendas.filter(venda => new Date(venda.data || '') >= inicioHoje) : [];
                const faturamentoHoje = vendasHoje.reduce((acc, v) => acc + (v.valorTotal || 0), 0);
                const lucroHoje = vendasHoje.reduce((acc, v) => acc + (v.lucro || 0), 0);
                
                const dadosKPIs = [
                    { 'KPI': 'Total de Ingredientes', 'Valor': ingredientes.length },
                    { 'KPI': 'Total de Pizzas', 'Valor': pizzas.length },
                    { 'KPI': 'Faturamento Hoje', 'Valor': faturamentoHoje },
                    { 'KPI': 'Lucro Hoje', 'Valor': lucroHoje },
                    { 'KPI': 'Vendas Hoje', 'Valor': vendasHoje.length },
                    { 'KPI': 'Ingredientes em Estoque', 'Valor': Object.keys(estoque).filter(id => (estoque[id].quantidade || 0) > 0).length },
                    { 'KPI': 'Alertas de Estoque', 'Valor': Object.keys(estoque).filter(id => (estoque[id].quantidade || 0) <= (estoque[id].estoqueMinimo || 0)).length },
                    { 'KPI': 'Meta Mensal', 'Valor': metaMensal || 0 },
                    { 'KPI': 'Data Exporta√ß√£o', 'Valor': new Date().toISOString() }
                ];
                
                const wsKPIs = XLSX.utils.json_to_sheet(dadosKPIs);
                XLSX.utils.book_append_sheet(wb, wsKPIs, 'Dashboard KPIs');

                // 12. ABA CONFIGURA√á√ïES
                const dadosConfig = [
                    { 'Configura√ß√£o': 'Margem Delivery Direto (%)', 'Valor': document.getElementById('margem-direto')?.value || 150 },
                    { 'Configura√ß√£o': 'Taxa de Entrega (R$)', 'Valor': document.getElementById('taxa-entrega')?.value || 5 },
                    { 'Configura√ß√£o': 'Taxa iFood (%)', 'Valor': document.getElementById('taxa-ifood')?.value || 27 },
                    { 'Configura√ß√£o': 'Margem iFood (%)', 'Valor': document.getElementById('margem-ifood')?.value || 150 },
                    { 'Configura√ß√£o': 'Meta Mensal (R$)', 'Valor': metaMensal || 0 },
                    { 'Configura√ß√£o': 'Faixa Margem Alta (%)', 'Valor': document.getElementById('faixa-margem-alta')?.value || 60 },
                    { 'Configura√ß√£o': 'Faixa Margem M√©dia Min (%)', 'Valor': document.getElementById('faixa-margem-media-min')?.value || 40 },
                    { 'Configura√ß√£o': 'Faixa Margem M√©dia Max (%)', 'Valor': document.getElementById('faixa-margem-media-max')?.value || 60 }
                ];
                
                const wsConfig = XLSX.utils.json_to_sheet(dadosConfig);
                XLSX.utils.book_append_sheet(wb, wsConfig, 'Configura√ß√µes');

                // 13. ABA HIST√ìRICO DE A√á√ïES
                const dadosHistorico = historico && historico.length > 0 ? historico.slice(-100).map(item => ({
                    'Data/Hora': new Date(item.timestamp || '').toLocaleString('pt-BR'),
                    'A√ß√£o': item.acao || '',
                    'Detalhes': item.detalhes || ''
                })) : [{ 'Data/Hora': new Date().toLocaleString('pt-BR'), 'A√ß√£o': 'Exporta√ß√£o', 'Detalhes': 'Exporta√ß√£o do sistema completo' }];
                
                const wsHistorico = XLSX.utils.json_to_sheet(dadosHistorico);
                XLSX.utils.book_append_sheet(wb, wsHistorico, 'Hist√≥rico de A√ß√µes');

                // GERAR E BAIXAR ARQUIVO
                console.log('Gerando arquivo Excel...');
                const nomeArquivo = `Sistema_Pizzaria_Completo_Funcional_${new Date().toISOString().split('T')[0].replace(/-/g, '')}.xlsx`;
                
                console.log('Iniciando download...');
                XLSX.writeFile(wb, nomeArquivo);
                
                // FEEDBACK DE SUCESSO
                const feedback = `
                    <div class="import-status">
                        <h4>‚úÖ DOWNLOAD REALIZADO COM SUCESSO!</h4>
                        <div class="import-detail">üìä Arquivo "${nomeArquivo}" exportado com:</div>
                        <div class="import-detail">‚Ä¢ Custos Base (${ingredientes.length} ingredientes)</div>
                        <div class="import-detail">‚Ä¢ Receitas (${pizzas.length} pizzas)</div>
                        <div class="import-detail">‚Ä¢ Controle de Estoque (sincronizado)</div>
                        <div class="import-detail">‚Ä¢ Hist√≥rico de Compras (${entradasEstoque ? entradasEstoque.length : 0} entradas)</div>
                        <div class="import-detail">‚Ä¢ Custos Operacionais (15 categorias expandidas)</div>
                        <div class="import-detail">‚Ä¢ Delivery Direto (${precosDirecto ? precosDirecto.length : 0} pre√ßos)</div>
                        <div class="import-detail">‚Ä¢ iFood (${precosIfood ? precosIfood.length : 0} pre√ßos)</div>
                        <div class="import-detail">‚Ä¢ Comparativo de Canais</div>
                        <div class="import-detail">‚Ä¢ Vendas Registradas (${vendas ? vendas.length : 0} vendas)</div>
                        <div class="import-detail">‚Ä¢ Produtos Extras (${produtosExtras ? produtosExtras.length : 0} produtos)</div>
                        <div class="import-detail">‚Ä¢ Dashboard KPIs</div>
                        <div class="import-detail">‚Ä¢ Configura√ß√µes</div>
                        <div class="import-detail">‚Ä¢ Hist√≥rico de A√ß√µes</div>
                        <div class="import-detail" style="margin-top: 15px; color: #28a745; font-weight: bold;">
                            üéâ TODAS AS 13 ABAS EXPORTADAS COM SUCESSO!
                        </div>
                    </div>
                `;
                
                if (document.getElementById('import-feedback')) {
                    document.getElementById('import-feedback').innerHTML = feedback;
                }
                
                mostrarToast('Sistema completo baixado com sucesso!', 'success');
                
                // Adicionar ao hist√≥rico
                historico.push({
                    acao: 'export_completo_final',
                    timestamp: new Date().toISOString(),
                    detalhes: `Exporta√ß√£o completa: 13 abas, ${vendas ? vendas.length : 0} vendas, ${ingredientes.length} ingredientes, simulador funcional`
                });
                
                salvarLocal();
                console.log('Exporta√ß√£o conclu√≠da com sucesso!');
                
            } catch (error) {
                console.error('Erro na exporta√ß√£o:', error);
                const errorMsg = `Erro ao gerar planilha: ${error.message}`;
                
                if (document.getElementById('import-feedback')) {
                    document.getElementById('import-feedback').innerHTML = `<div class="alert alert-danger">${errorMsg}</div>`;
                }
                
                mostrarToast(errorMsg, 'danger');
            } finally {
                mostrarLoading(false);
            }
        }

        // FUN√á√ïES DE PERSIST√äNCIA
        function salvarLocal() {
            const dados = {
                ingredientes,
                pizzas,
                estoque,
                historicoPrecos,
                entradasEstoque,
                vendas,
                produtosExtras,
                metaMensal,
                custosOperacionais,
                precosDirecto,
                precosIfood,
                historico,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('pizzaria_dados_pro_completo', JSON.stringify(dados));
        }

        function carregarLocal() {
            const dados = localStorage.getItem('pizzaria_dados_pro_completo');
            if (dados) {
                try {
                    const parsed = JSON.parse(dados);
                    ingredientes = parsed.ingredientes || [];
                    pizzas = parsed.pizzas || [];
                    estoque = parsed.estoque || {};
                    historicoPrecos = parsed.historicoPrecos || {};
                    entradasEstoque = parsed.entradasEstoque || [];
                    vendas = parsed.vendas || [];
                    produtosExtras = parsed.produtosExtras || [];
                    metaMensal = parsed.metaMensal || 0;
                    custosOperacionais = parsed.custosOperacionais || custosOperacionais;
                    precosDirecto = parsed.precosDirecto || [];
                    precosIfood = parsed.precosIfood || [];
                    historico = parsed.historico || [];
                    
                    atualizarTodasTabelas();
                    preencherCustosOperacionais();
                    document.getElementById('meta-mensal').value = metaMensal;
                    console.log('Dados carregados do backup local');
                } catch (e) {
                    console.error('Erro ao carregar dados locais:', e);
                }
            }
        }

        // Inicializa√ß√£o final
        setTimeout(() => {
            if (ingredientes.length > 0) {
                atualizarDashboard();
            }
        }, 1000);

        // ========================================
        // FUN√á√ïES DA NOVA ABA - GEST√ÉO DE INGREDIENTES UNIFICADA
        // ========================================

        let editandoIngredienteUnificado = null;
        let movimentacoesEstoque = [];

        // Fun√ß√£o para filtrar ingredientes na aba unificada
        function filtrarIngredientesUnificado() {
            const busca = document.getElementById('busca-ingrediente-unificado').value.toLowerCase();
            const categoria = document.getElementById('filtro-categoria-unificado').value;
            const status = document.getElementById('filtro-status-unificado').value;
            
            const tbody = document.querySelector('#tabela-ingredientes-unificado tbody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const nome = row.cells[0].textContent.toLowerCase();
                const categoriaRow = row.cells[1].textContent.toLowerCase();
                const statusRow = row.getAttribute('data-status') || '';
                
                const matchBusca = nome.includes(busca);
                const matchCategoria = !categoria || categoriaRow.includes(categoria);
                const matchStatus = !status || statusRow === status;
                
                row.style.display = (matchBusca && matchCategoria && matchStatus) ? '' : 'none';
            });
        }

        // Fun√ß√£o para adicionar novo ingrediente
        function adicionarIngredienteUnificado() {
            editandoIngredienteUnificado = null;
            document.getElementById('titulo-form-ingrediente').textContent = '‚ûï Adicionar Novo Ingrediente';
            limparFormularioIngredienteUnificado();
            document.getElementById('form-ingrediente-unificado').style.display = 'block';
            document.getElementById('ingrediente-nome-unificado').focus();
        }

        // Fun√ß√£o para editar ingrediente
        function editarIngredienteUnificado(id) {
            const ingrediente = ingredientes.find(ing => ing.id == id);
            if (!ingrediente) return;
            
            editandoIngredienteUnificado = id;
            document.getElementById('titulo-form-ingrediente').textContent = '‚úèÔ∏è Editar Ingrediente';
            
            document.getElementById('ingrediente-nome-unificado').value = ingrediente.nome;
            document.getElementById('ingrediente-categoria-unificado').value = ingrediente.categoria || 'outros';
            document.getElementById('ingrediente-unidade-unificado').value = ingrediente.unidade || 'kg';
            document.getElementById('ingrediente-preco-unificado').value = ingrediente.preco || 0;
            document.getElementById('ingrediente-quantidade-unificado').value = ingrediente.quantidadePadrao || 0;
            document.getElementById('ingrediente-estoque-atual-unificado').value = estoque[id]?.quantidade || 0;
            document.getElementById('ingrediente-estoque-minimo-unificado').value = estoque[id]?.minimo || 0;
            document.getElementById('ingrediente-fornecedor-unificado').value = ingrediente.fornecedor || '';
            
            calcularCustoIngredienteUnificado();
            document.getElementById('form-ingrediente-unificado').style.display = 'block';
        }

        // Fun√ß√£o para calcular custo do ingrediente
        function calcularCustoIngredienteUnificado() {
            const preco = parseFloat(document.getElementById('ingrediente-preco-unificado').value) || 0;
            const quantidade = parseFloat(document.getElementById('ingrediente-quantidade-unificado').value) || 0;
            const custo = preco * quantidade;
            
            document.getElementById('ingrediente-custo-pizza-unificado').value = custo.toFixed(2);
        }

        // Fun√ß√£o para salvar ingrediente
        function salvarIngredienteUnificado() {
            const nome = document.getElementById('ingrediente-nome-unificado').value.trim();
            const categoria = document.getElementById('ingrediente-categoria-unificado').value;
            const unidade = document.getElementById('ingrediente-unidade-unificado').value;
            const preco = parseFloat(document.getElementById('ingrediente-preco-unificado').value) || 0;
            const quantidade = parseFloat(document.getElementById('ingrediente-quantidade-unificado').value) || 0;
            const estoqueAtual = parseFloat(document.getElementById('ingrediente-estoque-atual-unificado').value) || 0;
            const estoqueMinimo = parseFloat(document.getElementById('ingrediente-estoque-minimo-unificado').value) || 0;
            const fornecedor = document.getElementById('ingrediente-fornecedor-unificado').value.trim();
            
            if (!nome) {
                mostrarToast('Nome do ingrediente √© obrigat√≥rio!', 'warning');
                return;
            }
            
            if (preco <= 0) {
                mostrarToast('Pre√ßo deve ser maior que zero!', 'warning');
                return;
            }
            
            let ingrediente;
            
            if (editandoIngredienteUnificado) {
                // Editando ingrediente existente
                ingrediente = ingredientes.find(ing => ing.id == editandoIngredienteUnificado);
                if (ingrediente) {
                    ingrediente.nome = nome;
                    ingrediente.categoria = categoria;
                    ingrediente.unidade = unidade;
                    ingrediente.preco = preco;
                    ingrediente.quantidadePadrao = quantidade;
                    ingrediente.custoPorPizza = preco * quantidade;
                    ingrediente.fornecedor = fornecedor;
                    
                    // Atualizar estoque
                    if (!estoque[ingrediente.id]) {
                        estoque[ingrediente.id] = {};
                    }
                    estoque[ingrediente.id].quantidade = estoqueAtual;
                    estoque[ingrediente.id].minimo = estoqueMinimo;
                    
                    mostrarToast('Ingrediente atualizado com sucesso!', 'success');
                }
            } else {
                // Adicionando novo ingrediente
                const novoId = Date.now();
                ingrediente = {
                    id: novoId,
                    nome: nome,
                    categoria: categoria,
                    unidade: unidade,
                    preco: preco,
                    quantidadePadrao: quantidade,
                    custoPorPizza: preco * quantidade,
                    fornecedor: fornecedor
                };
                
                ingredientes.push(ingrediente);
                
                // Inicializar estoque
                estoque[novoId] = {
                    quantidade: estoqueAtual,
                    minimo: estoqueMinimo
                };
                
                mostrarToast('Ingrediente adicionado com sucesso!', 'success');
            }
            
            // Registrar no hist√≥rico de pre√ßos
            if (!historicoPrecos[ingrediente.id]) {
                historicoPrecos[ingrediente.id] = [];
            }
            historicoPrecos[ingrediente.id].push({
                data: new Date().toISOString(),
                preco: preco
            });
            
            // Adicionar ao hist√≥rico
            historico.push({
                acao: editandoIngredienteUnificado ? 'editar_ingrediente_unificado' : 'adicionar_ingrediente_unificado',
                timestamp: new Date().toISOString(),
                detalhes: `${editandoIngredienteUnificado ? 'Editado' : 'Adicionado'}: ${nome} - R$ ${preco.toFixed(2)}/${unidade}`
            });
            
            cancelarEdicaoIngredienteUnificado();
            atualizarTabelaIngredientesUnificado();
            atualizarKPIsUnificado();
            atualizarSelectMovimentacao();
            salvarLocal();
        }

        // Fun√ß√£o para cancelar edi√ß√£o
        function cancelarEdicaoIngredienteUnificado() {
            editandoIngredienteUnificado = null;
            limparFormularioIngredienteUnificado();
            document.getElementById('form-ingrediente-unificado').style.display = 'none';
        }

        // Fun√ß√£o para limpar formul√°rio
        function limparFormularioIngredienteUnificado() {
            document.getElementById('ingrediente-nome-unificado').value = '';
            document.getElementById('ingrediente-categoria-unificado').value = 'outros';
            document.getElementById('ingrediente-unidade-unificado').value = 'kg';
            document.getElementById('ingrediente-preco-unificado').value = '';
            document.getElementById('ingrediente-quantidade-unificado').value = '';
            document.getElementById('ingrediente-custo-pizza-unificado').value = '';
            document.getElementById('ingrediente-estoque-atual-unificado').value = '';
            document.getElementById('ingrediente-estoque-minimo-unificado').value = '';
            document.getElementById('ingrediente-fornecedor-unificado').value = '';
        }

        // Fun√ß√£o para atualizar tabela de ingredientes unificada
        function atualizarTabelaIngredientesUnificado() {
            const tbody = document.querySelector('#tabela-ingredientes-unificado tbody');
            if (!tbody) {
                console.log('Tabela unificada n√£o encontrada');
                return;
            }
            
            tbody.innerHTML = '';
            
            if (!ingredientes || ingredientes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 20px;">Nenhum ingrediente cadastrado</td></tr>';
                return;
            }
            
            ingredientes.forEach(ingrediente => {
                const estoqueInfo = estoque[ingrediente.id] || { quantidade: 0, estoqueMinimo: 0 };
                const preco = ingrediente.preco || 0;
                const quantidade = estoqueInfo.quantidade || 0;
                const valorEstoque = preco * quantidade;
                
                // Determinar status
                let status = '‚úÖ OK';
                let statusClass = '';
                let statusData = 'ok';
                
                if (quantidade <= 0) {
                    status = '‚ùå Sem Estoque';
                    statusClass = 'stock-critical';
                    statusData = 'sem-estoque';
                } else if (quantidade <= (estoqueInfo.estoqueMinimo || 0)) {
                    status = 'üî¥ Cr√≠tico';
                    statusClass = 'stock-critical';
                    statusData = 'estoque-critico';
                } else if (quantidade <= (estoqueInfo.estoqueMinimo || 0) * 1.5) {
                    status = 'üü° Baixo';
                    statusClass = 'stock-low';
                    statusData = 'estoque-baixo';
                }
                
                const row = tbody.insertRow();
                row.className = statusClass;
                row.setAttribute('data-status', statusData);
                
                row.innerHTML = `
                    <td><strong>${ingrediente.nome || 'N/A'}</strong></td>
                    <td>${ingrediente.categoria || 'Outros'}</td>
                    <td>R$ ${preco.toFixed(2)}/${ingrediente.unidade || 'kg'}</td>
                    <td>${(ingrediente.quantidadePadrao || 0).toFixed(3)} ${ingrediente.unidade || 'kg'}</td>
                    <td><strong>R$ ${(ingrediente.custoPorPizza || 0).toFixed(2)}</strong></td>
                    <td>${quantidade.toFixed(2)} ${ingrediente.unidade || 'kg'}</td>
                    <td>${(estoqueInfo.estoqueMinimo || 0).toFixed(2)} ${ingrediente.unidade || 'kg'}</td>
                    <td>${status}</td>
                    <td><strong>R$ ${valorEstoque.toFixed(2)}</strong></td>
                    <td>${ingrediente.fornecedor || '-'}</td>
                    <td>
                        <button class="btn btn-edit" onclick="editarIngredienteUnificado(${ingrediente.id})" style="padding: 5px 10px; margin: 2px;">‚úèÔ∏è</button>
                        <button class="btn btn-danger" onclick="excluirIngredienteUnificado(${ingrediente.id})" style="padding: 5px 10px; margin: 2px;">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        // Fun√ß√£o para excluir ingrediente
        function excluirIngredienteUnificado(id) {
            const ingrediente = ingredientes.find(ing => ing.id == id);
            if (!ingrediente) return;
            
            if (confirm(`Tem certeza que deseja excluir o ingrediente "${ingrediente.nome}"?`)) {
                ingredientes = ingredientes.filter(ing => ing.id != id);
                delete estoque[id];
                delete historicoPrecos[id];
                
                // Adicionar ao hist√≥rico
                historico.push({
                    acao: 'excluir_ingrediente_unificado',
                    timestamp: new Date().toISOString(),
                    detalhes: `Exclu√≠do: ${ingrediente.nome}`
                });
                
                atualizarTabelaIngredientesUnificado();
                atualizarKPIsUnificado();
                atualizarSelectMovimentacao();
                salvarLocal();
                mostrarToast('Ingrediente exclu√≠do com sucesso!', 'success');
            }
        }

        // Fun√ß√£o para atualizar KPIs da aba unificada
        function atualizarKPIsUnificado() {
            const totalIngredientes = ingredientes.length;
            let ingredientesOk = 0;
            let alertasEstoque = 0;
            let valorTotalEstoque = 0;
            
            ingredientes.forEach(ingrediente => {
                const estoqueInfo = estoque[ingrediente.id] || { quantidade: 0, minimo: 0 };
                const valorEstoque = (ingrediente.preco || 0) * estoqueInfo.quantidade;
                valorTotalEstoque += valorEstoque;
                
                if (estoqueInfo.quantidade > estoqueInfo.minimo) {
                    ingredientesOk++;
                } else {
                    alertasEstoque++;
                }
            });
            
            document.getElementById('total-ingredientes-unificado').textContent = totalIngredientes;
            document.getElementById('ingredientes-ok-unificado').textContent = ingredientesOk;
            document.getElementById('alertas-estoque-unificado').textContent = alertasEstoque;
            document.getElementById('valor-total-estoque').textContent = `R$ ${valorTotalEstoque.toFixed(2)}`;
        }

        // Fun√ß√£o para atualizar select de movimenta√ß√£o
        function atualizarSelectMovimentacao() {
            const select = document.getElementById('movimentacao-ingrediente-unificado');
            select.innerHTML = '<option value="">Selecione um ingrediente</option>';
            
            ingredientes.forEach(ingrediente => {
                const option = document.createElement('option');
                option.value = ingrediente.id;
                option.textContent = `${ingrediente.nome} (${ingrediente.unidade || 'kg'})`;
                select.appendChild(option);
            });
        }

        // Fun√ß√£o para registrar movimenta√ß√£o de estoque
        function registrarMovimentacaoUnificado() {
            const ingredienteId = document.getElementById('movimentacao-ingrediente-unificado').value;
            const tipo = document.getElementById('movimentacao-tipo-unificado').value;
            const quantidade = parseFloat(document.getElementById('movimentacao-quantidade-unificado').value) || 0;
            const observacao = document.getElementById('movimentacao-obs-unificado').value.trim();
            
            if (!ingredienteId) {
                mostrarToast('Selecione um ingrediente!', 'warning');
                return;
            }
            
            if (quantidade <= 0) {
                mostrarToast('Quantidade deve ser maior que zero!', 'warning');
                return;
            }
            
            const ingrediente = ingredientes.find(ing => ing.id == ingredienteId);
            if (!ingrediente) return;
            
            if (!estoque[ingredienteId]) {
                estoque[ingredienteId] = { quantidade: 0, minimo: 0 };
            }
            
            const estoqueAnterior = estoque[ingredienteId].quantidade;
            let novoEstoque = estoqueAnterior;
            
            switch (tipo) {
                case 'entrada':
                    novoEstoque = estoqueAnterior + quantidade;
                    break;
                case 'saida':
                    novoEstoque = Math.max(0, estoqueAnterior - quantidade);
                    break;
                case 'ajuste':
                    novoEstoque = quantidade;
                    break;
            }
            
            estoque[ingredienteId].quantidade = novoEstoque;
            
            // Registrar movimenta√ß√£o
            const movimentacao = {
                id: Date.now(),
                ingredienteId: ingredienteId,
                ingredienteNome: ingrediente.nome,
                tipo: tipo,
                quantidade: quantidade,
                estoqueAnterior: estoqueAnterior,
                estoqueAtual: novoEstoque,
                observacao: observacao,
                data: new Date().toISOString()
            };
            
            if (!movimentacoesEstoque) {
                movimentacoesEstoque = [];
            }
            movimentacoesEstoque.push(movimentacao);
            
            // Adicionar ao hist√≥rico
            historico.push({
                acao: 'movimentacao_estoque_unificado',
                timestamp: new Date().toISOString(),
                detalhes: `${tipo.toUpperCase()}: ${ingrediente.nome} - ${quantidade} ${ingrediente.unidade || 'kg'}`
            });
            
            // Limpar formul√°rio
            document.getElementById('movimentacao-ingrediente-unificado').value = '';
            document.getElementById('movimentacao-quantidade-unificado').value = '';
            document.getElementById('movimentacao-obs-unificado').value = '';
            
            atualizarTabelaIngredientesUnificado();
            atualizarTabelaMovimentacoesUnificado();
            atualizarKPIsUnificado();
            salvarLocal();
            
            const tipoTexto = tipo === 'entrada' ? 'Entrada' : tipo === 'saida' ? 'Sa√≠da' : 'Ajuste';
            mostrarToast(`${tipoTexto} registrada com sucesso!`, 'success');
        }

        // Fun√ß√£o para atualizar tabela de movimenta√ß√µes
        function atualizarTabelaMovimentacoesUnificado() {
            const tbody = document.querySelector('#tabela-movimentacoes-unificado tbody');
            tbody.innerHTML = '';
            
            if (!movimentacoesEstoque) {
                movimentacoesEstoque = [];
            }
            
            // Mostrar apenas as √∫ltimas 20 movimenta√ß√µes
            const movimentacoesRecentes = movimentacoesEstoque.slice(-20).reverse();
            
            movimentacoesRecentes.forEach(mov => {
                const row = tbody.insertRow();
                const data = new Date(mov.data);
                
                let tipoIcon = '';
                let tipoClass = '';
                switch (mov.tipo) {
                    case 'entrada':
                        tipoIcon = '‚ûï Entrada';
                        tipoClass = 'high-margin';
                        break;
                    case 'saida':
                        tipoIcon = '‚ûñ Sa√≠da';
                        tipoClass = 'low-margin';
                        break;
                    case 'ajuste':
                        tipoIcon = 'üîß Ajuste';
                        tipoClass = 'editing';
                        break;
                }
                
                row.className = tipoClass;
                row.innerHTML = `
                    <td>${data.toLocaleString('pt-BR')}</td>
                    <td><strong>${mov.ingredienteNome}</strong></td>
                    <td>${tipoIcon}</td>
                    <td>${mov.quantidade.toFixed(2)}</td>
                    <td>${mov.estoqueAnterior.toFixed(2)}</td>
                    <td><strong>${mov.estoqueAtual.toFixed(2)}</strong></td>
                    <td>${mov.observacao || '-'}</td>
                `;
            });
        }

        // Fun√ß√£o para exportar dados da aba unificada
        function exportarIngredientesUnificado() {
            try {
                const wb = XLSX.utils.book_new();
                
                // Aba de ingredientes
                const dadosIngredientes = ingredientes.map(ing => {
                    const estoqueInfo = estoque[ing.id] || { quantidade: 0, minimo: 0 };
                    return {
                        'Nome': ing.nome,
                        'Categoria': ing.categoria || 'Outros',
                        'Unidade': ing.unidade || 'kg',
                        'Pre√ßo por Unidade': ing.preco || 0,
                        'Quantidade por Pizza': ing.quantidadePadrao || 0,
                        'Custo por Pizza': ing.custoPorPizza || 0,
                        'Estoque Atual': estoqueInfo.quantidade,
                        'Estoque M√≠nimo': estoqueInfo.minimo,
                        'Valor do Estoque': (ing.preco || 0) * estoqueInfo.quantidade,
                        'Fornecedor': ing.fornecedor || ''
                    };
                });
                
                const wsIngredientes = XLSX.utils.json_to_sheet(dadosIngredientes);
                XLSX.utils.book_append_sheet(wb, wsIngredientes, 'Ingredientes');
                
                // Aba de movimenta√ß√µes
                if (movimentacoesEstoque && movimentacoesEstoque.length > 0) {
                    const dadosMovimentacoes = movimentacoesEstoque.map(mov => ({
                        'Data/Hora': new Date(mov.data).toLocaleString('pt-BR'),
                        'Ingrediente': mov.ingredienteNome,
                        'Tipo': mov.tipo.toUpperCase(),
                        'Quantidade': mov.quantidade,
                        'Estoque Anterior': mov.estoqueAnterior,
                        'Estoque Atual': mov.estoqueAtual,
                        'Observa√ß√£o': mov.observacao || ''
                    }));
                    
                    const wsMovimentacoes = XLSX.utils.json_to_sheet(dadosMovimentacoes);
                    XLSX.utils.book_append_sheet(wb, wsMovimentacoes, 'Movimenta√ß√µes');
                }
                
                XLSX.writeFile(wb, `gestao_ingredientes_${new Date().toISOString().split('T')[0]}.xlsx`);
                mostrarToast('Dados exportados com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro na exporta√ß√£o:', error);
                mostrarToast('Erro ao exportar dados!', 'danger');
            }
        }

        // Fun√ß√£o para inicializar a aba unificada
        function inicializarGestaoIngredientesUnificada() {
            if (!movimentacoesEstoque) {
                movimentacoesEstoque = [];
            }
            
            atualizarTabelaIngredientesUnificado();
            atualizarTabelaMovimentacoesUnificado();
            atualizarKPIsUnificado();
            atualizarSelectMovimentacao();
        }

        // Atualizar fun√ß√£o showTab para incluir a nova aba
        const showTabOriginal = showTab;
        showTab = function(tabName) {
            showTabOriginal(tabName);
            
            if (tabName === 'gestao-ingredientes') {
                inicializarGestaoIngredientesUnificada();
            }
        };

        // ========================================
        // FIM DAS FUN√á√ïES DA GEST√ÉO DE INGREDIENTES UNIFICADA
        // ========================================

        // ========================================
        // SISTEMA DE ALERTAS INTELIGENTES - NOVA FUNCIONALIDADE
        // ========================================

        // Fun√ß√£o para gerar alertas inteligentes
        function gerarAlertasInteligentes() {
            const alertasList = document.getElementById('alertas-list');
            if (!alertasList) return;
            
            alertasList.innerHTML = '';
            let alertas = [];

            // Verificar estoque cr√≠tico
            let estoquesCriticos = 0;
            let estoquesZerados = 0;
            ingredientes.forEach(ingrediente => {
                const estoqueInfo = estoque[ingrediente.id] || { quantidade: 0, minimo: 0 };
                if (estoqueInfo.quantidade <= 0) {
                    estoquesZerados++;
                    alertas.push({
                        tipo: 'critico',
                        titulo: '‚ùå Estoque Zerado',
                        mensagem: `${ingrediente.nome} est√° sem estoque!`,
                        acao: 'Comprar urgentemente'
                    });
                } else if (estoqueInfo.quantidade <= estoqueInfo.minimo) {
                    estoquesCriticos++;
                    alertas.push({
                        tipo: 'warning',
                        titulo: 'üü° Estoque Baixo',
                        mensagem: `${ingrediente.nome} est√° abaixo do m√≠nimo (${estoqueInfo.quantidade.toFixed(1)}/${estoqueInfo.minimo.toFixed(1)} ${ingrediente.unidade || 'kg'})`,
                        acao: 'Reabastecer em breve'
                    });
                }
            });

            // Verificar se n√£o h√° vendas hoje
            const hoje = new Date().toISOString().split('T')[0];
            const vendasHoje = vendas.filter(v => v.data && v.data.startsWith(hoje));
            if (vendasHoje.length === 0 && new Date().getHours() > 10) {
                alertas.push({
                    tipo: 'info',
                    titulo: 'üìä Sem Vendas Hoje',
                    mensagem: 'Nenhuma venda foi registrada hoje ainda.',
                    acao: 'Verificar opera√ß√£o'
                });
            }

            // Verificar ingredientes sem pre√ßo
            const ingredientesSemPreco = ingredientes.filter(ing => !ing.preco || ing.preco <= 0);
            if (ingredientesSemPreco.length > 0) {
                alertas.push({
                    tipo: 'warning',
                    titulo: 'üí∞ Pre√ßos Pendentes',
                    mensagem: `${ingredientesSemPreco.length} ingrediente(s) sem pre√ßo definido.`,
                    acao: 'Atualizar pre√ßos'
                });
            }

            // Verificar se h√° muitos ingredientes sem fornecedor
            const ingredientesSemFornecedor = ingredientes.filter(ing => !ing.fornecedor || ing.fornecedor.trim() === '');
            if (ingredientesSemFornecedor.length > ingredientes.length * 0.3) {
                alertas.push({
                    tipo: 'info',
                    titulo: 'üè™ Fornecedores Pendentes',
                    mensagem: `${ingredientesSemFornecedor.length} ingredientes sem fornecedor cadastrado.`,
                    acao: 'Cadastrar fornecedores'
                });
            }

            // Verificar valor alto do estoque
            let valorTotalEstoque = 0;
            ingredientes.forEach(ingrediente => {
                const estoqueInfo = estoque[ingrediente.id] || { quantidade: 0 };
                valorTotalEstoque += (ingrediente.preco || 0) * estoqueInfo.quantidade;
            });

            if (valorTotalEstoque > 1000) {
                alertas.push({
                    tipo: 'success',
                    titulo: 'üíé Estoque Valioso',
                    mensagem: `Seu estoque vale R$ ${valorTotalEstoque.toFixed(2)}. Monitore para evitar perdas.`,
                    acao: 'Controlar validade'
                });
            }

            // Renderizar alertas
            if (alertas.length === 0) {
                alertasList.innerHTML = `
                    <div class="alert alert-success">
                        <h4>‚úÖ Tudo em Ordem!</h4>
                        <p>N√£o h√° alertas cr√≠ticos no momento. Sua opera√ß√£o est√° funcionando bem!</p>
                    </div>
                `;
            } else {
                alertas.forEach(alerta => {
                    const alertaDiv = document.createElement('div');
                    let alertaClass = 'alert';
                    
                    switch (alerta.tipo) {
                        case 'critico':
                            alertaClass += ' alert-danger';
                            break;
                        case 'warning':
                            alertaClass += ' alert-warning';
                            break;
                        case 'success':
                            alertaClass += ' alert-success';
                            break;
                        default:
                            alertaClass += ' alert-info';
                    }
                    
                    alertaDiv.className = alertaClass;
                    alertaDiv.innerHTML = `
                        <h4>${alerta.titulo}</h4>
                        <p>${alerta.mensagem}</p>
                        <small><strong>A√ß√£o sugerida:</strong> ${alerta.acao}</small>
                    `;
                    
                    alertasList.appendChild(alertaDiv);
                });
            }
        }

        // Fun√ß√£o para mostrar notifica√ß√£o toast melhorada
        function mostrarToastMelhorado(mensagem, tipo = 'success', duracao = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            
            // √çcones por tipo
            let icone = '';
            switch (tipo) {
                case 'success':
                    icone = '‚úÖ';
                    toast.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                    break;
                case 'warning':
                    icone = '‚ö†Ô∏è';
                    toast.style.background = 'linear-gradient(45deg, #ffc107, #e0a800)';
                    break;
                case 'danger':
                    icone = '‚ùå';
                    toast.style.background = 'linear-gradient(45deg, #dc3545, #c82333)';
                    break;
                case 'info':
                    icone = '‚ÑπÔ∏è';
                    toast.style.background = 'linear-gradient(45deg, #17a2b8, #138496)';
                    break;
            }
            
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2em;">${icone}</span>
                    <span>${mensagem}</span>
                </div>
            `;
            
            // Adicionar anima√ß√£o de entrada
            toast.style.transform = 'translateX(400px)';
            toast.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
                toast.style.opacity = '1';
            }, 100);
            
            setTimeout(() => {
                toast.style.transform = 'translateX(400px)';
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, duracao);
        }

        // Sobrescrever fun√ß√£o mostrarToast original
        mostrarToast = mostrarToastMelhorado;

        // Fun√ß√£o para atualizar dashboard com alertas
        function atualizarDashboardComAlertas() {
            atualizarDashboard();
            gerarAlertasInteligentes();
        }

        // ========================================
        // MELHORIAS DE UX - ATALHOS DE TECLADO EXPANDIDOS
        // ========================================

        // Expandir atalhos de teclado
        document.addEventListener('keydown', function(e) {
            // Atalhos existentes
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                salvarLocal();
                mostrarToast('Dados salvos automaticamente!', 'success');
            }
            
            // Novos atalhos
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                if (document.getElementById('gestao-ingredientes').classList.contains('active')) {
                    adicionarIngredienteUnificado();
                } else {
                    showTab('gestao-ingredientes');
                    setTimeout(adicionarIngredienteUnificado, 100);
                }
                mostrarToast('Novo ingrediente - Ctrl+N', 'info', 2000);
            }
            
            if (e.ctrlKey && e.key === 'v') {
                e.preventDefault();
                showTab('vendas');
                mostrarToast('Aba Vendas - Ctrl+V', 'info', 2000);
            }
            
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                showTab('dashboard');
                mostrarToast('Dashboard - Ctrl+D', 'info', 2000);
            }
            
            if (e.ctrlKey && e.key === 'g') {
                e.preventDefault();
                showTab('gestao-ingredientes');
                mostrarToast('Gest√£o de Ingredientes - Ctrl+G', 'info', 2000);
            }
            
            if (e.key === 'Escape') {
                fecharCalculadora();
                fecharModalConfirmacao();
                cancelarEdicaoPizza();
                cancelarEdicaoIngredienteUnificado();
            }
        });

        // ========================================
        // SISTEMA DE RESULTADOS DI√ÅRIOS - NOVA FUNCIONALIDADE
        // ========================================

        // Array para armazenar resultados di√°rios
        let resultadosDiarios = [];

        // Fun√ß√£o para calcular ticket m√©dio automaticamente
        function calcularTicketMedio() {
            const pedidos = parseFloat(document.getElementById('resultado-pedidos').value) || 0;
            const valor = parseFloat(document.getElementById('resultado-valor').value) || 0;
            const ticketMedio = pedidos > 0 ? valor / pedidos : 0;
            
            document.getElementById('resultado-ticket-medio').value = `R$ ${ticketMedio.toFixed(2)}`;
        }

        // Event listeners para c√°lculo autom√°tico
        document.addEventListener('DOMContentLoaded', function() {
            const pedidosInput = document.getElementById('resultado-pedidos');
            const valorInput = document.getElementById('resultado-valor');
            
            if (pedidosInput) pedidosInput.addEventListener('input', calcularTicketMedio);
            if (valorInput) valorInput.addEventListener('input', calcularTicketMedio);
        });

        // Fun√ß√£o para salvar resultado di√°rio
        function salvarResultadoDiario() {
            const data = document.getElementById('resultado-data').value;
            const pedidos = parseInt(document.getElementById('resultado-pedidos').value);
            const valor = parseFloat(document.getElementById('resultado-valor').value);
            const canal = document.getElementById('resultado-canal').value;
            const pagamento = document.getElementById('resultado-pagamento').value;
            const meta = parseFloat(document.getElementById('resultado-meta').value) || 0;
            const observacoes = document.getElementById('resultado-observacoes').value;

            // Valida√ß√µes
            if (!data || !pedidos || !valor || !canal) {
                mostrarToast('Preencha todos os campos obrigat√≥rios!', 'danger');
                return;
            }

            // Verificar se j√° existe resultado para esta data
            const existeData = resultadosDiarios.find(r => r.data === data);
            if (existeData) {
                if (!confirm('J√° existe um resultado para esta data. Deseja substituir?')) {
                    return;
                }
                // Remover resultado existente
                resultadosDiarios = resultadosDiarios.filter(r => r.data !== data);
            }

            const ticketMedio = valor / pedidos;
            const percentualMeta = meta > 0 ? (valor / meta) * 100 : 0;

            const novoResultado = {
                id: Date.now(),
                data: data,
                pedidos: pedidos,
                valor: valor,
                canal: canal,
                pagamento: pagamento || 'N√£o informado',
                meta: meta,
                observacoes: observacoes || '',
                ticketMedio: ticketMedio,
                percentualMeta: percentualMeta,
                timestamp: new Date().toISOString()
            };

            resultadosDiarios.push(novoResultado);
            resultadosDiarios.sort((a, b) => new Date(b.data) - new Date(a.data)); // Ordenar por data decrescente

            salvarLocal();
            atualizarTabelaResultados();
            atualizarKPIsMensais();
            limparFormularioResultado();
            
            mostrarToast('Resultado di√°rio salvo com sucesso!', 'success');
        }

        // Fun√ß√£o para limpar formul√°rio
        function limparFormularioResultado() {
            document.getElementById('resultado-data').value = '';
            document.getElementById('resultado-pedidos').value = '';
            document.getElementById('resultado-valor').value = '';
            document.getElementById('resultado-canal').value = '';
            document.getElementById('resultado-pagamento').value = '';
            document.getElementById('resultado-meta').value = '';
            document.getElementById('resultado-observacoes').value = '';
            document.getElementById('resultado-ticket-medio').value = '';
        }

        // Fun√ß√£o para atualizar tabela de resultados
        function atualizarTabelaResultados() {
            const tbody = document.querySelector('#tabela-resultados-diarios tbody');
            tbody.innerHTML = '';

            if (resultadosDiarios.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">Nenhum resultado registrado</td></tr>';
                return;
            }

            resultadosDiarios.forEach(resultado => {
                const row = tbody.insertRow();
                const dataFormatada = new Date(resultado.data + 'T00:00:00').toLocaleDateString('pt-BR');
                const percentualClass = resultado.percentualMeta >= 100 ? 'success' : resultado.percentualMeta >= 80 ? 'warning' : 'danger';
                
                row.innerHTML = `
                    <td><strong>${dataFormatada}</strong></td>
                    <td>${resultado.pedidos}</td>
                    <td><strong>R$ ${resultado.valor.toFixed(2)}</strong></td>
                    <td>R$ ${resultado.ticketMedio.toFixed(2)}</td>
                    <td>${resultado.canal}</td>
                    <td>${resultado.pagamento}</td>
                    <td>R$ ${resultado.meta.toFixed(2)}</td>
                    <td><span class="badge ${percentualClass}">${resultado.percentualMeta.toFixed(1)}%</span></td>
                    <td>${resultado.observacoes}</td>
                    <td>
                        <button class="btn btn-edit" onclick="editarResultado(${resultado.id})" style="padding: 5px 10px; margin: 2px;">‚úèÔ∏è</button>
                        <button class="btn btn-danger" onclick="excluirResultado(${resultado.id})" style="padding: 5px 10px; margin: 2px;">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        // Fun√ß√£o para atualizar KPIs mensais
        function atualizarKPIsMensais() {
            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();

            const resultadosDoMes = resultadosDiarios.filter(r => {
                const dataResultado = new Date(r.data + 'T00:00:00');
                return dataResultado.getMonth() === mesAtual && dataResultado.getFullYear() === anoAtual;
            });

            const faturamentoMensal = resultadosDoMes.reduce((total, r) => total + r.valor, 0);
            const pedidosMensal = resultadosDoMes.reduce((total, r) => total + r.pedidos, 0);
            const ticketMedioMensal = pedidosMensal > 0 ? faturamentoMensal / pedidosMensal : 0;
            const diasTrabalhados = resultadosDoMes.length;
            const metaMensal = resultadosDoMes.reduce((total, r) => total + r.meta, 0);
            const percentualMeta = metaMensal > 0 ? (faturamentoMensal / metaMensal) * 100 : 0;

            document.getElementById('kpi-faturamento-mensal').textContent = `R$ ${faturamentoMensal.toFixed(2)}`;
            document.getElementById('kpi-pedidos-mensal').textContent = pedidosMensal;
            document.getElementById('kpi-ticket-medio-mensal').textContent = `R$ ${ticketMedioMensal.toFixed(2)}`;
            document.getElementById('kpi-dias-trabalhados').textContent = diasTrabalhados;
            document.getElementById('kpi-meta-mensal').textContent = `R$ ${metaMensal.toFixed(2)}`;
            document.getElementById('kpi-percentual-meta').textContent = `${percentualMeta.toFixed(1)}%`;
        }

        // Fun√ß√£o para editar resultado
        function editarResultado(id) {
            const resultado = resultadosDiarios.find(r => r.id === id);
            if (!resultado) return;

            document.getElementById('resultado-data').value = resultado.data;
            document.getElementById('resultado-pedidos').value = resultado.pedidos;
            document.getElementById('resultado-valor').value = resultado.valor;
            document.getElementById('resultado-canal').value = resultado.canal;
            document.getElementById('resultado-pagamento').value = resultado.pagamento;
            document.getElementById('resultado-meta').value = resultado.meta;
            document.getElementById('resultado-observacoes').value = resultado.observacoes;
            
            calcularTicketMedio();

            // Remover o resultado atual para permitir edi√ß√£o
            resultadosDiarios = resultadosDiarios.filter(r => r.id !== id);
            
            mostrarToast('Resultado carregado para edi√ß√£o', 'info');
        }

        // Fun√ß√£o para excluir resultado
        function excluirResultado(id) {
            const resultado = resultadosDiarios.find(r => r.id === id);
            if (!resultado) return;

            const dataFormatada = new Date(resultado.data + 'T00:00:00').toLocaleDateString('pt-BR');
            if (confirm(`Tem certeza que deseja excluir o resultado do dia ${dataFormatada}?`)) {
                resultadosDiarios = resultadosDiarios.filter(r => r.id !== id);
                salvarLocal();
                atualizarTabelaResultados();
                atualizarKPIsMensais();
                mostrarToast('Resultado exclu√≠do com sucesso!', 'success');
            }
        }

        // Fun√ß√£o para filtrar por m√™s
        function filtrarResultadosPorMes() {
            const filtroMes = document.getElementById('filtro-mes-resultado').value;
            // Implementar filtro por m√™s se necess√°rio
            atualizarTabelaResultados();
        }

        // Fun√ß√£o para filtrar por canal
        function filtrarResultadosPorCanal() {
            const filtroCanal = document.getElementById('filtro-canal-resultado').value;
            // Implementar filtro por canal se necess√°rio
            atualizarTabelaResultados();
        }

        // Fun√ß√£o para buscar resultados
        function buscarResultados() {
            const termo = document.getElementById('busca-resultado').value.toLowerCase();
            // Implementar busca se necess√°rio
            atualizarTabelaResultados();
        }

        // Fun√ß√£o para exportar resultados di√°rios
        function exportarResultadosDiarios() {
            if (resultadosDiarios.length === 0) {
                mostrarToast('Nenhum resultado para exportar!', 'warning');
                return;
            }

            try {
                const wb = XLSX.utils.book_new();
                
                // Preparar dados para exporta√ß√£o
                const dadosExport = resultadosDiarios.map(r => ({
                    'Data': new Date(r.data + 'T00:00:00').toLocaleDateString('pt-BR'),
                    'Quantidade de Pedidos': r.pedidos,
                    'Valor Total (R$)': r.valor.toFixed(2),
                    'Ticket M√©dio (R$)': r.ticketMedio.toFixed(2),
                    'Canal Principal': r.canal,
                    'Forma de Pagamento': r.pagamento,
                    'Meta do Dia (R$)': r.meta.toFixed(2),
                    '% Meta Atingida': r.percentualMeta.toFixed(1) + '%',
                    'Observa√ß√µes': r.observacoes
                }));

                const ws = XLSX.utils.json_to_sheet(dadosExport);
                XLSX.utils.book_append_sheet(wb, ws, 'Resultados Di√°rios');
                
                const nomeArquivo = `resultados_diarios_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, nomeArquivo);
                
                mostrarToast('Resultados exportados com sucesso!', 'success');
            } catch (error) {
                console.error('Erro na exporta√ß√£o:', error);
                mostrarToast('Erro ao exportar resultados!', 'danger');
            }
        }

        // Adicionar CSS para badges
        const styleResultados = document.createElement('style');
        styleResultados.textContent = `
            .badge {
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: bold;
                color: white;
            }
            .badge.success { background-color: #28a745; }
            .badge.warning { background-color: #ffc107; color: #212529; }
            .badge.danger { background-color: #dc3545; }
        `;
        document.head.appendChild(styleResultados);

        // ========================================
        // FIM DO SISTEMA DE RESULTADOS DI√ÅRIOS
        // ========================================

        // ========================================
        // SISTEMA DE SIDEBAR LATERAL - NOVA FUNCIONALIDADE
        // ========================================

        // Fun√ß√£o para alternar sidebar mobile
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }

        // Fun√ß√£o para fechar sidebar mobile
        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
        }

        // Atualizar fun√ß√£o showTab para incluir sidebar
        const showTabOriginalComSidebar = showTab;
        showTab = function(tabName) {
            // Executar fun√ß√£o original
            showTabOriginalComSidebar(tabName);
            
            // Atualizar sidebar
            updateSidebarActive(tabName);
            updateContentHeader(tabName);
            
            // Fechar sidebar mobile se estiver aberta
            closeMobileSidebar();
            
            // Funcionalidades espec√≠ficas das abas
            if (tabName === 'gestao-ingredientes') {
                inicializarGestaoIngredientesUnificada();
            }
            
            if (tabName === 'dashboard') {
                setTimeout(gerarAlertasInteligentes, 500);
            }
            
            if (tabName === 'resultados-diarios') {
                setTimeout(() => {
                    atualizarTabelaResultados();
                    atualizarKPIsMensais();
                    // Definir data padr√£o como hoje
                    const hoje = new Date().toISOString().split('T')[0];
                    document.getElementById('resultado-data').value = hoje;
                    // Definir m√™s atual no filtro
                    const mesAtual = new Date().toISOString().slice(0, 7);
                    document.getElementById('filtro-mes-resultado').value = mesAtual;
                }, 100);
            }
        };

        // Fun√ß√£o para atualizar item ativo na sidebar
        function updateSidebarActive(tabName) {
            // Remover classe active de todos os itens
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Adicionar classe active ao item correspondente
            const activeItem = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }

        // Fun√ß√£o para atualizar cabe√ßalho do conte√∫do
        function updateContentHeader(tabName) {
            const titles = {
                'dashboard': {
                    title: 'üìä Dashboard - Vis√£o Geral',
                    subtitle: 'Monitore os indicadores-chave da sua opera√ß√£o'
                },
                'gestao-ingredientes': {
                    title: 'üî• Gest√£o de Ingredientes',
                    subtitle: 'Controle unificado de custos base e estoque'
                },
                'vendas': {
                    title: 'üí≥ Vendas & Contabilidade',
                    subtitle: 'Registre vendas e acompanhe a performance'
                },
                'resultados-diarios': {
                    title: 'üìä Resultados Di√°rios',
                    subtitle: 'Controle de faturamento e metas di√°rias'
                },
                'estoque': {
                    title: 'üì¶ Controle de Estoque',
                    subtitle: 'Gerencie o estoque de ingredientes'
                },
                'custos-base': {
                    title: 'üí∞ Custos Base',
                    subtitle: 'Defina pre√ßos dos ingredientes'
                },
                'receitas': {
                    title: 'üìù Receitas das Pizzas',
                    subtitle: 'Configure receitas e ingredientes'
                },
                'cardapio': {
                    title: 'üìã Card√°pio',
                    subtitle: 'Visualize e gerencie o card√°pio'
                },
                'operacionais': {
                    title: '‚öôÔ∏è Custos Operacionais',
                    subtitle: 'Configure custos fixos e vari√°veis'
                },
                'delivery-direto': {
                    title: 'üöó Delivery Direto',
                    subtitle: 'Gerencie entregas pr√≥prias'
                },
                'ifood': {
                    title: 'üçî iFood',
                    subtitle: 'Integra√ß√£o com iFood'
                },
                'comparativo': {
                    title: 'üìà Comparativo',
                    subtitle: 'Compare performance entre canais'
                },
                'analises': {
                    title: 'üìà An√°lises',
                    subtitle: 'Relat√≥rios e an√°lises avan√ßadas'
                },
                'import-export': {
                    title: 'üìÅ Import/Export',
                    subtitle: 'Importe e exporte dados'
                }
            };
            
            const config = titles[tabName] || {
                title: 'Sistema de Gest√£o',
                subtitle: 'Gerencie sua pizzaria'
            };
            
            document.getElementById('content-title').textContent = config.title;
            document.getElementById('content-subtitle').textContent = config.subtitle;
        }

        // Inicializar sidebar ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            updateSidebarActive('dashboard');
            updateContentHeader('dashboard');
        });

        // ========================================
        // FIM DO SISTEMA DE SIDEBAR LATERAL
        // ========================================

        // ========================================
        // AUTO-ATUALIZA√á√ÉO DE ALERTAS
        // ========================================

        // Atualizar alertas a cada 30 segundos
        setInterval(() => {
            if (document.getElementById('dashboard').classList.contains('active')) {
                gerarAlertasInteligentes();
            }
        }, 30000);

        // ========================================
        // FIM DAS MELHORIAS SECUND√ÅRIAS
        // ========================================
    </script>
</body>
</html>