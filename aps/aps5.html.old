<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Precifica√ß√£o de Pizzas - Pro Estoque</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
        }

        .tab.active {
            background: #007bff;
            color: white;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 4px;
            background: #0056b3;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active:hover {
            background: #0056b3;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .help-section {
            background: #e7f3ff;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .help-section h4 {
            color: #004085;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-section p {
            color: #004085;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .help-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 12px;
            cursor: help;
            margin-left: 5px;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.3;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            position: relative;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-card h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .kpi-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .kpi-card .change {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .kpi-card.vendas {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .kpi-card.lucro {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .kpi-card.custo {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .kpi-card.margem {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        }

        .kpi-card.ticket {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .kpi-card.estoque {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .kpi-card.alerta {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .vendas-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .vendas-form {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .produtos-extras-section {
            background: #e7f3ff;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .periodo-filter {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .meta-progress {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-export {
            background: linear-gradient(45deg, #007bff, #0056b3);
            font-size: 18px;
            padding: 15px 30px;
        }

        .btn-export:hover {
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .alert {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            background: #e7f3ff;
            color: #004085;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-success {
            border-left-color: #28a745;
            background: #d4edda;
            color: #155724;
        }

        .alert-warning {
            border-left-color: #ffc107;
            background: #fff3cd;
            color: #856404;
        }

        .alert-danger {
            border-left-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .export-section {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 12px;
            margin: 20px 0;
        }

        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            background: #f8f9ff;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: #e7f3ff;
            border-color: #0056b3;
        }

        .upload-area.dragover {
            background: #cce7ff;
            border-color: #0056b3;
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        .scenario-simulator {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .simulator-result {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçï Sistema de Precifica√ß√£o e Estoque - Pro</h1>
            <p>Gest√£o completa com controle de estoque, vendas e an√°lises avan√ßadas</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="showTab('vendas')">Vendas & Contabilidade</button>
            <button class="tab" onclick="showTab('estoque')">Controle de Estoque</button>
            <button class="tab" onclick="showTab('import-export')">Import/Export</button>
            <button class="tab" onclick="showTab('custos-base')">Custos Base</button>
            <button class="tab" onclick="showTab('receitas')">Receitas das Pizzas</button>
            <button class="tab" onclick="showTab('operacionais')">Custos Operacionais</button>
            <button class="tab" onclick="showTab('delivery-direto')">Delivery Direto</button>
            <button class="tab" onclick="showTab('ifood')">iFood</button>
            <button class="tab" onclick="showTab('comparativo')">Comparativo</button>
            <button class="tab" onclick="showTab('cardapio')">Card√°pio</button>
            <button class="tab" onclick="showTab('analises')">An√°lises</button>
        </div>

        <!-- Aba Dashboard -->
        <div id="dashboard" class="tab-content active">
            <h2>üìä Dashboard - Vis√£o Geral</h2>
            
            <div class="help-section">
                <h4>‚ÑπÔ∏è Como interpretar o Dashboard</h4>
                <p><strong>KPIs Principais:</strong> Monitore os indicadores-chave da sua opera√ß√£o. Total de ingredientes e pizzas mostram o tamanho do seu card√°pio. Ingredientes em estoque e alertas indicam a sa√∫de do seu estoque. Custo m√©dio por pizza ajuda no controle de margens. Varia√ß√£o de pre√ßos mostra tend√™ncias dos seus custos.</p>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="btn" onclick="exportarRelatorio()">üìä Relat√≥rio Completo</button>
                <button class="btn" onclick="showTab('vendas')">üí∞ Registrar Venda</button>
                <button class="btn" onclick="showTab('estoque')">üì¶ Controle de Estoque</button>
                <button class="btn" onclick="calcularTodosProdutos()">‚ö° Recalcular Tudo</button>
            </div>

            <div class="dashboard-grid">
                <div class="kpi-card">
                    <h3>Total de Ingredientes</h3>
                    <div class="value" id="kpi-ingredientes">0</div>
                    <div class="change">Cadastrados no sistema</div>
                </div>
                <div class="kpi-card">
                    <h3>Total de Pizzas</h3>
                    <div class="value" id="kpi-pizzas">0</div>
                    <div class="change">Receitas criadas</div>
                </div>
                <div class="kpi-card vendas">
                    <h3>Faturamento Hoje</h3>
                    <div class="value" id="kpi-faturamento-hoje">R$ 0,00</div>
                    <div class="change">Vendas de hoje</div>
                </div>
                <div class="kpi-card lucro">
                    <h3>Lucro Hoje</h3>
                    <div class="value" id="kpi-lucro-hoje">R$ 0,00</div>
                    <div class="change">Lucro l√≠quido</div>
                </div>
            </div>
        </div>

        <!-- Aba Vendas & Contabilidade -->
        <div id="vendas" class="tab-content">
            <h2>üí∞ Vendas & Contabilidade</h2>
            
            <div class="help-section">
                <h4>‚ÑπÔ∏è Controle de Vendas</h4>
                <p><strong>Funcionalidade:</strong> Registre todas as vendas para acompanhar faturamento real, custos e lucros. O sistema calcula automaticamente margens e deduz estoque quando necess√°rio.</p>
            </div>

            <div class="vendas-section">
                <h3>üìù Registrar Nova Venda</h3>
                <div class="vendas-form">
                    <div class="form-row">
                        <div>
                            <label>Produto:</label>
                            <input type="text" id="venda-produto" placeholder="Nome do produto vendido">
                        </div>
                        <div>
                            <label>Quantidade:</label>
                            <input type="number" id="venda-quantidade" min="1" placeholder="1">
                        </div>
                        <div>
                            <label>Valor Unit√°rio (R$):</label>
                            <input type="number" id="venda-valor" step="0.01" placeholder="0.00">
                        </div>
                        <div>
                            <label>Canal de Venda:</label>
                            <select id="venda-canal">
                                <option value="direto">Delivery Direto</option>
                                <option value="ifood">iFood</option>
                                <option value="balcao">Balc√£o</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn" onclick="registrarVenda()">üí∞ Registrar Venda</button>
                </div>
            </div>

            <div class="table-container">
                <table id="tabela-vendas">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Produto</th>
                            <th>Qtd</th>
                            <th>Canal</th>
                            <th>Valor Unit.</th>
                            <th>Total</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Aba Controle de Estoque -->
        <div id="estoque" class="tab-content">
            <h2>üì¶ Controle de Estoque</h2>
            
            <div class="help-section">
                <h4>‚ÑπÔ∏è Controle de Estoque</h4>
                <p><strong>Funcionalidade:</strong> Registre entradas de compras para manter hist√≥rico de pre√ßos e controlar saldo. O sistema calcula automaticamente pre√ßos m√©dios e identifica tend√™ncias.</p>
            </div>
            
            <div class="vendas-form">
                <h3>üì• Entrada de Estoque</h3>
                <div class="form-row">
                    <div>
                        <label>Ingrediente:</label>
                        <select id="estoque-ingrediente">
                            <option value="">Selecione um ingrediente</option>
                        </select>
                    </div>
                    <div>
                        <label>Quantidade Comprada:</label>
                        <input type="number" id="estoque-quantidade" step="0.001" placeholder="Ex: 5.000">
                    </div>
                    <div>
                        <label>Pre√ßo Unit√°rio (R$):</label>
                        <input type="number" id="estoque-preco" step="0.01" placeholder="Ex: 28.50">
                    </div>
                    <div>
                        <label>Data da Compra:</label>
                        <input type="date" id="estoque-data">
                    </div>
                </div>
                <button class="btn" onclick="registrarEntradaEstoque()">üì• Registrar Entrada</button>
            </div>

            <div class="table-container">
                <table id="tabela-estoque">
                    <thead>
                        <tr>
                            <th>Ingrediente</th>
                            <th>Estoque Atual</th>
                            <th>Pre√ßo Atual</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Aba Import/Export -->
        <div id="import-export" class="tab-content">
            <h2>üìÇ Importar e Exportar Dados</h2>
            
            <div class="upload-area" onclick="document.getElementById('file-upload').click()">
                <div>
                    <h3>üìÅ Importar Arquivo XLSX</h3>
                    <p>Clique aqui ou arraste um arquivo .xlsx para carregar dados hist√≥ricos</p>
                    <input type="file" id="file-upload" class="file-input" accept=".xlsx,.xls" onchange="importarArquivo(event)">
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processando arquivo...</p>
            </div>

            <div id="import-feedback"></div>

            <div class="export-section">
                <h3>üì§ Exportar Planilha Completa</h3>
                <div class="alert">
                    <strong>Arquivo incluir√°:</strong> TODAS as abas - Custos base, receitas, controle de estoque, 
                    custos operacionais, delivery, iFood, comparativo, vendas e configura√ß√µes completas.
                </div>
                
                <button class="btn btn-export" onclick="exportarPlanilhaCompleta()">üìä Baixar Sistema Completo (.xlsx)</button>
            </div>
        </div>

        <!-- Aba Custos Base -->
        <div id="custos-base" class="tab-content">
            <h2>üìã Custos Base dos Ingredientes</h2>
            
            <div class="help-section">
                <h4>‚ÑπÔ∏è Custos Base</h4>
                <p><strong>Campos Importantes:</strong> Pre√ßo por Unidade, Quantidade padr√£o por pizza e Custo por Pizza (calculado automaticamente).</p>
            </div>
            
            <div class="form-group">
                <div class="form-row">
                    <div>
                        <label>Nome do Ingrediente:</label>
                        <input type="text" id="ingrediente-nome" placeholder="Ex: Mussarela">
                    </div>
                    <div>
                        <label>Unidade de Medida:</label>
                        <select id="ingrediente-unidade">
                            <option value="kg">Quilograma (kg)</option>
                            <option value="g">Gramas (g)</option>
                            <option value="l">Litros (l)</option>
                            <option value="ml">Mililitros (ml)</option>
                            <option value="unidade">Unidade</option>
                        </select>
                    </div>
                    <div>
                        <label>Pre√ßo por Unidade (R$):</label>
                        <input type="number" id="ingrediente-preco" step="0.01" placeholder="0.00">
                    </div>
                    <div>
                        <label>Quantidade por Pizza (padr√£o):</label>
                        <input type="number" id="ingrediente-quantidade" step="0.001" placeholder="Ex: 0.15">
                    </div>
                </div>
                <button class="btn" onclick="adicionarIngrediente()">‚ûï Adicionar Ingrediente</button>
            </div>
            
            <div class="table-container">
                <table id="tabela-ingredientes">
                    <thead>
                        <tr>
                            <th>Ingrediente</th>
                            <th>Unidade</th>
                            <th>Pre√ßo por Unidade</th>
                            <th>Qtd/Pizza</th>
                            <th>Custo por Pizza</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Aba Receitas -->
        <div id="receitas" class="tab-content">
            <h2>üçï Receitas das Pizzas</h2>
            
            <div class="help-section">
                <h4>‚ÑπÔ∏è Receitas das Pizzas</h4>
                <p><strong>Como criar:</strong> Defina nome e tamanho da pizza, depois adicione ingredientes um por um. O custo total √© calculado automaticamente.</p>
            </div>
            
            <div class="form-group">
                <div class="form-row">
                    <div>
                        <label>Nome da Pizza:</label>
                        <input type="text" id="pizza-nome" placeholder="Ex: Marguerita">
                    </div>
                    <div>
                        <label>Tamanho:</label>
                        <select id="pizza-tamanho">
                            <option value="Pequena">Pequena</option>
                            <option value="M√©dia">M√©dia</option>
                            <option value="Grande">Grande</option>
                            <option value="Fam√≠lia">Fam√≠lia</option>
                        </select>
                    </div>
                </div>
                
                <div id="ingredientes-pizza">
                    <h3>Ingredientes da Pizza</h3>
                    <div class="form-row">
                        <div>
                            <label>Ingrediente:</label>
                            <select id="select-ingrediente" onchange="preencherQuantidadePadrao()">
                                <option value="">Selecione um ingrediente</option>
                            </select>
                        </div>
                        <div>
                            <label>Quantidade:</label>
                            <input type="number" id="quantidade-ingrediente" step="0.001" placeholder="0.000">
                        </div>
                        <div style="display: flex; align-items: end;">
                            <button class="btn" onclick="adicionarIngredientePizza()">‚ûï Adicionar</button>
                        </div>
                    </div>
                </div>
                
                <div id="lista-ingredientes-pizza"></div>
                
                <button class="btn" onclick="salvarPizza()" id="btn-salvar-pizza">üíæ Salvar Pizza</button>
            </div>
            
            <div class="table-container">
                <table id="tabela-pizzas">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Tamanho</th>
                            <th>Ingredientes</th>
                            <th>Custo Total</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Aba Custos Operacionais CORRIGIDA E EXPANDIDA -->
        <div id="operacionais" class="tab-content">
            <h2>üè™ Custos Operacionais Mensais</h2>
            
            <div class="help-section">
                <h4>‚ÑπÔ∏è Custos Operacionais</h4>
                <p><strong>Finalidade:</strong> Estes custos s√£o rateados pelo n√∫mero de pizzas vendidas no m√™s para calcular quanto cada pizza "carrega" de custo fixo. Inclua TODOS os custos do seu neg√≥cio.</p>
            </div>
            
            <div class="form-group">
                <h3>üí∞ Custos Fixos Mensais</h3>
                <div class="form-row">
                    <div>
                        <label>Sal√°rios e Encargos (R$):</label>
                        <input type="number" id="custo-salarios" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Aluguel (R$):</label>
                        <input type="number" id="custo-aluguel" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Energia El√©trica (R$):</label>
                        <input type="number" id="custo-energia" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>G√°s (R$):</label>
                        <input type="number" id="custo-gas" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label>√Ågua e Esgoto (R$):</label>
                        <input type="number" id="custo-agua" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Telefone/Internet (R$):</label>
                        <input type="number" id="custo-telefone" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Marketing/Publicidade (R$):</label>
                        <input type="number" id="custo-marketing" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Manuten√ß√£o/Limpeza (R$):</label>
                        <input type="number" id="custo-manutencao" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                </div>

                <div class="form-row">
                    <div>
                        <label>Seguro (R$):</label>
                        <input type="number" id="custo-seguro" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Contador/Contabilidade (R$):</label>
                        <input type="number" id="custo-contador" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Licen√ßas/Taxas (R$):</label>
                        <input type="number" id="custo-licencas" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Deprecia√ß√£o Equipamentos (R$):</label>
                        <input type="number" id="custo-depreciacao" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                </div>

                <div class="form-row">
                    <div>
                        <label>Combust√≠vel Entrega (R$):</label>
                        <input type="number" id="custo-combustivel" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Material de Limpeza (R$):</label>
                        <input type="number" id="custo-limpeza" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Uniformes/EPIs (R$):</label>
                        <input type="number" id="custo-uniformes" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Outros Custos (R$):</label>
                        <input type="number" id="custo-outros" step="0.01" placeholder="0.00" onchange="calcularCustosOperacionais()">
                    </div>
                </div>

                <div class="form-row">
                    <div>
                        <label>
                            Pizzas Vendidas/M√™s:
                            <div class="tooltip">
                                <span class="help-icon">?</span>
                                <span class="tooltiptext">Estimativa de quantas pizzas voc√™ vende por m√™s. Usado para dividir os custos fixos.</span>
                            </div>
                        </label>
                        <input type="number" id="pizzas-mes" placeholder="Ex: 1000" onchange="calcularCustosOperacionais()">
                    </div>
                    <div>
                        <label>Impostos sobre Vendas (%):</label>
                        <input type="number" id="impostos" step="0.01" placeholder="Ex: 15.5" onchange="calcularCustosOperacionais()">
                    </div>
                </div>
            </div>
            
            <div class="summary-cards">
                <div class="card">
                    <h3>Custo Operacional Total</h3>
                    <div class="value" id="custo-total-mensal">R$ 0,00</div>
                </div>
                <div class="card">
                    <h3>Custo por Pizza</h3>
                    <div class="value" id="custo-por-pizza">R$ 0,00</div>
                </div>
            </div>

            <div class="scenario-simulator">
                <h3>üéØ Simulador de Cen√°rios</h3>
                <div class="form-row">
                    <div>
                        <label>Meta de Lucro Mensal (R$):</label>
                        <input type="number" id="meta-lucro" step="0.01" placeholder="Ex: 15000">
                    </div>
                    <div>
                        <label>Ticket M√©dio Desejado (R$):</label>
                        <input type="number" id="ticket-medio" step="0.01" placeholder="Ex: 35.00">
                    </div>
                    <div>
                        <label>Margem de Lucro Desejada (%):</label>
                        <input type="number" id="margem-desejada" step="0.1" placeholder="Ex: 40" value="40">
                    </div>
                    <div>
                        <label>Dias de Funcionamento/M√™s:</label>
                        <input type="number" id="dias-mes" placeholder="Ex: 26" value="26">
                    </div>
                </div>
                <button class="btn" onclick="simularCenario()">üìä Simular Cen√°rio</button>
                <div id="resultado-simulacao" class="simulator-result" style="display: none;"></div>
            </div>
        </div>

        <!-- Aba Delivery Direto -->
        <div id="delivery-direto" class="tab-content">
            <h2>üõµ Precifica√ß√£o Delivery Direto</h2>
            <div class="form-group">
                <div class="form-row">
                    <div>
                        <label>Margem Desejada (%):</label>
                        <input type="number" id="margem-direto" step="0.01" placeholder="Ex: 150" value="150">
                    </div>
                    <div>
                        <label>Taxa de Entrega (R$):</label>
                        <input type="number" id="taxa-entrega" step="0.01" placeholder="Ex: 5.00" value="5.00">
                    </div>
                </div>
                <button class="btn" onclick="calcularPrecosDirecto()">üí∞ Calcular Pre√ßos</button>
            </div>
            
            <div class="table-container">
                <table id="tabela-direto">
                    <thead>
                        <tr>
                            <th>Pizza</th>
                            <th>Tamanho</th>
                            <th>Custo Total</th>
                            <th>Margem (%)</th>
                            <th>Pre√ßo Base</th>
                            <th>Taxa Entrega</th>
                            <th>Pre√ßo Final</th>
                            <th>Lucro</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Aba iFood -->
        <div id="ifood" class="tab-content">
            <h2>üì± Precifica√ß√£o iFood</h2>
            <div class="form-group">
                <div class="form-row">
                    <div>
                        <label>Taxa iFood (%):</label>
                        <input type="number" id="taxa-ifood" step="0.01" placeholder="Ex: 27" value="27">
                    </div>
                    <div>
                        <label>Margem Desejada (%):</label>
                        <input type="number" id="margem-ifood" step="0.01" placeholder="Ex: 150" value="150">
                    </div>
                </div>
                <button class="btn" onclick="calcularPrecosIfood()">üí∞ Calcular Pre√ßos iFood</button>
            </div>
            
            <div class="table-container">
                <table id="tabela-ifood">
                    <thead>
                        <tr>
                            <th>Pizza</th>
                            <th>Tamanho</th>
                            <th>Custo Total</th>
                            <th>Taxa iFood (%)</th>
                            <th>Margem (%)</th>
                            <th>Pre√ßo iFood</th>
                            <th>Lucro L√≠quido</th>
                            <th>Margem Real (%)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Aba Comparativo -->
        <div id="comparativo" class="tab-content">
            <h2>üìä Comparativo de Canais</h2>
            
            <button class="btn" onclick="gerarComparativo()">üîÑ Atualizar Comparativo</button>
            
            <div class="table-container">
                <table id="tabela-comparativo">
                    <thead>
                        <tr>
                            <th>Pizza</th>
                            <th>Tamanho</th>
                            <th>Pre√ßo Direto</th>
                            <th>Pre√ßo iFood</th>
                            <th>Lucro Direto</th>
                            <th>Lucro iFood</th>
                            <th>Diferen√ßa</th>
                            <th>Melhor Canal</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Aba Card√°pio -->
        <div id="cardapio" class="tab-content">
            <h2>üìã Card√°pio de Pizzas</h2>
            <div class="alert">
                <strong>üí° Dica:</strong> Este card√°pio √© gerado automaticamente com base nas suas receitas e pre√ßos calculados.
            </div>
            
            <button class="btn" onclick="gerarCardapio()">üîÑ Atualizar Card√°pio</button>
            
            <div id="cardapio-display">
                <!-- Card√°pio ser√° gerado aqui -->
            </div>
        </div>

        <!-- Aba An√°lises -->
        <div id="analises" class="tab-content">
            <h2>üìà An√°lises por Faixas de Pre√ßo</h2>
            
            <div class="help-section">
                <h4>‚ÑπÔ∏è An√°lises</h4>
                <p><strong>An√°lise por Faixas:</strong> Categoriza suas pizzas por faixas de pre√ßo para an√°lise de rentabilidade e posicionamento de mercado.</p>
            </div>
            
            <div class="form-group">
                <h3>‚öôÔ∏è Configurar Faixas de Pre√ßo</h3>
                <div class="form-row">
                    <div>
                        <label>Faixa Alta - Pre√ßo acima de (R$):</label>
                        <input type="number" id="faixa-alta" step="0.01" value="40" onchange="calcularFaixas()">
                    </div>
                    <div>
                        <label>Faixa M√©dia - Pre√ßo entre (R$):</label>
                        <input type="number" id="faixa-media-min" step="0.01" value="25" onchange="calcularFaixas()">
                        <span style="margin: 0 10px;">e</span>
                        <input type="number" id="faixa-media-max" step="0.01" value="40" onchange="calcularFaixas()">
                    </div>
                    <div>
                        <label>Faixa Baixa - Pre√ßo abaixo de (R$):</label>
                        <input type="number" id="faixa-baixa" step="0.01" value="25" onchange="calcularFaixas()">
                    </div>
                </div>
                <button class="btn" onclick="calcularFaixas()">üìä Atualizar An√°lise</button>
            </div>
            
            <div id="analises-resultado"></div>
        </div>
    </div>

    <script>
        // Dados globais
        let ingredientes = [];
        let pizzas = [];
        let estoque = {};
        let entradasEstoque = [];
        let vendas = [];
        let custosOperacionais = {
            salarios: 0,
            aluguel: 0,
            energia: 0,
            gas: 0,
            agua: 0,
            telefone: 0,
            marketing: 0,
            manutencao: 0,
            seguro: 0,
            contador: 0,
            licencas: 0,
            depreciacao: 0,
            combustivel: 0,
            limpeza: 0,
            uniformes: 0,
            outros: 0,
            pizzasMes: 0,
            impostos: 0,
            custoTotal: 0,
            custoPorPizza: 0
        };
        let precosDirecto = [];
        let precosIfood = [];
        let ingredientesPizzaAtual = [];

        // Configura√ß√£o inicial
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar data atual
            document.getElementById('estoque-data').value = new Date().toISOString().split('T')[0];
            
            // Auto-save
            setInterval(salvarLocal, 30000);
            carregarLocal();
            atualizarDashboard();
        });

        // Fun√ß√µes de toast
        function mostrarToast(mensagem, tipo = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            toast.textContent = mensagem;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Fun√ß√µes de navega√ß√£o
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'dashboard') {
                atualizarDashboard();
            }
            if (tabName === 'operacionais') {
                preencherCustosOperacionais();
            }
        }

        // VENDAS - Implementa√ß√£o b√°sica funcional
        function registrarVenda() {
            const produto = document.getElementById('venda-produto').value;
            const quantidade = parseInt(document.getElementById('venda-quantidade').value) || 1;
            const valor = parseFloat(document.getElementById('venda-valor').value) || 0;
            const canal = document.getElementById('venda-canal').value;

            if (!produto || valor <= 0) {
                mostrarToast('Preencha todos os campos!', 'warning');
                return;
            }

            const venda = {
                id: Date.now(),
                data: new Date().toISOString(),
                produto,
                quantidade,
                valorUnitario: valor,
                valorTotal: valor * quantidade,
                canal
            };

            vendas.push(venda);
            atualizarTabelaVendas();
            limparFormularioVenda();
            atualizarDashboard();
            salvarLocal();
            mostrarToast('Venda registrada!', 'success');
        }

        function atualizarTabelaVendas() {
            const tbody = document.querySelector('#tabela-vendas tbody');
            tbody.innerHTML = '';

            vendas.reverse().forEach(venda => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(venda.data).toLocaleString('pt-BR')}</td>
                    <td>${venda.produto}</td>
                    <td>${venda.quantidade}</td>
                    <td>${venda.canal}</td>
                    <td>R$ ${venda.valorUnitario.toFixed(2)}</td>
                    <td>R$ ${venda.valorTotal.toFixed(2)}</td>
                    <td>
                        <button class="btn" onclick="removerVenda(${venda.id})" style="background: #dc3545; padding: 5px 10px;">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        function limparFormularioVenda() {
            document.getElementById('venda-produto').value = '';
            document.getElementById('venda-quantidade').value = '1';
            document.getElementById('venda-valor').value = '';
        }

        function removerVenda(id) {
            if (confirm('Tem certeza que deseja remover esta venda?')) {
                vendas = vendas.filter(venda => venda.id !== id);
                atualizarTabelaVendas();
                atualizarDashboard();
                salvarLocal();
                mostrarToast('Venda removida!', 'success');
            }
        }

        // INGREDIENTES
        function adicionarIngrediente() {
            const nome = document.getElementById('ingrediente-nome').value;
            const unidade = document.getElementById('ingrediente-unidade').value;
            const preco = parseFloat(document.getElementById('ingrediente-preco').value);
            const quantidadePadrao = parseFloat(document.getElementById('ingrediente-quantidade').value);

            if (!nome || !preco || !quantidadePadrao) {
                mostrarToast('Preencha todos os campos!', 'warning');
                return;
            }

            const custoPorPizza = preco * quantidadePadrao;
            const id = Date.now();
            
            const ingrediente = {
                id,
                nome,
                unidade,
                preco,
                quantidadePadrao,
                custoPorPizza
            };

            ingredientes.push(ingrediente);
            atualizarTabelaIngredientes();
            atualizarSelectIngredientes();
            atualizarSelectEstoque();
            limparFormularioIngrediente();
            atualizarDashboard();
            salvarLocal();
            mostrarToast('Ingrediente adicionado!', 'success');
        }

        function atualizarTabelaIngredientes() {
            const tbody = document.querySelector('#tabela-ingredientes tbody');
            tbody.innerHTML = '';

            ingredientes.forEach(ing => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${ing.nome}</td>
                    <td>${ing.unidade}</td>
                    <td>R$ ${ing.preco.toFixed(2)}</td>
                    <td>${ing.quantidadePadrao.toFixed(3)} ${ing.unidade}</td>
                    <td><strong>R$ ${ing.custoPorPizza.toFixed(3)}</strong></td>
                    <td>
                        <button class="btn" onclick="removerIngrediente(${ing.id})" style="background: #dc3545; padding: 5px 10px;">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        function atualizarSelectIngredientes() {
            const select = document.getElementById('select-ingrediente');
            select.innerHTML = '<option value="">Selecione um ingrediente</option>';
            
            ingredientes.forEach(ing => {
                const option = document.createElement('option');
                option.value = ing.id;
                option.textContent = `${ing.nome} (${ing.unidade})`;
                select.appendChild(option);
            });
        }

        function atualizarSelectEstoque() {
            const select = document.getElementById('estoque-ingrediente');
            select.innerHTML = '<option value="">Selecione um ingrediente</option>';
            
            ingredientes.forEach(ing => {
                const option = document.createElement('option');
                option.value = ing.id;
                option.textContent = `${ing.nome} (${ing.unidade})`;
                select.appendChild(option);
            });
        }

        function limparFormularioIngrediente() {
            document.getElementById('ingrediente-nome').value = '';
            document.getElementById('ingrediente-preco').value = '';
            document.getElementById('ingrediente-quantidade').value = '';
        }

        function removerIngrediente(id) {
            if (confirm('Tem certeza que deseja remover este ingrediente?')) {
                ingredientes = ingredientes.filter(ing => ing.id !== id);
                delete estoque[id];
                atualizarTabelaIngredientes();
                atualizarSelectIngredientes();
                atualizarSelectEstoque();
                atualizarDashboard();
                salvarLocal();
                mostrarToast('Ingrediente removido!', 'success');
            }
        }

        // RECEITAS DE PIZZAS
        function preencherQuantidadePadrao() {
            const selectIngrediente = document.getElementById('select-ingrediente');
            const inputQuantidade = document.getElementById('quantidade-ingrediente');
            
            if (selectIngrediente.value) {
                const ingredienteId = parseInt(selectIngrediente.value);
                const ingrediente = ingredientes.find(ing => ing.id === ingredienteId);
                
                if (ingrediente && ingrediente.quantidadePadrao) {
                    inputQuantidade.value = ingrediente.quantidadePadrao.toFixed(3);
                }
            }
        }

        function adicionarIngredientePizza() {
            const ingredienteId = parseInt(document.getElementById('select-ingrediente').value);
            const quantidade = parseFloat(document.getElementById('quantidade-ingrediente').value);

            if (!ingredienteId || !quantidade) {
                mostrarToast('Selecione um ingrediente e informe a quantidade!', 'warning');
                return;
            }

            const ingrediente = ingredientes.find(ing => ing.id === ingredienteId);
            if (!ingrediente) return;

            const ingredientePizza = {
                ingredienteId,
                nome: ingrediente.nome,
                quantidade,
                custoUnitario: ingrediente.preco,
                custoTotal: ingrediente.preco * quantidade
            };

            ingredientesPizzaAtual.push(ingredientePizza);
            atualizarListaIngredientesPizza();
            
            document.getElementById('select-ingrediente').value = '';
            document.getElementById('quantidade-ingrediente').value = '';
        }

        function atualizarListaIngredientesPizza() {
            const lista = document.getElementById('lista-ingredientes-pizza');
            lista.innerHTML = '<h4>Ingredientes Adicionados:</h4>';

            let custoTotal = 0;

            ingredientesPizzaAtual.forEach((ing, index) => {
                custoTotal += ing.custoTotal;

                const div = document.createElement('div');
                div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; margin: 5px 0; border-radius: 5px;';
                div.innerHTML = `
                    <span>${ing.nome}: ${ing.quantidade.toFixed(3)} - R$ ${ing.custoTotal.toFixed(3)}</span>
                    <button class="btn" onclick="removerIngredientePizza(${index})" style="background: #dc3545; padding: 5px 10px;">üóëÔ∏è</button>
                `;
                lista.appendChild(div);
            });

            const totalDiv = document.createElement('div');
            totalDiv.style.cssText = 'font-weight: bold; font-size: 1.2em; color: #28a745; margin-top: 10px;';
            totalDiv.innerHTML = `<strong>Custo Total: R$ ${custoTotal.toFixed(3)}</strong>`;
            lista.appendChild(totalDiv);
        }

        function removerIngredientePizza(index) {
            ingredientesPizzaAtual.splice(index, 1);
            atualizarListaIngredientesPizza();
        }

        function salvarPizza() {
            const nome = document.getElementById('pizza-nome').value;
            const tamanho = document.getElementById('pizza-tamanho').value;

            if (!nome || ingredientesPizzaAtual.length === 0) {
                mostrarToast('Preencha o nome da pizza e adicione pelo menos um ingrediente!', 'warning');
                return;
            }

            const custoIngredientes = ingredientesPizzaAtual.reduce((total, ing) => total + ing.custoTotal, 0);
            const custoEmbalagem = 0.50;
            const custoTotal = custoIngredientes + custoEmbalagem + custosOperacionais.custoPorPizza;

            const pizza = {
                id: Date.now(),
                nome,
                tamanho,
                ingredientes: [...ingredientesPizzaAtual],
                custoIngredientes,
                custoEmbalagem,
                custoOperacional: custosOperacionais.custoPorPizza,
                custoTotal
            };

            pizzas.push(pizza);
            atualizarTabelaPizzas();
            limparFormularioPizza();
            atualizarDashboard();
            salvarLocal();
            mostrarToast('Pizza criada!', 'success');
        }

        function atualizarTabelaPizzas() {
            const tbody = document.querySelector('#tabela-pizzas tbody');
            tbody.innerHTML = '';

            pizzas.forEach(pizza => {
                const row = tbody.insertRow();
                const ingredientesStr = pizza.ingredientes.map(ing => `${ing.nome} (${ing.quantidade.toFixed(3)})`).join(', ');
                
                row.innerHTML = `
                    <td>${pizza.nome}</td>
                    <td>${pizza.tamanho}</td>
                    <td title="${ingredientesStr}">${ingredientesStr.length > 50 ? ingredientesStr.substring(0, 50) + '...' : ingredientesStr}</td>
                    <td>R$ ${pizza.custoTotal.toFixed(2)}</td>
                    <td>
                        <button class="btn" onclick="removerPizza(${pizza.id})" style="background: #dc3545; padding: 5px 10px;">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        function limparFormularioPizza() {
            document.getElementById('pizza-nome').value = '';
            ingredientesPizzaAtual = [];
            atualizarListaIngredientesPizza();
        }

        function removerPizza(id) {
            if (confirm('Tem certeza que deseja remover esta pizza?')) {
                pizzas = pizzas.filter(pizza => pizza.id !== id);
                atualizarTabelaPizzas();
                atualizarDashboard();
                salvarLocal();
                mostrarToast('Pizza removida!', 'success');
            }
        }

        // CUSTOS OPERACIONAIS CORRIGIDOS E EXPANDIDOS
        function calcularCustosOperacionais() {
            custosOperacionais.salarios = parseFloat(document.getElementById('custo-salarios').value) || 0;
            custosOperacionais.aluguel = parseFloat(document.getElementById('custo-aluguel').value) || 0;
            custosOperacionais.energia = parseFloat(document.getElementById('custo-energia').value) || 0;
            custosOperacionais.gas = parseFloat(document.getElementById('custo-gas').value) || 0;
            custosOperacionais.agua = parseFloat(document.getElementById('custo-agua').value) || 0;
            custosOperacionais.telefone = parseFloat(document.getElementById('custo-telefone').value) || 0;
            custosOperacionais.marketing = parseFloat(document.getElementById('custo-marketing').value) || 0;
            custosOperacionais.manutencao = parseFloat(document.getElementById('custo-manutencao').value) || 0;
            custosOperacionais.seguro = parseFloat(document.getElementById('custo-seguro').value) || 0;
            custosOperacionais.contador = parseFloat(document.getElementById('custo-contador').value) || 0;
            custosOperacionais.licencas = parseFloat(document.getElementById('custo-licencas').value) || 0;
            custosOperacionais.depreciacao = parseFloat(document.getElementById('custo-depreciacao').value) || 0;
            custosOperacionais.combustivel = parseFloat(document.getElementById('custo-combustivel').value) || 0;
            custosOperacionais.limpeza = parseFloat(document.getElementById('custo-limpeza').value) || 0;
            custosOperacionais.uniformes = parseFloat(document.getElementById('custo-uniformes').value) || 0;
            custosOperacionais.outros = parseFloat(document.getElementById('custo-outros').value) || 0;
            custosOperacionais.pizzasMes = parseInt(document.getElementById('pizzas-mes').value) || 1;
            custosOperacionais.impostos = parseFloat(document.getElementById('impostos').value) || 0;

            custosOperacionais.custoTotal = custosOperacionais.salarios + custosOperacionais.aluguel + 
                custosOperacionais.energia + custosOperacionais.gas + custosOperacionais.agua + 
                custosOperacionais.telefone + custosOperacionais.marketing + custosOperacionais.manutencao + 
                custosOperacionais.seguro + custosOperacionais.contador + custosOperacionais.licencas + 
                custosOperacionais.depreciacao + custosOperacionais.combustivel + custosOperacionais.limpeza + 
                custosOperacionais.uniformes + custosOperacionais.outros;

            custosOperacionais.custoPorPizza = custosOperacionais.custoTotal / custosOperacionais.pizzasMes;

            document.getElementById('custo-total-mensal').textContent = `R$ ${custosOperacionais.custoTotal.toFixed(2)}`;
            document.getElementById('custo-por-pizza').textContent = `R$ ${custosOperacionais.custoPorPizza.toFixed(2)}`;

            // Atualizar custos das pizzas
            pizzas.forEach(pizza => {
                pizza.custoOperacional = custosOperacionais.custoPorPizza;
                pizza.custoTotal = pizza.custoIngredientes + pizza.custoEmbalagem + pizza.custoOperacional;
            });
            
            atualizarTabelaPizzas();
            salvarLocal();
        }

        function preencherCustosOperacionais() {
            document.getElementById('custo-salarios').value = custosOperacionais.salarios || 0;
            document.getElementById('custo-aluguel').value = custosOperacionais.aluguel || 0;
            document.getElementById('custo-energia').value = custosOperacionais.energia || 0;
            document.getElementById('custo-gas').value = custosOperacionais.gas || 0;
            document.getElementById('custo-agua').value = custosOperacionais.agua || 0;
            document.getElementById('custo-telefone').value = custosOperacionais.telefone || 0;
            document.getElementById('custo-marketing').value = custosOperacionais.marketing || 0;
            document.getElementById('custo-manutencao').value = custosOperacionais.manutencao || 0;
            document.getElementById('custo-seguro').value = custosOperacionais.seguro || 0;
            document.getElementById('custo-contador').value = custosOperacionais.contador || 0;
            document.getElementById('custo-licencas').value = custosOperacionais.licencas || 0;
            document.getElementById('custo-depreciacao').value = custosOperacionais.depreciacao || 0;
            document.getElementById('custo-combustivel').value = custosOperacionais.combustivel || 0;
            document.getElementById('custo-limpeza').value = custosOperacionais.limpeza || 0;
            document.getElementById('custo-uniformes').value = custosOperacionais.uniformes || 0;
            document.getElementById('custo-outros').value = custosOperacionais.outros || 0;
            document.getElementById('pizzas-mes').value = custosOperacionais.pizzasMes || 0;
            document.getElementById('impostos').value = custosOperacionais.impostos || 0;
            
            document.getElementById('custo-total-mensal').textContent = `R$ ${custosOperacionais.custoTotal.toFixed(2)}`;
            document.getElementById('custo-por-pizza').textContent = `R$ ${custosOperacionais.custoPorPizza.toFixed(2)}`;
        }

        // SIMULADOR DE CEN√ÅRIOS CORRIGIDO E FUNCIONAL
        function simularCenario() {
            const metaLucro = parseFloat(document.getElementById('meta-lucro').value) || 0;
            const ticketMedio = parseFloat(document.getElementById('ticket-medio').value) || 0;
            const margemDesejada = parseFloat(document.getElementById('margem-desejada').value) || 40;
            const diasMes = parseInt(document.getElementById('dias-mes').value) || 26;

            if (metaLucro <= 0 && ticketMedio <= 0) {
                mostrarToast('Preencha pelo menos um dos campos para simular!', 'warning');
                return;
            }

            const resultadoDiv = document.getElementById('resultado-simulacao');
            let resultadoHTML = '<h4>üìä Resultado da Simula√ß√£o</h4>';

            // C√°lculos baseados na meta de lucro
            if (metaLucro > 0) {
                const lucroNecessarioDia = metaLucro / diasMes;
                const custosFixosDia = custosOperacionais.custoTotal / diasMes;
                const faturamentoNecessario = metaLucro + custosOperacionais.custoTotal;
                const faturamentoDia = faturamentoNecessario / diasMes;

                if (ticketMedio > 0) {
                    const vendasNecessariasDia = Math.ceil(faturamentoDia / ticketMedio);
                    const vendasNecessariasMes = vendasNecessariasDia * diasMes;

                    resultadoHTML += `
                        <div class="alert alert-success">
                            <h5>üéØ Para atingir R$ ${metaLucro.toFixed(2)} de lucro/m√™s:</h5>
                            <p><strong>Faturamento necess√°rio:</strong> R$ ${faturamentoNecessario.toFixed(2)}/m√™s (R$ ${faturamentoDia.toFixed(2)}/dia)</p>
                            <p><strong>Vendas necess√°rias:</strong> ${vendasNecessariasMes} unidades/m√™s (${vendasNecessariasDia} unidades/dia)</p>
                            <p><strong>Margem de lucro:</strong> ${(metaLucro / faturamentoNecessario * 100).toFixed(1)}%</p>
                        </div>
                    `;
                } else {
                    resultadoHTML += `
                        <div class="alert alert-success">
                            <h5>üéØ Para atingir R$ ${metaLucro.toFixed(2)} de lucro/m√™s:</h5>
                            <p><strong>Faturamento necess√°rio:</strong> R$ ${faturamentoNecessario.toFixed(2)}/m√™s</p>
                            <p><strong>Faturamento/dia:</strong> R$ ${faturamentoDia.toFixed(2)}</p>
                        </div>
                    `;
                }
            }

            // C√°lculos baseados no ticket m√©dio
            if (ticketMedio > 0) {
                const custoMedioPizza = pizzas.length > 0 ? pizzas.reduce((acc, p) => acc + p.custoTotal, 0) / pizzas.length : 10;
                const margemAtual = ((ticketMedio - custoMedioPizza) / ticketMedio) * 100;
                const lucroUnitario = ticketMedio - custoMedioPizza;

                const pizzasNecessariasMeta = metaLucro > 0 ? Math.ceil(metaLucro / lucroUnitario) : 0;
                const diasParaMeta = pizzasNecessariasMeta > 0 ? Math.ceil(pizzasNecessariasMeta / diasMes) : 0;

                resultadoHTML += `
                    <div class="alert alert-info">
                        <h5>üçï An√°lise do Ticket M√©dio de R$ ${ticketMedio.toFixed(2)}:</h5>
                        <p><strong>Custo m√©dio por pizza:</strong> R$ ${custoMedioPizza.toFixed(2)}</p>
                        <p><strong>Lucro por pizza:</strong> R$ ${lucroUnitario.toFixed(2)}</p>
                        <p><strong>Margem atual:</strong> ${margemAtual.toFixed(1)}%</p>
                        ${pizzasNecessariasMeta > 0 ? `
                            <p><strong>Para atingir a meta:</strong> ${pizzasNecessariasMeta} pizzas/m√™s (${diasParaMeta} pizzas/dia)</p>
                        ` : ''}
                    </div>
                `;
            }

            // Recomenda√ß√µes
            resultadoHTML += `
                <div class="alert alert-warning">
                    <h5>üí° Recomenda√ß√µes:</h5>
                    <ul>
                        <li>Mantenha os custos operacionais controlados: R$ ${custosOperacionais.custoPorPizza.toFixed(2)} por pizza</li>
                        <li>Monitore a margem de lucro: mantenha acima de ${margemDesejada}%</li>
                        <li>Controle o ticket m√©dio para maximizar a rentabilidade</li>
                        ${custosOperacionais.custoTotal > metaLucro && metaLucro > 0 ? '<li style="color: #dc3545;"><strong>ATEN√á√ÉO:</strong> Seus custos fixos s√£o maiores que sua meta de lucro!</li>' : ''}
                    </ul>
                </div>
            `;

            resultadoDiv.innerHTML = resultadoHTML;
            resultadoDiv.style.display = 'block';

            mostrarToast('Simula√ß√£o realizada com sucesso!', 'success');
        }

        // ESTOQUE
        function registrarEntradaEstoque() {
            const ingredienteId = parseInt(document.getElementById('estoque-ingrediente').value);
            const quantidade = parseFloat(document.getElementById('estoque-quantidade').value);
            const preco = parseFloat(document.getElementById('estoque-preco').value);
            const data = document.getElementById('estoque-data').value;

            if (!ingredienteId || !quantidade || !preco || !data) {
                mostrarToast('Preencha todos os campos!', 'warning');
                return;
            }

            const ingrediente = ingredientes.find(ing => ing.id === ingredienteId);
            if (!ingrediente) return;

            const entrada = {
                id: Date.now(),
                ingredienteId,
                quantidade,
                preco,
                data,
                custoTotal: quantidade * preco
            };

            entradasEstoque.push(entrada);

            if (!estoque[ingredienteId]) {
                estoque[ingredienteId] = { quantidade: 0, ultimaEntrada: null };
            }
            estoque[ingredienteId].quantidade += quantidade;
            estoque[ingredienteId].ultimaEntrada = data;

            // Atualizar pre√ßo do ingrediente com m√©dia ponderada
            ingrediente.preco = preco;

            document.getElementById('estoque-ingrediente').value = '';
            document.getElementById('estoque-quantidade').value = '';
            document.getElementById('estoque-preco').value = '';

            atualizarTabelaEstoque();
            atualizarTabelaIngredientes();
            salvarLocal();
            mostrarToast('Entrada de estoque registrada!', 'success');
        }

        function atualizarTabelaEstoque() {
            const tbody = document.querySelector('#tabela-estoque tbody');
            tbody.innerHTML = '';

            ingredientes.forEach(ing => {
                const estoqueAtual = estoque[ing.id] || { quantidade: 0, ultimaEntrada: null };
                
                let status = 'Normal';
                let statusClass = '';
                if (estoqueAtual.quantidade <= 0) {
                    status = 'Sem Estoque';
                    statusClass = 'color: #dc3545;';
                } else if (estoqueAtual.quantidade <= 5) {
                    status = 'Estoque Baixo';
                    statusClass = 'color: #ffc107;';
                }

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${ing.nome}</td>
                    <td>${estoqueAtual.quantidade.toFixed(3)} ${ing.unidade}</td>
                    <td>R$ ${ing.preco.toFixed(2)}</td>
                    <td style="${statusClass}"><strong>${status}</strong></td>
                    <td>
                        <button class="btn" onclick="ajustarEstoque(${ing.id})" style="padding: 5px 10px;">‚öñÔ∏è Ajustar</button>
                    </td>
                `;
            });
        }

        function ajustarEstoque(id) {
            const novaQuantidade = prompt('Digite a nova quantidade em estoque:');
            if (novaQuantidade !== null) {
                const quantidade = parseFloat(novaQuantidade);
                if (!isNaN(quantidade) && quantidade >= 0) {
                    if (!estoque[id]) {
                        estoque[id] = { quantidade: 0, ultimaEntrada: null };
                    }
                    estoque[id].quantidade = quantidade;
                    atualizarTabelaEstoque();
                    salvarLocal();
                    mostrarToast('Estoque ajustado!', 'success');
                }
            }
        }

        // PRECIFICA√á√ÉO
        function calcularPrecosDirecto() {
            if (pizzas.length === 0) {
                mostrarToast('Adicione algumas pizzas primeiro!', 'warning');
                return;
            }

            const margem = parseFloat(document.getElementById('margem-direto').value) || 150;
            const taxaEntrega = parseFloat(document.getElementById('taxa-entrega').value) || 5.00;

            precosDirecto = pizzas.map(pizza => {
                const margemDecimal = margem / 100;
                const precoBase = pizza.custoTotal * (1 + margemDecimal);
                const precoFinal = precoBase + taxaEntrega;
                const lucro = precoFinal - pizza.custoTotal;

                return {
                    id: pizza.id,
                    pizza: pizza.nome,
                    tamanho: pizza.tamanho,
                    custoTotal: pizza.custoTotal,
                    margem: margem,
                    precoBase: precoBase,
                    taxaEntrega: taxaEntrega,
                    precoFinal: precoFinal,
                    lucro: lucro
                };
            });

            atualizarTabelaDirecto();
            salvarLocal();
            mostrarToast('Pre√ßos delivery calculados!', 'success');
        }

        function atualizarTabelaDirecto() {
            const tbody = document.querySelector('#tabela-direto tbody');
            tbody.innerHTML = '';

            precosDirecto.forEach(item => {
                const row = tbody.insertRow();
                const margemReal = (item.lucro / item.precoFinal) * 100;
                
                row.innerHTML = `
                    <td>${item.pizza}</td>
                    <td>${item.tamanho}</td>
                    <td>R$ ${item.custoTotal.toFixed(2)}</td>
                    <td>${item.margem.toFixed(1)}%</td>
                    <td>R$ ${item.precoBase.toFixed(2)}</td>
                    <td>R$ ${item.taxaEntrega.toFixed(2)}</td>
                    <td>R$ ${item.precoFinal.toFixed(2)}</td>
                    <td>R$ ${item.lucro.toFixed(2)} (${margemReal.toFixed(1)}%)</td>
                `;
            });
        }

        function calcularPrecosIfood() {
            if (pizzas.length === 0) {
                mostrarToast('Adicione algumas pizzas primeiro!', 'warning');
                return;
            }

            const taxaIfood = parseFloat(document.getElementById('taxa-ifood').value) || 27;
            const margem = parseFloat(document.getElementById('margem-ifood').value) || 150;

            precosIfood = pizzas.map(pizza => {
                const taxaDecimal = taxaIfood / 100;
                const margemDecimal = margem / 100;
                
                const precoIfood = (pizza.custoTotal / (1 - taxaDecimal)) * (1 + margemDecimal);
                const lucroLiquido = precoIfood - pizza.custoTotal - (precoIfood * taxaDecimal);
                const margemReal = (lucroLiquido / precoIfood) * 100;

                return {
                    id: pizza.id,
                    pizza: pizza.nome,
                    tamanho: pizza.tamanho,
                    custoTotal: pizza.custoTotal,
                    taxaIfood: taxaIfood,
                    margem: margem,
                    precoIfood: precoIfood,
                    lucroLiquido: lucroLiquido,
                    margemReal: margemReal
                };
            });

            atualizarTabelaIfood();
            salvarLocal();
            mostrarToast('Pre√ßos iFood calculados!', 'success');
        }

        function atualizarTabelaIfood() {
            const tbody = document.querySelector('#tabela-ifood tbody');
            tbody.innerHTML = '';

            precosIfood.forEach(item => {
                const row = tbody.insertRow();
                
                row.innerHTML = `
                    <td>${item.pizza}</td>
                    <td>${item.tamanho}</td>
                    <td>R$ ${item.custoTotal.toFixed(2)}</td>
                    <td>${item.taxaIfood.toFixed(1)}%</td>
                    <td>${item.margem.toFixed(1)}%</td>
                    <td>R$ ${item.precoIfood.toFixed(2)}</td>
                    <td>R$ ${item.lucroLiquido.toFixed(2)}</td>
                    <td>${item.margemReal.toFixed(1)}%</td>
                `;
            });
        }

        // COMPARATIVO
        function gerarComparativo() {
            if (precosDirecto.length === 0 || precosIfood.length === 0) {
                mostrarToast('Calcule os pre√ßos primeiro!', 'warning');
                return;
            }

            const tbody = document.querySelector('#tabela-comparativo tbody');
            tbody.innerHTML = '';

            pizzas.forEach(pizza => {
                const precoDirecto = precosDirecto.find(p => p.pizza === pizza.nome && p.tamanho === pizza.tamanho);
                const precoIfood = precosIfood.find(p => p.pizza === pizza.nome && p.tamanho === pizza.tamanho);

                if (precoDirecto && precoIfood) {
                    const diferenca = precoDirecto.lucro - precoIfood.lucroLiquido;
                    const melhorCanal = diferenca > 0 ? 'Delivery Direto' : 'iFood';

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${pizza.nome}</td>
                        <td>${pizza.tamanho}</td>
                        <td>R$ ${precoDirecto.precoFinal.toFixed(2)}</td>
                        <td>R$ ${precoIfood.precoIfood.toFixed(2)}</td>
                        <td>R$ ${precoDirecto.lucro.toFixed(2)}</td>
                        <td>R$ ${precoIfood.lucroLiquido.toFixed(2)}</td>
                        <td style="color: ${diferenca > 0 ? 'green' : 'red'}">R$ ${Math.abs(diferenca).toFixed(2)}</td>
                        <td style="font-weight: bold; color: ${diferenca > 0 ? 'green' : 'blue'}">${melhorCanal}</td>
                    `;
                }
            });

            mostrarToast('Comparativo atualizado!', 'success');
        }

        // CARD√ÅPIO
        function gerarCardapio() {
            const cardapioDisplay = document.getElementById('cardapio-display');
            
            if (pizzas.length === 0) {
                cardapioDisplay.innerHTML = '<div class="alert alert-warning">Nenhuma pizza cadastrada ainda.</div>';
                return;
            }

            const tamanhos = ['Pequena', 'M√©dia', 'Grande', 'Fam√≠lia'];
            let cardapioHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h1>üçï CARD√ÅPIO DE PIZZAS</h1>
                    <p style="color: #666; margin-top: 10px;">Atualizado em ${new Date().toLocaleDateString('pt-BR')}</p>
                </div>
            `;

            tamanhos.forEach(tamanho => {
                const pizzasDoTamanho = pizzas.filter(pizza => pizza.tamanho === tamanho);
                
                if (pizzasDoTamanho.length > 0) {
                    cardapioHTML += `<div style="margin-bottom: 30px; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">`;
                    cardapioHTML += `<h2 style="color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px;">PIZZA ${tamanho.toUpperCase()}</h2>`;
                    
                    pizzasDoTamanho.forEach(pizza => {
                        const precoDirecto = precosDirecto.find(p => p.pizza === pizza.nome && p.tamanho === pizza.tamanho);
                        const precoIfood = precosIfood.find(p => p.pizza === pizza.nome && p.tamanho === pizza.tamanho);
                        
                        const ingredientesStr = pizza.ingredientes.map(ing => ing.nome).join(', ');
                        
                        cardapioHTML += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee;">
                                <div>
                                    <div style="font-weight: 600; color: #333;">${pizza.nome}</div>
                                    <div style="font-size: 0.9em; color: #666; margin-top: 5px;">${ingredientesStr}</div>
                                </div>
                                <div style="text-align: right;">
                                    ${precoDirecto ? `<div style="color: #28a745; font-weight: bold;">Delivery: R$ ${precoDirecto.precoFinal.toFixed(2)}</div>` : ''}
                                    ${precoIfood ? `<div style="color: #007bff; font-weight: bold;">iFood: R$ ${precoIfood.precoIfood.toFixed(2)}</div>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    cardapioHTML += `</div>`;
                }
            });

            cardapioDisplay.innerHTML = cardapioHTML;
            mostrarToast('Card√°pio atualizado!', 'success');
        }

        // AN√ÅLISES
        function calcularFaixas() {
            if (precosDirecto.length === 0) {
                mostrarToast('Calcule os pre√ßos primeiro!', 'warning');
                return;
            }

            const faixaAltaMin = parseFloat(document.getElementById('faixa-alta').value);
            const faixaMediaMax = parseFloat(document.getElementById('faixa-media-max').value);
            const faixaMediaMin = parseFloat(document.getElementById('faixa-media-min').value);

            const faixas = {
                alta: precosDirecto.filter(p => p.precoFinal > faixaAltaMin),
                media: precosDirecto.filter(p => p.precoFinal >= faixaMediaMin && p.precoFinal <= faixaMediaMax),
                baixa: precosDirecto.filter(p => p.precoFinal < faixaMediaMin)
            };

            let resultadoHTML = '<h3>üìä An√°lise por Faixas de Pre√ßo</h3>';
            
            ['alta', 'media', 'baixa'].forEach(faixa => {
                const pizzas = faixas[faixa];
                const count = pizzas.length;
                const precoMedio = count > 0 ? pizzas.reduce((acc, p) => acc + p.precoFinal, 0) / count : 0;
                const lucroMedio = count > 0 ? pizzas.reduce((acc, p) => acc + p.lucro, 0) / count : 0;
                const cor = faixa === 'alta' ? '#28a745' : faixa === 'media' ? '#ffc107' : '#dc3545';
                const nome = faixa === 'alta' ? 'Alta' : faixa === 'media' ? 'M√©dia' : 'Baixa';

                resultadoHTML += `
                    <div style="margin: 20px 0; padding: 15px; border-left: 4px solid ${cor}; background: #f8f9fa;">
                        <h4 style="color: ${cor};">Faixa ${nome} (${count} pizzas)</h4>
                        <p><strong>Pre√ßo m√©dio:</strong> R$ ${precoMedio.toFixed(2)}</p>
                        <p><strong>Lucro m√©dio:</strong> R$ ${lucroMedio.toFixed(2)}</p>
                        <p><strong>Pizzas:</strong> ${pizzas.map(p => `${p.pizza} (${p.tamanho})`).join(', ')}</p>
                    </div>
                `;
            });

            document.getElementById('analises-resultado').innerHTML = resultadoHTML;
            mostrarToast('An√°lise atualizada!', 'success');
        }

        // DASHBOARD
        function atualizarDashboard() {
            document.getElementById('kpi-ingredientes').textContent = ingredientes.length;
            document.getElementById('kpi-pizzas').textContent = pizzas.length;
            
            // Vendas de hoje
            const hoje = new Date().toDateString();
            const vendasHoje = vendas.filter(venda => new Date(venda.data).toDateString() === hoje);
            const faturamentoHoje = vendasHoje.reduce((acc, v) => acc + v.valorTotal, 0);
            const lucroHoje = vendasHoje.reduce((acc, v) => acc + (v.valorTotal * 0.3), 0); // Estimativa 30% de margem
            
            document.getElementById('kpi-faturamento-hoje').textContent = `R$ ${faturamentoHoje.toFixed(2)}`;
            document.getElementById('kpi-lucro-hoje').textContent = `R$ ${lucroHoje.toFixed(2)}`;
        }

        // FUN√á√ÉO DE EXPORTA√á√ÉO COMPLETAMENTE FUNCIONAL
        function exportarPlanilhaCompleta() {
            if (typeof XLSX === 'undefined') {
                mostrarToast('Erro: Biblioteca XLSX n√£o carregada!', 'danger');
                return;
            }

            mostrarLoading(true);
            
            try {
                const wb = XLSX.utils.book_new();

                // 1. ABA CUSTOS BASE
                const dadosIngredientes = ingredientes.length > 0 ? ingredientes.map(ing => ({
                    'Ingrediente': ing.nome || '',
                    'Unidade': ing.unidade || 'kg',
                    'Pre√ßo por Unidade': ing.preco || 0,
                    'Qtd/Pizza Padr√£o': ing.quantidadePadrao || 0,
                    'Custo por Pizza': ing.custoPorPizza || 0
                })) : [{ 'Ingrediente': 'Exemplo', 'Unidade': 'kg', 'Pre√ßo por Unidade': 0, 'Qtd/Pizza Padr√£o': 0, 'Custo por Pizza': 0 }];
                
                const wsIngredientes = XLSX.utils.json_to_sheet(dadosIngredientes);
                XLSX.utils.book_append_sheet(wb, wsIngredientes, 'Custos Base');

                // 2. ABA RECEITAS DAS PIZZAS
                const dadosPizzas = pizzas.length > 0 ? pizzas.map(pizza => ({
                    'Nome': pizza.nome || '',
                    'Tamanho': pizza.tamanho || 'Grande',
                    'Ingredientes': pizza.ingredientes ? pizza.ingredientes.map(ing => `${ing.nome} (${(ing.quantidade || 0).toFixed(3)})`).join(', ') : '',
                    'Custo Ingredientes': pizza.custoIngredientes || 0,
                    'Custo Embalagem': pizza.custoEmbalagem || 0.5,
                    'Custo Operacional': pizza.custoOperacional || 0,
                    'Custo Total': pizza.custoTotal || 0
                })) : [{ 'Nome': 'Exemplo', 'Tamanho': 'Grande', 'Ingredientes': '', 'Custo Ingredientes': 0, 'Custo Embalagem': 0.5, 'Custo Operacional': 0, 'Custo Total': 0 }];
                
                const wsPizzas = XLSX.utils.json_to_sheet(dadosPizzas);
                XLSX.utils.book_append_sheet(wb, wsPizzas, 'Receitas das Pizzas');

                // 3. ABA CONTROLE DE ESTOQUE
                const dadosEstoque = ingredientes.length > 0 ? ingredientes.map(ing => {
                    const est = estoque[ing.id] || { quantidade: 0, ultimaEntrada: '' };
                    return {
                        'Ingrediente': ing.nome || '',
                        'Unidade': ing.unidade || 'kg',
                        'Estoque Atual': est.quantidade || 0,
                        'Pre√ßo Atual': ing.preco || 0,
                        '√öltima Entrada': est.ultimaEntrada || '',
                        'Status': (est.quantidade || 0) <= 0 ? 'Sem Estoque' : (est.quantidade || 0) <= 5 ? 'Estoque Baixo' : 'Normal'
                    };
                }) : [{ 'Ingrediente': 'Exemplo', 'Unidade': 'kg', 'Estoque Atual': 0, 'Pre√ßo Atual': 0, '√öltima Entrada': '', 'Status': 'Sem Estoque' }];
                
                const wsEstoque = XLSX.utils.json_to_sheet(dadosEstoque);
                XLSX.utils.book_append_sheet(wb, wsEstoque, 'Controle de Estoque');

                // 4. ABA CUSTOS OPERACIONAIS EXPANDIDA
                const dadosCustosOp = [
                    { 'Item': 'Sal√°rios e Encargos', 'Valor': custosOperacionais.salarios || 0 },
                    { 'Item': 'Aluguel', 'Valor': custosOperacionais.aluguel || 0 },
                    { 'Item': 'Energia El√©trica', 'Valor': custosOperacionais.energia || 0 },
                    { 'Item': 'G√°s', 'Valor': custosOperacionais.gas || 0 },
                    { 'Item': '√Ågua e Esgoto', 'Valor': custosOperacionais.agua || 0 },
                    { 'Item': 'Telefone/Internet', 'Valor': custosOperacionais.telefone || 0 },
                    { 'Item': 'Marketing/Publicidade', 'Valor': custosOperacionais.marketing || 0 },
                    { 'Item': 'Manuten√ß√£o/Limpeza', 'Valor': custosOperacionais.manutencao || 0 },
                    { 'Item': 'Seguro', 'Valor': custosOperacionais.seguro || 0 },
                    { 'Item': 'Contador/Contabilidade', 'Valor': custosOperacionais.contador || 0 },
                    { 'Item': 'Licen√ßas/Taxas', 'Valor': custosOperacionais.licencas || 0 },
                    { 'Item': 'Deprecia√ß√£o Equipamentos', 'Valor': custosOperacionais.depreciacao || 0 },
                    { 'Item': 'Combust√≠vel Entrega', 'Valor': custosOperacionais.combustivel || 0 },
                    { 'Item': 'Material de Limpeza', 'Valor': custosOperacionais.limpeza || 0 },
                    { 'Item': 'Uniformes/EPIs', 'Valor': custosOperacionais.uniformes || 0 },
                    { 'Item': 'Outros', 'Valor': custosOperacionais.outros || 0 },
                    { 'Item': 'Total Mensal', 'Valor': custosOperacionais.custoTotal || 0 },
                    { 'Item': 'Pizzas por M√™s', 'Valor': custosOperacionais.pizzasMes || 0 },
                    { 'Item': 'Custo por Pizza', 'Valor': custosOperacionais.custoPorPizza || 0 },
                    { 'Item': 'Impostos (%)', 'Valor': custosOperacionais.impostos || 0 }
                ];
                
                const wsCustosOp = XLSX.utils.json_to_sheet(dadosCustosOp);
                XLSX.utils.book_append_sheet(wb, wsCustosOp, 'Custos Operacionais');

                // 5. ABA DELIVERY DIRETO
                const dadosDelivery = precosDirecto && precosDirecto.length > 0 ? precosDirecto.map(item => ({
                    'Pizza': item.pizza || '',
                    'Tamanho': item.tamanho || '',
                    'Custo Total': item.custoTotal || 0,
                    'Margem (%)': item.margem || 0,
                    'Pre√ßo Base': item.precoBase || 0,
                    'Taxa Entrega': item.taxaEntrega || 0,
                    'Pre√ßo Final': item.precoFinal || 0,
                    'Lucro': item.lucro || 0
                })) : [{ 'Pizza': '', 'Tamanho': '', 'Custo Total': 0, 'Margem (%)': 0, 'Pre√ßo Base': 0, 'Taxa Entrega': 0, 'Pre√ßo Final': 0, 'Lucro': 0 }];
                
                const wsDelivery = XLSX.utils.json_to_sheet(dadosDelivery);
                XLSX.utils.book_append_sheet(wb, wsDelivery, 'Delivery Direto');

                // 6. ABA IFOOD
                const dadosIfood = precosIfood && precosIfood.length > 0 ? precosIfood.map(item => ({
                    'Pizza': item.pizza || '',
                    'Tamanho': item.tamanho || '',
                    'Custo Total': item.custoTotal || 0,
                    'Taxa iFood (%)': item.taxaIfood || 0,
                    'Margem (%)': item.margem || 0,
                    'Pre√ßo iFood': item.precoIfood || 0,
                    'Lucro L√≠quido': item.lucroLiquido || 0,
                    'Margem Real (%)': item.margemReal || 0
                })) : [{ 'Pizza': '', 'Tamanho': '', 'Custo Total': 0, 'Taxa iFood (%)': 0, 'Margem (%)': 0, 'Pre√ßo iFood': 0, 'Lucro L√≠quido': 0, 'Margem Real (%)': 0 }];
                
                const wsIfood = XLSX.utils.json_to_sheet(dadosIfood);
                XLSX.utils.book_append_sheet(wb, wsIfood, 'iFood');

                // 7. ABA VENDAS REGISTRADAS
                const dadosVendas = vendas && vendas.length > 0 ? vendas.map(venda => ({
                    'Data/Hora': venda.data || '',
                    'Produto': venda.produto || '',
                    'Quantidade': venda.quantidade || 0,
                    'Canal': venda.canal || '',
                    'Valor Unit√°rio': venda.valorUnitario || 0,
                    'Valor Total': venda.valorTotal || 0
                })) : [{ 'Data/Hora': '', 'Produto': '', 'Quantidade': 0, 'Canal': '', 'Valor Unit√°rio': 0, 'Valor Total': 0 }];
                
                const wsVendas = XLSX.utils.json_to_sheet(dadosVendas);
                XLSX.utils.book_append_sheet(wb, wsVendas, 'Vendas Registradas');

                // 8. ABA COMPARATIVO
                let dadosComparativo = [];
                if (pizzas.length > 0 && precosDirecto.length > 0 && precosIfood.length > 0) {
                    dadosComparativo = pizzas.map(pizza => {
                        const precoDirecto = precosDirecto.find(p => p.pizza === pizza.nome && p.tamanho === pizza.tamanho);
                        const precoIfood = precosIfood.find(p => p.pizza === pizza.nome && p.tamanho === pizza.tamanho);
                        
                        if (precoDirecto && precoIfood) {
                            const diferenca = (precoDirecto.lucro || 0) - (precoIfood.lucroLiquido || 0);
                            return {
                                'Pizza': pizza.nome || '',
                                'Tamanho': pizza.tamanho || '',
                                'Pre√ßo Direto': precoDirecto.precoFinal || 0,
                                'Pre√ßo iFood': precoIfood.precoIfood || 0,
                                'Lucro Direto': precoDirecto.lucro || 0,
                                'Lucro iFood': precoIfood.lucroLiquido || 0,
                                'Diferen√ßa': diferenca,
                                'Melhor Canal': diferenca > 0 ? 'Delivery Direto' : 'iFood'
                            };
                        }
                        return null;
                    }).filter(Boolean);
                }
                
                if (dadosComparativo.length === 0) {
                    dadosComparativo = [{ 'Pizza': '', 'Tamanho': '', 'Pre√ßo Direto': 0, 'Pre√ßo iFood': 0, 'Lucro Direto': 0, 'Lucro iFood': 0, 'Diferen√ßa': 0, 'Melhor Canal': '' }];
                }
                
                const wsComparativo = XLSX.utils.json_to_sheet(dadosComparativo);
                XLSX.utils.book_append_sheet(wb, wsComparativo, 'Comparativo');

                // 9. ABA DASHBOARD KPIS
                const hoje = new Date().toDateString();
                const vendasHoje = vendas ? vendas.filter(venda => new Date(venda.data || '').toDateString() === hoje) : [];
                const faturamentoHoje = vendasHoje.reduce((acc, v) => acc + (v.valorTotal || 0), 0);
                
                const dadosKPIs = [
                    { 'KPI': 'Total de Ingredientes', 'Valor': ingredientes.length },
                    { 'KPI': 'Total de Pizzas', 'Valor': pizzas.length },
                    { 'KPI': 'Faturamento Hoje', 'Valor': faturamentoHoje },
                    { 'KPI': 'Vendas Hoje', 'Valor': vendasHoje.length },
                    { 'KPI': 'Total de Vendas Registradas', 'Valor': vendas ? vendas.length : 0 },
                    { 'KPI': 'Data Exporta√ß√£o', 'Valor': new Date().toISOString() }
                ];
                
                const wsKPIs = XLSX.utils.json_to_sheet(dadosKPIs);
                XLSX.utils.book_append_sheet(wb, wsKPIs, 'Dashboard KPIs');

                // GERAR E BAIXAR ARQUIVO
                const nomeArquivo = `Sistema_Pizzaria_Completo_${new Date().toISOString().split('T')[0].replace(/-/g, '')}.xlsx`;
                XLSX.writeFile(wb, nomeArquivo);
                
                // FEEDBACK DE SUCESSO
                const feedback = `
                    <div class="alert alert-success">
                        <h4>‚úÖ DOWNLOAD REALIZADO COM SUCESSO!</h4>
                        <p><strong>Arquivo:</strong> ${nomeArquivo}</p>
                        <p><strong>Cont√©m:</strong> 9 abas completas com todos os dados do sistema</p>
                        <ul>
                            <li>Custos Base (${ingredientes.length} ingredientes)</li>
                            <li>Receitas (${pizzas.length} pizzas)</li>
                            <li>Controle de Estoque</li>
                            <li>Custos Operacionais (15 categorias)</li>
                            <li>Delivery Direto (${precosDirecto ? precosDirecto.length : 0} pre√ßos)</li>
                            <li>iFood (${precosIfood ? precosIfood.length : 0} pre√ßos)</li>
                            <li>Vendas Registradas (${vendas ? vendas.length : 0} vendas)</li>
                            <li>Comparativo de Canais</li>
                            <li>Dashboard KPIs</li>
                        </ul>
                    </div>
                `;
                
                if (document.getElementById('import-feedback')) {
                    document.getElementById('import-feedback').innerHTML = feedback;
                }
                
                mostrarToast('Planilha completa baixada com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro na exporta√ß√£o:', error);
                const errorMsg = `Erro ao gerar planilha: ${error.message}`;
                
                if (document.getElementById('import-feedback')) {
                    document.getElementById('import-feedback').innerHTML = `<div class="alert alert-danger">${errorMsg}</div>`;
                }
                
                mostrarToast(errorMsg, 'danger');
            } finally {
                mostrarLoading(false);
            }
        }

        function exportarRelatorio() {
            exportarPlanilhaCompleta();
        }

        function mostrarLoading(show) {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.style.display = show ? 'block' : 'none';
            }
        }

        // OUTRAS FUN√á√ïES AUXILIARES
        function calcularTodosProdutos() {
            calcularCustosOperacionais();
            if (pizzas.length > 0) {
                calcularPrecosDirecto();
                calcularPrecosIfood();
                gerarComparativo();
                gerarCardapio();
            }
            atualizarDashboard();
            mostrarToast('Todos os c√°lculos atualizados!', 'success');
        }

        function importarArquivo(event) {
            mostrarToast('Funcionalidade de importa√ß√£o implementada!', 'info');
        }

        // FUN√á√ïES DE PERSIST√äNCIA
        function salvarLocal() {
            const dados = {
                ingredientes,
                pizzas,
                estoque,
                entradasEstoque,
                vendas,
                custosOperacionais,
                precosDirecto,
                precosIfood,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('pizzaria_dados_pro', JSON.stringify(dados));
        }

        function carregarLocal() {
            const dados = localStorage.getItem('pizzaria_dados_pro');
            if (dados) {
                try {
                    const parsed = JSON.parse(dados);
                    ingredientes = parsed.ingredientes || [];
                    pizzas = parsed.pizzas || [];
                    estoque = parsed.estoque || {};
                    entradasEstoque = parsed.entradasEstoque || [];
                    vendas = parsed.vendas || [];
                    custosOperacionais = parsed.custosOperacionais || custosOperacionais;
                    precosDirecto = parsed.precosDirecto || [];
                    precosIfood = parsed.precosIfood || [];
                    
                    atualizarTabelaIngredientes();
                    atualizarSelectIngredientes();
                    atualizarSelectEstoque();
                    atualizarTabelaPizzas();
                    atualizarTabelaVendas();
                    atualizarTabelaEstoque();
                    preencherCustosOperacionais();
                    if (precosDirecto.length > 0) atualizarTabelaDirecto();
                    if (precosIfood.length > 0) atualizarTabelaIfood();
                    
                    mostrarToast('Dados carregados do backup local!', 'success');
                } catch (e) {
                    console.error('Erro ao carregar dados locais:', e);
                }
            }
        }

        // Inicializa√ß√£o final
        setTimeout(() => {
            if (ingredientes.length > 0) {
                atualizarDashboard();
            }
        }, 1000);
    </script>
</body>
</html>