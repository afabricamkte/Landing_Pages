<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>NPS Eventos Pro - Sistema Avançado de Pesquisas</title>
    <meta name="color-scheme" content="light dark">
    <link rel="stylesheet" href="assets/css/main.css">
    <style>
        /* Additional styles for the hybrid version */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            border-color: var(--brand-primary);
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--brand-primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .text-center {
            text-align: center;
        }

        .mb-2 {
            margin-bottom: 2rem;
        }

        .mt-2 {
            margin-top: 2rem;
        }

        .hidden {
            display: none !important;
        }

        .visible {
            display: block !important;
        }

        /* Quiz specific styles */
        .quiz-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .question-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-xl);
        }

        .question-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .question-help {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        .nps-scale {
            display: grid;
            grid-template-columns: repeat(11, 1fr);
            gap: 0.5rem;
            margin: 1.5rem 0;
        }

        .nps-btn {
            aspect-ratio: 1;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .nps-btn:hover {
            border-color: var(--brand-primary);
            background: var(--bg-elevated);
        }

        .nps-btn.selected {
            border-color: var(--brand-primary);
            background: var(--brand-gradient);
            color: #fff;
            transform: scale(1.05);
        }

        .nps-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .likert-scale {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            margin: 1.5rem 0;
        }

        .likert-btn {
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            font-size: 0.85rem;
        }

        .likert-btn:hover {
            border-color: var(--brand-primary);
            background: var(--bg-elevated);
        }

        .likert-btn.selected {
            border-color: var(--brand-primary);
            background: var(--brand-gradient);
            color: #fff;
        }

        .radio-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin: 1.5rem 0;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .radio-option:hover {
            border-color: var(--brand-primary);
            background: var(--bg-elevated);
        }

        .radio-option.selected {
            border-color: var(--brand-primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .radio-option input[type="radio"] {
            width: auto;
            margin: 0;
        }

        .quiz-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
        }

        .error-message {
            color: var(--error);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        /* Admin styles */
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .survey-table {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .survey-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 2fr;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }

        .survey-row:last-child {
            border-bottom: none;
        }

        .survey-row:hover {
            background: var(--bg-secondary);
        }

        .survey-header {
            background: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-secondary);
        }

        .survey-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-badge.draft {
            background: rgba(107, 114, 128, 0.2);
            color: var(--text-secondary);
        }

        .status-badge.active {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .status-badge.closed {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        /* Editor styles */
        .editor-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .editor-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .editor-section h3 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .radio-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .radio-group input[type="radio"] {
            width: auto;
            margin: 0;
        }

        .question-editor {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
            background: var(--bg-secondary);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .question-controls {
            display: flex;
            gap: 0.5rem;
        }

        .add-question-btn {
            width: 100%;
            padding: 1rem;
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 1rem;
        }

        .add-question-btn:hover {
            border-color: var(--brand-primary);
            color: var(--brand-primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nps-scale {
                grid-template-columns: repeat(6, 1fr);
                gap: 0.25rem;
            }

            .nps-scale .nps-btn:nth-child(n+7) {
                grid-column: span 1;
            }

            .likert-scale {
                grid-template-columns: 1fr;
            }

            .survey-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .quiz-navigation {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>

<body>
    <header class="app">
        <div class="container">
            <div class="header-content">
                <a href="#/" class="logo">
                    <div class="logo-icon">N</div>
                    <div>
                        <div class="brandTitle">NPS Eventos Pro</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Sistema Avançado de Pesquisas</div>
                    </div>
                </a>
                <div class="toolbar">
                    <div class="lang-switcher">
                        <button class="lang-btn active" data-lang="pt">PT</button>
                        <button class="lang-btn" data-lang="en">EN</button>
                        <button class="lang-btn" data-lang="es">ES</button>
                    </div>
                    <a href="#/admin" class="btn btn-ghost">Admin</a>
                </div>
            </div>
        </div>
    </header>

    <main id="app">
        <!-- Content will be dynamically loaded here -->
    </main>

    <footer class="app">
        <div class="footwrap">
            <div>© 2025 NPS Eventos Pro - Sistema Avançado de Pesquisas</div>
            <div>Desenvolvido com ❤️ para eventos excepcionais</div>
        </div>
    </footer>

    <script>
        // Global state and configuration
        const state = {
            surveys: {},
            slugs: {},
            ui: {
                lang: 'pt',
                adminPassword: null
            }
        };

        // Internationalization
        const I18N = {
            pt: {
                // Basic
                title: "NPS Eventos Pro",
                subtitle: "Sistema Avançado de Pesquisas",
                admin: "Admin",
                login: "Entrar",
                logout: "Sair",
                password: "Senha",
                save: "Salvar",
                cancel: "Cancelar",
                edit: "Editar",
                delete: "Excluir",
                duplicate: "Duplicar",
                view: "Visualizar",
                back: "Voltar",
                next: "Próximo",
                previous: "Anterior",
                finish: "Finalizar",
                
                // Survey management
                surveys: "Pesquisas",
                newSurvey: "Nova Pesquisa",
                surveyTitle: "Título da Pesquisa",
                eventDate: "Data do Evento",
                status: "Status",
                responses: "Respostas",
                actions: "Ações",
                draft: "Rascunho",
                active: "Ativa",
                closed: "Encerrada",
                
                // Questions
                questions: "Perguntas",
                addQuestion: "Adicionar Pergunta",
                questionType: "Tipo de Pergunta",
                questionText: "Texto da Pergunta",
                required: "Obrigatória",
                optional: "Opcional",
                
                // Question types
                nps: "NPS (0-10)",
                likert: "Escala Likert (1-5)",
                text: "Texto Curto",
                textarea: "Texto Longo",
                radio: "Múltipla Escolha (única)",
                checkbox: "Múltipla Escolha (múltipla)",
                select: "Lista Suspensa",
                
                // NPS specific
                npsQuestion: "Em uma escala de 0 a 10, o quanto você recomendaria este evento a um amigo ou colega do mesmo nicho de mercado?",
                notRecommend: "Não recomendaria",
                definitelyRecommend: "Recomendaria com certeza",
                
                // Quiz
                invalidLink: "Link inválido ou pesquisa inativa",
                thankYou: "Obrigado pela sua participação!",
                alreadyAnswered: "Você já respondeu esta pesquisa",
                
                // Stats
                totalSurveys: "Total de Pesquisas",
                totalResponses: "Total de Respostas",
                averageNPS: "NPS Médio",
                activeSurveys: "Pesquisas Ativas",
                
                // Errors
                fieldRequired: "Este campo é obrigatório",
                invalidPassword: "Senha incorreta",
                errorSaving: "Erro ao salvar",
                errorLoading: "Erro ao carregar"
            },
            en: {
                // Basic
                title: "NPS Events Pro",
                subtitle: "Advanced Survey System",
                admin: "Admin",
                login: "Login",
                logout: "Logout",
                password: "Password",
                save: "Save",
                cancel: "Cancel",
                edit: "Edit",
                delete: "Delete",
                duplicate: "Duplicate",
                view: "View",
                back: "Back",
                next: "Next",
                previous: "Previous",
                finish: "Finish",
                
                // Survey management
                surveys: "Surveys",
                newSurvey: "New Survey",
                surveyTitle: "Survey Title",
                eventDate: "Event Date",
                status: "Status",
                responses: "Responses",
                actions: "Actions",
                draft: "Draft",
                active: "Active",
                closed: "Closed",
                
                // Questions
                questions: "Questions",
                addQuestion: "Add Question",
                questionType: "Question Type",
                questionText: "Question Text",
                required: "Required",
                optional: "Optional",
                
                // Question types
                nps: "NPS (0-10)",
                likert: "Likert Scale (1-5)",
                text: "Short Text",
                textarea: "Long Text",
                radio: "Multiple Choice (single)",
                checkbox: "Multiple Choice (multiple)",
                select: "Dropdown",
                
                // NPS specific
                npsQuestion: "On a scale of 0 to 10, how likely would you recommend this event to a friend or colleague in the same market niche?",
                notRecommend: "Would not recommend",
                definitelyRecommend: "Would definitely recommend",
                
                // Quiz
                invalidLink: "Invalid link or inactive survey",
                thankYou: "Thank you for your participation!",
                alreadyAnswered: "You have already answered this survey",
                
                // Stats
                totalSurveys: "Total Surveys",
                totalResponses: "Total Responses",
                averageNPS: "Average NPS",
                activeSurveys: "Active Surveys",
                
                // Errors
                fieldRequired: "This field is required",
                invalidPassword: "Invalid password",
                errorSaving: "Error saving",
                errorLoading: "Error loading"
            },
            es: {
                // Basic
                title: "NPS Eventos Pro",
                subtitle: "Sistema Avanzado de Encuestas",
                admin: "Admin",
                login: "Iniciar Sesión",
                logout: "Cerrar Sesión",
                password: "Contraseña",
                save: "Guardar",
                cancel: "Cancelar",
                edit: "Editar",
                delete: "Eliminar",
                duplicate: "Duplicar",
                view: "Ver",
                back: "Volver",
                next: "Siguiente",
                previous: "Anterior",
                finish: "Finalizar",
                
                // Survey management
                surveys: "Encuestas",
                newSurvey: "Nueva Encuesta",
                surveyTitle: "Título de la Encuesta",
                eventDate: "Fecha del Evento",
                status: "Estado",
                responses: "Respuestas",
                actions: "Acciones",
                draft: "Borrador",
                active: "Activa",
                closed: "Cerrada",
                
                // Questions
                questions: "Preguntas",
                addQuestion: "Agregar Pregunta",
                questionType: "Tipo de Pregunta",
                questionText: "Texto de la Pregunta",
                required: "Obligatoria",
                optional: "Opcional",
                
                // Question types
                nps: "NPS (0-10)",
                likert: "Escala Likert (1-5)",
                text: "Texto Corto",
                textarea: "Texto Largo",
                radio: "Opción Múltiple (única)",
                checkbox: "Opción Múltiple (múltiple)",
                select: "Lista Desplegable",
                
                // NPS specific
                npsQuestion: "En una escala de 0 a 10, ¿qué tan probable es que recomiendes este evento a un amigo o colega del mismo nicho de mercado?",
                notRecommend: "No recomendaría",
                definitelyRecommend: "Definitivamente recomendaría",
                
                // Quiz
                invalidLink: "Enlace inválido o encuesta inactiva",
                thankYou: "¡Gracias por tu participación!",
                alreadyAnswered: "Ya has respondido esta encuesta",
                
                // Stats
                totalSurveys: "Total de Encuestas",
                totalResponses: "Total de Respuestas",
                averageNPS: "NPS Promedio",
                activeSurveys: "Encuestas Activas",
                
                // Errors
                fieldRequired: "Este campo es obligatorio",
                invalidPassword: "Contraseña incorrecta",
                errorSaving: "Error al guardar",
                errorLoading: "Error al cargar"
            }
        };

        // Translation function
        function t(key) {
            return I18N[state.ui.lang][key] || key;
        }

        // Utility functions
        function uid(prefix = '') {
            return prefix + Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function saveState() {
            localStorage.setItem('nps_events_state', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('nps_events_state');
            if (saved) {
                Object.assign(state, JSON.parse(saved));
            }
            
            // Initialize with default survey if none exists
            if (Object.keys(state.surveys).length === 0) {
                initializeDefaultSurvey();
            }
        }

        function initializeDefaultSurvey() {
            const surveyId = uid('srv_');
            const survey = {
                id: surveyId,
                slug: 'ellit-3a',
                title: {
                    pt: 'Pesquisa de Satisfação do Evento',
                    en: 'Event Satisfaction Survey',
                    es: 'Encuesta de Satisfacción del Evento'
                },
                eventDate: '2025-08-16',
                status: 'draft',
                brandColor: '#6366f1',
                requireToken: false,
                webhook: '',
                questions: [
                    {
                        id: 'q1',
                        type: 'nps',
                        required: true,
                        label: {
                            pt: 'Em uma escala de 0 a 10, o quanto você recomendaria este evento a um amigo ou colega do mesmo nicho de mercado?',
                            en: 'On a scale of 0 to 10, how likely would you recommend this event to a friend or colleague in the same market niche?',
                            es: 'En una escala de 0 a 10, ¿qué tan probable es que recomiendes este evento a un amigo o colega del mismo nicho de mercado?'
                        },
                        help: {
                            pt: '0 = não recomendaria; 10 = recomendaria com certeza',
                            en: '0 = would not recommend; 10 = would definitely recommend',
                            es: '0 = no recomendaría; 10 = definitivamente recomendaría'
                        }
                    },
                    {
                        id: 'q2',
                        type: 'likert',
                        required: true,
                        label: {
                            pt: 'Organização geral do evento (1-5)',
                            en: 'Overall event organization (1-5)',
                            es: 'Organización general del evento (1-5)'
                        },
                        help: {
                            pt: '1 = muito ruim; 5 = excelente',
                            en: '1 = very poor; 5 = excellent',
                            es: '1 = muy malo; 5 = excelente'
                        }
                    }
                ],
                responses: [],
                tokens: {},
                answeredDevices: {}
            };
            
            state.surveys[surveyId] = survey;
            state.slugs[survey.slug] = surveyId;
            saveState();
        }

        // Router
        function router() {
            const hash = window.location.hash.slice(1) || '/';
            const [path, queryString] = hash.split('?');
            const params = new URLSearchParams(queryString || '');
            
            const app = document.getElementById('app');
            
            if (path === '/' || path === '') {
                renderHome(app);
            } else if (path === '/admin') {
                if (params.get('edit')) {
                    renderEditor(app, params.get('edit'));
                } else {
                    renderAdmin(app);
                }
            } else if (path.startsWith('/s/')) {
                const slug = path.split('/')[2];
                renderQuiz(app, slug, params);
            } else {
                render404(app);
            }
        }

        // Render functions
        function renderHome(app) {
            app.innerHTML = `
                <div class="container">
                    <div class="text-center mb-2">
                        <h1>Bem-vindo ao NPS Eventos Pro</h1>
                        <p class="muted">Sistema avançado de pesquisas de satisfação para eventos</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${Object.keys(state.surveys).length}</div>
                            <div class="stat-label">${t('totalSurveys')}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${getTotalResponses()}</div>
                            <div class="stat-label">${t('totalResponses')}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${getAverageNPS()}</div>
                            <div class="stat-label">${t('averageNPS')}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${getActiveSurveys()}</div>
                            <div class="stat-label">${t('activeSurveys')}</div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <a href="#/admin" class="btn btn-primary">Acessar Área Administrativa</a>
                    </div>
                </div>
            `;
        }

        function renderAdmin(app) {
            if (!state.ui.adminPassword) {
                renderAdminLogin(app);
                return;
            }
            
            const surveys = Object.values(state.surveys);
            
            app.innerHTML = `
                <div class="admin-container">
                    <div class="admin-header">
                        <h2>${t('surveys')}</h2>
                        <div class="row">
                            <button class="btn btn-primary" onclick="createNewSurvey()">${t('newSurvey')}</button>
                            <button class="btn btn-ghost" onclick="logout()">${t('logout')}</button>
                        </div>
                    </div>
                    
                    <div class="survey-table">
                        <div class="survey-row survey-header">
                            <div>Título</div>
                            <div>Data do Evento</div>
                            <div>Status</div>
                            <div>Respostas</div>
                            <div>Ações</div>
                        </div>
                        ${surveys.map(survey => `
                            <div class="survey-row">
                                <div>
                                    <strong>${survey.title.pt}</strong>
                                    <div class="muted">Slug: ${survey.slug}</div>
                                </div>
                                <div>${survey.eventDate}</div>
                                <div>
                                    <span class="status-badge ${survey.status}">
                                        ${survey.status === 'draft' ? 'Rascunho' : survey.status === 'active' ? 'Ativa' : 'Encerrada'}
                                    </span>
                                </div>
                                <div>${survey.responses.length}</div>
                                <div class="survey-actions">
                                    <button class="btn small" onclick="editSurvey('${survey.id}')">${t('edit')}</button>
                                    <button class="btn small btn-success" onclick="viewSurvey('${survey.slug}')">${t('view')}</button>
                                    <button class="btn small btn-warning" onclick="duplicateSurvey('${survey.id}')">${t('duplicate')}</button>
                                    <button class="btn small btn-error" onclick="deleteSurvey('${survey.id}')">${t('delete')}</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderAdminLogin(app) {
            app.innerHTML = `
                <div class="container">
                    <div class="quiz-container">
                        <div class="question-card text-center">
                            <h2>Acesso do Administrador</h2>
                            <div class="form-group">
                                <label>Senha</label>
                                <input type="password" id="adminPassword" placeholder="Digite a senha">
                            </div>
                            <button class="btn btn-primary" onclick="adminLogin()" style="margin-top: 1rem;">Entrar</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEditor(app, surveyId) {
            const survey = state.surveys[surveyId];
            if (!survey) {
                render404(app);
                return;
            }
            
            app.innerHTML = `
                <div class="editor-container">
                    <div class="admin-header">
                        <h2>Editar Pesquisa</h2>
                        <button class="btn btn-ghost" onclick="window.location.hash = '/admin'">← ${t('back')}</button>
                    </div>
                    
                    <div class="editor-section">
                        <h3>Configurações Básicas</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Título (PT)</label>
                                <input type="text" id="titlePt" value="${survey.title.pt}">
                            </div>
                            <div class="form-group">
                                <label>Título (EN)</label>
                                <input type="text" id="titleEn" value="${survey.title.en}">
                            </div>
                            <div class="form-group">
                                <label>Título (ES)</label>
                                <input type="text" id="titleEs" value="${survey.title.es}">
                            </div>
                            <div class="form-group">
                                <label>Slug (URL amigável)</label>
                                <input type="text" id="slug" value="${survey.slug}">
                            </div>
                            <div class="form-group">
                                <label>Data do evento</label>
                                <input type="date" id="eventDate" value="${survey.eventDate}">
                            </div>
                            <div class="form-group">
                                <label>Cor da marca</label>
                                <input type="color" id="brandColor" value="${survey.brandColor}">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Status</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="status" value="draft" ${survey.status === 'draft' ? 'checked' : ''}>
                                    Rascunho
                                </label>
                                <label>
                                    <input type="radio" name="status" value="active" ${survey.status === 'active' ? 'checked' : ''}>
                                    Ativa
                                </label>
                                <label>
                                    <input type="radio" name="status" value="closed" ${survey.status === 'closed' ? 'checked' : ''}>
                                    Encerrada
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="requireToken" ${survey.requireToken ? 'checked' : ''}>
                                Exigir token (1 resposta por link)
                            </label>
                        </div>
                    </div>
                    
                    <div class="editor-section">
                        <h3>Perguntas Personalizadas</h3>
                        <div id="questionsContainer">
                            ${survey.questions.map((q, index) => renderQuestionEditor(q, index)).join('')}
                        </div>
                        <button class="add-question-btn" onclick="addQuestion('${surveyId}')">
                            + Adicionar Pergunta
                        </button>
                    </div>
                    
                    <div class="editor-section">
                        <h3>Configurações Avançadas</h3>
                        <div class="form-group">
                            <label>Webhook URL</label>
                            <input type="url" id="webhook" value="${survey.webhook}" placeholder="https://script.google.com/macros/s/.../exec">
                        </div>
                    </div>
                    
                    <div class="row" style="justify-content: space-between; margin-top: 2rem;">
                        <button class="btn btn-ghost" onclick="window.location.hash = '/admin'">Cancelar</button>
                        <div class="row">
                            <button class="btn btn-success" onclick="saveSurvey('${surveyId}')">Salvar</button>
                            <a href="#/s/${survey.slug}" class="btn btn-primary" target="_blank">Visualizar</a>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderQuestionEditor(question, index) {
            return `
                <div class="question-editor" data-question-id="${question.id}">
                    <div class="question-header">
                        <strong>Pergunta ${index + 1}</strong>
                        <div class="question-controls">
                            <button class="btn small" onclick="moveQuestion(${index}, -1)" ${index === 0 ? 'disabled' : ''}>↑</button>
                            <button class="btn small" onclick="moveQuestion(${index}, 1)">↓</button>
                            <button class="btn small btn-error" onclick="removeQuestion(${index})">×</button>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tipo</label>
                            <select onchange="updateQuestionType('${question.id}', this.value)">
                                <option value="nps" ${question.type === 'nps' ? 'selected' : ''}>NPS (0-10)</option>
                                <option value="likert" ${question.type === 'likert' ? 'selected' : ''}>Likert (1-5)</option>
                                <option value="text" ${question.type === 'text' ? 'selected' : ''}>Texto Curto</option>
                                <option value="textarea" ${question.type === 'textarea' ? 'selected' : ''}>Texto Longo</option>
                                <option value="radio" ${question.type === 'radio' ? 'selected' : ''}>Múltipla Escolha</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" ${question.required ? 'checked' : ''} onchange="updateQuestionRequired('${question.id}', this.checked)">
                                Obrigatória
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Pergunta (PT)</label>
                            <input type="text" value="${question.label.pt}" onchange="updateQuestionLabel('${question.id}', 'pt', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Pergunta (EN)</label>
                            <input type="text" value="${question.label.en}" onchange="updateQuestionLabel('${question.id}', 'en', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Pergunta (ES)</label>
                            <input type="text" value="${question.label.es}" onchange="updateQuestionLabel('${question.id}', 'es', this.value)">
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Texto de Ajuda (PT)</label>
                            <input type="text" value="${question.help?.pt || ''}" onchange="updateQuestionHelp('${question.id}', 'pt', this.value)">
                        </div>
                    </div>
                </div>
            `;
        }

        function renderQuiz(app, slug, params) {
            const surveyId = state.slugs[slug];
            const survey = state.surveys[surveyId];
            
            if (!survey || survey.status !== 'active') {
                app.innerHTML = `
                    <div class="container">
                        <div class="quiz-container">
                            <div class="question-card text-center">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
                                <h2>Ops!</h2>
                                <p class="muted">Link inválido ou pesquisa inativa</p>
                                <a href="#/" class="btn btn-primary" style="margin-top: 1rem;">← Voltar ao Início</a>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Initialize quiz state
            if (!window.quizState) {
                window.quizState = {
                    currentQuestion: 0,
                    answers: {},
                    surveyId: surveyId
                };
            }
            
            const currentQ = survey.questions[window.quizState.currentQuestion];
            const progress = ((window.quizState.currentQuestion + 1) / survey.questions.length) * 100;
            
            app.innerHTML = `
                <div class="container">
                    <div class="quiz-container">
                        <div class="progress">
                            <div class="progress-bar" style="width: ${progress}%"></div>
                        </div>
                        
                        <div class="question-card">
                            <div class="question-title">${currentQ.label[state.ui.lang]}</div>
                            ${currentQ.help ? `<div class="question-help">${currentQ.help[state.ui.lang]}</div>` : ''}
                            
                            <div id="questionInput">
                                ${renderQuestionInput(currentQ)}
                            </div>
                            
                            <div class="quiz-navigation">
                                <button class="btn btn-ghost" onclick="previousQuestion()" ${window.quizState.currentQuestion === 0 ? 'disabled' : ''}>
                                    ${t('previous')}
                                </button>
                                <div class="muted">
                                    ${window.quizState.currentQuestion + 1} de ${survey.questions.length}
                                </div>
                                <button class="btn btn-primary" onclick="nextQuestion()">
                                    ${window.quizState.currentQuestion === survey.questions.length - 1 ? t('finish') : t('next')}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderQuestionInput(question) {
            switch (question.type) {
                case 'nps':
                    return `
                        <div class="nps-scale">
                            ${Array.from({length: 11}, (_, i) => `
                                <button class="nps-btn" onclick="selectNPS(${i})" data-value="${i}">
                                    ${i}
                                </button>
                            `).join('')}
                        </div>
                        <div class="nps-labels">
                            <span>${t('notRecommend')}</span>
                            <span>${t('definitelyRecommend')}</span>
                        </div>
                    `;
                    
                case 'likert':
                    return `
                        <div class="likert-scale">
                            ${Array.from({length: 5}, (_, i) => `
                                <button class="likert-btn" onclick="selectLikert(${i + 1})" data-value="${i + 1}">
                                    ${i + 1}
                                </button>
                            `).join('')}
                        </div>
                    `;
                    
                case 'text':
                    return `<input type="text" id="textInput" placeholder="Digite sua resposta...">`;
                    
                case 'textarea':
                    return `<textarea id="textareaInput" placeholder="Digite sua resposta..."></textarea>`;
                    
                case 'radio':
                    return `
                        <div class="radio-options">
                            ${(question.options || ['Opção 1', 'Opção 2']).map((option, i) => `
                                <div class="radio-option" onclick="selectRadio('${option}')">
                                    <input type="radio" name="radioOption" value="${option}">
                                    <span>${option}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                default:
                    return '<p>Tipo de pergunta não suportado</p>';
            }
        }

        function render404(app) {
            app.innerHTML = `
                <div class="container">
                    <div class="quiz-container">
                        <div class="question-card text-center">
                            <h2>Página não encontrada</h2>
                            <p class="muted">A página que você está procurando não existe.</p>
                            <a href="#/" class="btn btn-primary" style="margin-top: 1rem;">← Voltar ao Início</a>
                        </div>
                    </div>
                </div>
            `;
        }

        // Utility functions for stats
        function getTotalResponses() {
            return Object.values(state.surveys).reduce((total, survey) => total + survey.responses.length, 0);
        }

        function getAverageNPS() {
            const allNPS = [];
            Object.values(state.surveys).forEach(survey => {
                survey.responses.forEach(response => {
                    if (response.answers.q1 !== undefined) {
                        allNPS.push(parseInt(response.answers.q1));
                    }
                });
            });
            
            if (allNPS.length === 0) return '--';
            
            const avg = allNPS.reduce((sum, score) => sum + score, 0) / allNPS.length;
            return Math.round(avg * 10) / 10;
        }

        function getActiveSurveys() {
            return Object.values(state.surveys).filter(survey => survey.status === 'active').length;
        }

        // Admin functions
        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (password === 'admin123') {
                state.ui.adminPassword = password;
                saveState();
                window.location.hash = '/admin';
            } else {
                alert(t('invalidPassword'));
            }
        }

        function logout() {
            state.ui.adminPassword = null;
            saveState();
            window.location.hash = '/admin';
        }

        function createNewSurvey() {
            const surveyId = uid('srv_');
            const slug = uid('survey_');
            
            const survey = {
                id: surveyId,
                slug: slug,
                title: {
                    pt: 'Nova Pesquisa',
                    en: 'New Survey',
                    es: 'Nueva Encuesta'
                },
                eventDate: new Date().toISOString().split('T')[0],
                status: 'draft',
                brandColor: '#6366f1',
                requireToken: false,
                webhook: '',
                questions: [
                    {
                        id: 'q1',
                        type: 'nps',
                        required: true,
                        label: {
                            pt: 'Em uma escala de 0 a 10, o quanto você recomendaria este evento a um amigo ou colega do mesmo nicho de mercado?',
                            en: 'On a scale of 0 to 10, how likely would you recommend this event to a friend or colleague in the same market niche?',
                            es: 'En una escala de 0 a 10, ¿qué tan probable es que recomiendes este evento a un amigo o colega del mismo nicho de mercado?'
                        },
                        help: {
                            pt: '0 = não recomendaria; 10 = recomendaria com certeza',
                            en: '0 = would not recommend; 10 = would definitely recommend',
                            es: '0 = no recomendaría; 10 = definitivamente recomendaría'
                        }
                    }
                ],
                responses: [],
                tokens: {},
                answeredDevices: {}
            };
            
            state.surveys[surveyId] = survey;
            state.slugs[slug] = surveyId;
            saveState();
            
            window.location.hash = `/admin?edit=${surveyId}`;
        }

        function editSurvey(surveyId) {
            window.location.hash = `/admin?edit=${surveyId}`;
        }

        function viewSurvey(slug) {
            window.open(`#/s/${slug}`, '_blank');
        }

        function duplicateSurvey(surveyId) {
            const original = state.surveys[surveyId];
            const newId = uid('srv_');
            const newSlug = uid('survey_');
            
            const duplicate = JSON.parse(JSON.stringify(original));
            duplicate.id = newId;
            duplicate.slug = newSlug;
            duplicate.title.pt += ' (Cópia)';
            duplicate.title.en += ' (Copy)';
            duplicate.title.es += ' (Copia)';
            duplicate.responses = [];
            duplicate.tokens = {};
            duplicate.answeredDevices = {};
            
            state.surveys[newId] = duplicate;
            state.slugs[newSlug] = newId;
            saveState();
            
            router();
        }

        function deleteSurvey(surveyId) {
            if (confirm('Tem certeza que deseja excluir esta pesquisa?')) {
                const survey = state.surveys[surveyId];
                delete state.surveys[surveyId];
                delete state.slugs[survey.slug];
                saveState();
                router();
            }
        }

        function saveSurvey(surveyId) {
            const survey = state.surveys[surveyId];
            
            // Update basic info
            survey.title.pt = document.getElementById('titlePt').value;
            survey.title.en = document.getElementById('titleEn').value;
            survey.title.es = document.getElementById('titleEs').value;
            survey.slug = document.getElementById('slug').value;
            survey.eventDate = document.getElementById('eventDate').value;
            survey.brandColor = document.getElementById('brandColor').value;
            survey.status = document.querySelector('input[name="status"]:checked').value;
            survey.requireToken = document.getElementById('requireToken').checked;
            survey.webhook = document.getElementById('webhook').value;
            
            // Update slug mapping
            Object.keys(state.slugs).forEach(slug => {
                if (state.slugs[slug] === surveyId) {
                    delete state.slugs[slug];
                }
            });
            state.slugs[survey.slug] = surveyId;
            
            saveState();
            alert('Pesquisa salva com sucesso!');
        }

        // Question management functions
        function addQuestion(surveyId) {
            const survey = state.surveys[surveyId];
            const questionId = uid('q_');
            
            const newQuestion = {
                id: questionId,
                type: 'text',
                required: false,
                label: {
                    pt: 'Nova pergunta',
                    en: 'New question',
                    es: 'Nueva pregunta'
                },
                help: {
                    pt: '',
                    en: '',
                    es: ''
                }
            };
            
            survey.questions.push(newQuestion);
            saveState();
            router();
        }

        function removeQuestion(index) {
            const surveyId = new URLSearchParams(window.location.hash.split('?')[1]).get('edit');
            const survey = state.surveys[surveyId];
            
            if (confirm('Tem certeza que deseja remover esta pergunta?')) {
                survey.questions.splice(index, 1);
                saveState();
                router();
            }
        }

        function moveQuestion(index, direction) {
            const surveyId = new URLSearchParams(window.location.hash.split('?')[1]).get('edit');
            const survey = state.surveys[surveyId];
            
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < survey.questions.length) {
                const temp = survey.questions[index];
                survey.questions[index] = survey.questions[newIndex];
                survey.questions[newIndex] = temp;
                saveState();
                router();
            }
        }

        function updateQuestionType(questionId, type) {
            const surveyId = new URLSearchParams(window.location.hash.split('?')[1]).get('edit');
            const survey = state.surveys[surveyId];
            const question = survey.questions.find(q => q.id === questionId);
            
            if (question) {
                question.type = type;
                saveState();
            }
        }

        function updateQuestionRequired(questionId, required) {
            const surveyId = new URLSearchParams(window.location.hash.split('?')[1]).get('edit');
            const survey = state.surveys[surveyId];
            const question = survey.questions.find(q => q.id === questionId);
            
            if (question) {
                question.required = required;
                saveState();
            }
        }

        function updateQuestionLabel(questionId, lang, value) {
            const surveyId = new URLSearchParams(window.location.hash.split('?')[1]).get('edit');
            const survey = state.surveys[surveyId];
            const question = survey.questions.find(q => q.id === questionId);
            
            if (question) {
                question.label[lang] = value;
                saveState();
            }
        }

        function updateQuestionHelp(questionId, lang, value) {
            const surveyId = new URLSearchParams(window.location.hash.split('?')[1]).get('edit');
            const survey = state.surveys[surveyId];
            const question = survey.questions.find(q => q.id === questionId);
            
            if (question) {
                if (!question.help) question.help = {};
                question.help[lang] = value;
                saveState();
            }
        }

        // Quiz functions
        function selectNPS(value) {
            document.querySelectorAll('.nps-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelector(`[data-value="${value}"]`).classList.add('selected');
            window.quizState.answers[getCurrentQuestionId()] = value;
        }

        function selectLikert(value) {
            document.querySelectorAll('.likert-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelector(`[data-value="${value}"]`).classList.add('selected');
            window.quizState.answers[getCurrentQuestionId()] = value;
        }

        function selectRadio(value) {
            document.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            event.currentTarget.querySelector('input').checked = true;
            window.quizState.answers[getCurrentQuestionId()] = value;
        }

        function getCurrentQuestionId() {
            const survey = state.surveys[window.quizState.surveyId];
            return survey.questions[window.quizState.currentQuestion].id;
        }

        function nextQuestion() {
            const survey = state.surveys[window.quizState.surveyId];
            const currentQ = survey.questions[window.quizState.currentQuestion];
            
            // Get current answer
            let answer = window.quizState.answers[currentQ.id];
            
            if (currentQ.type === 'text') {
                answer = document.getElementById('textInput').value;
                window.quizState.answers[currentQ.id] = answer;
            } else if (currentQ.type === 'textarea') {
                answer = document.getElementById('textareaInput').value;
                window.quizState.answers[currentQ.id] = answer;
            }
            
            // Validate required fields
            if (currentQ.required && (!answer || answer === '')) {
                alert(t('fieldRequired'));
                return;
            }
            
            // Move to next question or finish
            if (window.quizState.currentQuestion < survey.questions.length - 1) {
                window.quizState.currentQuestion++;
                router();
            } else {
                finishQuiz();
            }
        }

        function previousQuestion() {
            if (window.quizState.currentQuestion > 0) {
                window.quizState.currentQuestion--;
                router();
            }
        }

        function finishQuiz() {
            const survey = state.surveys[window.quizState.surveyId];
            
            // Save response
            const response = {
                id: uid('resp_'),
                timestamp: new Date().toISOString(),
                lang: state.ui.lang,
                answers: window.quizState.answers
            };
            
            survey.responses.push(response);
            saveState();
            
            // Reset quiz state
            window.quizState = null;
            
            // Show thank you message
            document.getElementById('app').innerHTML = `
                <div class="container">
                    <div class="quiz-container">
                        <div class="question-card text-center">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">🎉</div>
                            <h2>${t('thankYou')}</h2>
                            <p class="muted">Sua resposta foi registrada com sucesso.</p>
                            <a href="#/" class="btn btn-primary" style="margin-top: 1rem;">← Voltar ao Início</a>
                        </div>
                    </div>
                </div>
            `;
        }

        // Language switching
        function switchLanguage(lang) {
            state.ui.lang = lang;
            saveState();
            
            // Update active language button
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
            
            router();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadState();
            
            // Language switcher
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', () => switchLanguage(btn.dataset.lang));
            });
            
            // Router
            window.addEventListener('hashchange', router);
            router();
        });

        // Admin password input handler
        document.addEventListener('keypress', function(e) {
            if (e.target.id === 'adminPassword' && e.key === 'Enter') {
                adminLogin();
            }
        });
    </script>
</body>
</html>

